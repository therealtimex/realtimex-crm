{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "atomic-crm",
  "title": "Atomic CRM",
  "description": "A fully fledged CRM application built with Shadcn Admin Kit",
  "dependencies": [
    "@hello-pangea/dnd@^18.0.1",
    "@nivo/bar@^0.99.0",
    "faker@^5.5.3",
    "jsonexport@^3.2.0",
    "papaparse@^5.5.3",
    "ra-supabase-core@^3.5.1",
    "ra-supabase-language-english@^3.5.0",
    "zod@^4.0.5"
  ],
  "registryDependencies": [
    "progress",
    "tabs",
    "https://marmelab.com/shadcn-admin-kit/r/admin.json"
  ],
  "files": [
    {
      "path": "src/components/atomic-crm/types.ts",
      "content": "import type { Identifier, RaRecord } from \"ra-core\";\nimport type { ComponentType } from \"react\";\n\nimport type {\n  COMPANY_CREATED,\n  CONTACT_CREATED,\n  CONTACT_NOTE_CREATED,\n  DEAL_CREATED,\n  DEAL_NOTE_CREATED,\n} from \"./consts\";\n\nexport type SignUpData = {\n  email: string;\n  password: string;\n  first_name: string;\n  last_name: string;\n};\n\nexport type SalesFormData = {\n  avatar: string;\n  email: string;\n  password: string;\n  first_name: string;\n  last_name: string;\n  administrator: boolean;\n  disabled: boolean;\n};\n\nexport type Sale = {\n  first_name: string;\n  last_name: string;\n  administrator: boolean;\n  avatar?: RAFile;\n  disabled?: boolean;\n  user_id: string;\n\n  /**\n   * This is a copy of the user's email, to make it easier to handle by react admin\n   * DO NOT UPDATE this field directly, it should be updated by the backend\n   */\n  email: string;\n\n  /**\n   * This is used by the fake rest provider to store the password\n   * DO NOT USE this field in your code besides the fake rest provider\n   * @deprecated\n   */\n  password?: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type Company = {\n  name: string;\n  logo: RAFile;\n  sector: string;\n  size: 1 | 10 | 50 | 250 | 500;\n  linkedin_url: string;\n  website: string;\n  phone_number: string;\n  address: string;\n  zipcode: string;\n  city: string;\n  stateAbbr: string;\n  sales_id: Identifier;\n  created_at: string;\n  description: string;\n  revenue: string;\n  tax_identifier: string;\n  country: string;\n  context_links?: string[];\n  nb_contacts?: number;\n  nb_deals?: number;\n  nb_notes?: number;\n  nb_tasks?: number;\n  last_seen?: string;\n\n  // Phase 1: Lifecycle & Classification\n  updated_at?: string;\n  lifecycle_stage?: string;\n  company_type?: string;\n  qualification_status?: string;\n\n  // Phase 1: External Integration\n  external_id?: string;\n  external_system?: string;\n\n  // Phase 1: Contact Information\n  email?: string;\n\n  // Phase 1: Firmographics\n  industry?: string;\n  revenue_range?: string;\n  employee_count?: number;\n  founded_year?: number;\n\n  // Phase 1: Social & Enrichment\n  social_profiles?: Record<string, string>;\n  logo_url?: string;\n\n  // Phase 2: External Heartbeat\n  external_heartbeat_status?: string;\n  external_heartbeat_checked_at?: string;\n\n  // Phase 2: Internal Heartbeat\n  internal_heartbeat_status?: string;\n  internal_heartbeat_score?: number;\n  internal_heartbeat_updated_at?: string;\n\n  // View-computed fields\n  last_note_date?: string;\n  last_deal_activity?: string;\n  last_task_activity?: string;\n  days_since_last_activity?: number;\n  total_deal_amount?: number;\n} & Pick<RaRecord, \"id\">;\n\nexport type EmailAndType = {\n  email: string;\n  type: \"Work\" | \"Home\" | \"Other\";\n};\n\nexport type PhoneNumberAndType = {\n  number: string;\n  type: \"Work\" | \"Home\" | \"Other\";\n};\n\nexport type Contact = {\n  first_name: string;\n  last_name: string;\n  title: string;\n  company_id: Identifier;\n  email_jsonb: EmailAndType[];\n  avatar?: Partial<RAFile>;\n  linkedin_url?: string | null;\n  first_seen: string;\n  last_seen: string;\n  has_newsletter: boolean;\n  tags: Identifier[];\n  gender: string;\n  sales_id: Identifier;\n  status: string;\n  background: string;\n  phone_jsonb: PhoneNumberAndType[];\n  nb_tasks?: number;\n  company_name?: string;\n\n  // Internal Heartbeat\n  internal_heartbeat_score?: number;\n  internal_heartbeat_status?: string; // 'strong' | 'active' | 'cooling' | 'cold' | 'dormant'\n  internal_heartbeat_updated_at?: string;\n\n  // External Heartbeat\n  external_heartbeat_status?: string; // 'valid' | 'warning' | 'invalid' | 'unknown'\n  external_heartbeat_checked_at?: string;\n  email_validation_status?: string; // 'valid' | 'risky' | 'invalid' | 'unknown'\n  email_last_bounced_at?: string;\n  linkedin_profile_status?: string; // 'active' | 'inactive' | 'not_found' | 'unknown'\n  employment_verified_at?: string;\n\n  // View-computed fields\n  nb_completed_tasks?: number;\n  task_completion_rate?: number;\n  last_note_date?: string;\n  last_task_activity?: string;\n  days_since_last_activity?: number;\n} & Pick<RaRecord, \"id\">;\n\nexport type ContactNote = {\n  contact_id: Identifier;\n  text: string;\n  date: string;\n  sales_id: Identifier;\n  status: string;\n  attachments?: AttachmentNote[];\n} & Pick<RaRecord, \"id\">;\n\nexport type Deal = {\n  name: string;\n  company_id: Identifier;\n  contact_ids: Identifier[];\n  category: string;\n  stage: string;\n  description: string;\n  amount: number;\n  created_at: string;\n  updated_at: string;\n  archived_at?: string;\n  expected_closing_date: string;\n  sales_id: Identifier;\n  index: number;\n} & Pick<RaRecord, \"id\">;\n\nexport type DealNote = {\n  deal_id: Identifier;\n  text: string;\n  date: string;\n  sales_id: Identifier;\n  attachments?: AttachmentNote[];\n\n  // This is defined for compatibility with `ContactNote`\n  status?: undefined;\n} & Pick<RaRecord, \"id\">;\n\nexport type CompanyNote = {\n  company_id: Identifier;\n  text: string;\n  date: string;\n  sales_id: Identifier;\n  attachments?: AttachmentNote[];\n\n  // This is defined for compatibility with `ContactNote`\n  status?: undefined;\n} & Pick<RaRecord, \"id\">;\n\nexport type Tag = {\n  name: string;\n  color: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type TaskPriority = \"low\" | \"medium\" | \"high\" | \"urgent\";\n\nexport type TaskStatus =\n  | \"todo\"\n  | \"in_progress\"\n  | \"blocked\"\n  | \"done\"\n  | \"cancelled\";\n\nexport type Task = {\n  contact_id: Identifier;\n  type: string;\n  text: string;\n  due_date: string;\n  done_date?: string | null;\n  sales_id?: Identifier;\n  priority?: TaskPriority;\n  assigned_to?: Identifier;\n  status?: TaskStatus;\n  created_at?: string;\n  updated_at?: string;\n  archived?: boolean;\n  archived_at?: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type TaskSummary = Task & {\n  contact_first_name?: string;\n  contact_last_name?: string;\n  contact_email?: string;\n  company_id?: Identifier;\n  company_name?: string;\n  assigned_first_name?: string;\n  assigned_last_name?: string;\n  creator_first_name?: string;\n  creator_last_name?: string;\n  nb_notes?: number;\n  last_note_date?: string;\n};\n\nexport type TaskNote = {\n  task_id: Identifier;\n  text: string;\n  date: string;\n  sales_id: Identifier;\n  status?: string;\n  created_at?: string;\n  updated_at?: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type TaskActivity = {\n  task_id: Identifier;\n  sales_id: Identifier;\n  action: string;\n  field_name?: string;\n  old_value?: string;\n  new_value?: string;\n  created_at: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type ActivityCompanyCreated = {\n  type: typeof COMPANY_CREATED;\n  company_id: Identifier;\n  company: Company;\n  sales_id: Identifier;\n  date: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type ActivityContactCreated = {\n  type: typeof CONTACT_CREATED;\n  company_id: Identifier;\n  sales_id?: Identifier;\n  contact: Contact;\n  date: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type ActivityContactNoteCreated = {\n  type: typeof CONTACT_NOTE_CREATED;\n  sales_id?: Identifier;\n  contactNote: ContactNote;\n  date: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type ActivityDealCreated = {\n  type: typeof DEAL_CREATED;\n  company_id: Identifier;\n  sales_id?: Identifier;\n  deal: Deal;\n  date: string;\n};\n\nexport type ActivityDealNoteCreated = {\n  type: typeof DEAL_NOTE_CREATED;\n  sales_id?: Identifier;\n  dealNote: DealNote;\n  date: string;\n};\n\nexport type ActivityCompanyNoteCreated = {\n  type: typeof COMPANY_NOTE_CREATED;\n  sales_id?: Identifier;\n  companyNote: CompanyNote;\n  date: string;\n};\n\nexport type Activity = RaRecord &\n  (\n    | ActivityCompanyCreated\n    | ActivityContactCreated\n    | ActivityContactNoteCreated\n    | ActivityDealCreated\n    | ActivityDealNoteCreated\n    | ActivityCompanyNoteCreated\n  );\n\nexport interface RAFile {\n  src: string;\n  title: string;\n  path?: string;\n  rawFile: File;\n  type?: string;\n}\n\nexport type AttachmentNote = RAFile;\nexport interface DealStage {\n  value: string;\n  label: string;\n}\n\nexport interface NoteStatus {\n  value: string;\n  label: string;\n  color: string;\n}\n\nexport interface ContactGender {\n  value: string;\n  label: string;\n  icon: ComponentType<{ className?: string }>;\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/consts.ts",
      "content": "export const COMPANY_CREATED = \"company.created\" as const;\nexport const COMPANY_NOTE_CREATED = \"companyNote.created\" as const;\nexport const CONTACT_CREATED = \"contact.created\" as const;\nexport const CONTACT_NOTE_CREATED = \"contactNote.created\" as const;\nexport const DEAL_CREATED = \"deal.created\" as const;\nexport const DEAL_NOTE_CREATED = \"dealNote.created\" as const;\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/tasks/index.ts",
      "content": "import { TaskCreate } from \"./TaskCreate\";\nimport TaskList from \"./TaskList\";\nimport { TaskShow } from \"./TaskShow\";\n\nexport default {\n    list: TaskList,\n    show: TaskShow,\n    create: TaskCreate,\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/tasks/TasksIterator.tsx",
      "content": "import { isAfter } from \"date-fns\";\nimport { useListContext } from \"ra-core\";\n\nimport { Task } from \"./Task\";\n\nexport const TasksIterator = ({\n  showContact,\n  className,\n}: {\n  showContact?: boolean;\n  className?: string;\n}) => {\n  const { data, error, isPending } = useListContext();\n  if (isPending || error || data.length === 0) return null;\n\n  // Keep only tasks that are not done or done less than 5 minutes ago\n  const tasks = data.filter(\n    (task) =>\n      !task.done_date ||\n      isAfter(new Date(task.done_date), new Date(Date.now() - 5 * 60 * 1000)),\n  );\n\n  return (\n    <div className={`space-y-2 ${className || \"\"}`}>\n      {tasks.map((task) => (\n        <Task task={task} showContact={showContact} key={task.id} />\n      ))}\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/tasks/TaskStatusBadge.tsx",
      "content": "import { Badge } from \"@/components/ui/badge\";\nimport { cn } from \"@/lib/utils\";\n\nconst statusColors = {\n  todo: \"bg-slate-500 hover:bg-slate-600\",\n  in_progress: \"bg-blue-500 hover:bg-blue-600\",\n  blocked: \"bg-red-500 hover:bg-red-600\",\n  done: \"bg-green-500 hover:bg-green-600\",\n  cancelled: \"bg-gray-400 hover:bg-gray-500\",\n};\n\nexport const TaskStatusBadge = ({ status }: { status?: string }) => {\n    if (!status) return null;\n    const colorClass = statusColors[status as keyof typeof statusColors] || \"bg-slate-500\";\n    \n    return (\n        <Badge className={cn(\"capitalize\", colorClass)}>\n            {status.replace(\"_\", \" \")}\n        </Badge>\n    );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/tasks/TaskShow.tsx",
      "content": "import { ShowBase, useShowContext } from \"ra-core\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { ReferenceManyField } from \"@/components/admin/reference-many-field\";\n\nimport { NoteCreate, NotesIterator } from \"../notes\";\nimport type { Task } from \"../types\";\nimport { TaskAside } from \"./TaskAside\";\nimport { TaskPriorityBadge } from \"./TaskPriorityBadge\";\nimport { TaskStatusBadge } from \"./TaskStatusBadge\";\nimport { TaskActivityTimeline } from \"./TaskActivityTimeline\";\n\nexport const TaskShow = () => (\n  <ShowBase>\n    <TaskShowContent />\n  </ShowBase>\n);\n\nconst TaskShowContent = () => {\n  const { record, isPending } = useShowContext<Task>();\n  if (isPending || !record) return null;\n\n  return (\n    <div className=\"mt-2 mb-2 flex gap-8\">\n      <div className=\"flex-1\">\n        <Card>\n          <CardContent>\n            {/* Task Header */}\n            <div className=\"mb-6\">\n              <h5 className=\"text-xl font-semibold mb-3\">{record.type}</h5>\n              <div className=\"flex gap-3 mb-4\">\n                <TaskStatusBadge status={record.status} />\n                <TaskPriorityBadge priority={record.priority} />\n              </div>\n              {record.text && (\n                <p className=\"text-sm text-muted-foreground whitespace-pre-line\">\n                  {record.text}\n                </p>\n              )}\n            </div>\n\n            {/* Activity Timeline */}\n            <div className=\"mt-8\">\n              <h3 className=\"text-lg font-semibold mb-4\">Activity Timeline</h3>\n              <p className=\"text-sm text-muted-foreground mb-3\">\n                Track all status changes and updates for this task\n              </p>\n              <TaskActivityTimeline taskId={record.id} />\n            </div>\n\n            {/* Notes */}\n            <div className=\"mt-8\">\n              <h3 className=\"text-lg font-semibold mb-4\">Notes</h3>\n              <p className=\"text-sm text-muted-foreground mb-3\">\n                Add notes and updates to this task\n              </p>\n              <ReferenceManyField\n                reference=\"taskNotes\"\n                target=\"task_id\"\n                sort={{ field: \"date\", order: \"DESC\" }}\n                empty={<NoteCreate reference=\"tasks\" showStatus className=\"mt-4\" />}\n              >\n                <NotesIterator reference=\"tasks\" showStatus />\n              </ReferenceManyField>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n      <TaskAside />\n    </div>\n  );\n};",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/tasks/TaskPriorityBadge.tsx",
      "content": "import { Badge } from \"@/components/ui/badge\";\nimport { cn } from \"@/lib/utils\";\n\nconst priorityColors = {\n  low: \"bg-slate-500 hover:bg-slate-600\",\n  medium: \"bg-blue-500 hover:bg-blue-600\",\n  high: \"bg-orange-500 hover:bg-orange-600\",\n  urgent: \"bg-red-500 hover:bg-red-600\",\n};\n\nexport const TaskPriorityBadge = ({ priority }: { priority?: string }) => {\n  if (!priority) return null;\n  const colorClass = priorityColors[priority as keyof typeof priorityColors] || \"bg-slate-500\";\n  \n  return (\n    <Badge className={cn(\"capitalize\", colorClass)}>\n      {priority}\n    </Badge>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/tasks/TaskListTable.tsx",
      "content": "import { DataTable } from \"@/components/admin/data-table\";\nimport { DateField } from \"@/components/admin/date-field\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { TextField } from \"@/components/admin/text-field\";\n\nimport type { Task } from \"../types\";\nimport { TaskPriorityBadge } from \"./TaskPriorityBadge\";\nimport { TaskStatusBadge } from \"./TaskStatusBadge\";\n\nexport const TaskListTable = () => {\n  return (\n    <DataTable rowClick=\"show\">\n      <DataTable.Col\n        source=\"text\"\n        label=\"Task\"\n        className=\"w-[35%]\"\n        cellClassName=\"max-w-md\"\n        render={(record: Task) => (\n          <div className=\"truncate\" title={record.text}>\n            {record.type && record.type !== \"None\" && (\n              <span className=\"font-semibold\">{record.type}: </span>\n            )}\n            {record.text}\n          </div>\n        )}\n      />\n      <DataTable.Col label=\"Contact\" className=\"w-[15%]\">\n        <ReferenceField source=\"contact_id\" reference=\"contacts\" link=\"show\" />\n      </DataTable.Col>\n      <DataTable.Col label=\"Company\" className=\"w-[15%]\">\n        <ReferenceField\n          source=\"company_id\"\n          reference=\"companies\"\n          link=\"show\"\n          sortable={false}\n        >\n          <TextField source=\"name\" />\n        </ReferenceField>\n      </DataTable.Col>\n      <DataTable.Col label=\"Due Date\" className=\"w-[12%]\">\n        <DateField source=\"due_date\" />\n      </DataTable.Col>\n      <DataTable.Col\n        label=\"Priority\"\n        className=\"w-[10%]\"\n        render={(record: Task) => (\n          <TaskPriorityBadge priority={record.priority} />\n        )}\n      />\n      <DataTable.Col\n        label=\"Status\"\n        className=\"w-[10%]\"\n        render={(record: Task) => <TaskStatusBadge status={record.status} />}\n      />\n      <DataTable.Col label=\"Assigned To\" className=\"w-[13%]\">\n        <ReferenceField source=\"assigned_to\" reference=\"sales\" link={false} />\n      </DataTable.Col>\n    </DataTable>\n  );\n};",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/tasks/TaskList.tsx",
      "content": "import { AutocompleteInput } from \"@/components/admin/autocomplete-input\";\nimport { BooleanInput } from \"@/components/admin/boolean-input\";\nimport { CreateButton } from \"@/components/admin/create-button\";\nimport { ExportButton } from \"@/components/admin/export-button\";\nimport { FilterButton } from \"@/components/admin/filter-form\";\nimport { List } from \"@/components/admin/list\";\nimport { ReferenceInput } from \"@/components/admin/reference-input\";\nimport { SearchInput } from \"@/components/admin/search-input\";\nimport { SelectInput } from \"@/components/admin/select-input\";\n\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport { TopToolbar } from \"../layout/TopToolbar\";\nimport { MyTasksInput } from \"./MyTasksInput\";\nimport { TaskListTable } from \"./TaskListTable\";\n\nconst TaskList = () => {\n  const { taskStatuses, taskPriorities } = useConfigurationContext();\n\n  const taskFilters = [\n    <SearchInput source=\"q\" alwaysOn />,\n    <SelectInput source=\"status\" choices={taskStatuses} alwaysOn />,\n    <ReferenceInput source=\"contact_id\" reference=\"contacts\">\n      <AutocompleteInput label={false} placeholder=\"Contact\" />\n    </ReferenceInput>,\n    <SelectInput source=\"priority\" choices={taskPriorities} />,\n    <MyTasksInput source=\"assigned_to\" label=\"My Tasks\" alwaysOn />,\n    <BooleanInput source=\"archived\" label=\"Archived\" />,\n  ];\n\n  return (\n    <List\n      perPage={25}\n      sort={{ field: \"due_date\", order: \"ASC\" }}\n      filters={taskFilters}\n      filterDefaultValues={{ archived: false }}\n      actions={<TaskActions />}\n      title=\"Tasks\"\n    >\n      <TaskListTable />\n    </List>\n  );\n};\n\nconst TaskActions = () => (\n  <TopToolbar>\n    <FilterButton />\n    <ExportButton />\n    <CreateButton label=\"New Task\" />\n  </TopToolbar>\n);\n\nexport default TaskList;\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/tasks/TaskEdit.tsx",
      "content": "import { EditBase, Form, required, useNotify, type Identifier } from \"ra-core\";\nimport { DeleteButton } from \"@/components/admin/delete-button\";\nimport { TextInput } from \"@/components/admin/text-input\";\nimport { DateInput } from \"@/components/admin/date-input\";\nimport { SelectInput } from \"@/components/admin/select-input\";\nimport { ReferenceInput } from \"@/components/admin/reference-input\";\nimport { SaveButton } from \"@/components/admin/form\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\n\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\n\nexport const TaskEdit = ({\n  open,\n  close,\n  taskId,\n}: {\n  taskId: Identifier;\n  open: boolean;\n  close: () => void;\n}) => {\n  const { taskTypes, taskPriorities, taskStatuses } = useConfigurationContext();\n  const notify = useNotify();\n  return (\n    <Dialog open={open} onOpenChange={close}>\n      {taskId && (\n        <EditBase\n          id={taskId}\n          resource=\"tasks\"\n          className=\"mt-0\"\n          mutationOptions={{\n            onSuccess: () => {\n              close();\n              notify(\"Task updated\", {\n                type: \"info\",\n                undoable: true,\n              });\n            },\n          }}\n          redirect={false}\n        >\n          <DialogContent className=\"lg:max-w-xl overflow-y-auto max-h-9/10 top-1/20 translate-y-0\">\n            <Form className=\"flex flex-col gap-4\">\n              <DialogHeader>\n                <DialogTitle>Edit task</DialogTitle>\n              </DialogHeader>\n              <TextInput\n                autoFocus\n                source=\"text\"\n                label=\"Description\"\n                validate={required()}\n                multiline\n                helperText={false}\n              />\n              <div className=\"grid grid-cols-2 gap-4\">\n                <DateInput\n                  source=\"due_date\"\n                  helperText={false}\n                  validate={required()}\n                />\n                <SelectInput\n                  source=\"type\"\n                  choices={taskTypes.map((type) => ({\n                    id: type,\n                    name: type,\n                  }))}\n                  helperText={false}\n                  validate={required()}\n                />\n                <SelectInput\n                  source=\"priority\"\n                  choices={taskPriorities}\n                  helperText={false}\n                />\n                <SelectInput\n                  source=\"status\"\n                  choices={taskStatuses}\n                  helperText={false}\n                />\n                <ReferenceInput source=\"assigned_to\" reference=\"sales\">\n                  <SelectInput\n                    optionText={(record) =>\n                      `${record.first_name} ${record.last_name}`\n                    }\n                    label=\"Assigned To\"\n                  />\n                </ReferenceInput>\n              </div>\n              <DialogFooter className=\"w-full sm:justify-between gap-4\">\n                <DeleteButton\n                  mutationOptions={{\n                    onSuccess: () => {\n                      close();\n                      notify(\"Task deleted\", {\n                        type: \"info\",\n                        undoable: true,\n                      });\n                    },\n                  }}\n                  redirect={false}\n                />\n                <SaveButton label=\"Save\" />\n              </DialogFooter>\n            </Form>\n          </DialogContent>\n        </EditBase>\n      )}\n    </Dialog>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/tasks/TaskCreate.tsx",
      "content": "import { AutocompleteInput } from \"@/components/admin/autocomplete-input\";\nimport { DateInput } from \"@/components/admin/date-input\";\nimport { SaveButton } from \"@/components/admin/form\";\nimport { ReferenceInput } from \"@/components/admin/reference-input\";\nimport { SelectInput } from \"@/components/admin/select-input\";\nimport { TextInput } from \"@/components/admin/text-input\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Create } from \"@/components/admin/create\";\nimport {\n  Form,\n  required,\n  useGetIdentity,\n  useNotify,\n  useRedirect,\n} from \"ra-core\";\n\nimport { FormToolbar } from \"../layout/FormToolbar\";\nimport { contactOptionText } from \"../misc/ContactOption\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\n\nexport const TaskCreate = () => {\n  const { identity } = useGetIdentity();\n  const { taskTypes, taskPriorities, taskStatuses } = useConfigurationContext();\n  const notify = useNotify();\n  const redirect = useRedirect();\n\n  const handleSuccess = () => {\n    notify(\"Task created\");\n    redirect(\"list\", \"tasks\");\n  };\n\n  return (\n    <div className=\"mt-4 max-w-2xl mx-auto\">\n      <Card>\n        <CardHeader>\n          <CardTitle>Create Task</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <Create\n            resource=\"tasks\"\n            redirect=\"list\"\n            mutationOptions={{ onSuccess: handleSuccess }}\n            transform={(data) => ({\n              ...data,\n              sales_id: identity?.id,\n              created_at: new Date().toISOString(),\n              updated_at: new Date().toISOString(),\n            })}\n          >\n            <Form\n              defaultValues={{\n                due_date: new Date().toISOString().slice(0, 10),\n                priority: \"medium\",\n                status: \"todo\",\n                assigned_to: identity?.id,\n              }}\n            >\n              <TextInput\n                autoFocus\n                source=\"text\"\n                label=\"Description\"\n                validate={required()}\n                multiline\n                className=\"w-full\"\n              />\n              <div className=\"grid grid-cols-2 gap-4 mt-4\">\n                <ReferenceInput\n                  source=\"contact_id\"\n                  reference=\"contacts_summary\"\n                >\n                  <AutocompleteInput\n                    label=\"Contact\"\n                    optionText={contactOptionText}\n                    validate={required()}\n                  />\n                </ReferenceInput>\n                <DateInput\n                  source=\"due_date\"\n                  validate={required()}\n                />\n                <SelectInput\n                  source=\"type\"\n                  validate={required()}\n                  choices={taskTypes.map((type) => ({\n                    id: type,\n                    name: type,\n                  }))}\n                />\n                <SelectInput\n                  source=\"priority\"\n                  choices={taskPriorities}\n                />\n                <SelectInput\n                  source=\"status\"\n                  choices={taskStatuses}\n                />\n                <ReferenceInput source=\"assigned_to\" reference=\"sales\">\n                  <SelectInput\n                    optionText={(record) =>\n                      `${record.first_name} ${record.last_name}`\n                    }\n                    label=\"Assigned To\"\n                  />\n                </ReferenceInput>\n              </div>\n              <FormToolbar />\n            </Form>\n          </Create>\n        </CardContent>\n      </Card>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/tasks/TaskAside.tsx",
      "content": "import { Calendar, Building2, UserCircle, UserCheck, Pencil } from \"lucide-react\";\nimport { useRecordContext } from \"ra-core\";\nimport { useState, type ReactNode } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { DeleteButton } from \"@/components/admin/delete-button\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { DateField } from \"@/components/admin/date-field\";\n\nimport { AsideSection } from \"../misc/AsideSection\";\nimport type { Task } from \"../types\";\nimport { TaskEdit } from \"./TaskEdit\";\n\nexport const TaskAside = () => {\n  const record = useRecordContext<Task>();\n  const [editOpen, setEditOpen] = useState(false);\n\n  if (!record) return null;\n  return (\n    <div className=\"hidden sm:block w-64 min-w-64 text-sm\">\n      <div className=\"mb-4 -ml-1\">\n        <Button\n          variant=\"outline\"\n          size=\"sm\"\n          onClick={() => setEditOpen(true)}\n          className=\"flex items-center gap-2\"\n        >\n          <Pencil className=\"h-4 w-4\" />\n          Edit Task\n        </Button>\n      </div>\n\n      <TaskEdit\n        open={editOpen}\n        close={() => setEditOpen(false)}\n        taskId={record.id}\n      />\n\n      <AsideSection title=\"Task Info\">\n        <InfoRow\n          icon={<Calendar className=\"w-4 h-4 text-muted-foreground\" />}\n          label=\"Due Date\"\n          value={<DateField source=\"due_date\" />}\n        />\n        {record.done_date && (\n          <InfoRow\n            icon={<Calendar className=\"w-4 h-4 text-muted-foreground\" />}\n            label=\"Completed\"\n            value={<DateField source=\"done_date\" />}\n          />\n        )}\n      </AsideSection>\n\n      <AsideSection title=\"Related\">\n        <InfoRow\n          icon={<UserCircle className=\"w-4 h-4 text-muted-foreground\" />}\n          label=\"Contact\"\n          value={\n            <ReferenceField\n              source=\"contact_id\"\n              reference=\"contacts\"\n              link=\"show\"\n            />\n          }\n        />\n        <InfoRow\n          icon={<Building2 className=\"w-4 h-4 text-muted-foreground\" />}\n          label=\"Company\"\n          value={\n            <ReferenceField source=\"contact_id\" reference=\"contacts\" link={false}>\n              <ReferenceField source=\"company_id\" reference=\"companies\" link=\"show\">\n                <TextField source=\"name\" />\n              </ReferenceField>\n            </ReferenceField>\n          }\n        />\n      </AsideSection>\n\n      <AsideSection title=\"Assignment\">\n        <InfoRow\n          icon={<UserCheck className=\"w-4 h-4 text-muted-foreground\" />}\n          label=\"Assigned To\"\n          value={\n            <ReferenceField source=\"assigned_to\" reference=\"sales\" link={false} />\n          }\n        />\n        <InfoRow\n          icon={<UserCircle className=\"w-4 h-4 text-muted-foreground\" />}\n          label=\"Created By\"\n          value={\n            <ReferenceField source=\"sales_id\" reference=\"sales\" link={false} />\n          }\n        />\n      </AsideSection>\n\n      <div className=\"mt-6 pt-6 border-t hidden sm:flex flex-col gap-2 items-start\">\n        <DeleteButton\n          className=\"h-6 cursor-pointer hover:bg-destructive/10! text-destructive! border-destructive! focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40\"\n          size=\"sm\"\n        />\n      </div>\n    </div>\n  );\n};\n\nconst InfoRow = ({\n  icon,\n  label,\n  value,\n}: {\n  icon: ReactNode;\n  label: string;\n  value: ReactNode;\n}) => (\n  <div className=\"flex flex-col gap-1 mb-3\">\n    <div className=\"flex items-center gap-2\">\n      {icon}\n      <span className=\"text-xs text-muted-foreground\">{label}</span>\n    </div>\n    <div className=\"pl-6 text-sm\">{value}</div>\n  </div>\n);\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/tasks/TaskActivityTimeline.tsx",
      "content": "import { formatDistance } from \"date-fns\";\nimport { useGetList, useRecordContext } from \"ra-core\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport type { TaskActivity, Sale } from \"../types\";\n\nexport const TaskActivityTimeline = ({\n  taskId,\n}: {\n  taskId: string | number;\n}) => {\n  const { data: activities, isPending } = useGetList<TaskActivity>(\n    \"task_activity\",\n    {\n      filter: { task_id: taskId },\n      pagination: { page: 1, perPage: 100 },\n      sort: { field: \"created_at\", order: \"DESC\" },\n    },\n  );\n\n  if (isPending)\n    return (\n      <div className=\"p-4 text-center text-sm text-muted-foreground\">\n        Loading activity...\n      </div>\n    );\n  if (!activities || activities.length === 0)\n    return (\n      <div className=\"p-4 text-center text-sm text-muted-foreground\">\n        No activity recorded.\n      </div>\n    );\n\n  return (\n    <div className=\"space-y-6 relative pl-4 border-l border-border ml-2 my-4\">\n      {activities.map((activity) => (\n        <div key={activity.id} className=\"relative\">\n          <div className=\"absolute -left-[21px] top-1 h-3 w-3 rounded-full bg-primary ring-4 ring-background\" />\n          <div className=\"text-sm\">\n            <ReferenceField\n              source=\"sales_id\"\n              record={activity}\n              reference=\"sales\"\n              link={false}\n            >\n              <SaleName />\n            </ReferenceField>{\" \"}\n            {formatActivityMessage(activity)}\n          </div>\n          <div className=\"text-xs text-muted-foreground\">\n            {formatDistance(new Date(activity.created_at), new Date(), {\n              addSuffix: true,\n            })}\n          </div>\n        </div>\n      ))}\n    </div>\n  );\n};\n\nconst SaleName = () => {\n  const record = useRecordContext<Sale>();\n  if (!record) return null;\n  return (\n    <span className=\"font-semibold\">\n      {record.first_name} {record.last_name}\n    </span>\n  );\n};\n\nconst formatActivityMessage = (activity: TaskActivity) => {\n  switch (activity.action) {\n    case \"created\":\n      return \"created this task\";\n    case \"updated\":\n      if (!activity.field_name) return \"updated this task\";\n      return `changed ${activity.field_name}`;\n    // Simplified because old/new values might be IDs or technical values\n    case \"assigned\":\n      return \"assigned this task\";\n    case \"completed\":\n      return \"completed this task\";\n    case \"reopened\":\n      return \"reopened this task\";\n    case \"duplicated\":\n      return \"duplicated this task\";\n    case \"archived\":\n      return \"archived this task\";\n    default:\n      return activity.action;\n  }\n};",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/tasks/Task.tsx",
      "content": "import { useQueryClient } from \"@tanstack/react-query\";\nimport { MoreVertical } from \"lucide-react\";\nimport { useDeleteWithUndoController, useNotify, useUpdate } from \"ra-core\";\nimport { useEffect, useState } from \"react\";\nimport { Link } from \"react-router\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { DateField } from \"@/components/admin/date-field\";\nimport { Button } from \"@/components/ui/button\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\n\nimport type { Contact, Task as TData } from \"../types\";\nimport { TaskEdit } from \"./TaskEdit\";\n\nexport const Task = ({\n  task,\n  showContact,\n}: {\n  task: TData;\n  showContact?: boolean;\n}) => {\n  const notify = useNotify();\n  const queryClient = useQueryClient();\n\n  const [openEdit, setOpenEdit] = useState(false);\n\n  const handleCloseEdit = () => {\n    setOpenEdit(false);\n  };\n\n  const [update, { isPending: isUpdatePending, isSuccess, variables }] =\n    useUpdate();\n  const { handleDelete } = useDeleteWithUndoController({\n    record: task,\n    redirect: false,\n    mutationOptions: {\n      onSuccess() {\n        notify(\"Task deleted successfully\", { undoable: true });\n      },\n    },\n  });\n\n  const handleEdit = () => {\n    setOpenEdit(true);\n  };\n\n  const handleCheck = () => () => {\n    update(\"tasks\", {\n      id: task.id,\n      data: {\n        done_date: task.done_date ? null : new Date().toISOString(),\n      },\n      previousData: task,\n    });\n  };\n\n  useEffect(() => {\n    // We do not want to invalidate the query when a tack is checked or unchecked\n    if (\n      isUpdatePending ||\n      !isSuccess ||\n      variables?.data?.done_date != undefined\n    ) {\n      return;\n    }\n\n    queryClient.invalidateQueries({ queryKey: [\"tasks\", \"getList\"] });\n  }, [queryClient, isUpdatePending, isSuccess, variables]);\n\n  const labelId = `checkbox-list-label-${task.id}`;\n\n  return (\n    <>\n      <div className=\"flex items-start justify-between\">\n        <div className=\"flex items-start gap-2 flex-1\">\n          <Checkbox\n            id={labelId}\n            checked={!!task.done_date}\n            onCheckedChange={handleCheck()}\n            disabled={isUpdatePending}\n            className=\"mt-1\"\n          />\n          <div className={`flex-grow ${task.done_date ? \"line-through\" : \"\"}`}>\n            <Link\n              to={`/tasks/${task.id}/show`}\n              className=\"block hover:text-primary transition-colors\"\n            >\n              <div className=\"text-sm\">\n                {task.type && task.type !== \"None\" && (\n                  <>\n                    <span className=\"font-semibold text-sm\">{task.type}</span>\n                    &nbsp;\n                  </>\n                )}\n                {task.text}\n              </div>\n            </Link>\n            <div className=\"text-sm text-muted-foreground\">\n              due&nbsp;\n              <DateField source=\"due_date\" record={task} />\n              {showContact && (\n                <ReferenceField<TData, Contact>\n                  source=\"contact_id\"\n                  reference=\"contacts\"\n                  record={task}\n                  link=\"show\"\n                  className=\"inline text-sm text-muted-foreground\"\n                  render={({ referenceRecord }) => {\n                    if (!referenceRecord) return null;\n                    return (\n                      <>\n                        {\" \"}\n                        (Re:&nbsp;\n                        {referenceRecord?.first_name}{\" \"}\n                        {referenceRecord?.last_name})\n                      </>\n                    );\n                  }}\n                />\n              )}\n            </div>\n          </div>\n        </div>\n\n        <DropdownMenu>\n          <DropdownMenuTrigger asChild>\n            <Button\n              variant=\"ghost\"\n              size=\"icon\"\n              className=\"h-5 pr-0! size-8 cursor-pointer\"\n              aria-label=\"task actions\"\n            >\n              <MoreVertical className=\"h-4 w-4\" />\n            </Button>\n          </DropdownMenuTrigger>\n          <DropdownMenuContent align=\"end\">\n            <DropdownMenuItem asChild>\n              <Link to={`/tasks/${task.id}/show`} className=\"cursor-pointer\">\n                Show Details\n              </Link>\n            </DropdownMenuItem>\n            <DropdownMenuItem\n              className=\"cursor-pointer\"\n              onClick={() => {\n                update(\"tasks\", {\n                  id: task.id,\n                  data: {\n                    due_date: new Date(Date.now() + 24 * 60 * 60 * 1000)\n                      .toISOString()\n                      .slice(0, 10),\n                  },\n                  previousData: task,\n                });\n              }}\n            >\n              Postpone to tomorrow\n            </DropdownMenuItem>\n            <DropdownMenuItem\n              className=\"cursor-pointer\"\n              onClick={() => {\n                update(\"tasks\", {\n                  id: task.id,\n                  data: {\n                    due_date: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)\n                      .toISOString()\n                      .slice(0, 10),\n                  },\n                  previousData: task,\n                });\n              }}\n            >\n              Postpone to next week\n            </DropdownMenuItem>\n            <DropdownMenuItem className=\"cursor-pointer\" onClick={handleEdit}>\n              Edit\n            </DropdownMenuItem>\n            <DropdownMenuItem className=\"cursor-pointer\" onClick={handleDelete}>\n              Delete\n            </DropdownMenuItem>\n          </DropdownMenuContent>\n        </DropdownMenu>\n      </div>\n\n      {/* This part is for editing the Task directly via a Dialog */}\n      {openEdit && (\n        <TaskEdit taskId={task.id} open={openEdit} close={handleCloseEdit} />\n      )}\n    </>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/tasks/MyTasksInput.tsx",
      "content": "import { useGetIdentity, useListFilterContext } from \"ra-core\";\nimport { Label } from \"@/components/ui/label\";\nimport { Switch } from \"@/components/ui/switch\";\n\nexport const MyTasksInput = ({ source = \"assigned_to\", label = \"My Tasks\" }: { alwaysOn?: boolean; source?: string, label?: string }) => {\n  const { filterValues, displayedFilters, setFilters } = useListFilterContext();\n  const { identity } = useGetIdentity();\n\n  const handleChange = () => {\n    const newFilterValues = { ...filterValues };\n    if (typeof filterValues[source] !== \"undefined\") {\n      delete newFilterValues[source];\n    } else {\n      newFilterValues[source] = identity && identity?.id;\n    }\n    setFilters(newFilterValues, displayedFilters);\n  };\n  return (\n    <div className=\"mt-auto pb-2.25\">\n      <div className=\"flex items-center space-x-2\">\n        <Switch\n          id=\"my-tasks\"\n          checked={typeof filterValues[source] !== \"undefined\"}\n          onCheckedChange={handleChange}\n        />\n        <Label htmlFor=\"my-tasks\">{label}</Label>\n      </div>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/tasks/AddTask.tsx",
      "content": "import { Plus } from \"lucide-react\";\nimport {\n  CreateBase,\n  Form,\n  RecordRepresentation,\n  required,\n  useDataProvider,\n  useGetIdentity,\n  useNotify,\n  useRecordContext,\n  useUpdate,\n} from \"ra-core\";\nimport { useState } from \"react\";\nimport { AutocompleteInput } from \"@/components/admin/autocomplete-input\";\nimport { ReferenceInput } from \"@/components/admin/reference-input\";\nimport { TextInput } from \"@/components/admin/text-input\";\nimport { DateInput } from \"@/components/admin/date-input\";\nimport { SelectInput } from \"@/components/admin/select-input\";\nimport { SaveButton } from \"@/components/admin/form\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\n\nimport { contactOptionText } from \"../misc/ContactOption\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\n\nexport const AddTask = ({\n  selectContact,\n  display = \"chip\",\n}: {\n  selectContact?: boolean;\n  display?: \"chip\" | \"icon\";\n}) => {\n  const { identity } = useGetIdentity();\n  const dataProvider = useDataProvider();\n  const [update] = useUpdate();\n  const notify = useNotify();\n  const { taskTypes } = useConfigurationContext();\n  const contact = useRecordContext();\n  const [open, setOpen] = useState(false);\n  const handleOpen = () => {\n    setOpen(true);\n  };\n\n  const handleSuccess = async (data: any) => {\n    setOpen(false);\n    const contact = await dataProvider.getOne(\"contacts\", {\n      id: data.contact_id,\n    });\n    if (!contact.data) return;\n\n    await update(\"contacts\", {\n      id: contact.data.id,\n      data: { last_seen: new Date().toISOString() },\n      previousData: contact.data,\n    });\n\n    notify(\"Task added\");\n  };\n\n  if (!identity) return null;\n\n  return (\n    <>\n      {display === \"icon\" ? (\n        <TooltipProvider>\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <Button\n                size=\"sm\"\n                variant=\"ghost\"\n                className=\"p-2 cursor-pointer\"\n                onClick={handleOpen}\n              >\n                <Plus className=\"w-4 h-4\" />\n              </Button>\n            </TooltipTrigger>\n            <TooltipContent>Create task</TooltipContent>\n          </Tooltip>\n        </TooltipProvider>\n      ) : (\n        <div className=\"my-2\">\n          <Button\n            variant=\"outline\"\n            className=\"h-6 cursor-pointer\"\n            onClick={handleOpen}\n            size=\"sm\"\n          >\n            <Plus className=\"w-4 h-4\" />\n            Add task\n          </Button>\n        </div>\n      )}\n\n      <CreateBase\n        resource=\"tasks\"\n        record={{\n          type: \"None\",\n          contact_id: contact?.id,\n          due_date: new Date().toISOString().slice(0, 10),\n          sales_id: identity.id,\n        }}\n        transform={(data) => {\n          const dueDate = new Date(data.due_date);\n          dueDate.setHours(0, 0, 0, 0);\n          data.due_date = dueDate.toISOString();\n          return {\n            ...data,\n            due_date: new Date(data.due_date).toISOString(),\n          };\n        }}\n        mutationOptions={{ onSuccess: handleSuccess }}\n      >\n        <Dialog open={open} onOpenChange={() => setOpen(false)}>\n          <DialogContent className=\"lg:max-w-xl overflow-y-auto max-h-9/10 top-1/20 translate-y-0\">\n            <Form className=\"flex flex-col gap-4\">\n              <DialogHeader>\n                <DialogTitle>\n                  {!selectContact\n                    ? \"Create a new task for \"\n                    : \"Create a new task\"}\n                  {!selectContact && (\n                    <RecordRepresentation\n                      record={contact}\n                      resource=\"contacts\"\n                    />\n                  )}\n                </DialogTitle>\n              </DialogHeader>\n              <div className=\"flex flex-col gap-4\">\n                <TextInput\n                  autoFocus\n                  source=\"text\"\n                  label=\"Description\"\n                  validate={required()}\n                  multiline\n                  className=\"m-0\"\n                  helperText={false}\n                />\n                {selectContact && (\n                  <ReferenceInput\n                    source=\"contact_id\"\n                    reference=\"contacts_summary\"\n                  >\n                    <AutocompleteInput\n                      label=\"Contact\"\n                      optionText={contactOptionText}\n                      helperText={false}\n                      validate={required()}\n                    />\n                  </ReferenceInput>\n                )}\n\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <DateInput\n                    source=\"due_date\"\n                    helperText={false}\n                    validate={required()}\n                  />\n                  <SelectInput\n                    source=\"type\"\n                    validate={required()}\n                    choices={taskTypes.map((type) => ({\n                      id: type,\n                      name: type,\n                    }))}\n                    helperText={false}\n                  />\n                </div>\n              </div>\n              <DialogFooter className=\"w-full justify-end\">\n                <SaveButton />\n              </DialogFooter>\n            </Form>\n          </DialogContent>\n        </Dialog>\n      </CreateBase>\n    </>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/tags/colors.ts",
      "content": "export const colors = [\n  \"#eddcd2\",\n  \"#fff1e6\",\n  \"#fde2e4\",\n  \"#fad2e1\",\n  \"#c5dedd\",\n  \"#dbe7e4\",\n  \"#f0efeb\",\n  \"#d6e2e9\",\n  \"#bcd4e6\",\n  \"#99c1de\",\n];\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/tags/TagEditModal.tsx",
      "content": "import { useUpdate } from \"ra-core\";\n\nimport type { Tag } from \"../types\";\nimport { TagDialog } from \"./TagDialog\";\n\ntype TagEditModalProps = {\n  tag: Tag;\n  open: boolean;\n  onClose(): void;\n  onSuccess?(tag: Tag): Promise<void>;\n};\n\nexport function TagEditModal({\n  tag,\n  open,\n  onClose,\n  onSuccess,\n}: TagEditModalProps) {\n  const [update] = useUpdate<Tag>();\n\n  const handleEditTag = async (data: Pick<Tag, \"name\" | \"color\">) => {\n    await update(\n      \"tags\",\n      { id: tag.id, data, previousData: tag },\n      {\n        onSuccess: async (tag) => {\n          await onSuccess?.(tag);\n        },\n      },\n    );\n  };\n\n  return (\n    <TagDialog\n      open={open}\n      title=\"Edit tag\"\n      onClose={onClose}\n      onSubmit={handleEditTag}\n      tag={tag}\n    />\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/tags/TagDialog.tsx",
      "content": "import { SaveIcon } from \"lucide-react\";\nimport { useEffect, useState, type ChangeEvent, type FormEvent } from \"react\";\nimport { Button, buttonVariants } from \"@/components/ui/button\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { cn } from \"@/lib/utils\";\n\nimport type { Tag } from \"../types\";\nimport { colors } from \"./colors\";\nimport { RoundButton } from \"./RoundButton\";\n\ntype TagDialogProps = {\n  open: boolean;\n  tag?: Pick<Tag, \"name\" | \"color\">;\n  title: string;\n  onSubmit(tag: Pick<Tag, \"name\" | \"color\">): Promise<void>;\n  onClose(): void;\n};\n\nexport function TagDialog({\n  open,\n  tag,\n  title,\n  onClose,\n  onSubmit,\n}: TagDialogProps) {\n  const [newTagName, setNewTagName] = useState(\"\");\n  const [newTagColor, setNewTagColor] = useState(colors[0]);\n  const [disabled, setDisabled] = useState(false);\n\n  const handleNewTagNameChange = (event: ChangeEvent<HTMLInputElement>) => {\n    setNewTagName(event.target.value);\n  };\n\n  const handleClose = () => {\n    setDisabled(false);\n    onClose();\n  };\n\n  const handleSubmit = async (event: FormEvent<HTMLFormElement>) => {\n    event.preventDefault();\n\n    await onSubmit({ name: newTagName, color: newTagColor });\n\n    setDisabled(true);\n    setNewTagName(\"\");\n    setNewTagColor(colors[0]);\n\n    handleClose();\n  };\n\n  useEffect(() => {\n    setNewTagName(tag?.name ?? \"\");\n    setNewTagColor(tag?.color ?? colors[0]);\n  }, [tag]);\n\n  return (\n    <Dialog open={open} onOpenChange={handleClose}>\n      <DialogContent className=\"sm:max-w-lg\">\n        <form onSubmit={handleSubmit}>\n          <DialogHeader>\n            <DialogTitle>{title}</DialogTitle>\n          </DialogHeader>\n\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"tag-name\">Tag name</Label>\n              <Input\n                id=\"tag-name\"\n                autoFocus\n                value={newTagName}\n                onChange={handleNewTagNameChange}\n                placeholder=\"Enter tag name\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Color</Label>\n              <div className=\"flex flex-wrap\">\n                {colors.map((color) => (\n                  <RoundButton\n                    key={color}\n                    color={color}\n                    selected={color === newTagColor}\n                    handleClick={() => {\n                      setNewTagColor(color);\n                    }}\n                  />\n                ))}\n              </div>\n            </div>\n          </div>\n\n          <div className=\"flex justify-end pt-4\">\n            <Button\n              variant=\"outline\"\n              disabled={disabled}\n              className={cn(\n                buttonVariants({ variant: \"outline\" }),\n                \"text-primary\",\n                disabled ? \"opacity-50 cursor-not-allowed\" : \"cursor-pointer\",\n              )}\n            >\n              <SaveIcon />\n              Save\n            </Button>\n          </div>\n        </form>\n      </DialogContent>\n    </Dialog>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/tags/TagCreateModal.tsx",
      "content": "import { useCreate } from \"ra-core\";\n\nimport type { Tag } from \"../types\";\nimport { TagDialog } from \"./TagDialog\";\n\ntype TagCreateModalProps = {\n  open: boolean;\n  onClose(): void;\n  onSuccess?(tag: Tag): Promise<void>;\n};\n\nexport function TagCreateModal({\n  open,\n  onClose,\n  onSuccess,\n}: TagCreateModalProps) {\n  const [create] = useCreate<Tag>();\n\n  const handleCreateTag = async (data: Pick<Tag, \"name\" | \"color\">) => {\n    await create(\n      \"tags\",\n      { data },\n      {\n        onSuccess: async (tag) => {\n          await onSuccess?.(tag);\n        },\n      },\n    );\n  };\n\n  return (\n    <TagDialog\n      open={open}\n      title=\"Create a new tag\"\n      onClose={onClose}\n      onSubmit={handleCreateTag}\n    />\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/tags/TagChip.tsx",
      "content": "import { X } from \"lucide-react\";\nimport { useState } from \"react\";\n\nimport type { Tag } from \"../types\";\nimport { TagEditModal } from \"./TagEditModal\";\n\ntype TagChipProps = {\n  tag: Tag;\n\n  onUnlink: () => Promise<void>;\n};\n\nexport function TagChip({ tag, onUnlink }: TagChipProps) {\n  const [open, setOpen] = useState(false);\n\n  const handleClose = () => {\n    setOpen(false);\n  };\n\n  const handleClick = () => {\n    setOpen(true);\n  };\n\n  return (\n    <>\n      <div\n        className=\"text-black inline-flex items-center gap-1 px-2 py-1 text-xs rounded-md cursor-pointer hover:opacity-80 transition-opacity\"\n        style={{ backgroundColor: tag.color }}\n        onClick={handleClick}\n      >\n        {tag.name}\n        <button\n          onClick={(e) => {\n            e.stopPropagation();\n            onUnlink();\n          }}\n          className=\"transition-colors p-0 ml-1 cursor-pointer\"\n        >\n          <X className=\"w-3 h-3\" />\n        </button>\n      </div>\n      <TagEditModal tag={tag} open={open} onClose={handleClose} />\n    </>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/tags/RoundButton.tsx",
      "content": "export const RoundButton = ({ color, handleClick, selected }: any) => (\n  <button\n    type=\"button\"\n    className={`w-8 h-8 rounded-full inline-block m-1 transition-all ${\n      selected ? \"ring-2 ring-gray-500 ring-offset-1\" : \"\"\n    }`}\n    style={{ backgroundColor: color }}\n    onClick={handleClick}\n  />\n);\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/simple-list/SimpleListLoading.tsx",
      "content": "import { useTimeout } from \"ra-core\";\nimport type { ReactNode } from \"react\";\n\nimport { ListPlaceholder } from \"./ListPlaceholder.tsx\";\n\nexport const SimpleListLoading = (props: SimpleListLoadingProps) => {\n  const {\n    className,\n    hasLeftAvatarOrIcon,\n    hasRightAvatarOrIcon,\n    hasSecondaryText,\n    hasTertiaryText,\n    nbFakeLines = 5,\n    ...rest\n  } = props;\n\n  const oneSecondHasPassed = useTimeout(1000);\n\n  return oneSecondHasPassed ? (\n    <ul className={className} {...rest}>\n      {times(nbFakeLines, (key) => (\n        <li key={key} className=\"flex items-center space-x-3 p-3\">\n          {hasLeftAvatarOrIcon && (\n            <div className=\"w-10 h-10 bg-gray-300 rounded-full flex-shrink-0\">\n              &nbsp;\n            </div>\n          )}\n          <div className=\"flex-1 min-w-0\">\n            <div className=\"mb-1\">\n              <ListPlaceholder className=\"w-1/3 inline-block mb-1\" />\n              {hasTertiaryText && (\n                <span className=\"float-right opacity-55 min-w-[10vw]\">\n                  <ListPlaceholder />\n                </span>\n              )}\n            </div>\n            {hasSecondaryText && <ListPlaceholder className=\"w-1/4\" />}\n          </div>\n          {hasRightAvatarOrIcon && (\n            <div className=\"w-10 h-10 bg-gray-300 rounded-full flex-shrink-0\">\n              &nbsp;\n            </div>\n          )}\n        </li>\n      ))}\n    </ul>\n  ) : null;\n};\n\nconst times = (nbChildren: number, fn: (key: number) => ReactNode) =>\n  Array.from({ length: nbChildren }, (_, key) => fn(key));\n\nexport interface SimpleListLoadingProps {\n  className?: string;\n  hasLeftAvatarOrIcon?: boolean;\n  hasRightAvatarOrIcon?: boolean;\n  hasSecondaryText?: boolean;\n  hasTertiaryText?: boolean;\n  nbFakeLines?: number;\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/simple-list/SimpleListItem.tsx",
      "content": "import {\n  useEvent,\n  useGetPathForRecord,\n  useGetPathForRecordCallback,\n  useRecordContext,\n  useResourceContext,\n  type Identifier,\n  type LinkToType,\n  type RaRecord,\n} from \"ra-core\";\nimport type { CSSProperties, ReactElement, ReactNode } from \"react\";\nimport { Link, useNavigate } from \"react-router\";\n\nexport const SimpleListItem = <RecordType extends RaRecord = any>(\n  props: SimpleListItemProps<RecordType>,\n) => {\n  const { children, linkType, rowClick, style } = props;\n  const resource = useResourceContext(props);\n  const record = useRecordContext<RecordType>(props);\n  const navigate = useNavigate();\n  // If we don't have a function to get the path, we can compute the path immediately and set the href\n  // on the Link correctly without onClick (better for accessibility)\n  const isFunctionLink =\n    typeof linkType === \"function\" || typeof rowClick === \"function\";\n  const pathForRecord = useGetPathForRecord({\n    link: isFunctionLink ? false : (linkType ?? rowClick),\n    resource,\n  });\n  const getPathForRecord = useGetPathForRecordCallback();\n  const handleClick = useEvent(async () => {\n    // No need to handle non function linkType or rowClick\n    if (!isFunctionLink) return;\n    if (!record) return;\n\n    const link: LinkToType =\n      typeof linkType === \"function\"\n        ? linkType(record, record.id)\n        : typeof rowClick === \"function\"\n          ? (record, resource) => rowClick(record.id, resource, record)\n          : false;\n\n    const path = await getPathForRecord({\n      record,\n      resource,\n      link,\n    });\n    if (path === false || path == null) {\n      return;\n    }\n    navigate(path);\n  });\n\n  if (!record) return null;\n\n  if (isFunctionLink) {\n    return (\n      <li className=\"w-full\">\n        <button\n          onClick={handleClick}\n          style={style}\n          className=\"w-full text-left hover:bg-muted focus: bg-muted focus:outline-none\"\n        >\n          {children}\n        </button>\n      </li>\n    );\n  }\n\n  if (pathForRecord) {\n    return (\n      <li className=\"w-full\">\n        <Link\n          to={pathForRecord}\n          style={style}\n          className=\"block w-full hover:bg-muted focus:bg-muted focus:outline-none\"\n        >\n          {children}\n        </Link>\n      </li>\n    );\n  }\n\n  return <li className=\"w-full\">{children}</li>;\n};\n\nexport type FunctionToElement<RecordType extends RaRecord = any> = (\n  record: RecordType,\n  id: Identifier,\n) => ReactNode;\n\nexport type FunctionLinkType = (record: RaRecord, id: Identifier) => string;\n\nexport interface SimpleListBaseProps<RecordType extends RaRecord = any> {\n  leftAvatar?: FunctionToElement<RecordType>;\n  leftIcon?: FunctionToElement<RecordType>;\n  primaryText?: FunctionToElement<RecordType> | ReactElement | string;\n  /**\n   * @deprecated use rowClick instead\n   */\n  linkType?: string | FunctionLinkType | false;\n\n  /**\n   * The action to trigger when the user clicks on a row.\n   *\n   * @see https://marmelab.com/shadcn-admin-kit/docs/datatable/\n   * @example\n   * import { List, DataTable } from 'shadcn-admin-kit';\n   *\n   * export const PostList = () => (\n   *     <List>\n   *         <DataTable rowClick=\"edit\">\n   *             ...\n   *         </DataTable>                    </ListItem>\n\n   *     </List>\n   * );\n   */\n  rowClick?: string | RowClickFunction | false;\n  rightAvatar?: FunctionToElement<RecordType>;\n  rightIcon?: FunctionToElement<RecordType>;\n  secondaryText?: FunctionToElement<RecordType> | ReactElement | string;\n  tertiaryText?: FunctionToElement<RecordType> | ReactElement | string;\n}\n\nexport interface SimpleListItemProps<RecordType extends RaRecord = any>\n  extends SimpleListBaseProps<RecordType> {\n  rowIndex: number;\n  className?: string;\n  style?: CSSProperties;\n  children?: ReactNode;\n  resource?: string;\n}\n\nexport type RowClickFunction<RecordType extends RaRecord = RaRecord> = (\n  id: Identifier,\n  resource: string,\n  record: RecordType,\n) => string | false | Promise<string | false>;\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/simple-list/SimpleList.tsx",
      "content": "import {\n  ListIterator,\n  type RaRecord,\n  sanitizeListRestProps,\n  useGetRecordRepresentation,\n  useListContextWithProps,\n  useRecordContext,\n  useResourceContext,\n  useTranslate,\n} from \"ra-core\";\nimport { isValidElement, type ReactElement } from \"react\";\n\nimport { ListNoResults } from \"./ListNoResults.tsx\";\nimport type { FunctionToElement } from \"./SimpleListItem.tsx\";\nimport {\n  type SimpleListBaseProps,\n  SimpleListItem,\n  type SimpleListItemProps,\n} from \"./SimpleListItem.tsx\";\nimport { SimpleListLoading } from \"./SimpleListLoading.tsx\";\n\n/**\n * The <SimpleList> component renders a list of records\n * It is usually used as a child of shadcn-admin-kit's <List> and <ReferenceManyField> components.\n *\n * Also widely used on Mobile.\n *\n * Props:\n * - primaryText: function returning a React element (or some text) based on the record\n * - secondaryText: same\n * - tertiaryText: same\n * - leftAvatar: function returning a React element based on the record\n * - leftIcon: same\n * - rightAvatar: same\n * - rightIcon: same\n * - linkType: deprecated - 'edit' or 'show', or a function returning 'edit' or 'show' based on the record\n * - rowClick: The action to trigger when the user clicks on a row.\n * - rowStyle: function returning a style object based on (record, index)\n * - rowSx: function returning a sx object based on (record, index)\n *\n * @example // Display all posts as a List\n * const postRowSx = (record, index) => ({\n *     backgroundColor: record.views >= 500 ? '#efe' : 'white',\n * });\n * export const PostList = () => (\n *     <List>\n *         <SimpleList\n *             primaryText={record => record.title}\n *             secondaryText={record => `${record.views} views`}\n *             tertiaryText={record =>\n *                 new Date(record.published_at).toLocaleDateString()\n *             }\n *             rowSx={postRowSx}\n *          />\n *     </List>\n * );\n */\nexport const SimpleList = <RecordType extends RaRecord = any>(\n  props: SimpleListProps<RecordType>,\n) => {\n  const {\n    className,\n    empty = DefaultEmpty,\n    leftAvatar,\n    leftIcon,\n    linkType,\n    rowClick,\n    primaryText,\n    rightAvatar,\n    rightIcon,\n    secondaryText,\n    tertiaryText,\n    resource,\n    ...rest\n  } = props;\n  const { data, isPending, total } = useListContextWithProps<RecordType>(props);\n\n  if (isPending === true) {\n    return (\n      <SimpleListLoading\n        className={className}\n        hasLeftAvatarOrIcon={!!leftIcon || !!leftAvatar}\n        hasRightAvatarOrIcon={!!rightIcon || !!rightAvatar}\n        hasSecondaryText={!!secondaryText}\n        hasTertiaryText={!!tertiaryText}\n      />\n    );\n  }\n\n  if (data == null || data.length === 0 || total === 0) {\n    if (empty) {\n      return empty;\n    }\n\n    return null;\n  }\n\n  return (\n    <ul className={className} {...sanitizeListRestProps(rest)}>\n      <ListIterator<RecordType>\n        data={data}\n        total={total}\n        render={(record, rowIndex) => (\n          <SimpleListItem\n            key={record.id}\n            rowIndex={rowIndex}\n            linkType={linkType}\n            rowClick={rowClick}\n            resource={resource}\n          >\n            <SimpleListItemContent\n              leftAvatar={leftAvatar}\n              leftIcon={leftIcon}\n              primaryText={primaryText}\n              rightAvatar={rightAvatar}\n              rightIcon={rightIcon}\n              secondaryText={secondaryText}\n              tertiaryText={tertiaryText}\n              rowIndex={rowIndex}\n            />\n          </SimpleListItem>\n        )}\n      />\n    </ul>\n  );\n};\n\nexport interface SimpleListProps<RecordType extends RaRecord = any>\n  extends SimpleListBaseProps<RecordType> {\n  className?: string;\n  empty?: ReactElement;\n  // can be injected when using the component without context\n  resource?: string;\n  data?: RecordType[];\n  isLoading?: boolean;\n  isPending?: boolean;\n  isLoaded?: boolean;\n  total?: number;\n}\n\nconst SimpleListItemContent = <RecordType extends RaRecord = any>(\n  props: SimpleListItemProps<RecordType>,\n) => {\n  const {\n    leftAvatar,\n    leftIcon,\n    primaryText,\n    rightAvatar,\n    rightIcon,\n    secondaryText,\n    tertiaryText,\n  } = props;\n  const resource = useResourceContext(props);\n  const record = useRecordContext<RecordType>(props);\n  const getRecordRepresentation = useGetRecordRepresentation(resource);\n  const translate = useTranslate();\n\n  const renderAvatar = (\n    record: RecordType,\n    avatarCallback: FunctionToElement<RecordType>,\n  ) => {\n    const avatarValue = avatarCallback(record, record.id);\n    if (\n      typeof avatarValue === \"string\" &&\n      (avatarValue.startsWith(\"http\") || avatarValue.startsWith(\"data:\"))\n    ) {\n      return (\n        <img\n          src={avatarValue}\n          alt=\"\"\n          className=\"w-10 h-10 rounded-full object-cover\"\n        />\n      );\n    } else {\n      return (\n        <div className=\"w-10 h-10 rounded-full flex items-center justify-center text-sm\">\n          {avatarValue}\n        </div>\n      );\n    }\n  };\n\n  if (!record) return null;\n\n  return (\n    <div className=\"flex items-center space-x-3 p-3\">\n      {leftIcon && (\n        <div className=\"flex-shrink-0\">{leftIcon(record, record.id)}</div>\n      )}\n      {leftAvatar && (\n        <div className=\"flex-shrink-0\">{renderAvatar(record, leftAvatar)}</div>\n      )}\n      <div className=\"flex-1 min-w-0\">\n        <div className=\"flex items-center justify-between\">\n          <div className=\"text-sm font-medium truncate\">\n            {primaryText\n              ? typeof primaryText === \"string\"\n                ? translate(primaryText, {\n                    ...record,\n                    _: primaryText,\n                  })\n                : isValidElement(primaryText)\n                  ? primaryText\n                  : primaryText(record, record.id)\n              : getRecordRepresentation(record)}\n          </div>\n\n          {!!tertiaryText && (\n            <div className=\"text-xs text-muted-foreground ml-2\">\n              {typeof tertiaryText === \"string\"\n                ? translate(tertiaryText, {\n                    ...record,\n                    _: tertiaryText,\n                  })\n                : isValidElement(tertiaryText)\n                  ? tertiaryText\n                  : tertiaryText(record, record.id)}\n            </div>\n          )}\n        </div>\n\n        {!!secondaryText && (\n          <div className=\"text-sm text-muted-foreground truncate\">\n            {typeof secondaryText === \"string\"\n              ? translate(secondaryText, {\n                  ...record,\n                  _: secondaryText,\n                })\n              : isValidElement(secondaryText)\n                ? secondaryText\n                : secondaryText(record, record.id)}\n          </div>\n        )}\n      </div>\n      {(rightAvatar || rightIcon) && (\n        <div className=\"flex-shrink-0 flex items-center space-x-2\">\n          {rightAvatar && renderAvatar(record, rightAvatar)}\n          {rightIcon && rightIcon(record, record.id)}\n        </div>\n      )}\n    </div>\n  );\n};\n\nconst DefaultEmpty = <ListNoResults />;\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/simple-list/ListPlaceholder.tsx",
      "content": "import { cn } from \"@/lib/utils\";\n\ninterface ListPlaceholderProps {\n  className?: string;\n}\n\nexport const ListPlaceholder = ({ className }: ListPlaceholderProps) => {\n  return <span className={cn(\"bg-gray-300 flex\", className)}>&nbsp;</span>;\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/simple-list/ListNoResults.tsx",
      "content": "import {\n  useGetResourceLabel,\n  useListContextWithProps,\n  useResourceContext,\n  useTranslate,\n} from \"ra-core\";\nimport { Button } from \"@/components/ui/button\";\n\nexport const ListNoResults = (props: ListNoResultsProps) => {\n  const translate = useTranslate();\n  const resource = useResourceContext(props);\n  const { filterValues, setFilters } = useListContextWithProps(props);\n  const getResourceLabel = useGetResourceLabel();\n  if (!resource) {\n    throw new Error(\"<ListNoResults> must be used inside a <List> component\");\n  }\n  return (\n    <div className=\"p-6\">\n      <p className=\"text-sm text-muted-foreground\">\n        {filterValues && setFilters && Object.keys(filterValues).length > 0 ? (\n          <>\n            {translate(\"ra.navigation.no_filtered_results\", {\n              resource,\n              name: getResourceLabel(resource, 0),\n              _: \"No results found with the current filters.\",\n            })}{\" \"}\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={() => setFilters({}, [])}\n            >\n              {translate(\"ra.navigation.clear_filters\", {\n                _: \"Clear filters\",\n              })}\n            </Button>\n          </>\n        ) : (\n          translate(\"ra.navigation.no_results\", {\n            resource,\n            name: getResourceLabel(resource, 0),\n            _: \"No results found.\",\n          })\n        )}\n      </p>\n    </div>\n  );\n};\n\nexport interface ListNoResultsProps {\n  resource?: string;\n  filterValues?: any;\n  setFilters?: (filters: any, filterTypes?: string[]) => void;\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/setup/SupabaseSetupWizard.tsx",
      "content": "import { useState } from \"react\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Loader2, Database, CheckCircle, AlertCircle, ExternalLink, Check } from \"lucide-react\";\nimport {\n  saveSupabaseConfig,\n  validateSupabaseConnection,\n} from \"@/lib/supabase-config\";\n\ntype WizardStep = \"welcome\" | \"credentials\" | \"validating\" | \"success\";\n\ninterface SupabaseSetupWizardProps {\n  open: boolean;\n  onComplete: () => void;\n  canClose?: boolean;\n}\n\n/**\n * Normalizes Supabase URL input - accepts either full URL or just project ID\n */\nfunction normalizeSupabaseUrl(input: string): string {\n  const trimmed = input.trim();\n  if (!trimmed) return \"\";\n\n  // If it starts with http:// or https://, treat as full URL\n  if (trimmed.startsWith(\"http://\") || trimmed.startsWith(\"https://\")) {\n    return trimmed;\n  }\n\n  // Otherwise, treat as project ID and construct full URL\n  return `https://${trimmed}.supabase.co`;\n}\n\n/**\n * Validates if input looks like a valid Supabase URL or project ID\n */\nfunction validateUrlFormat(input: string): { valid: boolean; message?: string } {\n  const trimmed = input.trim();\n  if (!trimmed) return { valid: false };\n\n  // Check if it's a full URL\n  if (trimmed.startsWith(\"http://\") || trimmed.startsWith(\"https://\")) {\n    try {\n      const url = new URL(trimmed);\n      if (url.hostname.endsWith(\".supabase.co\")) {\n        return { valid: true, message: \"Valid Supabase URL\" };\n      }\n      return { valid: false, message: \"URL must be a Supabase domain\" };\n    } catch {\n      return { valid: false, message: \"Invalid URL format\" };\n    }\n  }\n\n  // Check if it's a project ID (alphanumeric, typically 20 chars)\n  if (/^[a-z0-9]+$/.test(trimmed)) {\n    return { valid: true, message: \"Valid project ID (will expand to full URL)\" };\n  }\n\n  return { valid: false, message: \"Enter full URL or project ID\" };\n}\n\n/**\n * Validates if input looks like a valid Supabase API key\n */\nfunction validateKeyFormat(input: string): { valid: boolean; message?: string } {\n  const trimmed = input.trim();\n  if (!trimmed) return { valid: false };\n\n  // New publishable keys start with \"sb_publishable_\" followed by key content\n  if (trimmed.startsWith(\"sb_publishable_\")) {\n    // Check that there's actual key content after the prefix (at least 20 chars)\n    if (trimmed.length > \"sb_publishable_\".length + 20) {\n      return { valid: true, message: \"Valid publishable key format\" };\n    }\n    return { valid: false, message: \"Publishable key seems incomplete\" };\n  }\n\n  // Legacy anon keys are JWT tokens starting with \"eyJ\"\n  if (trimmed.startsWith(\"eyJ\")) {\n    if (trimmed.length > 100) {\n      return { valid: true, message: \"Valid anon key format\" };\n    }\n    return { valid: false, message: \"Anon key seems incomplete\" };\n  }\n\n  return { valid: false, message: \"Must be a valid Supabase API key (anon or publishable)\" };\n}\n\nexport function SupabaseSetupWizard({\n  open,\n  onComplete,\n  canClose = false,\n}: SupabaseSetupWizardProps) {\n  const [step, setStep] = useState<WizardStep>(\"welcome\");\n  const [url, setUrl] = useState(\"\");\n  const [anonKey, setAnonKey] = useState(\"\");\n  const [error, setError] = useState<string | null>(null);\n  const [urlTouched, setUrlTouched] = useState(false);\n  const [keyTouched, setKeyTouched] = useState(false);\n\n  const handleValidateAndSave = async () => {\n    setError(null);\n    setStep(\"validating\");\n\n    // Normalize the URL before validation\n    const normalizedUrl = normalizeSupabaseUrl(url);\n    const trimmedKey = anonKey.trim();\n\n    const result = await validateSupabaseConnection(normalizedUrl, trimmedKey);\n\n    if (result.valid) {\n      saveSupabaseConfig({ url: normalizedUrl, anonKey: trimmedKey });\n      setStep(\"success\");\n\n      // Reload after short delay to apply new config\n      setTimeout(() => {\n        // Force reload to ensure new config is loaded\n        window.location.href = window.location.origin;\n      }, 1500);\n    } else {\n      setError(result.error || \"Connection failed\");\n      setStep(\"credentials\");\n    }\n  };\n\n  // Get validation states\n  const urlValidation = url ? validateUrlFormat(url) : { valid: false };\n  const keyValidation = anonKey ? validateKeyFormat(anonKey) : { valid: false };\n  const normalizedUrl = url ? normalizeSupabaseUrl(url) : \"\";\n  const showUrlExpansion = url && !url.startsWith(\"http\") && urlValidation.valid;\n\n  const handleClose = () => {\n    if (canClose) {\n      onComplete();\n    }\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={canClose ? handleClose : undefined}>\n      <DialogContent\n        className=\"sm:max-w-md\"\n        onPointerDownOutside={(e) => !canClose && e.preventDefault()}\n        onEscapeKeyDown={(e) => !canClose && e.preventDefault()}\n      >\n        {step === \"welcome\" && (\n          <>\n            <DialogHeader>\n              <div className=\"flex items-center gap-2 mb-2\">\n                <Database className=\"h-6 w-6 text-primary\" />\n                <DialogTitle>Welcome to CRM</DialogTitle>\n              </div>\n              <DialogDescription>\n                To get started, you'll need to connect to a Supabase database.\n              </DialogDescription>\n            </DialogHeader>\n\n            <div className=\"space-y-4 py-4\">\n              <Alert>\n                <AlertDescription>\n                  <strong>Don't have a Supabase project?</strong>\n                  <br />\n                  Create one for free at{\" \"}\n                  <a\n                    href=\"https://supabase.com\"\n                    target=\"_blank\"\n                    rel=\"noopener noreferrer\"\n                    className=\"underline text-primary inline-flex items-center gap-1\"\n                  >\n                    supabase.com\n                    <ExternalLink className=\"h-3 w-3\" />\n                  </a>\n                </AlertDescription>\n              </Alert>\n\n              <div className=\"space-y-2\">\n                <h4 className=\"font-medium text-sm\">What you'll need:</h4>\n                <ul className=\"list-disc list-inside text-sm text-muted-foreground space-y-1\">\n                  <li>Your Supabase project URL or project ID</li>\n                  <li>Your API key (anon or publishable key)</li>\n                </ul>\n              </div>\n\n              <div className=\"space-y-2\">\n                <a\n                  href=\"https://supabase.com/docs/guides/api#api-url-and-keys\"\n                  target=\"_blank\"\n                  rel=\"noopener noreferrer\"\n                  className=\"text-sm text-primary hover:underline inline-flex items-center gap-1\"\n                >\n                  Where do I find these?\n                  <ExternalLink className=\"h-3 w-3\" />\n                </a>\n              </div>\n\n              <Button onClick={() => setStep(\"credentials\")} className=\"w-full\">\n                Continue\n              </Button>\n            </div>\n          </>\n        )}\n\n        {step === \"credentials\" && (\n          <>\n            <DialogHeader>\n              <DialogTitle>Connect to Supabase</DialogTitle>\n              <DialogDescription>\n                Enter your Supabase project credentials\n              </DialogDescription>\n            </DialogHeader>\n\n            <div className=\"space-y-4 py-4\">\n              {error && (\n                <Alert variant=\"destructive\">\n                  <AlertCircle className=\"h-4 w-4\" />\n                  <AlertDescription>{error}</AlertDescription>\n                </Alert>\n              )}\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"supabase-url\">Project URL or ID</Label>\n                <div className=\"relative\">\n                  <Input\n                    id=\"supabase-url\"\n                    placeholder=\"xxxxx or https://xxxxx.supabase.co\"\n                    value={url}\n                    onChange={(e) => {\n                      setUrl(e.target.value);\n                      setUrlTouched(true);\n                    }}\n                    onBlur={() => setUrlTouched(true)}\n                    className={\n                      urlTouched && url\n                        ? urlValidation.valid\n                          ? \"pr-8 border-green-500\"\n                          : \"pr-8 border-destructive\"\n                        : \"\"\n                    }\n                  />\n                  {urlTouched && url && urlValidation.valid && (\n                    <Check className=\"absolute right-2 top-1/2 -translate-y-1/2 h-4 w-4 text-green-500\" />\n                  )}\n                </div>\n                {showUrlExpansion && (\n                  <div className=\"flex items-start gap-1.5 text-xs text-green-600 dark:text-green-400\">\n                    <Check className=\"h-3 w-3 mt-0.5 flex-shrink-0\" />\n                    <span>Will expand to: {normalizedUrl}</span>\n                  </div>\n                )}\n                {urlTouched && url && urlValidation.message && !urlValidation.valid && (\n                  <p className=\"text-xs text-destructive\">{urlValidation.message}</p>\n                )}\n                {(!urlTouched || !url) && (\n                  <p className=\"text-xs text-muted-foreground\">\n                    Enter full URL or just the project ID (from Project Settings  API)\n                  </p>\n                )}\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"anon-key\">API Key</Label>\n                <div className=\"relative\">\n                  <Input\n                    id=\"anon-key\"\n                    type=\"password\"\n                    placeholder=\"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\"\n                    value={anonKey}\n                    onChange={(e) => {\n                      setAnonKey(e.target.value);\n                      setKeyTouched(true);\n                    }}\n                    onBlur={() => setKeyTouched(true)}\n                    className={\n                      keyTouched && anonKey\n                        ? keyValidation.valid\n                          ? \"pr-8 border-green-500\"\n                          : \"pr-8 border-destructive\"\n                        : \"\"\n                    }\n                  />\n                  {keyTouched && anonKey && keyValidation.valid && (\n                    <Check className=\"absolute right-2 top-1/2 -translate-y-1/2 h-4 w-4 text-green-500\" />\n                  )}\n                </div>\n                {keyTouched && anonKey && keyValidation.message && (\n                  <p className={`text-xs ${keyValidation.valid ? \"text-green-600 dark:text-green-400\" : \"text-destructive\"}`}>\n                    {keyValidation.message}\n                  </p>\n                )}\n                {(!keyTouched || !anonKey) && (\n                  <p className=\"text-xs text-muted-foreground\">\n                    Anon or publishable key (from Project Settings  API)\n                  </p>\n                )}\n              </div>\n\n              <div className=\"flex gap-2\">\n                <Button\n                  variant=\"outline\"\n                  onClick={() => setStep(\"welcome\")}\n                  className=\"flex-1\"\n                >\n                  Back\n                </Button>\n                <Button\n                  onClick={handleValidateAndSave}\n                  disabled={!urlValidation.valid || !keyValidation.valid}\n                  className=\"flex-1\"\n                >\n                  Connect\n                </Button>\n              </div>\n            </div>\n          </>\n        )}\n\n        {step === \"validating\" && (\n          <>\n            <DialogHeader>\n              <DialogTitle>Validating Connection</DialogTitle>\n              <DialogDescription>\n                Testing your Supabase credentials...\n              </DialogDescription>\n            </DialogHeader>\n\n            <div className=\"flex flex-col items-center justify-center py-8\">\n              <Loader2 className=\"h-12 w-12 animate-spin text-primary mb-4\" />\n              <p className=\"text-sm text-muted-foreground\">Please wait...</p>\n            </div>\n          </>\n        )}\n\n        {step === \"success\" && (\n          <>\n            <DialogHeader>\n              <DialogTitle>Connection Successful!</DialogTitle>\n              <DialogDescription>\n                Your Supabase database is now connected\n              </DialogDescription>\n            </DialogHeader>\n\n            <div className=\"flex flex-col items-center justify-center py-8\">\n              <CheckCircle className=\"h-12 w-12 text-green-500 mb-4\" />\n              <p className=\"text-sm text-muted-foreground\">\n                Reloading application...\n              </p>\n            </div>\n          </>\n        )}\n      </DialogContent>\n    </Dialog>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/setup/DatabaseSetupGuide.tsx",
      "content": "import {\n  Alert,\n  AlertDescription,\n  AlertTitle,\n} from \"@/components/ui/alert\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Card,\n  CardContent,\n  CardDescription,\n  CardHeader,\n  CardTitle,\n} from \"@/components/ui/card\";\nimport { AlertCircle, CheckCircle, Database, ExternalLink } from \"lucide-react\";\n\ninterface DatabaseSetupGuideProps {\n  missingTables: string[];\n  supabaseUrl: string;\n}\n\nexport function DatabaseSetupGuide({\n  missingTables,\n  supabaseUrl,\n}: DatabaseSetupGuideProps) {\n  const projectRef = supabaseUrl.match(/https:\\/\\/([^.]+)\\.supabase\\.co/)?.[1];\n\n  return (\n    <div className=\"max-w-2xl mx-auto mt-8 space-y-4\">\n      <Alert variant=\"destructive\">\n        <AlertCircle className=\"h-4 w-4\" />\n        <AlertTitle>Database Schema Not Configured</AlertTitle>\n        <AlertDescription>\n          Your Supabase database is connected, but the CRM schema hasn't been\n          set up yet.\n        </AlertDescription>\n      </Alert>\n\n      <Card>\n        <CardHeader>\n          <div className=\"flex items-center gap-2\">\n            <Database className=\"h-5 w-5\" />\n            <CardTitle>Setup Instructions</CardTitle>\n          </div>\n          <CardDescription>\n            Follow these steps to set up your database schema\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-6\">\n          {/* Missing Tables */}\n          <div>\n            <h3 className=\"font-semibold mb-2\">Missing Tables:</h3>\n            <div className=\"flex flex-wrap gap-2\">\n              {missingTables.map((table) => (\n                <span\n                  key={table}\n                  className=\"px-2 py-1 bg-destructive/10 text-destructive text-sm rounded\"\n                >\n                  {table}\n                </span>\n              ))}\n            </div>\n          </div>\n\n          {/* Option 1: Supabase CLI */}\n          <div className=\"space-y-3\">\n            <div className=\"flex items-center gap-2\">\n              <div className=\"flex items-center justify-center w-6 h-6 rounded-full bg-primary text-primary-foreground text-sm font-bold\">\n                1\n              </div>\n              <h3 className=\"font-semibold\">Using Supabase CLI (Recommended)</h3>\n            </div>\n            <div className=\"ml-8 space-y-3\">\n              <div>\n                <p className=\"text-sm text-muted-foreground mb-2\">\n                  Install Supabase CLI:\n                </p>\n                <pre className=\"bg-muted p-3 rounded text-sm overflow-x-auto\">\n                  npm install -g supabase\n                </pre>\n              </div>\n\n              <div>\n                <p className=\"text-sm text-muted-foreground mb-2\">\n                  Clone the RealTimeX CRM repository to get migrations:\n                </p>\n                <pre className=\"bg-muted p-3 rounded text-sm overflow-x-auto\">\n                  git clone https://github.com/therealtimex/realtimex-crm.git\n                  {\"\\n\"}cd realtimex-crm\n                </pre>\n              </div>\n\n              <div>\n                <p className=\"text-sm text-muted-foreground mb-2\">\n                  Link to your Supabase project:\n                </p>\n                <pre className=\"bg-muted p-3 rounded text-sm overflow-x-auto\">\n                  supabase link --project-ref {projectRef || \"YOUR_PROJECT_REF\"}\n                </pre>\n              </div>\n\n              <div>\n                <p className=\"text-sm text-muted-foreground mb-2\">\n                  Push the migrations:\n                </p>\n                <pre className=\"bg-muted p-3 rounded text-sm overflow-x-auto\">\n                  supabase db push\n                </pre>\n              </div>\n\n              <div>\n                <p className=\"text-sm text-muted-foreground mb-2\">\n                  Reload this page after migrations are complete.\n                </p>\n              </div>\n            </div>\n          </div>\n\n          {/* Option 2: SQL Editor */}\n          <div className=\"space-y-3\">\n            <div className=\"flex items-center gap-2\">\n              <div className=\"flex items-center justify-center w-6 h-6 rounded-full bg-primary text-primary-foreground text-sm font-bold\">\n                2\n              </div>\n              <h3 className=\"font-semibold\">Using Supabase SQL Editor</h3>\n            </div>\n            <div className=\"ml-8 space-y-3\">\n              <p className=\"text-sm text-muted-foreground\">\n                Manually run the SQL migrations in your Supabase SQL Editor:\n              </p>\n\n              <ol className=\"list-decimal list-inside space-y-2 text-sm text-muted-foreground\">\n                <li>\n                  Download migrations from{\" \"}\n                  <a\n                    href=\"https://github.com/therealtimex/realtimex-crm/tree/main/supabase/migrations\"\n                    target=\"_blank\"\n                    rel=\"noopener noreferrer\"\n                    className=\"text-primary hover:underline inline-flex items-center gap-1\"\n                  >\n                    GitHub\n                    <ExternalLink className=\"h-3 w-3\" />\n                  </a>\n                </li>\n                <li>\n                  Open your{\" \"}\n                  <a\n                    href={`https://supabase.com/dashboard/project/${projectRef}/sql/new`}\n                    target=\"_blank\"\n                    rel=\"noopener noreferrer\"\n                    className=\"text-primary hover:underline inline-flex items-center gap-1\"\n                  >\n                    Supabase SQL Editor\n                    <ExternalLink className=\"h-3 w-3\" />\n                  </a>\n                </li>\n                <li>\n                  Run each migration file in order (by date in filename)\n                </li>\n                <li>\n                  Reload this page after all migrations are complete\n                </li>\n              </ol>\n\n              {projectRef && (\n                <Button asChild variant=\"outline\" className=\"w-full\">\n                  <a\n                    href={`https://supabase.com/dashboard/project/${projectRef}/sql/new`}\n                    target=\"_blank\"\n                    rel=\"noopener noreferrer\"\n                  >\n                    <ExternalLink className=\"h-4 w-4 mr-2\" />\n                    Open SQL Editor\n                  </a>\n                </Button>\n              )}\n            </div>\n          </div>\n\n          {/* Verification */}\n          <div className=\"space-y-3 pt-4 border-t\">\n            <h3 className=\"font-semibold\">After Setup</h3>\n            <div className=\"space-y-2 text-sm text-muted-foreground\">\n              <div className=\"flex items-start gap-2\">\n                <CheckCircle className=\"h-4 w-4 mt-0.5 text-green-500\" />\n                <span>\n                  All tables will be created with proper schemas and\n                  relationships\n                </span>\n              </div>\n              <div className=\"flex items-start gap-2\">\n                <CheckCircle className=\"h-4 w-4 mt-0.5 text-green-500\" />\n                <span>Row Level Security (RLS) policies will be configured</span>\n              </div>\n              <div className=\"flex items-start gap-2\">\n                <CheckCircle className=\"h-4 w-4 mt-0.5 text-green-500\" />\n                <span>Database triggers and functions will be set up</span>\n              </div>\n            </div>\n\n            <Button\n              onClick={() => window.location.reload()}\n              className=\"w-full mt-4\"\n            >\n              Reload Page\n            </Button>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Additional Resources */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"text-base\">Need Help?</CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-2 text-sm\">\n          <a\n            href=\"https://github.com/therealtimex/realtimex-crm#installation\"\n            target=\"_blank\"\n            rel=\"noopener noreferrer\"\n            className=\"flex items-center gap-2 text-primary hover:underline\"\n          >\n            <ExternalLink className=\"h-4 w-4\" />\n            View Full Setup Guide\n          </a>\n          <a\n            href=\"https://github.com/therealtimex/realtimex-crm/issues\"\n            target=\"_blank\"\n            rel=\"noopener noreferrer\"\n            className=\"flex items-center gap-2 text-primary hover:underline\"\n          >\n            <ExternalLink className=\"h-4 w-4\" />\n            Report an Issue\n          </a>\n          <a\n            href=\"https://supabase.com/docs/guides/cli\"\n            target=\"_blank\"\n            rel=\"noopener noreferrer\"\n            className=\"flex items-center gap-2 text-primary hover:underline\"\n          >\n            <ExternalLink className=\"h-4 w-4\" />\n            Supabase CLI Documentation\n          </a>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/settings/SettingsPage.tsx",
      "content": "import { useMutation } from \"@tanstack/react-query\";\nimport { CircleX, Copy, Pencil, Save } from \"lucide-react\";\nimport {\n  Form,\n  useDataProvider,\n  useGetIdentity,\n  useGetOne,\n  useNotify,\n  useRecordContext,\n} from \"ra-core\";\nimport { useState } from \"react\";\nimport { useFormState } from \"react-hook-form\";\nimport { useNavigate } from \"react-router\";\nimport { RecordField } from \"@/components/admin/record-field\";\nimport { TextInput } from \"@/components/admin/text-input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\n\nimport ImageEditorField from \"../misc/ImageEditorField\";\nimport type { CrmDataProvider } from \"../providers/types\";\nimport type { Sale, SalesFormData } from \"../types\";\n\nexport const SettingsPage = () => {\n  const [isEditMode, setEditMode] = useState(false);\n  const { identity, refetch: refetchIdentity } = useGetIdentity();\n  const { data, refetch: refetchUser } = useGetOne(\"sales\", {\n    id: identity?.id,\n  });\n  const notify = useNotify();\n  const dataProvider = useDataProvider<CrmDataProvider>();\n\n  const { mutate } = useMutation({\n    mutationKey: [\"signup\"],\n    mutationFn: async (data: SalesFormData) => {\n      if (!identity) {\n        throw new Error(\"Record not found\");\n      }\n      return dataProvider.salesUpdate(identity.id, data);\n    },\n    onSuccess: () => {\n      refetchIdentity();\n      refetchUser();\n      setEditMode(false);\n      notify(\"Your profile has been updated\");\n    },\n    onError: (_) => {\n      notify(\"An error occurred. Please try again\", {\n        type: \"error\",\n      });\n    },\n  });\n\n  if (!identity) return null;\n\n  const handleOnSubmit = async (values: any) => {\n    mutate(values);\n  };\n\n  return (\n    <div className=\"max-w-lg mx-auto mt-8\">\n      <Form onSubmit={handleOnSubmit} record={data}>\n        <SettingsForm isEditMode={isEditMode} setEditMode={setEditMode} />\n      </Form>\n    </div>\n  );\n};\n\nconst SettingsForm = ({\n  isEditMode,\n  setEditMode,\n}: {\n  isEditMode: boolean;\n  setEditMode: (value: boolean) => void;\n}) => {\n  const notify = useNotify();\n  const navigate = useNavigate();\n  const record = useRecordContext<Sale>();\n  const { identity, refetch } = useGetIdentity();\n  const { isDirty } = useFormState();\n  const dataProvider = useDataProvider<CrmDataProvider>();\n\n  // Removed old updatePassword mutation - now uses OTP flow\n  // Users will be redirected to forgot-password page which sends OTP\n\n  const { mutate: mutateSale } = useMutation({\n    mutationKey: [\"signup\"],\n    mutationFn: async (data: SalesFormData) => {\n      if (!record) {\n        throw new Error(\"Record not found\");\n      }\n      return dataProvider.salesUpdate(record.id, data);\n    },\n    onSuccess: () => {\n      refetch();\n      notify(\"Your profile has been updated\");\n    },\n    onError: () => {\n      notify(\"An error occurred. Please try again.\");\n    },\n  });\n  if (!identity) return null;\n\n      const handleClickOpenPasswordChange = () => {\n        // Navigate directly to the change password page for authenticated users\n        navigate('/change-password');\n      };\n  const handleAvatarUpdate = async (values: any) => {\n    mutateSale(values);\n  };\n\n  return (\n    <div className=\"space-y-4\">\n      <Card>\n        <CardContent>\n          <div className=\"mb-4 flex flex-row justify-between\">\n            <h2 className=\"text-xl font-semibold text-muted-foreground\">\n              My info\n            </h2>\n          </div>\n\n          <div className=\"space-y-4 mb-4\">\n            <ImageEditorField\n              source=\"avatar\"\n              type=\"avatar\"\n              onSave={handleAvatarUpdate}\n              linkPosition=\"right\"\n            />\n            <TextRender source=\"first_name\" isEditMode={isEditMode} />\n            <TextRender source=\"last_name\" isEditMode={isEditMode} />\n            <TextRender source=\"email\" isEditMode={isEditMode} />\n          </div>\n\n          <div className=\"flex flex-row justify-end gap-2\">\n            {!isEditMode && (\n              <>\n                <Button\n                  variant=\"outline\"\n                  type=\"button\"\n                  onClick={handleClickOpenPasswordChange}\n                >\n                  Change password\n                </Button>\n              </>\n            )}\n\n            <Button\n              type=\"button\"\n              variant={isEditMode ? \"ghost\" : \"outline\"}\n              onClick={() => setEditMode(!isEditMode)}\n              className=\"flex items-center\"\n            >\n              {isEditMode ? <CircleX /> : <Pencil />}\n              {isEditMode ? \"Cancel\" : \"Edit\"}\n            </Button>\n\n            {isEditMode && (\n              <Button type=\"submit\" disabled={!isDirty} variant=\"outline\">\n                <Save />\n                Save\n              </Button>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n      {import.meta.env.VITE_INBOUND_EMAIL && (\n        <Card>\n          <CardContent>\n            <div className=\"space-y-4 justify-between\">\n              <h2 className=\"text-xl font-semibold text-muted-foreground\">\n                Inbound email\n              </h2>\n              <p className=\"text-sm text-muted-foreground\">\n                You can start sending emails to your server's inbound email\n                address, e.g. by adding it to the\n                <b> Cc: </b> field. Atomic CRM will process the emails and add\n                notes to the corresponding contacts.\n              </p>\n              <CopyPaste />\n            </div>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n};\n\nconst TextRender = ({\n  source,\n  isEditMode,\n}: {\n  source: string;\n  isEditMode: boolean;\n}) => {\n  if (isEditMode) {\n    return <TextInput source={source} helperText={false} />;\n  }\n  return (\n    <div className=\"m-2\">\n      <RecordField source={source} />\n    </div>\n  );\n};\n\nconst CopyPaste = () => {\n  const [copied, setCopied] = useState(false);\n  const handleCopy = () => {\n    setCopied(true);\n    navigator.clipboard.writeText(import.meta.env.VITE_INBOUND_EMAIL);\n    setTimeout(() => {\n      setCopied(false);\n    }, 1500);\n  };\n  return (\n    <TooltipProvider>\n      <Tooltip>\n        <TooltipTrigger asChild>\n          <Button\n            type=\"button\"\n            onClick={handleCopy}\n            variant=\"ghost\"\n            className=\"normal-case justify-between w-full\"\n          >\n            <span className=\"overflow-hidden text-ellipsis\">\n              {import.meta.env.VITE_INBOUND_EMAIL}\n            </span>\n            <Copy className=\"h-4 w-4 ml-2\" />\n          </Button>\n        </TooltipTrigger>\n        <TooltipContent>\n          <p>{copied ? \"Copied!\" : \"Copy\"}</p>\n        </TooltipContent>\n      </Tooltip>\n    </TooltipProvider>\n  );\n};\n\nSettingsPage.path = \"/settings\";\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/settings/DatabaseSettings.tsx",
      "content": "import { useState } from \"react\";\nimport {\n  Card,\n  CardContent,\n  CardDescription,\n  CardHeader,\n  CardTitle,\n} from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Database, CheckCircle, XCircle, Settings, Trash2 } from \"lucide-react\";\nimport {\n  getSupabaseConfig,\n  clearSupabaseConfig,\n  getConfigSource,\n} from \"@/lib/supabase-config\";\nimport { SupabaseSetupWizard } from \"../setup/SupabaseSetupWizard\";\n\nexport function DatabaseSettings() {\n  const [showWizard, setShowWizard] = useState(false);\n  const config = getSupabaseConfig();\n  const source = getConfigSource();\n\n  const handleClearConfig = () => {\n    if (\n      confirm(\n        \"Are you sure you want to clear the database configuration? The app will need to be reconfigured on next launch.\",\n      )\n    ) {\n      clearSupabaseConfig();\n      window.location.reload();\n    }\n  };\n\n  return (\n    <>\n      <Card>\n        <CardHeader>\n          <div className=\"flex items-center gap-2\">\n            <Database className=\"h-5 w-5\" />\n            <CardTitle>Database Connection</CardTitle>\n          </div>\n          <CardDescription>\n            Manage your Supabase database connection settings\n          </CardDescription>\n        </CardHeader>\n\n        <CardContent className=\"space-y-4\">\n          {config ? (\n            <>\n              {/* Connection Status */}\n              <div className=\"flex items-start gap-3 p-4 border rounded-lg\">\n                <CheckCircle className=\"h-5 w-5 text-green-500 mt-0.5\" />\n                <div className=\"flex-1 space-y-1\">\n                  <p className=\"font-medium\">Connected</p>\n                  <p className=\"text-sm text-muted-foreground\">{config.url}</p>\n                  {config.configuredAt && (\n                    <p className=\"text-xs text-muted-foreground\">\n                      Configured on{\" \"}\n                      {new Date(config.configuredAt).toLocaleDateString()}\n                    </p>\n                  )}\n                </div>\n              </div>\n\n              {/* Configuration Source Info */}\n              {source === \"env\" && (\n                <Alert>\n                  <Settings className=\"h-4 w-4\" />\n                  <AlertDescription>\n                    Using configuration from environment variables. You can\n                    override this by setting up a new connection via the UI.\n                  </AlertDescription>\n                </Alert>\n              )}\n\n              {/* Actions */}\n              <div className=\"flex gap-2\">\n                <Button\n                  variant=\"outline\"\n                  onClick={() => setShowWizard(true)}\n                  className=\"flex-1\"\n                >\n                  <Settings className=\"h-4 w-4 mr-2\" />\n                  Change Connection\n                </Button>\n                {source === \"ui\" && (\n                  <Button\n                    variant=\"destructive\"\n                    onClick={handleClearConfig}\n                    className=\"flex-1\"\n                  >\n                    <Trash2 className=\"h-4 w-4 mr-2\" />\n                    Clear Configuration\n                  </Button>\n                )}\n              </div>\n\n              {/* Anon Key Display (masked) */}\n              <div className=\"space-y-2\">\n                <Label className=\"text-sm font-medium\">Anonymous Key</Label>\n                <div className=\"font-mono text-sm p-2 bg-muted rounded\">\n                  {config.anonKey.substring(0, 20)}...\n                  {config.anonKey.substring(config.anonKey.length - 10)}\n                </div>\n              </div>\n            </>\n          ) : (\n            <>\n              <div className=\"flex items-start gap-3 p-4 border border-dashed rounded-lg\">\n                <XCircle className=\"h-5 w-5 text-destructive mt-0.5\" />\n                <div className=\"flex-1 space-y-1\">\n                  <p className=\"font-medium\">Not Connected</p>\n                  <p className=\"text-sm text-muted-foreground\">\n                    No Supabase database is configured\n                  </p>\n                </div>\n              </div>\n\n              <Alert>\n                <AlertDescription>\n                  Connect to a Supabase database to start using Atomic CRM. You\n                  can create a free project at{\" \"}\n                  <a\n                    href=\"https://supabase.com\"\n                    target=\"_blank\"\n                    rel=\"noopener noreferrer\"\n                    className=\"underline\"\n                  >\n                    supabase.com\n                  </a>\n                </AlertDescription>\n              </Alert>\n\n              <Button onClick={() => setShowWizard(true)} className=\"w-full\">\n                <Database className=\"h-4 w-4 mr-2\" />\n                Connect to Supabase\n              </Button>\n            </>\n          )}\n        </CardContent>\n      </Card>\n\n      <SupabaseSetupWizard\n        open={showWizard}\n        onComplete={() => setShowWizard(false)}\n        canClose={true}\n      />\n    </>\n  );\n}\n\nfunction Label({\n  children,\n  className,\n}: {\n  children: React.ReactNode;\n  className?: string;\n}) {\n  return <label className={className}>{children}</label>;\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/settings/DatabasePage.tsx",
      "content": "import { DatabaseSettings } from \"./DatabaseSettings\";\n\nexport const DatabasePage = () => {\n  return (\n    <div className=\"max-w-lg mx-auto mt-8\">\n      <DatabaseSettings />\n    </div>\n  );\n};\n\nDatabasePage.path = \"/database\";\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/sales/index.ts",
      "content": "import type { Sale } from \"../types\";\nimport { SalesCreate } from \"./SalesCreate\";\nimport { SalesEdit } from \"./SalesEdit\";\nimport { SalesList } from \"./SalesList\";\n\nexport default {\n  list: SalesList,\n  create: SalesCreate,\n  edit: SalesEdit,\n  recordRepresentation: (record: Sale) =>\n    `${record.first_name} ${record.last_name}`,\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/sales/SalesList.tsx",
      "content": "import { useMutation } from \"@tanstack/react-query\";\nimport { KeyRound, MoreHorizontal, RefreshCw } from \"lucide-react\";\nimport * as React from \"react\";\nimport {\n  useDataProvider,\n  useGetIdentity,\n  useListContext,\n  useNotify,\n  useRecordContext,\n  useRefresh,\n} from \"ra-core\";\nimport { CreateButton } from \"@/components/admin/create-button\";\nimport { DataTable } from \"@/components/admin/data-table\";\nimport { ExportButton } from \"@/components/admin/export-button\";\nimport { List } from \"@/components/admin/list\";\nimport { SearchInput } from \"@/components/admin/search-input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card } from \"@/components/ui/card\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\n\nimport { TopToolbar } from \"../layout/TopToolbar\";\nimport useAppBarHeight from \"../misc/useAppBarHeight\";\nimport type { CrmDataProvider } from \"../providers/types\";\n\nconst SalesListActions = () => (\n  <TopToolbar>\n    <ExportButton />\n    <CreateButton label=\"New user\" />\n  </TopToolbar>\n);\n\nconst filters = [<SearchInput source=\"q\" alwaysOn />];\n\nconst OptionsField = (_props: { label?: string | boolean }) => {\n  const record = useRecordContext();\n  if (!record) return null;\n  return (\n    <div className=\"flex flex-row gap-1\">\n      {record.administrator && (\n        <Badge\n          variant=\"outline\"\n          className=\"border-blue-300 dark:border-blue-700\"\n        >\n          Admin\n        </Badge>\n      )}\n      {record.disabled && (\n        <Badge\n          variant=\"outline\"\n          className=\"border-orange-300 dark:border-orange-700\"\n        >\n          Disabled\n        </Badge>\n      )}\n    </div>\n  );\n};\n\nconst RowActions = () => {\n  const record = useRecordContext();\n  const dataProvider = useDataProvider<CrmDataProvider>();\n  const notify = useNotify();\n  const refresh = useRefresh();\n  const [inviteDialogOpen, setInviteDialogOpen] = React.useState(false);\n  const [resetDialogOpen, setResetDialogOpen] = React.useState(false);\n\n  const { mutate: resendInvite, isPending: isInvitePending } = useMutation({\n    mutationFn: async () => {\n      return dataProvider.resendInvite(record.id);\n    },\n    onSuccess: () => {\n      notify(\"Invitation email resent successfully\");\n      setInviteDialogOpen(false);\n      refresh();\n    },\n    onError: () => {\n      notify(\"Failed to resend invitation email\", { type: \"error\" });\n      setInviteDialogOpen(false);\n    },\n  });\n\n  const { mutate: resetPassword, isPending: isResetPending } = useMutation({\n    mutationFn: async () => {\n      return dataProvider.resetPassword(record.id);\n    },\n    onSuccess: () => {\n      notify(\"Password reset email sent successfully\");\n      setResetDialogOpen(false);\n      refresh();\n    },\n    onError: () => {\n      notify(\"Failed to send password reset email\", { type: \"error\" });\n      setResetDialogOpen(false);\n    },\n  });\n\n  if (!record) return null;\n\n  // Determine which action to show based on confirmation status\n  const isConfirmed = record.email_confirmed_at !== null;\n  const isDisabled = record.disabled === true;\n\n  console.log(\"[RowActions] Record:\", {\n    email: record.email,\n    email_confirmed_at: record.email_confirmed_at,\n    isConfirmed,\n    isDisabled,\n    inviteDialogOpen,\n    resetDialogOpen,\n  });\n\n  return (\n    <>\n      <DropdownMenu>\n        <DropdownMenuTrigger asChild>\n          <Button variant=\"ghost\" className=\"h-8 w-8 p-0\">\n            <span className=\"sr-only\">Open menu</span>\n            <MoreHorizontal className=\"h-4 w-4\" />\n          </Button>\n        </DropdownMenuTrigger>\n        <DropdownMenuContent align=\"end\">\n          <DropdownMenuLabel>Email Actions</DropdownMenuLabel>\n          <DropdownMenuSeparator />\n          {!isConfirmed && (\n            <DropdownMenuItem\n              onClick={(e) => {\n                e.preventDefault();\n                e.stopPropagation();\n                console.log(\"[Menu] Clicked Resend Invite\");\n                setInviteDialogOpen(true);\n              }}\n            >\n              <RefreshCw className=\"mr-2 h-4 w-4\" />\n              Resend Invite\n            </DropdownMenuItem>\n          )}\n          {isConfirmed && !isDisabled && (\n            <DropdownMenuItem onClick={() => setResetDialogOpen(true)}>\n              <KeyRound className=\"mr-2 h-4 w-4\" />\n              Send Password Reset\n            </DropdownMenuItem>\n          )}\n        </DropdownMenuContent>\n      </DropdownMenu>\n\n      {/* Resend Invite Dialog */}\n      <Dialog open={inviteDialogOpen} onOpenChange={setInviteDialogOpen}>\n        <DialogContent\n          onClick={(e) => e.stopPropagation()}\n          onPointerDown={(e) => e.stopPropagation()}\n        >\n          <DialogHeader>\n            <DialogTitle>Resend Invitation</DialogTitle>\n            <DialogDescription>\n              Send a new invitation email to <strong>{record.email}</strong>?\n              <br />\n              <br />\n              This will send them a fresh invitation link to set up their account.\n            </DialogDescription>\n          </DialogHeader>\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={(e) => {\n                e.stopPropagation();\n                setInviteDialogOpen(false);\n              }}\n              disabled={isInvitePending}\n            >\n              Cancel\n            </Button>\n            <Button\n              onClick={(e) => {\n                e.stopPropagation();\n                resendInvite();\n              }}\n              disabled={isInvitePending}\n            >\n              {isInvitePending ? \"Sending...\" : \"Send Invitation\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Password Reset Dialog */}\n      <Dialog open={resetDialogOpen} onOpenChange={setResetDialogOpen}>\n        <DialogContent\n          onClick={(e) => e.stopPropagation()}\n          onPointerDown={(e) => e.stopPropagation()}\n        >\n          <DialogHeader>\n            <DialogTitle>Send Password Reset</DialogTitle>\n            <DialogDescription>\n              Send a password reset email to <strong>{record.email}</strong>?\n              <br />\n              <br />\n              This will send them a link to reset their password.\n            </DialogDescription>\n          </DialogHeader>\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={(e) => {\n                e.stopPropagation();\n                setResetDialogOpen(false);\n              }}\n              disabled={isResetPending}\n            >\n              Cancel\n            </Button>\n            <Button\n              onClick={(e) => {\n                e.stopPropagation();\n                resetPassword();\n              }}\n              disabled={isResetPending}\n            >\n              {isResetPending ? \"Sending...\" : \"Send Reset Link\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </>\n  );\n};\n\nexport function SalesList() {\n  return (\n    <List\n      filters={filters}\n      actions={<SalesListActions />}\n      sort={{ field: \"first_name\", order: \"ASC\" }}\n    >\n      <SalesListLayout />\n    </List>\n  );\n}\n\nconst SalesListLayout = () => {\n  const { data, isPending, filterValues } = useListContext();\n  const { identity } = useGetIdentity();\n\n  const hasFilters = filterValues && Object.keys(filterValues).length > 0;\n\n  // Show loading skeleton while identity or data is loading\n  if (!identity || isPending) {\n    return (\n      <Card className=\"p-4\">\n        <div className=\"space-y-3\">\n          <Skeleton className=\"h-12 w-full\" />\n          <Skeleton className=\"h-12 w-full\" />\n          <Skeleton className=\"h-12 w-full\" />\n          <Skeleton className=\"h-12 w-full\" />\n          <Skeleton className=\"h-12 w-full\" />\n        </div>\n      </Card>\n    );\n  }\n\n  // Show empty state when no data\n  if (!data?.length && !hasFilters) {\n    return <SalesEmpty />;\n  }\n\n  return (\n    <DataTable>\n      <DataTable.Col source=\"first_name\" />\n      <DataTable.Col source=\"last_name\" />\n      <DataTable.Col source=\"email\" />\n      <DataTable.Col label={false}>\n        <OptionsField />\n      </DataTable.Col>\n      <DataTable.Col label={false}>\n        <RowActions />\n      </DataTable.Col>\n    </DataTable>\n  );\n};\n\nconst SalesEmpty = () => {\n  const appbarHeight = useAppBarHeight();\n  return (\n    <div\n      className=\"flex flex-col justify-center items-center gap-3\"\n      style={{\n        height: `calc(100dvh - ${appbarHeight}px)`,\n      }}\n    >\n      <img src=\"./img/empty.svg\" alt=\"No users found\" />\n      <div className=\"flex flex-col gap-0 items-center\">\n        <h6 className=\"text-lg font-bold\">No users found</h6>\n        <p className=\"text-sm text-muted-foreground text-center mb-4\">\n          It seems your user list is empty.\n        </p>\n      </div>\n      <div className=\"flex flex-row gap-2\">\n        <CreateButton label=\"New user\" />\n      </div>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/sales/SalesInputs.tsx",
      "content": "import { email, required, useGetIdentity, useRecordContext } from \"ra-core\";\nimport { BooleanInput } from \"@/components/admin/boolean-input\";\nimport { TextInput } from \"@/components/admin/text-input\";\n\nimport type { Sale } from \"../types\";\n\nexport function SalesInputs() {\n  const { identity } = useGetIdentity();\n  const record = useRecordContext<Sale>();\n  return (\n    <div className=\"space-y-4 w-full\">\n      <TextInput source=\"first_name\" validate={required()} helperText={false} />\n      <TextInput source=\"last_name\" validate={required()} helperText={false} />\n      <TextInput\n        source=\"email\"\n        validate={[required(), email()]}\n        helperText={false}\n      />\n      <BooleanInput\n        source=\"administrator\"\n        readOnly={record?.id === identity?.id}\n        helperText={false}\n      />\n      <BooleanInput\n        source=\"disabled\"\n        readOnly={record?.id === identity?.id}\n        helperText={false}\n      />\n    </div>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/sales/SalesEdit.tsx",
      "content": "import { useMutation } from \"@tanstack/react-query\";\nimport {\n  useDataProvider,\n  useEditController,\n  useNotify,\n  useRecordContext,\n  useRedirect,\n} from \"ra-core\";\nimport type { SubmitHandler } from \"react-hook-form\";\nimport { SimpleForm } from \"@/components/admin/simple-form\";\nimport { CancelButton } from \"@/components/admin/cancel-button\";\nimport { SaveButton } from \"@/components/admin/form\";\nimport { Card, CardContent } from \"@/components/ui/card\";\n\nimport type { CrmDataProvider } from \"../providers/types\";\nimport type { Sale, SalesFormData } from \"../types\";\nimport { SalesInputs } from \"./SalesInputs\";\n\nfunction EditToolbar() {\n  return (\n    <div className=\"flex justify-end gap-4\">\n      <CancelButton />\n      <SaveButton />\n    </div>\n  );\n}\n\nexport function SalesEdit() {\n  const { record } = useEditController();\n\n  const dataProvider = useDataProvider<CrmDataProvider>();\n  const notify = useNotify();\n  const redirect = useRedirect();\n\n  const { mutate } = useMutation({\n    mutationKey: [\"signup\"],\n    mutationFn: async (data: SalesFormData) => {\n      if (!record) {\n        throw new Error(\"Record not found\");\n      }\n      return dataProvider.salesUpdate(record.id, data);\n    },\n    onSuccess: () => {\n      redirect(\"/sales\");\n      notify(\"User updated successfully\");\n    },\n    onError: () => {\n      notify(\"An error occurred. Please try again.\");\n    },\n  });\n\n  const onSubmit: SubmitHandler<SalesFormData> = async (data) => {\n    mutate(data);\n  };\n\n  return (\n    <div className=\"max-w-lg w-full mx-auto mt-8\">\n      <Card>\n        <CardContent>\n          <SimpleForm\n            toolbar={<EditToolbar />}\n            onSubmit={onSubmit as SubmitHandler<any>}\n            record={record}\n          >\n            <SaleEditTitle />\n            <SalesInputs />\n          </SimpleForm>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n\nconst SaleEditTitle = () => {\n  const record = useRecordContext<Sale>();\n  if (!record) return null;\n  return (\n    <h2 className=\"text-lg font-semibold mb-4\">\n      Edit {record?.first_name} {record?.last_name}\n    </h2>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/sales/SalesCreate.tsx",
      "content": "import { useMutation } from \"@tanstack/react-query\";\nimport { useDataProvider, useNotify, useRedirect } from \"ra-core\";\nimport type { SubmitHandler } from \"react-hook-form\";\nimport { SimpleForm } from \"@/components/admin/simple-form\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\n\nimport type { CrmDataProvider } from \"../providers/types\";\nimport type { SalesFormData } from \"../types\";\nimport { SalesInputs } from \"./SalesInputs\";\n\nexport function SalesCreate() {\n  const dataProvider = useDataProvider<CrmDataProvider>();\n  const notify = useNotify();\n  const redirect = useRedirect();\n\n  const { mutate } = useMutation({\n    mutationKey: [\"signup\"],\n    mutationFn: async (data: SalesFormData) => {\n      return dataProvider.salesCreate(data);\n    },\n    onSuccess: () => {\n      notify(\n        \"User created. They will soon receive an email to set their password.\",\n      );\n      redirect(\"/sales\");\n    },\n    onError: () => {\n      notify(\"An error occurred while creating the user.\", {\n        type: \"error\",\n      });\n    },\n  });\n  const onSubmit: SubmitHandler<SalesFormData> = async (data) => {\n    mutate(data);\n  };\n\n  return (\n    <div className=\"max-w-lg w-full mx-auto mt-8\">\n      <Card>\n        <CardHeader>\n          <CardTitle>Create a new user</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <SimpleForm onSubmit={onSubmit as SubmitHandler<any>}>\n            <SalesInputs />\n          </SimpleForm>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/sales/SaleName.tsx",
      "content": "import { useGetIdentity, useRecordContext } from \"ra-core\";\n\nimport type { Sale } from \"../types\";\n\nexport const SaleName = ({ sale }: { sale?: Sale }) => {\n  const { identity, isPending } = useGetIdentity();\n  const saleFromContext = useRecordContext<Sale>();\n  const finalSale = sale || saleFromContext;\n  if (isPending || !finalSale) return null;\n  return finalSale.id === identity?.id\n    ? \"You\"\n    : `${finalSale.first_name} ${finalSale.last_name}`;\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/root/i18nProvider.tsx",
      "content": "import { mergeTranslations } from \"ra-core\";\nimport polyglotI18nProvider from \"ra-i18n-polyglot\";\nimport englishMessages from \"ra-language-english\";\nimport { raSupabaseEnglishMessages } from \"ra-supabase-language-english\";\n\nconst raSupabaseEnglishMessagesOverride = {\n  \"ra-supabase\": {\n    auth: {\n      password_reset: \"Check your emails for a Reset Password message.\",\n    },\n  },\n};\n\nexport const i18nProvider = polyglotI18nProvider(\n  () => {\n    return mergeTranslations(\n      englishMessages,\n      raSupabaseEnglishMessages,\n      raSupabaseEnglishMessagesOverride,\n    );\n  },\n  \"en\",\n  [{ locale: \"en\", name: \"English\" }],\n  { allowMissing: true },\n);\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/root/defaultConfiguration.ts",
      "content": "import { Mars, NonBinary, Venus } from \"lucide-react\";\n\nexport const defaultDarkModeLogo = \"./logos/logo_atomic_crm_dark.svg\";\nexport const defaultLightModeLogo = \"./logos/logo_atomic_crm_light.svg\";\n\nexport const defaultTitle = \"CRM\";\n\nexport const defaultCompanySectors = [\n  \"Communication Services\",\n  \"Consumer Discretionary\",\n  \"Consumer Staples\",\n  \"Energy\",\n  \"Financials\",\n  \"Health Care\",\n  \"Industrials\",\n  \"Information Technology\",\n  \"Materials\",\n  \"Real Estate\",\n  \"Utilities\",\n];\n\nexport const defaultDealStages = [\n  { value: \"opportunity\", label: \"Opportunity\" },\n  { value: \"proposal-sent\", label: \"Proposal Sent\" },\n  { value: \"in-negociation\", label: \"In Negotiation\" },\n  { value: \"won\", label: \"Won\" },\n  { value: \"lost\", label: \"Lost\" },\n  { value: \"delayed\", label: \"Delayed\" },\n];\n\nexport const defaultDealPipelineStatuses = [\"won\"];\n\nexport const defaultDealCategories = [\n  \"Other\",\n  \"Copywriting\",\n  \"Print project\",\n  \"UI Design\",\n  \"Website design\",\n];\n\nexport const defaultNoteStatuses = [\n  { value: \"cold\", label: \"Cold\", color: \"#7dbde8\" },\n  { value: \"warm\", label: \"Warm\", color: \"#e8cb7d\" },\n  { value: \"hot\", label: \"Hot\", color: \"#e88b7d\" },\n  { value: \"in-contract\", label: \"In Contract\", color: \"#a4e87d\" },\n];\n\nexport const defaultTaskTypes = [\n  \"None\",\n  \"Email\",\n  \"Demo\",\n  \"Lunch\",\n  \"Meeting\",\n  \"Follow-up\",\n  \"Thank you\",\n  \"Ship\",\n  \"Call\",\n];\n\nexport const defaultTaskPriorities = [\n  { id: \"low\", name: \"Low\" },\n  { id: \"medium\", name: \"Medium\" },\n  { id: \"high\", name: \"High\" },\n  { id: \"urgent\", name: \"Urgent\" },\n];\n\nexport const defaultTaskStatuses = [\n  { id: \"todo\", name: \"To Do\" },\n  { id: \"in_progress\", name: \"In Progress\" },\n  { id: \"blocked\", name: \"Blocked\" },\n  { id: \"done\", name: \"Done\" },\n  { id: \"cancelled\", name: \"Cancelled\" },\n];\n\nexport const defaultContactGender = [\n  { value: \"male\", label: \"He/Him\", icon: Mars },\n  { value: \"female\", label: \"She/Her\", icon: Venus },\n  { value: \"nonbinary\", label: \"They/Them\", icon: NonBinary },\n];\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/root/DatabaseHealthCheck.tsx",
      "content": "import { useEffect, useState } from \"react\";\nimport type { DataProvider } from \"ra-core\";\nimport { checkDatabaseHealth, DatabaseHealthStatus } from \"@/lib/database-health-check\";\nimport { getSupabaseConfig } from \"@/lib/supabase-config\";\nimport { DatabaseSetupGuide } from \"../setup/DatabaseSetupGuide\";\n\ninterface DatabaseHealthCheckProps {\n  children: React.ReactNode;\n  dataProvider: DataProvider;\n}\n\nexport function DatabaseHealthCheck({ children, dataProvider }: DatabaseHealthCheckProps) {\n  const [healthStatus, setHealthStatus] = useState<DatabaseHealthStatus | null>(null);\n  const [isChecking, setIsChecking] = useState(true);\n\n  useEffect(() => {\n    let cancelled = false;\n\n    async function checkHealth() {\n      try {\n        const status = await checkDatabaseHealth(dataProvider);\n        if (!cancelled) {\n          setHealthStatus(status);\n          setIsChecking(false);\n        }\n      } catch (error) {\n        console.error(\"[DatabaseHealthCheck] Failed to check database health:\", error);\n        if (!cancelled) {\n          setIsChecking(false);\n        }\n      }\n    }\n\n    checkHealth();\n\n    return () => {\n      cancelled = true;\n    };\n  }, [dataProvider]);\n\n  // Show loading state\n  if (isChecking) {\n    return (\n      <div className=\"flex items-center justify-center min-h-screen\">\n        <div className=\"text-center space-y-4\">\n          <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto\"></div>\n          <p className=\"text-muted-foreground\">Checking database connection...</p>\n        </div>\n      </div>\n    );\n  }\n\n  // Show setup guide if database is not healthy\n  if (healthStatus && !healthStatus.isHealthy) {\n    const config = getSupabaseConfig();\n    if (config) {\n      return (\n        <DatabaseSetupGuide\n          missingTables={healthStatus.missingTables}\n          supabaseUrl={config.url}\n        />\n      );\n    }\n  }\n\n  // Database is healthy, render children\n  return <>{children}</>;\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/root/ConfigurationContext.tsx",
      "content": "import { createContext, useContext, type ReactNode } from \"react\";\n\nimport type { ContactGender, DealStage, NoteStatus } from \"../types\";\nimport {\n  defaultCompanySectors,\n  defaultContactGender,\n  defaultDarkModeLogo,\n  defaultDealCategories,\n  defaultDealPipelineStatuses,\n  defaultDealStages,\n  defaultLightModeLogo,\n  defaultNoteStatuses,\n  defaultTaskPriorities,\n  defaultTaskStatuses,\n  defaultTaskTypes,\n  defaultTitle,\n} from \"./defaultConfiguration\";\n\n// Define types for the context value\nexport interface ConfigurationContextValue {\n  companySectors: string[];\n  dealCategories: string[];\n  dealPipelineStatuses: string[];\n  dealStages: DealStage[];\n  noteStatuses: NoteStatus[];\n  taskTypes: string[];\n  taskPriorities: { id: string; name: string }[];\n  taskStatuses: { id: string; name: string }[];\n  title: string;\n  darkModeLogo: string;\n  lightModeLogo: string;\n  contactGender: ContactGender[];\n}\n\nexport interface ConfigurationProviderProps extends ConfigurationContextValue {\n  children: ReactNode;\n}\n\n// Create context with default value\nexport const ConfigurationContext = createContext<ConfigurationContextValue>({\n  companySectors: defaultCompanySectors,\n  dealCategories: defaultDealCategories,\n  dealPipelineStatuses: defaultDealPipelineStatuses,\n  dealStages: defaultDealStages,\n  noteStatuses: defaultNoteStatuses,\n  taskTypes: defaultTaskTypes,\n  taskPriorities: defaultTaskPriorities,\n  taskStatuses: defaultTaskStatuses,\n  title: defaultTitle,\n  darkModeLogo: defaultDarkModeLogo,\n  lightModeLogo: defaultLightModeLogo,\n  contactGender: defaultContactGender,\n});\n\nexport const ConfigurationProvider = ({\n  children,\n  companySectors,\n  dealCategories,\n  dealPipelineStatuses,\n  dealStages,\n  darkModeLogo,\n  lightModeLogo,\n  noteStatuses,\n  taskTypes,\n  taskPriorities,\n  taskStatuses,\n  title,\n  contactGender,\n}: ConfigurationProviderProps) => (\n  <ConfigurationContext.Provider\n    value={{\n      companySectors,\n      dealCategories,\n      dealPipelineStatuses,\n      dealStages,\n      darkModeLogo,\n      lightModeLogo,\n      noteStatuses,\n      title,\n      taskTypes,\n      taskPriorities,\n      taskStatuses,\n      contactGender,\n    }}\n  >\n    {children}\n  </ConfigurationContext.Provider>\n);\n\nexport const useConfigurationContext = () => useContext(ConfigurationContext);\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/root/CRM.tsx",
      "content": "import {\n  CustomRoutes,\n  localStorageStore,\n  Resource,\n  type AuthProvider,\n  type DataProvider,\n} from \"ra-core\";\nimport { useEffect } from \"react\";\nimport { Route } from \"react-router\";\nimport { Admin } from \"@/components/admin/admin\";\nimport { ForgotPasswordPage } from \"@/components/supabase/forgot-password-page\";\nimport { SetPasswordPage } from \"@/components/supabase/set-password-page\";\nimport { ChangePasswordPage } from \"@/components/supabase/change-password-page\";\nimport { OtpLoginPage } from \"@/components/supabase/otp-login-page\";\n\nimport companies from \"../companies\";\nimport contacts from \"../contacts\";\nimport { Dashboard } from \"../dashboard/Dashboard\";\nimport deals from \"../deals\";\nimport { Layout } from \"../layout/Layout\";\nimport { SignupPage } from \"../login/SignupPage\";\nimport {\n  authProvider as defaultAuthProvider,\n  dataProvider as defaultDataProvider,\n} from \"../providers/supabase\";\nimport sales from \"../sales\";\nimport { DatabasePage } from \"../settings/DatabasePage\";\nimport { SettingsPage } from \"../settings/SettingsPage\";\nimport { IntegrationsPage } from \"../integrations/IntegrationsPage\";\nimport tasks from \"../tasks\";\nimport type { ConfigurationContextValue } from \"./ConfigurationContext\";\nimport { ConfigurationProvider } from \"./ConfigurationContext\";\nimport {\n  defaultCompanySectors,\n  defaultContactGender,\n  defaultDarkModeLogo,\n  defaultDealCategories,\n  defaultDealPipelineStatuses,\n  defaultDealStages,\n  defaultLightModeLogo,\n  defaultNoteStatuses,\n  defaultTaskPriorities,\n  defaultTaskStatuses,\n  defaultTaskTypes,\n  defaultTitle,\n} from \"./defaultConfiguration\";\nimport { i18nProvider } from \"./i18nProvider\";\nimport { StartPage } from \"../login/StartPage.tsx\";\nimport { DatabaseHealthCheck } from \"./DatabaseHealthCheck\";\n\nexport type CRMProps = {\n  dataProvider?: DataProvider;\n  authProvider?: AuthProvider;\n  disableTelemetry?: boolean;\n} & Partial<ConfigurationContextValue>;\n\n/**\n * CRM Component\n *\n * This component sets up and renders the main CRM application using `ra-core`. It provides\n * default configurations and themes but allows for customization through props. The component\n * wraps the application with a `ConfigurationProvider` to provide configuration values via context.\n *\n * @param {Array<ContactGender>} contactGender - The gender options for contacts used in the application.\n * @param {string[]} companySectors - The list of company sectors used in the application.\n * @param {RaThemeOptions} darkTheme - The theme to use when the application is in dark mode.\n * @param {string[]} dealCategories - The categories of deals used in the application.\n * @param {string[]} dealPipelineStatuses - The statuses of deals in the pipeline used in the application.\n * @param {DealStage[]} dealStages - The stages of deals used in the application.\n * @param {RaThemeOptions} lightTheme - The theme to use when the application is in light mode.\n * @param {string} logo - The logo used in the CRM application.\n * @param {NoteStatus[]} noteStatuses - The statuses of notes used in the application.\n * @param {string[]} taskTypes - The types of tasks used in the application.\n * @param {Object[]} taskPriorities - The priorities of tasks used in the application.\n * @param {Object[]} taskStatuses - The statuses of tasks used in the application.\n * @param {string} title - The title of the CRM application.\n *\n * @returns {JSX.Element} The rendered CRM application.\n *\n * @example\n * // Basic usage of the CRM component\n * import { CRM } from '@/components/atomic-crm/dashboard/CRM';\n *\n * const App = () => (\n *     <CRM\n *         logo=\"/path/to/logo.png\"\n *         title=\"My Custom CRM\"\n *         lightTheme={{\n *             ...defaultTheme,\n *             palette: {\n *                 primary: { main: '#0000ff' },\n *             },\n *         }}\n *     />\n * );\n *\n * export default App;\n */\nexport const CRM = ({\n  contactGender = defaultContactGender,\n  companySectors = defaultCompanySectors,\n  dealCategories = defaultDealCategories,\n  dealPipelineStatuses = defaultDealPipelineStatuses,\n  dealStages = defaultDealStages,\n  darkModeLogo = defaultDarkModeLogo,\n  lightModeLogo = defaultLightModeLogo,\n  noteStatuses = defaultNoteStatuses,\n  taskTypes = defaultTaskTypes,\n  taskPriorities = defaultTaskPriorities,\n  taskStatuses = defaultTaskStatuses,\n  title = defaultTitle,\n  dataProvider = defaultDataProvider,\n  authProvider = defaultAuthProvider,\n  disableTelemetry,\n  ...rest\n}: CRMProps) => {\n  useEffect(() => {\n    if (\n      disableTelemetry ||\n      process.env.NODE_ENV !== \"production\" ||\n      typeof window === \"undefined\" ||\n      typeof window.location === \"undefined\" ||\n      typeof Image === \"undefined\"\n    ) {\n      return;\n    }\n    const img = new Image();\n    img.src = `https://atomic-crm-telemetry.marmelab.com/atomic-crm-telemetry?domain=${window.location.hostname}`;\n  }, [disableTelemetry]);\n\n  return (\n    <ConfigurationProvider\n      contactGender={contactGender}\n      companySectors={companySectors}\n      dealCategories={dealCategories}\n      dealPipelineStatuses={dealPipelineStatuses}\n      dealStages={dealStages}\n      darkModeLogo={darkModeLogo}\n      lightModeLogo={lightModeLogo}\n      noteStatuses={noteStatuses}\n      taskTypes={taskTypes}\n      taskPriorities={taskPriorities}\n      taskStatuses={taskStatuses}\n      title={title}\n    >\n      <DatabaseHealthCheck dataProvider={dataProvider}>\n        <Admin\n          dataProvider={dataProvider}\n          authProvider={authProvider}\n          store={localStorageStore(undefined, \"CRM\")}\n          layout={Layout}\n          loginPage={StartPage}\n          i18nProvider={i18nProvider}\n          dashboard={Dashboard}\n          requireAuth\n          disableTelemetry\n          {...rest}\n        >\n          <CustomRoutes noLayout>\n            <Route path={SignupPage.path} element={<SignupPage />} />\n            <Route path={SetPasswordPage.path} element={<SetPasswordPage />} />\n            <Route\n              path={ForgotPasswordPage.path}\n              element={<ForgotPasswordPage />}\n            />\n            <Route\n              path={ChangePasswordPage.path}\n              element={<ChangePasswordPage />}\n            />\n            <Route path={OtpLoginPage.path} element={<OtpLoginPage />} />\n          </CustomRoutes>\n\n          <CustomRoutes>\n            <Route path={SettingsPage.path} element={<SettingsPage />} />\n            <Route path={DatabasePage.path} element={<DatabasePage />} />\n            <Route path={IntegrationsPage.path} element={<IntegrationsPage />} />\n          </CustomRoutes>\n          <Resource name=\"deals\" {...deals} />\n          <Resource name=\"contacts\" {...contacts} />\n          <Resource name=\"companies\" {...companies} />\n          <Resource name=\"companyNotes\" />\n          <Resource name=\"contactNotes\" />\n          <Resource name=\"dealNotes\" />\n          <Resource name=\"taskNotes\" />\n          <Resource name=\"task_activity\" />\n          <Resource name=\"tasks\" {...tasks} />\n          <Resource name=\"sales\" {...sales} />\n          <Resource name=\"tags\" />\n        </Admin>\n      </DatabaseHealthCheck>\n    </ConfigurationProvider>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/types.ts",
      "content": "export type { CrmDataProvider } from \"./supabase/dataProvider\";\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/supabase/supabase.ts",
      "content": "import { createClient, type SupabaseClient } from \"@supabase/supabase-js\";\nimport { getSupabaseConfig } from \"@/lib/supabase-config\";\n\n// Create client immediately to ensure session restoration happens early\n// This is critical for auth session persistence across page refreshes\nfunction createSupabaseClient(): SupabaseClient {\n  const config = getSupabaseConfig();\n\n  if (!config) {\n    // Return a placeholder client that will never be used\n    // (App.tsx will show setup wizard before this is accessed)\n    console.warn(\"[Supabase] No configuration found, using placeholder\");\n    return createClient(\n      \"https://placeholder.supabase.co\",\n      \"placeholder-key\",\n    );\n  }\n\n  return createClient(config.url, config.anonKey, {\n    auth: {\n      // Ensure session is persisted and restored from localStorage\n      persistSession: true,\n      autoRefreshToken: true,\n      detectSessionInUrl: true,\n    },\n  });\n}\n\n// Create client immediately on module load (not lazy!)\n// This ensures session restoration from localStorage happens before any auth checks\nexport const supabase = createSupabaseClient();\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/supabase/index.ts",
      "content": "export { authProvider } from \"./authProvider\";\nexport { dataProvider } from \"./dataProvider\";\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/supabase/dataProvider.ts",
      "content": "import { supabaseDataProvider } from \"ra-supabase-core\";\nimport {\n  withLifecycleCallbacks,\n  type CreateParams,\n  type DataProvider,\n  type GetListParams,\n  type Identifier,\n  type UpdateParams,\n} from \"ra-core\";\n\nimport type {\n  Contact,\n  ContactNote,\n  Deal,\n  DealNote,\n  RAFile,\n  Sale,\n  SalesFormData,\n  SignUpData,\n} from \"../../types\";\nimport { getActivityLog } from \"../commons/activity\";\nimport { getCompanyAvatar } from \"../commons/getCompanyAvatar\";\nimport { getContactAvatar } from \"../commons/getContactAvatar\";\nimport { getIsInitialized } from \"./authProvider\";\nimport { supabase } from \"./supabase\";\nimport { getSupabaseConfig } from \"@/lib/supabase-config\";\n\n// Get config dynamically (from localStorage or env vars)\n// If no config, create a dummy provider that will never be used\n// (App.tsx will show setup wizard before CRM loads)\nconst config = getSupabaseConfig() || {\n  url: \"https://placeholder.supabase.co\",\n  anonKey: \"placeholder-key\",\n};\n\nconst baseDataProvider = supabaseDataProvider({\n  instanceUrl: config.url,\n  apiKey: config.anonKey,\n  supabaseClient: supabase,\n  sortOrder: \"asc,desc.nullslast\" as any,\n});\n\nconst processCompanyLogo = async (params: any) => {\n  let logo = params.data.logo;\n\n  if (typeof logo !== \"object\" || logo === null || !logo.src) {\n    logo = await getCompanyAvatar(params.data);\n  } else if (logo.rawFile instanceof File) {\n    await uploadToBucket(logo);\n  }\n\n  return {\n    ...params,\n    data: {\n      ...params.data,\n      logo,\n    },\n  };\n};\n\nasync function processContactAvatar(\n  params: UpdateParams<Contact>,\n): Promise<UpdateParams<Contact>>;\n\nasync function processContactAvatar(\n  params: CreateParams<Contact>,\n): Promise<CreateParams<Contact>>;\n\nasync function processContactAvatar(\n  params: CreateParams<Contact> | UpdateParams<Contact>,\n): Promise<CreateParams<Contact> | UpdateParams<Contact>> {\n  const { data } = params;\n  if (data.avatar?.src || !data.email_jsonb || !data.email_jsonb.length) {\n    return params;\n  }\n  const avatarUrl = await getContactAvatar(data);\n\n  // Clone the data and modify the clone\n  const newData = { ...data, avatar: { src: avatarUrl || undefined } };\n\n  return { ...params, data: newData };\n}\n\nconst dataProviderWithCustomMethods = {\n  ...baseDataProvider,\n  async getList(resource: string, params: GetListParams) {\n    if (resource === \"companies\") {\n      return baseDataProvider.getList(\"companies_summary\", params);\n    }\n    if (resource === \"contacts\") {\n      return baseDataProvider.getList(\"contacts_summary\", params);\n    }\n    if (resource === \"tasks\") {\n      return baseDataProvider.getList(\"tasks_summary\", params);\n    }\n\n    return baseDataProvider.getList(resource, params);\n  },\n  async getOne(resource: string, params: any) {\n    if (resource === \"companies\") {\n      return baseDataProvider.getOne(\"companies_summary\", params);\n    }\n    if (resource === \"contacts\") {\n      return baseDataProvider.getOne(\"contacts_summary\", params);\n    }\n    if (resource === \"tasks\") {\n      return baseDataProvider.getOne(\"tasks_summary\", params);\n    }\n\n    return baseDataProvider.getOne(resource, params);\n  },\n\n  async update(resource: string, params: any) {\n    if (resource === \"tasks\") {\n      const {\n        contact_first_name,\n        contact_last_name,\n        contact_email,\n        company_id,\n        company_name,\n        assigned_first_name,\n        assigned_last_name,\n        creator_first_name,\n        creator_last_name,\n        nb_notes,\n        last_note_date,\n        ...data\n      } = params.data;\n\n      return baseDataProvider.update(resource, {\n        ...params,\n        data,\n      });\n    }\n    return baseDataProvider.update(resource, params);\n  },\n\n  async signUp({ email, password, first_name, last_name }: SignUpData) {\n    // Use admin API via edge function to create first user\n    // This bypasses the signup restriction (enable_signup = false)\n    const { data, error } = await supabase.functions.invoke(\"setup\", {\n      method: \"POST\",\n      body: { email, password, first_name, last_name },\n    });\n\n    if (!data || error) {\n      console.error(\"signUp.error\", error);\n      throw new Error(\"Failed to create account\");\n    }\n\n    // Update the is initialized cache\n    getIsInitialized._is_initialized_cache = true;\n\n    return {\n      id: data.data.id,\n      email,\n      password,\n    };\n  },\n  async salesCreate(body: SalesFormData) {\n    const { data, error } = await supabase.functions.invoke<Sale>(\"users\", {\n      method: \"POST\",\n      body,\n    });\n\n    if (!data || error) {\n      console.error(\"salesCreate.error\", error);\n      throw new Error(\"Failed to create account manager\");\n    }\n\n    return data;\n  },\n  async salesUpdate(\n    id: Identifier,\n    data: Partial<Omit<SalesFormData, \"password\">>,\n  ) {\n    const { email, first_name, last_name, administrator, avatar, disabled } =\n      data;\n\n    const { data: sale, error } = await supabase.functions.invoke<Sale>(\n      \"users\",\n      {\n        method: \"PATCH\",\n        body: {\n          sales_id: id,\n          email,\n          first_name,\n          last_name,\n          administrator,\n          disabled,\n          avatar,\n        },\n      },\n    );\n\n    if (!sale || error) {\n      console.error(\"salesCreate.error\", error);\n      throw new Error(\"Failed to update account manager\");\n    }\n\n    return data;\n  },\n  async resendInvite(id: Identifier) {\n    const { data: sale, error } = await supabase.functions.invoke<Sale>(\n      \"users\",\n      {\n        method: \"PUT\",\n        body: {\n          sales_id: id,\n          action: \"invite\",\n        },\n      },\n    );\n\n    if (!sale || error) {\n      console.error(\"resendInvite.error\", error);\n      throw new Error(\"Failed to resend invitation\");\n    }\n\n    return sale;\n  },\n  async resetPassword(id: Identifier) {\n    const { data: sale, error } = await supabase.functions.invoke<Sale>(\n      \"users\",\n      {\n        method: \"PUT\",\n        body: {\n          sales_id: id,\n          action: \"reset\",\n        },\n      },\n    );\n\n    if (!sale || error) {\n      console.error(\"resetPassword.error\", error);\n      throw new Error(\"Failed to send password reset\");\n    }\n\n    return sale;\n  },\n  async updatePassword(id: Identifier) {\n    const { data: passwordUpdated, error } =\n      await supabase.functions.invoke<boolean>(\"updatePassword\", {\n        method: \"PATCH\",\n        body: {\n          sales_id: id,\n        },\n      });\n\n    if (!passwordUpdated || error) {\n      console.error(\"passwordUpdate.error\", error);\n      throw new Error(\"Failed to update password\");\n    }\n\n    return passwordUpdated;\n  },\n  async unarchiveDeal(deal: Deal) {\n    // get all deals where stage is the same as the deal to unarchive\n    const { data: deals } = await baseDataProvider.getList<Deal>(\"deals\", {\n      filter: { stage: deal.stage },\n      pagination: { page: 1, perPage: 1000 },\n      sort: { field: \"index\", order: \"ASC\" },\n    });\n\n    // set index for each deal starting from 1, if the deal to unarchive is found, set its index to the last one\n    const updatedDeals = deals.map((d, index) => ({\n      ...d,\n      index: d.id === deal.id ? 0 : index + 1,\n      archived_at: d.id === deal.id ? null : d.archived_at,\n    }));\n\n    return await Promise.all(\n      updatedDeals.map((updatedDeal) =>\n        baseDataProvider.update(\"deals\", {\n          id: updatedDeal.id,\n          data: updatedDeal,\n          previousData: deals.find((d) => d.id === updatedDeal.id),\n        }),\n      ),\n    );\n  },\n  async getActivityLog(companyId?: Identifier) {\n    return getActivityLog(baseDataProvider, companyId);\n  },\n  async isInitialized() {\n    return getIsInitialized();\n  },\n  async mergeContacts(sourceId: Identifier, targetId: Identifier) {\n    const { data, error } = await supabase.functions.invoke(\"mergeContacts\", {\n      method: \"POST\",\n      body: { loserId: sourceId, winnerId: targetId },\n    });\n\n    if (error) {\n      console.error(\"mergeContacts.error\", error);\n      throw new Error(\"Failed to merge contacts\");\n    }\n\n    return data;\n  },\n  async mergeCompanies(sourceId: Identifier, targetId: Identifier) {\n    const { data, error } = await supabase.functions.invoke(\"mergeCompanies\", {\n      method: \"POST\",\n      body: { loserId: sourceId, winnerId: targetId },\n    });\n\n    if (error) {\n      console.error(\"mergeCompanies.error\", error);\n      throw new Error(\"Failed to merge companies\");\n    }\n\n    return data;\n  },\n} satisfies DataProvider;\n\nexport type CrmDataProvider = typeof dataProviderWithCustomMethods;\n\nexport const dataProvider = withLifecycleCallbacks(\n  dataProviderWithCustomMethods,\n  [\n    {\n      resource: \"contactNotes\",\n      beforeSave: async (data: ContactNote, _, __) => {\n        if (data.attachments) {\n          for (const fi of data.attachments) {\n            await uploadToBucket(fi);\n          }\n        }\n        return data;\n      },\n    },\n    {\n      resource: \"dealNotes\",\n      beforeSave: async (data: DealNote, _, __) => {\n        if (data.attachments) {\n          for (const fi of data.attachments) {\n            await uploadToBucket(fi);\n          }\n        }\n        return data;\n      },\n    },\n    {\n      resource: \"sales\",\n      beforeSave: async (data: Sale, _, __) => {\n        if (data.avatar) {\n          await uploadToBucket(data.avatar);\n        }\n        return data;\n      },\n    },\n    {\n      resource: \"contacts\",\n      beforeCreate: async (params) => {\n        return processContactAvatar(params);\n      },\n      beforeUpdate: async (params) => {\n        return processContactAvatar(params);\n      },\n      beforeGetList: async (params) => {\n        return applyFullTextSearch([\n          \"first_name\",\n          \"last_name\",\n          \"company_name\",\n          \"title\",\n          \"email\",\n          \"phone\",\n          \"background\",\n        ])(params);\n      },\n    },\n    {\n      resource: \"companies\",\n      beforeGetList: async (params) => {\n        return applyFullTextSearch([\n          \"name\",\n          \"phone_number\",\n          \"website\",\n          \"zipcode\",\n          \"city\",\n          \"stateAbbr\",\n        ])(params);\n      },\n      beforeCreate: async (params) => {\n        const createParams = await processCompanyLogo(params);\n\n        return {\n          ...createParams,\n          data: {\n            ...createParams.data,\n            created_at: new Date().toISOString(),\n          },\n        };\n      },\n      beforeUpdate: async (params) => {\n        return await processCompanyLogo(params);\n      },\n    },\n    {\n      resource: \"contacts_summary\",\n      beforeGetList: async (params) => {\n        return applyFullTextSearch([\"first_name\", \"last_name\"])(params);\n      },\n    },\n    {\n      resource: \"tasks\",\n      beforeGetList: async (params) => {\n        return applyFullTextSearch([\"text\", \"contact_first_name\"])(params);\n      },\n    },\n    {\n      resource: \"deals\",\n      beforeGetList: async (params) => {\n        return applyFullTextSearch([\"name\", \"type\", \"description\"])(params);\n      },\n    },\n  ],\n);\n\nconst applyFullTextSearch = (columns: string[]) => (params: GetListParams) => {\n  if (!params.filter?.q) {\n    return params;\n  }\n  const { q, ...filter } = params.filter;\n  return {\n    ...params,\n    filter: {\n      ...filter,\n      \"@or\": columns.reduce((acc, column) => {\n        if (column === \"email\")\n          return {\n            ...acc,\n            [`email_fts@ilike`]: q,\n          };\n        if (column === \"phone\")\n          return {\n            ...acc,\n            [`phone_fts@ilike`]: q,\n          };\n        else\n          return {\n            ...acc,\n            [`${column}@ilike`]: q,\n          };\n      }, {}),\n    },\n  };\n};\n\nconst uploadToBucket = async (fi: RAFile) => {\n  if (!fi.src.startsWith(\"blob:\") && !fi.src.startsWith(\"data:\")) {\n    // Sign URL check if path exists in the bucket\n    if (fi.path) {\n      const { error } = await supabase.storage\n        .from(\"attachments\")\n        .createSignedUrl(fi.path, 60);\n\n      if (!error) {\n        return;\n      }\n    }\n  }\n\n  const dataContent = fi.src\n    ? await fetch(fi.src).then((res) => res.blob())\n    : fi.rawFile;\n\n  const file = fi.rawFile;\n  const fileExt = file.name.split(\".\").pop();\n  const fileName = `${Math.random()}.${fileExt}`;\n  const filePath = `${fileName}`;\n  const { error: uploadError } = await supabase.storage\n    .from(\"attachments\")\n    .upload(filePath, dataContent);\n\n  if (uploadError) {\n    console.error(\"uploadError\", uploadError);\n    throw new Error(\"Failed to upload attachment\");\n  }\n\n  const { data } = supabase.storage.from(\"attachments\").getPublicUrl(filePath);\n\n  fi.path = filePath;\n  fi.src = data.publicUrl;\n\n  // save MIME type\n  const mimeType = file.type;\n  fi.type = mimeType;\n\n  return fi;\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/supabase/authProvider.ts",
      "content": "/* eslint-disable no-var */\n/* eslint-disable @typescript-eslint/no-namespace */\nimport type { AuthProvider } from \"ra-core\";\nimport { supabaseAuthProvider } from \"ra-supabase-core\";\n\nimport { canAccess } from \"../commons/canAccess\";\nimport { supabase } from \"./supabase\";\n\nconst baseAuthProvider = supabaseAuthProvider(supabase, {\n  getIdentity: async () => {\n    const sale = await getSaleFromCache();\n\n    if (sale == null) {\n      throw new Error();\n    }\n\n    return {\n      id: sale.id,\n      fullName: `${sale.first_name} ${sale.last_name}`,\n      avatar: sale.avatar?.src,\n    };\n  },\n});\n\nexport async function getIsInitialized() {\n  if (getIsInitialized._is_initialized_cache == null) {\n    const { data } = await supabase.from(\"init_state\").select(\"is_initialized\");\n\n    getIsInitialized._is_initialized_cache = data?.at(0)?.is_initialized > 0;\n  }\n\n  return getIsInitialized._is_initialized_cache;\n}\n\nexport namespace getIsInitialized {\n  export var _is_initialized_cache: boolean | null = null;\n}\n\nexport const authProvider: AuthProvider = {\n  ...baseAuthProvider,\n  login: async (params) => {\n    const result = await baseAuthProvider.login(params);\n    // clear cached sale\n    cachedSale = undefined;\n    return result;\n  },\n  checkAuth: async (params) => {\n    // Users are on the set-password page, nothing to do\n    if (\n      window.location.pathname === \"/set-password\" ||\n      window.location.hash.includes(\"#/set-password\")\n    ) {\n      return;\n    }\n    // Users are on the forgot-password page, nothing to do\n    if (\n      window.location.pathname === \"/forgot-password\" ||\n      window.location.hash.includes(\"#/forgot-password\")\n    ) {\n      return;\n    }\n    // Users are on the change-password page, nothing to do\n    if (\n      window.location.pathname === \"/change-password\" ||\n      window.location.hash.includes(\"#/change-password\")\n    ) {\n      return;\n    }\n    // Users are on the otp-login page, nothing to do\n    if (\n      window.location.pathname === \"/otp-login\" ||\n      window.location.hash.includes(\"#/otp-login\")\n    ) {\n      return;\n    }\n    // Users are on the sign-up page, nothing to do\n    if (\n      window.location.pathname === \"/sign-up\" ||\n      window.location.hash.includes(\"#/sign-up\")\n    ) {\n      return;\n    }\n\n    const isInitialized = await getIsInitialized();\n\n    if (!isInitialized) {\n      await supabase.auth.signOut();\n      throw {\n        redirectTo: \"/sign-up\",\n        message: false,\n      };\n    }\n\n    return baseAuthProvider.checkAuth(params);\n  },\n  canAccess: async (params) => {\n    const isInitialized = await getIsInitialized();\n    if (!isInitialized) return false;\n\n    // Get the current user\n    const sale = await getSaleFromCache();\n    if (sale == null) return false;\n\n    // Compute access rights from the sale role\n    const role = sale.administrator ? \"admin\" : \"user\";\n    return canAccess(role, params);\n  },\n};\n\nlet cachedSale: any;\nconst getSaleFromCache = async () => {\n  if (cachedSale != null) return cachedSale;\n\n  const { data: dataSession, error: errorSession } =\n    await supabase.auth.getSession();\n\n  // Shouldn't happen after login but just in case\n  if (dataSession?.session?.user == null || errorSession) {\n    return undefined;\n  }\n\n  const { data: dataSale, error: errorSale } = await supabase\n    .from(\"sales\")\n    .select(\"id, first_name, last_name, avatar, administrator\")\n    .match({ user_id: dataSession?.session?.user.id })\n    .single();\n\n  // Shouldn't happen either as all users are sales but just in case\n  if (dataSale == null || errorSale) {\n    return undefined;\n  }\n\n  cachedSale = dataSale;\n  return dataSale;\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/index.ts",
      "content": "export { authProvider } from \"./authProvider\";\nexport { dataProvider } from \"./dataProvider\";\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/dataProvider.ts",
      "content": "import {\n  withLifecycleCallbacks,\n  type CreateParams,\n  type DataProvider,\n  type Identifier,\n  type ResourceCallbacks,\n  type UpdateParams,\n} from \"ra-core\";\nimport fakeRestDataProvider from \"ra-data-fakerest\";\n\nimport type {\n  Company,\n  Contact,\n  Deal,\n  Sale,\n  SalesFormData,\n  SignUpData,\n  Task,\n} from \"../../types\";\nimport { getActivityLog } from \"../commons/activity\";\nimport { getCompanyAvatar } from \"../commons/getCompanyAvatar\";\nimport { getContactAvatar } from \"../commons/getContactAvatar\";\nimport { mergeContacts } from \"../commons/mergeContacts\";\nimport { mergeCompanies } from \"../commons/mergeCompanies\";\nimport type { CrmDataProvider } from \"../types\";\nimport { authProvider, USER_STORAGE_KEY } from \"./authProvider\";\nimport generateData from \"./dataGenerator\";\nimport { withSupabaseFilterAdapter } from \"./internal/supabaseAdapter\";\n\nconst baseDataProvider = fakeRestDataProvider(generateData(), true, 300);\n\nconst TASK_MARKED_AS_DONE = \"TASK_MARKED_AS_DONE\";\nconst TASK_MARKED_AS_UNDONE = \"TASK_MARKED_AS_UNDONE\";\nconst TASK_DONE_NOT_CHANGED = \"TASK_DONE_NOT_CHANGED\";\nlet taskUpdateType = TASK_DONE_NOT_CHANGED;\n\nconst processCompanyLogo = async (params: any) => {\n  let logo = params.data.logo;\n\n  if (typeof logo !== \"object\" || logo === null || !logo.src) {\n    logo = await getCompanyAvatar(params.data);\n  } else if (logo.rawFile instanceof File) {\n    const base64Logo = await convertFileToBase64(logo);\n    logo = { src: base64Logo, title: logo.title };\n  }\n\n  return {\n    ...params,\n    data: {\n      ...params.data,\n      logo,\n    },\n  };\n};\n\nasync function processContactAvatar(\n  params: UpdateParams<Contact>,\n): Promise<UpdateParams<Contact>>;\n\nasync function processContactAvatar(\n  params: CreateParams<Contact>,\n): Promise<CreateParams<Contact>>;\n\nasync function processContactAvatar(\n  params: CreateParams<Contact> | UpdateParams<Contact>,\n): Promise<CreateParams<Contact> | UpdateParams<Contact>> {\n  const { data } = params;\n  if (data.avatar?.src || !data.email_jsonb || !data.email_jsonb.length) {\n    return params;\n  }\n  const avatarUrl = await getContactAvatar(data);\n\n  // Clone the data and modify the clone\n  const newData = { ...data, avatar: { src: avatarUrl || undefined } };\n\n  return { ...params, data: newData };\n}\n\nasync function fetchAndUpdateCompanyData(\n  params: UpdateParams<Contact>,\n  dataProvider: DataProvider,\n): Promise<UpdateParams<Contact>>;\n\nasync function fetchAndUpdateCompanyData(\n  params: CreateParams<Contact>,\n  dataProvider: DataProvider,\n): Promise<CreateParams<Contact>>;\n\nasync function fetchAndUpdateCompanyData(\n  params: CreateParams<Contact> | UpdateParams<Contact>,\n  dataProvider: DataProvider,\n): Promise<CreateParams<Contact> | UpdateParams<Contact>> {\n  const { data } = params;\n  const newData = { ...data };\n\n  if (!newData.company_id) {\n    return params;\n  }\n\n  const { data: company } = await dataProvider.getOne(\"companies\", {\n    id: newData.company_id,\n  });\n\n  if (!company) {\n    return params;\n  }\n\n  newData.company_name = company.name;\n  return { ...params, data: newData };\n}\n\nconst dataProviderWithCustomMethod: CrmDataProvider = {\n  ...baseDataProvider,\n  unarchiveDeal: async (deal: Deal) => {\n    // get all deals where stage is the same as the deal to unarchive\n    const { data: deals } = await baseDataProvider.getList<Deal>(\"deals\", {\n      filter: { stage: deal.stage },\n      pagination: { page: 1, perPage: 1000 },\n      sort: { field: \"index\", order: \"ASC\" },\n    });\n\n    // set index for each deal starting from 1, if the deal to unarchive is found, set its index to the last one\n    const updatedDeals = deals.map((d, index) => ({\n      ...d,\n      index: d.id === deal.id ? 0 : index + 1,\n      archived_at: d.id === deal.id ? null : d.archived_at,\n    }));\n\n    return await Promise.all(\n      updatedDeals.map((updatedDeal) =>\n        dataProvider.update(\"deals\", {\n          id: updatedDeal.id,\n          data: updatedDeal,\n          previousData: deals.find((d) => d.id === updatedDeal.id),\n        }),\n      ),\n    );\n  },\n  // We simulate a remote endpoint that is in charge of returning activity log\n  getActivityLog: async (companyId?: Identifier) => {\n    return getActivityLog(dataProvider, companyId);\n  },\n  signUp: async ({\n    email,\n    password,\n    first_name,\n    last_name,\n  }: SignUpData): Promise<{ id: string; email: string; password: string }> => {\n    const user = await baseDataProvider.create(\"sales\", {\n      data: {\n        email,\n        first_name,\n        last_name,\n      },\n    });\n\n    return {\n      ...user.data,\n      password,\n    };\n  },\n  salesCreate: async ({ ...data }: SalesFormData): Promise<Sale> => {\n    const user = await dataProvider.create(\"sales\", {\n      data: {\n        ...data,\n        password: \"new_password\",\n      },\n    });\n\n    return {\n      ...user.data,\n    };\n  },\n  salesUpdate: async (\n    id: Identifier,\n    data: Partial<Omit<SalesFormData, \"password\">>,\n  ): Promise<Partial<Omit<SalesFormData, \"password\">>> => {\n    const { data: previousData } = await dataProvider.getOne<Sale>(\"sales\", {\n      id,\n    });\n\n    if (!previousData) {\n      throw new Error(\"User not found\");\n    }\n\n    const { data: sale } = await dataProvider.update(\"sales\", {\n      id,\n      data,\n      previousData,\n    });\n    return sale;\n  },\n  isInitialized: async (): Promise<boolean> => {\n    const sales = await dataProvider.getList<Sale>(\"sales\", {\n      filter: {},\n      pagination: { page: 1, perPage: 1 },\n      sort: { field: \"id\", order: \"ASC\" },\n    });\n    if (sales.data.length === 0) {\n      return false;\n    }\n    return true;\n  },\n  updatePassword: async (id: Identifier): Promise<true> => {\n    const currentUser = await authProvider.getIdentity?.();\n    if (!currentUser) {\n      throw new Error(\"User not found\");\n    }\n    const { data: previousData } = await dataProvider.getOne<Sale>(\"sales\", {\n      id: currentUser.id,\n    });\n\n    if (!previousData) {\n      throw new Error(\"User not found\");\n    }\n\n    await dataProvider.update(\"sales\", {\n      id,\n      data: {\n        password: \"demo_newPassword\",\n      },\n      previousData,\n    });\n\n    return true;\n  },\n  mergeContacts: async (sourceId: Identifier, targetId: Identifier) => {\n    return mergeContacts(sourceId, targetId, baseDataProvider);\n  },\n  mergeCompanies: async (sourceId: Identifier, targetId: Identifier) => {\n    return mergeCompanies(sourceId, targetId, baseDataProvider);\n  },\n};\n\nasync function updateCompany(\n  companyId: Identifier,\n  updateFn: (company: Company) => Partial<Company>,\n) {\n  const { data: company } = await dataProvider.getOne<Company>(\"companies\", {\n    id: companyId,\n  });\n\n  return await dataProvider.update(\"companies\", {\n    id: companyId,\n    data: {\n      ...updateFn(company),\n    },\n    previousData: company,\n  });\n}\n\nexport const dataProvider = withLifecycleCallbacks(\n  withSupabaseFilterAdapter(dataProviderWithCustomMethod),\n  [\n    {\n      resource: \"sales\",\n      beforeCreate: async (params) => {\n        const { data } = params;\n        // If administrator role is not set, we simply set it to false\n        if (data.administrator == null) {\n          data.administrator = false;\n        }\n        return params;\n      },\n      afterSave: async (data) => {\n        // Since the current user is stored in localStorage in fakerest authProvider\n        // we need to update it to keep information up to date in the UI\n        const currentUser = await authProvider.getIdentity?.();\n        if (currentUser?.id === data.id) {\n          localStorage.setItem(USER_STORAGE_KEY, JSON.stringify(data));\n        }\n        return data;\n      },\n      beforeDelete: async (params) => {\n        if (params.meta?.identity?.id == null) {\n          throw new Error(\"Identity MUST be set in meta\");\n        }\n\n        const newSaleId = params.meta.identity.id as Identifier;\n\n        const [companies, contacts, contactNotes, deals] = await Promise.all([\n          dataProvider.getList(\"companies\", {\n            filter: { sales_id: params.id },\n            pagination: {\n              page: 1,\n              perPage: 10_000,\n            },\n            sort: { field: \"id\", order: \"ASC\" },\n          }),\n          dataProvider.getList(\"contacts\", {\n            filter: { sales_id: params.id },\n            pagination: {\n              page: 1,\n              perPage: 10_000,\n            },\n            sort: { field: \"id\", order: \"ASC\" },\n          }),\n          dataProvider.getList(\"contactNotes\", {\n            filter: { sales_id: params.id },\n            pagination: {\n              page: 1,\n              perPage: 10_000,\n            },\n            sort: { field: \"id\", order: \"ASC\" },\n          }),\n          dataProvider.getList(\"deals\", {\n            filter: { sales_id: params.id },\n            pagination: {\n              page: 1,\n              perPage: 10_000,\n            },\n            sort: { field: \"id\", order: \"ASC\" },\n          }),\n        ]);\n\n        await Promise.all([\n          dataProvider.updateMany(\"companies\", {\n            ids: companies.data.map((company) => company.id),\n            data: {\n              sales_id: newSaleId,\n            },\n          }),\n          dataProvider.updateMany(\"contacts\", {\n            ids: contacts.data.map((company) => company.id),\n            data: {\n              sales_id: newSaleId,\n            },\n          }),\n          dataProvider.updateMany(\"contactNotes\", {\n            ids: contactNotes.data.map((company) => company.id),\n            data: {\n              sales_id: newSaleId,\n            },\n          }),\n          dataProvider.updateMany(\"deals\", {\n            ids: deals.data.map((company) => company.id),\n            data: {\n              sales_id: newSaleId,\n            },\n          }),\n        ]);\n\n        return params;\n      },\n    } satisfies ResourceCallbacks<Sale>,\n    {\n      resource: \"contacts\",\n      beforeCreate: async (params, dataProvider) => {\n        const newParams = await processContactAvatar(params);\n        return fetchAndUpdateCompanyData(newParams, dataProvider);\n      },\n      afterCreate: async (result) => {\n        if (result.data.company_id != null) {\n          await updateCompany(result.data.company_id, (company) => ({\n            nb_contacts: (company.nb_contacts ?? 0) + 1,\n          }));\n        }\n\n        return result;\n      },\n      beforeUpdate: async (params) => {\n        const newParams = await processContactAvatar(params);\n        return fetchAndUpdateCompanyData(newParams, dataProvider);\n      },\n      afterDelete: async (result) => {\n        if (result.data.company_id != null) {\n          await updateCompany(result.data.company_id, (company) => ({\n            nb_contacts: (company.nb_contacts ?? 1) - 1,\n          }));\n        }\n\n        return result;\n      },\n    } satisfies ResourceCallbacks<Contact>,\n    {\n      resource: \"tasks\",\n      afterCreate: async (result, dataProvider) => {\n        // update the task count in the related contact\n        const { contact_id } = result.data;\n        const { data: contact } = await dataProvider.getOne(\"contacts\", {\n          id: contact_id,\n        });\n        await dataProvider.update(\"contacts\", {\n          id: contact_id,\n          data: {\n            nb_tasks: (contact.nb_tasks ?? 0) + 1,\n          },\n          previousData: contact,\n        });\n        return result;\n      },\n      beforeUpdate: async (params) => {\n        const { data, previousData } = params;\n        if (previousData.done_date !== data.done_date) {\n          taskUpdateType = data.done_date\n            ? TASK_MARKED_AS_DONE\n            : TASK_MARKED_AS_UNDONE;\n        } else {\n          taskUpdateType = TASK_DONE_NOT_CHANGED;\n        }\n        return params;\n      },\n      afterUpdate: async (result, dataProvider) => {\n        // update the contact: if the task is done, decrement the nb tasks, otherwise increment it\n        const { contact_id } = result.data;\n        const { data: contact } = await dataProvider.getOne(\"contacts\", {\n          id: contact_id,\n        });\n        if (taskUpdateType !== TASK_DONE_NOT_CHANGED) {\n          await dataProvider.update(\"contacts\", {\n            id: contact_id,\n            data: {\n              nb_tasks:\n                taskUpdateType === TASK_MARKED_AS_DONE\n                  ? (contact.nb_tasks ?? 0) - 1\n                  : (contact.nb_tasks ?? 0) + 1,\n            },\n            previousData: contact,\n          });\n        }\n        return result;\n      },\n      afterDelete: async (result, dataProvider) => {\n        // update the task count in the related contact\n        const { contact_id } = result.data;\n        const { data: contact } = await dataProvider.getOne(\"contacts\", {\n          id: contact_id,\n        });\n        await dataProvider.update(\"contacts\", {\n          id: contact_id,\n          data: {\n            nb_tasks: (contact.nb_tasks ?? 0) - 1,\n          },\n          previousData: contact,\n        });\n        return result;\n      },\n    } satisfies ResourceCallbacks<Task>,\n    {\n      resource: \"companies\",\n      beforeCreate: async (params) => {\n        const createParams = await processCompanyLogo(params);\n\n        return {\n          ...createParams,\n          data: {\n            ...createParams.data,\n            created_at: new Date().toISOString(),\n          },\n        };\n      },\n      beforeUpdate: async (params) => {\n        return await processCompanyLogo(params);\n      },\n      afterUpdate: async (result, dataProvider) => {\n        // get all contacts of the company and for each contact, update the company_name\n        const { id, name } = result.data;\n        const { data: contacts } = await dataProvider.getList(\"contacts\", {\n          filter: { company_id: id },\n          pagination: { page: 1, perPage: 1000 },\n          sort: { field: \"id\", order: \"ASC\" },\n        });\n\n        const contactIds = contacts.map((contact) => contact.id);\n        await dataProvider.updateMany(\"contacts\", {\n          ids: contactIds,\n          data: { company_name: name },\n        });\n        return result;\n      },\n    } satisfies ResourceCallbacks<Company>,\n    {\n      resource: \"deals\",\n      beforeCreate: async (params) => {\n        return {\n          ...params,\n          data: {\n            ...params.data,\n            created_at: new Date().toISOString(),\n            updated_at: new Date().toISOString(),\n          },\n        };\n      },\n      afterCreate: async (result) => {\n        await updateCompany(result.data.company_id, (company) => ({\n          nb_deals: (company.nb_deals ?? 0) + 1,\n        }));\n\n        return result;\n      },\n      beforeUpdate: async (params) => {\n        return {\n          ...params,\n          data: {\n            ...params.data,\n            updated_at: new Date().toISOString(),\n          },\n        };\n      },\n      afterDelete: async (result) => {\n        await updateCompany(result.data.company_id, (company) => ({\n          nb_deals: (company.nb_deals ?? 1) - 1,\n        }));\n\n        return result;\n      },\n    } satisfies ResourceCallbacks<Deal>,\n  ],\n);\n\n/**\n * Convert a `File` object returned by the upload input into a base 64 string.\n * That's not the most optimized way to store images in production, but it's\n * enough to illustrate the idea of dataprovider decoration.\n */\nconst convertFileToBase64 = (file: { rawFile: Blob }) =>\n  new Promise((resolve, reject) => {\n    const reader = new FileReader();\n    reader.onload = () => resolve(reader.result);\n    reader.onerror = reject;\n    reader.readAsDataURL(file.rawFile);\n  });\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/authProvider.ts",
      "content": "import type { AuthProvider } from \"ra-core\";\n\nimport type { Sale } from \"../../types\";\nimport { canAccess } from \"../commons/canAccess\";\nimport { dataProvider } from \"./dataProvider\";\n\nexport const DEFAULT_USER = {\n  id: 0,\n  first_name: \"Jane\",\n  last_name: \"Doe\",\n  email: \"janedoe@atomic.dev\",\n  password: \"demo\",\n  administrator: true,\n  avatar: {\n    src: \"data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEASABIAAD/4gKgSUNDX1BST0ZJTEUAAQEAAAKQbGNtcwQwAABtbnRyUkdCIFhZWiAH3wAIABMAEgAWADFhY3NwQVBQTAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA9tYAAQAAAADTLWxjbXMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAtkZXNjAAABCAAAADhjcHJ0AAABQAAAAE53dHB0AAABkAAAABRjaGFkAAABpAAAACxyWFlaAAAB0AAAABRiWFlaAAAB5AAAABRnWFlaAAAB+AAAABRyVFJDAAACDAAAACBnVFJDAAACLAAAACBiVFJDAAACTAAAACBjaHJtAAACbAAAACRtbHVjAAAAAAAAAAEAAAAMZW5VUwAAABwAAAAcAHMAUgBHAEIAIABiAHUAaQBsAHQALQBpAG4AAG1sdWMAAAAAAAAAAQAAAAxlblVTAAAAMgAAABwATgBvACAAYwBvAHAAeQByAGkAZwBoAHQALAAgAHUAcwBlACAAZgByAGUAZQBsAHkAAAAAWFlaIAAAAAAAAPbWAAEAAAAA0y1zZjMyAAAAAAABDEoAAAXj///zKgAAB5sAAP2H///7ov///aMAAAPYAADAlFhZWiAAAAAAAABvlAAAOO4AAAOQWFlaIAAAAAAAACSdAAAPgwAAtr5YWVogAAAAAAAAYqUAALeQAAAY3nBhcmEAAAAAAAMAAAACZmYAAPKnAAANWQAAE9AAAApbcGFyYQAAAAAAAwAAAAJmZgAA8qcAAA1ZAAAT0AAACltwYXJhAAAAAAADAAAAAmZmAADypwAADVkAABPQAAAKW2Nocm0AAAAAAAMAAAAAo9cAAFR7AABMzQAAmZoAACZmAAAPXP/bAEMACAYGBwYFCAcHBwkJCAoMFA0MCwsMGRITDxQdGh8eHRocHCAkLicgIiwjHBwoNyksMDE0NDQfJzk9ODI8LjM0Mv/bAEMBCQkJDAsMGA0NGDIhHCEyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMv/AABEIAIAAgAMBIgACEQEDEQH/xAAcAAABBAMBAAAAAAAAAAAAAAABAAUGBwIDBAj/xAA2EAABAwMBBgMHAwQDAQAAAAABAAIDBAUREgYTITFBUSJxgRQyYZGxwdEHQqEkUmLhFRYjkv/EABoBAAIDAQEAAAAAAAAAAAAAAAIDAAEEBQb/xAAkEQACAgIDAAEEAwAAAAAAAAAAAQIRAyEEEjETBSJRcTJBYf/aAAwDAQACEQMRAD8AuIIoIogAooIqygorB72xsc97g1rRkk9FFrlfnVD3Rwu0Qj5uQyko+hRi5eEjlr6aEkOlBI6N4rSbpCG6j4R0zzPoFEIpZpn+Ahv+TuJ9E9Qtipodc0haD15ud5BI+Vsb8aXoq/a6GgJ1UsrgBknTj6rgp/1JtEkgjnbNTk9Xxkt/+m5Cbrvbam9sc2XeU9G0jTFry6Q9M/hddk/T6kpId7UwNmqJCOBOGxjoD3KLvIroiX0VxprhCJaeVr2njlpyutR+k2dlttQZ4KwMZpwIGjwD5lbI785leaSppZWHmJG+JpHfKYppgOLQ9pIAhwBHIpIwBJFJBQhgiEAiFRYQkgmzaCuNDaZHsOJHeBvmVG6VkSt0Me0l93spoqY5Y0+N3Qn8JgjdrcA3xOPU9f8AS485Jy4c8ucep/CzirNBIh4D9zz1WGU7dmyMElRIIXspeBw+fGeJ4N8/wtsEstTUtHFzz1Pb7BNVHvJQA0EAnOo83fH/AGpBR7qniw14yfekz9+qFMNxHiljYwjhqc3kTxPxwnaIZA+6ZoJWDGhjnZ68gnaEvewftHw4BOixTVGc2GsOdI4c3KFXmSuq75Rw0kQ3EWZKieQaQG8g0D4n7KauaGgiNu8eeJJPBN89JLUN8btWg5HDAL++OwUZSMbTWxV9vZNFqxyIcMEELuTdTBtNUbiP3A0D5BOC0QdozzVMWUksoIwTBFBIKEMlFdtJSIKaMHHEuKlKg+3Ly6rgizhugl3wHVLyv7WMxK5Ih8k2+IAJEecNGeLvj5LvoossDsZHl9E2x6ZZNTvDGPp2WFde45P6WlqI4tPAZIGT6rAb0vwSiOox4RgA+84nn6ruiuAhLdA1n+5x5Kt6SsrYagtqqkyuJ8Jxj+FLpIql9qM0b9GW8Ceioaoa2TigrXStDsMb8SOKeYtUgGpxLe5+wVQ2eouftIabs52T7ugHPqrOtNNX7gb+r3zSPE1zNJPljknQaehGSFDo6piax5Em7iZ78h+gXJV1OId7lzIgzIYOePyue4QvxGGs8OsAN6D/ACPfH1QinirgZmODoi4Mb5BFYlqjfSsc58kjxgkN4dua61wWWqFbb2VGCDM4uAPMN6LsJ4p+LwRlM8pZWGUU0UBFYhFUWFV/t0S67xR8muhGT8MqwFDNvKJz4IqxgyWjQ49uyXl3EbidSKxrp31VWaKnJaxoySO6aX7INZG9swlcHuD3OyMkjlxKdLWA2uqJH/3NH8KRVNWz2XJ7LCm1tHSUIyWyL0NvdC6CnBeQHjRqOSB2VwVdnd/1YwRt/wDQx8Pkq4sX9XdoXubpZrGCeo7q7i3eW0OjbqLW8B3RRjdkm+tJHn6usdbV1JY6rnpmBww5jT4QPLn6q09jLdcKBsRgv0lZSFgaaaoYXBuBza4kuB7g5HwCa6y50tRWvi3ZjeHYc1wwQVMdm42NaC3lhXBu6JkikuzHS4QuNuqCPf3biPPCqj9OdonubHa6txLyXkPJ65JH1x6K27tKYrXVPAyRE/A7nBVE7OUEtJtDSs0k6JwHO8zghMemZ6bjZcdqjZT0jo2DAY4tC68rVBHuosY4klx81sWnGqiYcjuRkllAIhGCBFBFUWFc9dSR11FLTyDLXtI8l0BJUXZRt4tNRZ7hPFI3Trw5p6HHBcEk0jgwO93l6q3tsrJ/y1oL4WZqYTqZ8R1H0VRVEDKqikgkaQRkdiCsOWHWR0+Pk7RFRzVNHXQmNwc1pHAHBVq2m+19QIzTgMhaMFsjclx+ap2wW6gn3dNXvqIpA7G+DstcB9CrVtVqsVDa4Zpa2eUmPIDS4knIzgD4FUou9Dvtqpe/oZ9qrfUR1Elw3ZDy7UeGAVKtibgKi3skzwPDj0KiV7ornc6xk8EtdTW+QhraSZ+S49SW8cAeamWzlsFupBG39ztXkotSKl/CmO21N3pbLs7U3GtL/Z4tOsMGScuAwB6qK7JUrbs1t6ex+5kOuESBoceJ4uDeGfJP+1NpO0NLSWyRgNE6cS1Rzza3iGjzOPknKCnipadkEEbY4o2hrWtGAAFojj7O2YJ5eq6oyKCywlhaTIBEJJKEMQigEVRYUViioQJAIIPVVrtzYW0FY2507cQVLtMoH7X9/X6hWVlcl0pKWvtlRTVuPZ3sOs5xpxx1A9COaDJDtGhuKbhKyjW2uT2newSuZq544g+in2ytGYpGzTPMj28WgNAwofRV0cFU6F7w5oOGudw1DoVPbRdKCBrdU0eojg1pyT6BYbr+zsd5dKRIvZN6/ey4yPhyXRTx+PDeXfssaZz6wBzssj6N6nzTiyJrAABgI1vaMrdaZp06SQTniktkvv5WtbIO4o5+RVJgwkikjAAkigVCGsJZWuSaOGMySvaxg5uccAJiqtqqeNxbSxOmP9x8I/KCU4x9DjCUvESIJuvG0Fp2fp2zXWvhpWPzo3h4uxzwBxKi1XtTcJGnS5sDe7Bx+ZVD7WX+p2gvs1TNM+VkZ3cOp2fCD9+amOayPReTG4LZaF2/XVjKmRlotTZIG5DZal5Bce+kch5lcLNqL5erSJrhXPd7SNRiYA2No6AAKocHGOqs21NJs1K3HERgfwg5T6xSQzixTk2zAtEziCn6wwbmoa4DHHoE1tgO9BA9FJLfTua0ODeK5sjpw0WFaagua0Ek+akAcC3KiNnbI0AkKTsfiLJTsb0IyrZue3U3yULuW39stV+fbKlkmmMAPmZ4sPPTCeNoL9HZbPUVbiCWN8I7novPE9TLVVktTM4ukkLnuJ6kldPg4fkk2/DncyfSKr09C2zaizXZzI6SvidM/lE7wv8AkU7rznsdUvG1Nvbk5FWz6r0O2XuPkj5EYYpJJ+isPfIm6NqCQcDySSk0/A2mvStrpepLtWu0kimYcRt+5+K1sZlqa6LmMp13ga1cuUnJ2zrQioqkM21VULfs7VzA4foLWeZ4fdUnjAHmrI/Uiv8A6OmpQffeXkfAD8lVyBlkY75K6XDhWO/yc7ly++vwGMZljGM5I+qvWlpab2eMNiDQGjgAqNb4J2EftwR6cV6Et0Daihp5WjwyRtcPUIebGkhnCabZjTWykmOHsHDkU7U9BHF7ucLXFTljuSc4W8srnUb26OmmeI2Dgt7qzIw44C1BgwmLaq7w2a0S1Dj4sYYM8S7oEyKb0hcmvWRD9S9pI6qaCz0rsiM7ydw79B6c/kq/Mni7cM/RYmd9XUyVEpJe4l7s9StD3nWT105+y9NxsXw4lE8/nyfLkch32Lk07X21zjw3+r5L0HHUa25yvPWxzc7YW9nYk/wVdrKgsAHRcn6lKpx/R0+BG4N/6P8AFL4hxTg2IvZkc1HqSoy8EqUUUgfGFjxt3o0ZUq2f/9k=\",\n  },\n} as const;\n\nexport const USER_STORAGE_KEY = \"user\";\n\nlocalStorage.setItem(USER_STORAGE_KEY, JSON.stringify({ ...DEFAULT_USER }));\n\nasync function getUser(email: string) {\n  const sales = await dataProvider.getList(\"sales\", {\n    pagination: { page: 1, perPage: 200 },\n    sort: { field: \"name\", order: \"ASC\" },\n  });\n\n  if (!sales.data.length) {\n    return { ...DEFAULT_USER };\n  }\n\n  const user = sales.data.find((sale) => sale.email === email);\n  if (!user || user.disabled) {\n    return { ...DEFAULT_USER };\n  }\n  return user;\n}\n\nexport const authProvider: AuthProvider = {\n  login: async ({ email }) => {\n    const user = await getUser(email);\n    localStorage.setItem(USER_STORAGE_KEY, JSON.stringify(user));\n    return Promise.resolve();\n  },\n  logout: () => {\n    localStorage.removeItem(USER_STORAGE_KEY);\n    return Promise.resolve();\n  },\n  checkError: () => Promise.resolve(),\n  checkAuth: () =>\n    localStorage.getItem(USER_STORAGE_KEY)\n      ? Promise.resolve()\n      : Promise.reject(),\n  canAccess: async ({ signal: _signal, ...params }) => {\n    // Get the current user\n    const userItem = localStorage.getItem(USER_STORAGE_KEY);\n    const localUser = userItem ? (JSON.parse(userItem) as Sale) : null;\n    if (!localUser) return false;\n\n    // Compute access rights from the sale role\n    const role = localUser.administrator ? \"admin\" : \"user\";\n    return canAccess(role, params);\n  },\n  getIdentity: () => {\n    const userItem = localStorage.getItem(USER_STORAGE_KEY);\n    const user = userItem ? (JSON.parse(userItem) as Sale) : null;\n    return Promise.resolve({\n      id: user?.id ?? 0,\n      fullName: user ? `${user.first_name} ${user.last_name}` : \"Jane Doe\",\n      avatar: user?.avatar?.src,\n    });\n  },\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/internal/transformOrFilter.ts",
      "content": "import isObject from \"lodash/isObject\";\n\n// @or filter is an equivaluent of fakerest `q=`\nexport function transformOrFilter(values: any) {\n  if (!isObject(values) || Array.isArray(values)) {\n    throw new Error(\n      \"Invalid '@or' filter, expected an object as first element\",\n    );\n  }\n\n  const queries = Object.values(values);\n  if (queries.length === 0) {\n    throw new Error(\"Invalid '@or' filter, object is empty\");\n  }\n\n  return queries[0];\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/internal/transformOrFilter.spec.ts",
      "content": "import { transformOrFilter } from \"./transformOrFilter\";\n\nit(\"should throw an error if the value is not an object\", () => {\n  expect(() => transformOrFilter([])).toThrow(\n    \"Invalid '@or' filter, expected an object\",\n  );\n});\n\nit(\"should throw an error if the object is empty\", () => {\n  expect(() => transformOrFilter({})).toThrow(\n    \"Invalid '@or' filter, object is empty\",\n  );\n});\n\nit(\"should return the query value\", () => {\n  expect(transformOrFilter({ \"last_name@ilike\": \"one\" })).toEqual(\"one\");\n  expect(\n    transformOrFilter({\n      \"last_name@ilike\": \"one\",\n      \"first_name@ilike\": \"one\",\n    }),\n  ).toEqual(\"one\");\n});\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/internal/transformInFilter.ts",
      "content": "import { LIST_REGEX_BASE, parseList } from \"./listParser\";\n\nexport const IN_FILTER_REGEX = new RegExp(`^\\\\(${LIST_REGEX_BASE}\\\\)$`);\n\nexport function transformInFilter(value: any) {\n  if (value === \"()\") {\n    return [];\n  }\n\n  if (typeof value !== \"string\" || !value.match(IN_FILTER_REGEX)) {\n    throw new Error(\n      `Invalid '@in' filter value, expected a string matching '${IN_FILTER_REGEX.source}', got: ${value}`,\n    );\n  }\n\n  return parseList(value.slice(1, -1));\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/internal/transformInFilter.spec.ts",
      "content": "import { IN_FILTER_REGEX, transformInFilter } from \"./transformInFilter\";\n\nit(\"should throw an error if the filter is not a string\", () => {\n  expect(() => transformInFilter(1)).toThrow(\n    `Invalid '@in' filter value, expected a string matching '${IN_FILTER_REGEX.source}', got: 1`,\n  );\n});\n\nit(\"should throw an error if the filter does not match pattern\", () => {\n  expect(() => transformInFilter(\"1,2\")).toThrow(\n    `Invalid '@in' filter value, expected a string matching '${IN_FILTER_REGEX.source}', got: 1,2`,\n  );\n});\n\nit(\"should support empty arrays\", () => {\n  expect(transformInFilter(\"()\")).toEqual([]);\n});\n\nit(\"should return an array of numbers\", () => {\n  expect(transformInFilter(\"(1)\")).toEqual([1]);\n  expect(transformInFilter(\"(1,2,3)\")).toEqual([1, 2, 3]);\n});\n\nit(\"should return an array of strings\", () => {\n  expect(transformInFilter(\"(a)\")).toEqual([\"a\"]);\n  expect(transformInFilter(\"(a,B,c-d)\")).toEqual([\"a\", \"B\", \"c-d\"]);\n});\n\nit(\"should return an array of quoted strings\", () => {\n  expect(transformInFilter('(\"a\")')).toEqual([\"a\"]);\n  expect(transformInFilter('(\"a\",\"B, c\")')).toEqual([\"a\", \"B, c\"]);\n});\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/internal/transformFilter.ts",
      "content": "import { transformContainsFilter } from \"./transformContainsFilter\";\nimport { transformInFilter } from \"./transformInFilter\";\nimport { transformOrFilter } from \"./transformOrFilter\";\n\nexport function transformFilter(filter: Record<string, any>) {\n  if (!filter) {\n    return undefined;\n  }\n  const transformedFilters: Record<string, any> = {};\n  for (const [key, value] of Object.entries(filter)) {\n    if (\n      key.endsWith(\"@eq\") ||\n      key.endsWith(\"@neq\") ||\n      key.endsWith(\"@lt\") ||\n      key.endsWith(\"@lte\") ||\n      key.endsWith(\"@gt\") ||\n      key.endsWith(\"@gte\")\n    ) {\n      const lastIndexOfAt = key.lastIndexOf(\"@\");\n      transformedFilters[\n        `${key.substring(0, lastIndexOfAt)}_${key.substring(lastIndexOfAt + 1)}`\n      ] = value;\n      continue;\n    }\n\n    if (key.endsWith(\"@is\")) {\n      transformedFilters[`${key.slice(0, -3)}_eq`] = value;\n      continue;\n    }\n\n    if (key.endsWith(\"@not.is\")) {\n      transformedFilters[`${key.slice(0, -7)}_neq`] = value;\n      continue;\n    }\n\n    if (key.endsWith(\"@in\")) {\n      transformedFilters[`${key.slice(0, -3)}_eq_any`] =\n        transformInFilter(value);\n      continue;\n    }\n\n    if (key.endsWith(\"@cs\")) {\n      transformedFilters[`${key.slice(0, -3)}`] =\n        transformContainsFilter(value);\n      continue;\n    }\n\n    // Search query\n    if (key.endsWith(\"@or\")) {\n      transformedFilters[\"q\"] = transformOrFilter(value);\n      continue;\n    }\n\n    transformedFilters[key] = value;\n  }\n  return transformedFilters;\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/internal/transformContainsFilter.ts",
      "content": "import { LIST_REGEX_BASE, parseList } from \"./listParser\";\n\nexport const CONTAINS_FILTER_REGEX = new RegExp(`^\\\\{${LIST_REGEX_BASE}\\\\}$`);\n\nexport function transformContainsFilter(value: any) {\n  if (value === \"{}\") {\n    return [];\n  }\n\n  if (typeof value !== \"string\" || !value.match(CONTAINS_FILTER_REGEX)) {\n    throw new Error(\n      `Invalid '@cs' filter value, expected a string matching '${CONTAINS_FILTER_REGEX.source}', got: ${value}`,\n    );\n  }\n\n  return parseList(value.slice(1, -1));\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/internal/transformContainsFilter.spec.ts",
      "content": "import {\n  CONTAINS_FILTER_REGEX,\n  transformContainsFilter,\n} from \"./transformContainsFilter\";\n\nit(\"should throw an error if the filter is not a string\", () => {\n  expect(() => transformContainsFilter(1)).toThrow(\n    `Invalid '@cs' filter value, expected a string matching '${CONTAINS_FILTER_REGEX.source}', got: 1`,\n  );\n});\n\nit(\"should throw an error if the filter does not match pattern\", () => {\n  expect(() => transformContainsFilter(\"1,2\")).toThrow(\n    `Invalid '@cs' filter value, expected a string matching '${CONTAINS_FILTER_REGEX.source}', got: 1,2`,\n  );\n});\n\nit(\"should support empty arrays\", () => {\n  expect(transformContainsFilter(\"{}\")).toEqual([]);\n});\n\nit(\"should return an array of numbers\", () => {\n  expect(transformContainsFilter(\"{1}\")).toEqual([1]);\n  expect(transformContainsFilter(\"{1,2,3}\")).toEqual([1, 2, 3]);\n});\n\nit(\"should return an array of strings\", () => {\n  expect(transformContainsFilter(\"{a}\")).toEqual([\"a\"]);\n  expect(transformContainsFilter(\"{a,B,c-d}\")).toEqual([\"a\", \"B\", \"c-d\"]);\n});\n\nit(\"should return an array of quoted strings\", () => {\n  expect(transformContainsFilter('{\"a\"}')).toEqual([\"a\"]);\n  expect(transformContainsFilter('{\"a\",\"B, c\"}')).toEqual([\"a\", \"B, c\"]);\n});\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/internal/supabaseAdapter.ts",
      "content": "import type { DataProvider } from \"ra-core\";\nimport { transformFilter } from \"./transformFilter\";\n\nfunction removeSummarySuffix(resource: string) {\n  return resource.endsWith(\"_summary\")\n    ? resource.replace(\"_summary\", \"\")\n    : resource;\n}\n\nexport function withSupabaseFilterAdapter<T extends DataProvider>(\n  dataProvider: T,\n): T {\n  return {\n    ...dataProvider,\n    getOne(resource, params) {\n      return dataProvider.getOne(removeSummarySuffix(resource), params);\n    },\n    getList(resource, params) {\n      return dataProvider.getList(removeSummarySuffix(resource), {\n        ...params,\n        filter: transformFilter(params.filter),\n      });\n    },\n    getMany(resource, params) {\n      return dataProvider.getMany(removeSummarySuffix(resource), params);\n    },\n    getManyReference(resource, params) {\n      return dataProvider.getManyReference(removeSummarySuffix(resource), {\n        ...params,\n        filter: transformFilter(params.filter),\n      });\n    },\n    create(resource, params) {\n      return dataProvider.create(removeSummarySuffix(resource), params);\n    },\n    delete(resource, params) {\n      return dataProvider.delete(removeSummarySuffix(resource), params);\n    },\n    deleteMany(resource, params) {\n      return dataProvider.deleteMany(removeSummarySuffix(resource), params);\n    },\n    update(resource, params) {\n      return dataProvider.update(removeSummarySuffix(resource), params);\n    },\n    updateMany(resource, params) {\n      return dataProvider.updateMany(removeSummarySuffix(resource), params);\n    },\n  };\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/internal/supabaseAdapter.spec.ts",
      "content": "import type { DataProvider } from \"ra-core\";\nimport { withSupabaseFilterAdapter } from \"./supabaseAdapter\";\n\ndescribe(\"getList\", () => {\n  it(\"should transform '@eq'\", () => {\n    const getList = vi.fn();\n    const mockDataProvider = {\n      getList,\n    } as unknown as DataProvider;\n\n    getList.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getList: getListAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getListAdapter(\"resource\", { filter: { \"a@id@eq\": \"1\" } }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getList).toHaveBeenCalledWith(\"resource\", {\n      filter: { \"a@id_eq\": \"1\" },\n    });\n  });\n\n  it(\"should transform '@neq'\", () => {\n    const getList = vi.fn();\n    const mockDataProvider = {\n      getList,\n    } as unknown as DataProvider;\n\n    getList.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getList: getListAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getListAdapter(\"resource\", { filter: { \"a@id@neq\": \"1\" } }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getList).toHaveBeenCalledWith(\"resource\", {\n      filter: { \"a@id_neq\": \"1\" },\n    });\n  });\n\n  it(\"should transform '@eq'\", () => {\n    const getList = vi.fn();\n    const mockDataProvider = {\n      getList,\n    } as unknown as DataProvider;\n\n    getList.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getList: getListAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getListAdapter(\"resource\", { filter: { \"a@id@eq\": \"1\" } }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getList).toHaveBeenCalledWith(\"resource\", {\n      filter: { \"a@id_eq\": \"1\" },\n    });\n  });\n\n  it(\"should transform '@neq'\", () => {\n    const getList = vi.fn();\n    const mockDataProvider = {\n      getList,\n    } as unknown as DataProvider;\n\n    getList.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getList: getListAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getListAdapter(\"resource\", { filter: { \"a@id@neq\": \"1\" } }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getList).toHaveBeenCalledWith(\"resource\", {\n      filter: { \"a@id_neq\": \"1\" },\n    });\n  });\n\n  it(\"should transform '@is'\", () => {\n    const getList = vi.fn();\n    const mockDataProvider = {\n      getList,\n    } as unknown as DataProvider;\n\n    getList.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getList: getListAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getListAdapter(\"resource\", { filter: { \"id@is\": null } }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getList).toHaveBeenCalledWith(\"resource\", {\n      filter: { id_eq: null },\n    });\n  });\n\n  it(\"should transform '@not.is'\", () => {\n    const getList = vi.fn();\n    const mockDataProvider = {\n      getList,\n    } as unknown as DataProvider;\n\n    getList.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getList: getListAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getListAdapter(\"resource\", { filter: { \"id@not.is\": null } }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getList).toHaveBeenCalledWith(\"resource\", {\n      filter: { id_neq: null },\n    });\n  });\n\n  it(\"should transform '@lt'\", () => {\n    const getList = vi.fn();\n    const mockDataProvider = {\n      getList,\n    } as unknown as DataProvider;\n\n    getList.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getList: getListAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getListAdapter(\"resource\", { filter: { \"a@id@lt\": \"1\" } }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getList).toHaveBeenCalledWith(\"resource\", {\n      filter: { \"a@id_lt\": \"1\" },\n    });\n  });\n\n  it(\"should transform '@lte'\", () => {\n    const getList = vi.fn();\n    const mockDataProvider = {\n      getList,\n    } as unknown as DataProvider;\n\n    getList.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getList: getListAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getListAdapter(\"resource\", { filter: { \"a@id@lte\": \"1\" } }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getList).toHaveBeenCalledWith(\"resource\", {\n      filter: { \"a@id_lte\": \"1\" },\n    });\n  });\n\n  it(\"should transform '@gt'\", () => {\n    const getList = vi.fn();\n    const mockDataProvider = {\n      getList,\n    } as unknown as DataProvider;\n\n    getList.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getList: getListAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getListAdapter(\"resource\", { filter: { \"a@id@gt\": \"1\" } }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getList).toHaveBeenCalledWith(\"resource\", {\n      filter: { \"a@id_gt\": \"1\" },\n    });\n  });\n\n  it(\"should transform '@gte'\", () => {\n    const getList = vi.fn();\n    const mockDataProvider = {\n      getList,\n    } as unknown as DataProvider;\n\n    getList.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getList: getListAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getListAdapter(\"resource\", { filter: { \"a@id@gte\": \"1\" } }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getList).toHaveBeenCalledWith(\"resource\", {\n      filter: { \"a@id_gte\": \"1\" },\n    });\n  });\n\n  it(\"should transform '@in'\", () => {\n    const getList = vi.fn();\n    const mockDataProvider = {\n      getList,\n    } as unknown as DataProvider;\n\n    getList.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getList: getListAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getListAdapter(\"resource\", { filter: { \"id@in\": \"(1,2,a)\" } }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getList).toHaveBeenCalledWith(\"resource\", {\n      filter: { id_eq_any: [1, 2, \"a\"] },\n    });\n  });\n\n  it(\"should transform '@cs'\", () => {\n    const getList = vi.fn();\n    const mockDataProvider = {\n      getList,\n    } as unknown as DataProvider;\n\n    getList.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getList: getListAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getListAdapter(\"resource\", { filter: { \"tags@cs\": \"{1,2,a}\" } }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getList).toHaveBeenCalledWith(\"resource\", {\n      filter: { tags: [1, 2, \"a\"] },\n    });\n  });\n\n  it(\"should transform '@or'\", () => {\n    const getList = vi.fn();\n    const mockDataProvider = {\n      getList,\n    } as unknown as DataProvider;\n\n    getList.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getList: getListAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getListAdapter(\"resource\", {\n        filter: { \"@or\": { last_name: \"one\" } },\n      }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getList).toHaveBeenCalledWith(\"resource\", {\n      filter: { q: \"one\" },\n    });\n  });\n\n  it(\"should not transform a filter without operator\", () => {\n    const getList = vi.fn();\n    const mockDataProvider = {\n      getList,\n    } as unknown as DataProvider;\n\n    getList.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getList: getListAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(getListAdapter(\"resource\", { filter: { id: 1 } })).resolves.toEqual([\n      { id: 1 },\n    ]);\n\n    expect(getList).toHaveBeenCalledWith(\"resource\", {\n      filter: { id: 1 },\n    });\n  });\n});\n\ndescribe(\"getManyReference\", () => {\n  it(\"should transform @eq\", () => {\n    const getManyReference = vi.fn();\n    const mockDataProvider = {\n      getManyReference,\n    } as unknown as DataProvider;\n\n    getManyReference.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getManyReference: getManyReferenceAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getManyReferenceAdapter(\"resource\", {\n        id: 1,\n        target: \"target\",\n        pagination: { page: 1, perPage: 10 },\n        sort: { field: \"id\", order: \"ASC\" },\n        filter: { \"a@id@eq\": \"2\" },\n      }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getManyReference).toHaveBeenCalledWith(\"resource\", {\n      id: 1,\n      target: \"target\",\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: { \"a@id_eq\": \"2\" },\n    });\n  });\n\n  it(\"should transform @neq\", () => {\n    const getManyReference = vi.fn();\n    const mockDataProvider = {\n      getManyReference,\n    } as unknown as DataProvider;\n\n    getManyReference.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getManyReference: getManyReferenceAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getManyReferenceAdapter(\"resource\", {\n        id: 1,\n        target: \"target\",\n        pagination: { page: 1, perPage: 10 },\n        sort: { field: \"id\", order: \"ASC\" },\n        filter: { \"a@id@neq\": \"2\" },\n      }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getManyReference).toHaveBeenCalledWith(\"resource\", {\n      id: 1,\n      target: \"target\",\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: { \"a@id_neq\": \"2\" },\n    });\n  });\n\n  it(\"should transform @is\", () => {\n    const getManyReference = vi.fn();\n    const mockDataProvider = {\n      getManyReference,\n    } as unknown as DataProvider;\n\n    getManyReference.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getManyReference: getManyReferenceAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getManyReferenceAdapter(\"resource\", {\n        id: 1,\n        target: \"target\",\n        pagination: { page: 1, perPage: 10 },\n        sort: { field: \"id\", order: \"ASC\" },\n        filter: { \"id@is\": null },\n      }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getManyReference).toHaveBeenCalledWith(\"resource\", {\n      id: 1,\n      target: \"target\",\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: { id_eq: null },\n    });\n  });\n\n  it(\"should transform @not.is\", () => {\n    const getManyReference = vi.fn();\n    const mockDataProvider = {\n      getManyReference,\n    } as unknown as DataProvider;\n\n    getManyReference.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getManyReference: getManyReferenceAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getManyReferenceAdapter(\"resource\", {\n        id: 1,\n        target: \"target\",\n        pagination: { page: 1, perPage: 10 },\n        sort: { field: \"id\", order: \"ASC\" },\n        filter: { \"id@not.is\": null },\n      }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getManyReference).toHaveBeenCalledWith(\"resource\", {\n      id: 1,\n      target: \"target\",\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: { id_neq: null },\n    });\n  });\n\n  it(\"should transform @lt\", () => {\n    const getManyReference = vi.fn();\n    const mockDataProvider = {\n      getManyReference,\n    } as unknown as DataProvider;\n\n    getManyReference.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getManyReference: getManyReferenceAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getManyReferenceAdapter(\"resource\", {\n        id: 1,\n        target: \"target\",\n        pagination: { page: 1, perPage: 10 },\n        sort: { field: \"id\", order: \"ASC\" },\n        filter: { \"a@id@lt\": \"2\" },\n      }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getManyReference).toHaveBeenCalledWith(\"resource\", {\n      id: 1,\n      target: \"target\",\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: { \"a@id_lt\": \"2\" },\n    });\n  });\n\n  it(\"should transform @lte\", () => {\n    const getManyReference = vi.fn();\n    const mockDataProvider = {\n      getManyReference,\n    } as unknown as DataProvider;\n\n    getManyReference.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getManyReference: getManyReferenceAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getManyReferenceAdapter(\"resource\", {\n        id: 1,\n        target: \"target\",\n        pagination: { page: 1, perPage: 10 },\n        sort: { field: \"id\", order: \"ASC\" },\n        filter: { \"a@id@lte\": \"2\" },\n      }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getManyReference).toHaveBeenCalledWith(\"resource\", {\n      id: 1,\n      target: \"target\",\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: { \"a@id_lte\": \"2\" },\n    });\n  });\n\n  it(\"should transform @gt\", () => {\n    const getManyReference = vi.fn();\n    const mockDataProvider = {\n      getManyReference,\n    } as unknown as DataProvider;\n\n    getManyReference.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getManyReference: getManyReferenceAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getManyReferenceAdapter(\"resource\", {\n        id: 1,\n        target: \"target\",\n        pagination: { page: 1, perPage: 10 },\n        sort: { field: \"id\", order: \"ASC\" },\n        filter: { \"a@id@gt\": \"2\" },\n      }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getManyReference).toHaveBeenCalledWith(\"resource\", {\n      id: 1,\n      target: \"target\",\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: { \"a@id_gt\": \"2\" },\n    });\n  });\n\n  it(\"should transform @gte\", () => {\n    const getManyReference = vi.fn();\n    const mockDataProvider = {\n      getManyReference,\n    } as unknown as DataProvider;\n\n    getManyReference.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getManyReference: getManyReferenceAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getManyReferenceAdapter(\"resource\", {\n        id: 1,\n        target: \"target\",\n        pagination: { page: 1, perPage: 10 },\n        sort: { field: \"id\", order: \"ASC\" },\n        filter: { \"a@id@gte\": \"2\" },\n      }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getManyReference).toHaveBeenCalledWith(\"resource\", {\n      id: 1,\n      target: \"target\",\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: { \"a@id_gte\": \"2\" },\n    });\n  });\n\n  it(\"should transform '@in'\", () => {\n    const getManyReference = vi.fn();\n    const mockDataProvider = {\n      getManyReference,\n    } as unknown as DataProvider;\n\n    getManyReference.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getManyReference: getManyReferenceAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getManyReferenceAdapter(\"resource\", {\n        id: 1,\n        target: \"target\",\n        pagination: { page: 1, perPage: 10 },\n        sort: { field: \"id\", order: \"ASC\" },\n        filter: { \"id@in\": \"(1,2,a)\" },\n      }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getManyReference).toHaveBeenCalledWith(\"resource\", {\n      id: 1,\n      target: \"target\",\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: { id_eq_any: [1, 2, \"a\"] },\n    });\n  });\n\n  it(\"should transform '@cs'\", () => {\n    const getManyReference = vi.fn();\n    const mockDataProvider = {\n      getManyReference,\n    } as unknown as DataProvider;\n\n    getManyReference.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getManyReference: getManyReferenceAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getManyReferenceAdapter(\"resource\", {\n        id: 1,\n        target: \"target\",\n        pagination: { page: 1, perPage: 10 },\n        sort: { field: \"id\", order: \"ASC\" },\n        filter: { \"tags@cs\": \"{1,2,a}\" },\n      }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getManyReference).toHaveBeenCalledWith(\"resource\", {\n      id: 1,\n      target: \"target\",\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: { tags: [1, 2, \"a\"] },\n    });\n  });\n\n  it(\"should transform '@or'\", () => {\n    const getManyReference = vi.fn();\n    const mockDataProvider = {\n      getManyReference,\n    } as unknown as DataProvider;\n\n    getManyReference.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getManyReference: getManyReferenceAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getManyReferenceAdapter(\"resource\", {\n        id: 1,\n        target: \"target\",\n        pagination: { page: 1, perPage: 10 },\n        sort: { field: \"id\", order: \"ASC\" },\n        filter: { \"@or\": { last_name: \"one\" } },\n      }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getManyReference).toHaveBeenCalledWith(\"resource\", {\n      id: 1,\n      target: \"target\",\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: { q: \"one\" },\n    });\n  });\n\n  it(\"should not transform a filter without operator\", () => {\n    const getManyReference = vi.fn();\n    const mockDataProvider = {\n      getManyReference,\n    } as unknown as DataProvider;\n\n    getManyReference.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getManyReference: getManyReferenceAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getManyReferenceAdapter(\"resource\", {\n        id: 1,\n        target: \"target\",\n        pagination: { page: 1, perPage: 10 },\n        sort: { field: \"id\", order: \"ASC\" },\n        filter: { id: 2 },\n      }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getManyReference).toHaveBeenCalledWith(\"resource\", {\n      id: 1,\n      target: \"target\",\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: { id: 2 },\n    });\n  });\n});\n\nit(\"should remove summary suffix\", () => {\n  const getOne = vi.fn();\n  const getList = vi.fn();\n  const getMany = vi.fn();\n  const getManyReference = vi.fn();\n  const create = vi.fn();\n  const del = vi.fn();\n  const deleteMany = vi.fn();\n  const update = vi.fn();\n  const updateMany = vi.fn();\n\n  const dataProvider: DataProvider = withSupabaseFilterAdapter({\n    getOne,\n    getList,\n    getMany,\n    getManyReference,\n    create,\n    delete: del,\n    deleteMany,\n    update,\n    updateMany,\n  });\n\n  expect(\n    Promise.all([\n      dataProvider.getOne(\"resource_summary\", { id: 1 }),\n      dataProvider.getList(\"resource_summary\", {\n        pagination: { page: 1, perPage: 10 },\n      }),\n      dataProvider.getMany(\"resource_summary\", { ids: [1] }),\n      dataProvider.getManyReference(\"resource_summary\", {\n        id: 1,\n        target: \"target\",\n        pagination: { page: 1, perPage: 10 },\n        sort: { field: \"id\", order: \"ASC\" },\n        filter: {},\n      }),\n      dataProvider.create(\"resource_summary\", { data: {} }),\n      dataProvider.delete(\"resource_summary\", { id: 1 }),\n      dataProvider.deleteMany(\"resource_summary\", { ids: [1] }),\n      dataProvider.update(\"resource_summary\", {\n        id: 1,\n        data: {},\n        previousData: {},\n      }),\n      dataProvider.updateMany(\"resource_summary\", { ids: [1], data: {} }),\n    ]),\n  ).resolves.toHaveLength(9);\n\n  expect(getOne).toHaveBeenCalledWith(\"resource\", { id: 1 });\n  expect(getList).toHaveBeenCalledWith(\"resource\", {\n    pagination: { page: 1, perPage: 10 },\n    filter: undefined,\n  });\n  expect(getMany).toHaveBeenCalledWith(\"resource\", { ids: [1] });\n  expect(getManyReference).toHaveBeenCalledWith(\"resource\", {\n    id: 1,\n    target: \"target\",\n    pagination: { page: 1, perPage: 10 },\n    sort: { field: \"id\", order: \"ASC\" },\n    filter: {},\n  });\n  expect(create).toHaveBeenCalledWith(\"resource\", { data: {} });\n  expect(del).toHaveBeenCalledWith(\"resource\", { id: 1 });\n  expect(deleteMany).toHaveBeenCalledWith(\"resource\", { ids: [1] });\n  expect(update).toHaveBeenCalledWith(\"resource\", {\n    id: 1,\n    data: {},\n    previousData: {},\n  });\n  expect(updateMany).toHaveBeenCalledWith(\"resource\", { ids: [1], data: {} });\n});\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/internal/listParser.ts",
      "content": "export const UNQUOTED_ALLOWED_CHARS = \"[A-Za-z---0-9-]+\";\nexport const QUOTED_ALLOWED_CHARS = \"[A-Za-z---0-9, -]+\";\nexport const LIST_REGEX_BASE = `(${UNQUOTED_ALLOWED_CHARS}|\"${QUOTED_ALLOWED_CHARS}\")(,(${UNQUOTED_ALLOWED_CHARS}|\"${QUOTED_ALLOWED_CHARS}\"))*`;\n\n/**\n * List represents a list of values, quoted or not.\n *\n * e.g. 1\n * e.g 1,2\n * e.g \"a\",\"b\"\n * e.g \"a\",b\n */\nexport function parseList(list: string) {\n  const parsedItems = [];\n\n  let currentItem = \"\";\n  let currentQuoted = false;\n  for (const char of list) {\n    if (char === \",\") {\n      if (currentQuoted) {\n        currentItem += char;\n        continue;\n      }\n\n      parsedItems.push(currentItem);\n      currentItem = \"\";\n      continue;\n    }\n\n    if (char === '\"') {\n      currentQuoted = !currentQuoted;\n      continue;\n    }\n\n    currentItem += char;\n  }\n  if (currentItem) {\n    parsedItems.push(currentItem);\n  }\n\n  return parsedItems.map((v: string) => {\n    const parsedFloat = Number.parseFloat(v);\n    if (!Number.isNaN(parsedFloat)) {\n      return parsedFloat;\n    }\n    return v;\n  });\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/dataGenerator/utils.ts",
      "content": "import faker from \"faker/locale/en\";\n\nexport const weightedArrayElement = (values: any[], weights: any) =>\n  faker.random.arrayElement(\n    values.reduce(\n      (acc, value, index) => acc.concat(new Array(weights[index]).fill(value)),\n      [],\n    ),\n  );\n\nexport const weightedBoolean = (likelyhood: number) =>\n  faker.datatype.number(99) < likelyhood;\n\nexport const randomDate = (minDate?: Date, maxDate?: Date) => {\n  const minTs =\n    minDate instanceof Date\n      ? minDate.getTime()\n      : Date.now() - 5 * 365 * 24 * 60 * 60 * 1000; // 5 years\n  const maxTs = maxDate instanceof Date ? maxDate.getTime() : Date.now();\n  const range = maxTs - minTs;\n  const randomRange = faker.datatype.number({ max: range });\n  // move it more towards today to account for traffic increase\n  const ts = Math.sqrt(randomRange / range) * range;\n  return new Date(minTs + ts);\n};\n\nexport const randomFloat = (min: number, max: number) =>\n  parseFloat(faker.datatype.number({ min, max, precision: 0.01 }).toFixed(2));\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/dataGenerator/types.ts",
      "content": "import type {\n  Company,\n  CompanyNote,\n  Contact,\n  ContactNote,\n  Deal,\n  DealNote,\n  Sale,\n  Tag,\n  Task,\n  TaskNote,\n  TaskActivity,\n} from \"../../../types\";\n\nexport interface Db {\n  companies: Required<Company>[];\n  companyNotes: CompanyNote[];\n  contacts: Required<Contact>[];\n  contactNotes: ContactNote[];\n  deals: Deal[];\n  dealNotes: DealNote[];\n  sales: Sale[];\n  tags: Tag[];\n  tasks: Task[];\n  taskNotes: TaskNote[];\n  taskActivity: TaskActivity[];\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/dataGenerator/tasks.ts",
      "content": "import { datatype, lorem, random } from \"faker/locale/en_US\";\n\nimport { defaultTaskTypes } from \"../../../root/defaultConfiguration\";\nimport type { Task } from \"../../../types\";\nimport type { Db } from \"./types\";\nimport { randomDate } from \"./utils\";\n\ntype TaskType = (typeof defaultTaskTypes)[number];\n\nexport const type: TaskType[] = [\n  \"Email\",\n  \"Email\",\n  \"Email\",\n  \"Email\",\n  \"Email\",\n  \"Email\",\n  \"Call\",\n  \"Call\",\n  \"Call\",\n  \"Call\",\n  \"Call\",\n  \"Call\",\n  \"Call\",\n  \"Call\",\n  \"Call\",\n  \"Call\",\n  \"Call\",\n  \"Demo\",\n  \"Lunch\",\n  \"Meeting\",\n  \"Follow-up\",\n  \"Follow-up\",\n  \"Thank you\",\n  \"Ship\",\n  \"None\",\n];\n\nexport const generateTasks = (db: Db) => {\n  return Array.from(Array(400).keys()).map<any>((id) => {\n    const contact = random.arrayElement(db.contacts);\n    const company = db.companies.find((c) => c.id === contact.company_id);\n    const creator = db.sales.find((s) => s.id === contact.sales_id);\n    contact.nb_tasks++;\n    \n    const createdDate = randomDate(new Date(contact.first_seen)).toISOString();\n    const dueDate = randomDate(\n      datatype.boolean() ? new Date() : new Date(contact.first_seen),\n      new Date(Date.now() + 100 * 24 * 60 * 60 * 1000),\n    ).toISOString();\n    \n    const isDone = datatype.boolean();\n    const doneDate = isDone ? randomDate(new Date(createdDate)).toISOString() : undefined;\n    \n    return {\n      id,\n      contact_id: contact.id,\n      type: random.arrayElement(defaultTaskTypes),\n      text: lorem.sentence(),\n      due_date: dueDate,\n      done_date: doneDate,\n      sales_id: contact.sales_id,\n      priority: random.arrayElement([\"low\", \"medium\", \"high\", \"urgent\"]),\n      assigned_to: contact.sales_id,\n      status: isDone ? \"done\" : \"todo\",\n      created_at: createdDate,\n      updated_at: createdDate,\n      archived: false,\n      \n      // Denormalized fields for TaskSummary simulation\n      contact_first_name: contact.first_name,\n      contact_last_name: contact.last_name,\n      contact_email: contact.email_jsonb?.[0]?.email,\n      company_id: contact.company_id,\n      company_name: company?.name,\n      creator_first_name: creator?.first_name,\n      creator_last_name: creator?.last_name,\n      assigned_first_name: creator?.first_name,\n      assigned_last_name: creator?.last_name,\n    };\n  });\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/dataGenerator/taskNotes.ts",
      "content": "import { lorem } from \"faker/locale/en_US\";\nimport type { TaskNote } from \"../../../types\";\nimport type { Db } from \"./types\";\nimport { randomDate } from \"./utils\";\n\nexport const generateTaskNotes = (db: Db): TaskNote[] => {\n  const taskNotes: TaskNote[] = [];\n  let id = 0;\n\n  db.tasks.forEach((task) => {\n    // Generate 0-3 notes per task\n    const noteCount = Math.floor(Math.random() * 4);\n    for (let i = 0; i < noteCount; i++) {\n        const date = randomDate(new Date(task.created_at || new Date()));\n        taskNotes.push({\n            id: id++,\n            task_id: task.id,\n            text: lorem.paragraph(),\n            date: date.toISOString(),\n            sales_id: task.sales_id || db.sales[0].id,\n            status: [\"cold\", \"warm\", \"hot\"][Math.floor(Math.random() * 3)],\n            created_at: date.toISOString(),\n            updated_at: date.toISOString(),\n        });\n    }\n  });\n\n  return taskNotes;\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/dataGenerator/taskActivity.ts",
      "content": "import { datatype, random } from \"faker/locale/en_US\";\nimport type { TaskActivity } from \"../../../types\";\nimport type { Db } from \"./types\";\nimport { randomDate } from \"./utils\";\n\nexport const generateTaskActivity = (db: Db): TaskActivity[] => {\n  const activities: TaskActivity[] = [];\n  const actionsPool = ['updated', 'assigned', 'completed', 'reopened'];\n  const fieldsPool = ['text', 'priority', 'status', 'due_date'];\n  let id = 0;\n\n  db.tasks.forEach((task) => {\n    // Always create \"created\" activity\n    const createdAt = task.created_at || new Date().toISOString();\n    \n    activities.push({\n      id: id++,\n      task_id: task.id,\n      sales_id: task.sales_id || db.sales[0].id,\n      action: 'created',\n      field_name: undefined,\n      old_value: undefined,\n      new_value: undefined,\n      created_at: createdAt,\n    });\n\n    // Generate 1-5 random activities per task\n    const activityCount = datatype.number({min: 1, max: 5});\n    for (let i = 0; i < activityCount; i++) {\n      const action = random.arrayElement(actionsPool);\n      const field = action === 'updated' ? random.arrayElement(fieldsPool) : undefined;\n      const date = randomDate(new Date(createdAt));\n\n      activities.push({\n        id: id++,\n        task_id: task.id,\n        sales_id: random.arrayElement(db.sales).id,\n        action,\n        field_name: field,\n        old_value: field ? 'medium' : undefined,\n        new_value: field ? 'high' : undefined,\n        created_at: date.toISOString(),\n      });\n    }\n\n    // Add \"completed\" activity if task is done\n    if (task.done_date) {\n      activities.push({\n        id: id++,\n        task_id: task.id,\n        sales_id: task.sales_id || db.sales[0].id,\n        action: 'completed',\n        field_name: undefined,\n        old_value: undefined,\n        new_value: undefined,\n        created_at: task.done_date,\n      });\n    }\n  });\n\n  return activities;\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/dataGenerator/tags.ts",
      "content": "import type { Db } from \"./types\";\n\nconst tags = [\n  { id: 0, name: \"football-fan\", color: \"#eddcd2\" },\n  { id: 1, name: \"holiday-card\", color: \"#fff1e6\" },\n  { id: 2, name: \"influencer\", color: \"#fde2e4\" },\n  { id: 3, name: \"manager\", color: \"#fad2e1\" },\n  { id: 4, name: \"musician\", color: \"#c5dedd\" },\n  { id: 5, name: \"vip\", color: \"#dbe7e4\" },\n];\n\nexport const generateTags = (_: Db) => {\n  return [...tags];\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/dataGenerator/sales.ts",
      "content": "import { internet, name } from \"faker/locale/en_US\";\n\nimport type { RAFile, Sale } from \"../../../types\";\nimport type { Db } from \"./types\";\n\nexport const generateSales = (_: Db): Sale[] => {\n  const randomSales = Array.from(Array(5).keys()).map((id) => {\n    const first_name = name.firstName();\n    const last_name = name.lastName();\n    const email = internet.email(first_name, last_name);\n\n    return {\n      id: id + 1,\n      user_id: `${id + 1}`,\n      first_name,\n      last_name,\n      email,\n      password: \"demo\",\n      administrator: false,\n    };\n  });\n  return [\n    {\n      id: 0,\n      user_id: \"0\",\n      first_name: \"Jane\",\n      last_name: \"Doe\",\n      email: \"janedoe@atomic.dev\",\n      password: \"demo\",\n      administrator: true,\n      avatar: {\n        src: \"data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEASABIAAD/4gKgSUNDX1BST0ZJTEUAAQEAAAKQbGNtcwQwAABtbnRyUkdCIFhZWiAH3wAIABMAEgAWADFhY3NwQVBQTAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA9tYAAQAAAADTLWxjbXMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAtkZXNjAAABCAAAADhjcHJ0AAABQAAAAE53dHB0AAABkAAAABRjaGFkAAABpAAAACxyWFlaAAAB0AAAABRiWFlaAAAB5AAAABRnWFlaAAAB+AAAABRyVFJDAAACDAAAACBnVFJDAAACLAAAACBiVFJDAAACTAAAACBjaHJtAAACbAAAACRtbHVjAAAAAAAAAAEAAAAMZW5VUwAAABwAAAAcAHMAUgBHAEIAIABiAHUAaQBsAHQALQBpAG4AAG1sdWMAAAAAAAAAAQAAAAxlblVTAAAAMgAAABwATgBvACAAYwBvAHAAeQByAGkAZwBoAHQALAAgAHUAcwBlACAAZgByAGUAZQBsAHkAAAAAWFlaIAAAAAAAAPbWAAEAAAAA0y1zZjMyAAAAAAABDEoAAAXj///zKgAAB5sAAP2H///7ov///aMAAAPYAADAlFhZWiAAAAAAAABvlAAAOO4AAAOQWFlaIAAAAAAAACSdAAAPgwAAtr5YWVogAAAAAAAAYqUAALeQAAAY3nBhcmEAAAAAAAMAAAACZmYAAPKnAAANWQAAE9AAAApbcGFyYQAAAAAAAwAAAAJmZgAA8qcAAA1ZAAAT0AAACltwYXJhAAAAAAADAAAAAmZmAADypwAADVkAABPQAAAKW2Nocm0AAAAAAAMAAAAAo9cAAFR7AABMzQAAmZoAACZmAAAPXP/bAEMACAYGBwYFCAcHBwkJCAoMFA0MCwsMGRITDxQdGh8eHRocHCAkLicgIiwjHBwoNyksMDE0NDQfJzk9ODI8LjM0Mv/bAEMBCQkJDAsMGA0NGDIhHCEyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMv/AABEIAIAAgAMBIgACEQEDEQH/xAAcAAABBAMBAAAAAAAAAAAAAAABAAUGBwIDBAj/xAA2EAABAwMBBgMHAwQDAQAAAAABAAIDBAUREgYTITFBUSJxgRQyYZGxwdEHQqEkUmLhFRYjkv/EABoBAAIDAQEAAAAAAAAAAAAAAAIDAAEEBQb/xAAkEQACAgIDAAEEAwAAAAAAAAAAAQIRAyEEEjETBSJRcTJBYf/aAAwDAQACEQMRAD8AuIIoIogAooIqygorB72xsc97g1rRkk9FFrlfnVD3Rwu0Qj5uQyko+hRi5eEjlr6aEkOlBI6N4rSbpCG6j4R0zzPoFEIpZpn+Ahv+TuJ9E9Qtipodc0haD15ud5BI+Vsb8aXoq/a6GgJ1UsrgBknTj6rgp/1JtEkgjnbNTk9Xxkt/+m5Cbrvbam9sc2XeU9G0jTFry6Q9M/hddk/T6kpId7UwNmqJCOBOGxjoD3KLvIroiX0VxprhCJaeVr2njlpyutR+k2dlttQZ4KwMZpwIGjwD5lbI785leaSppZWHmJG+JpHfKYppgOLQ9pIAhwBHIpIwBJFJBQhgiEAiFRYQkgmzaCuNDaZHsOJHeBvmVG6VkSt0Me0l93spoqY5Y0+N3Qn8JgjdrcA3xOPU9f8AS485Jy4c8ucep/CzirNBIh4D9zz1WGU7dmyMElRIIXspeBw+fGeJ4N8/wtsEstTUtHFzz1Pb7BNVHvJQA0EAnOo83fH/AGpBR7qniw14yfekz9+qFMNxHiljYwjhqc3kTxPxwnaIZA+6ZoJWDGhjnZ68gnaEvewftHw4BOixTVGc2GsOdI4c3KFXmSuq75Rw0kQ3EWZKieQaQG8g0D4n7KauaGgiNu8eeJJPBN89JLUN8btWg5HDAL++OwUZSMbTWxV9vZNFqxyIcMEELuTdTBtNUbiP3A0D5BOC0QdozzVMWUksoIwTBFBIKEMlFdtJSIKaMHHEuKlKg+3Ly6rgizhugl3wHVLyv7WMxK5Ih8k2+IAJEecNGeLvj5LvoossDsZHl9E2x6ZZNTvDGPp2WFde45P6WlqI4tPAZIGT6rAb0vwSiOox4RgA+84nn6ruiuAhLdA1n+5x5Kt6SsrYagtqqkyuJ8Jxj+FLpIql9qM0b9GW8Ceioaoa2TigrXStDsMb8SOKeYtUgGpxLe5+wVQ2eouftIabs52T7ugHPqrOtNNX7gb+r3zSPE1zNJPljknQaehGSFDo6piax5Em7iZ78h+gXJV1OId7lzIgzIYOePyue4QvxGGs8OsAN6D/ACPfH1QinirgZmODoi4Mb5BFYlqjfSsc58kjxgkN4dua61wWWqFbb2VGCDM4uAPMN6LsJ4p+LwRlM8pZWGUU0UBFYhFUWFV/t0S67xR8muhGT8MqwFDNvKJz4IqxgyWjQ49uyXl3EbidSKxrp31VWaKnJaxoySO6aX7INZG9swlcHuD3OyMkjlxKdLWA2uqJH/3NH8KRVNWz2XJ7LCm1tHSUIyWyL0NvdC6CnBeQHjRqOSB2VwVdnd/1YwRt/wDQx8Pkq4sX9XdoXubpZrGCeo7q7i3eW0OjbqLW8B3RRjdkm+tJHn6usdbV1JY6rnpmBww5jT4QPLn6q09jLdcKBsRgv0lZSFgaaaoYXBuBza4kuB7g5HwCa6y50tRWvi3ZjeHYc1wwQVMdm42NaC3lhXBu6JkikuzHS4QuNuqCPf3biPPCqj9OdonubHa6txLyXkPJ65JH1x6K27tKYrXVPAyRE/A7nBVE7OUEtJtDSs0k6JwHO8zghMemZ6bjZcdqjZT0jo2DAY4tC68rVBHuosY4klx81sWnGqiYcjuRkllAIhGCBFBFUWFc9dSR11FLTyDLXtI8l0BJUXZRt4tNRZ7hPFI3Trw5p6HHBcEk0jgwO93l6q3tsrJ/y1oL4WZqYTqZ8R1H0VRVEDKqikgkaQRkdiCsOWHWR0+Pk7RFRzVNHXQmNwc1pHAHBVq2m+19QIzTgMhaMFsjclx+ap2wW6gn3dNXvqIpA7G+DstcB9CrVtVqsVDa4Zpa2eUmPIDS4knIzgD4FUou9Dvtqpe/oZ9qrfUR1Elw3ZDy7UeGAVKtibgKi3skzwPDj0KiV7ornc6xk8EtdTW+QhraSZ+S49SW8cAeamWzlsFupBG39ztXkotSKl/CmO21N3pbLs7U3GtL/Z4tOsMGScuAwB6qK7JUrbs1t6ex+5kOuESBoceJ4uDeGfJP+1NpO0NLSWyRgNE6cS1Rzza3iGjzOPknKCnipadkEEbY4o2hrWtGAAFojj7O2YJ5eq6oyKCywlhaTIBEJJKEMQigEVRYUViioQJAIIPVVrtzYW0FY2507cQVLtMoH7X9/X6hWVlcl0pKWvtlRTVuPZ3sOs5xpxx1A9COaDJDtGhuKbhKyjW2uT2newSuZq544g+in2ytGYpGzTPMj28WgNAwofRV0cFU6F7w5oOGudw1DoVPbRdKCBrdU0eojg1pyT6BYbr+zsd5dKRIvZN6/ey4yPhyXRTx+PDeXfssaZz6wBzssj6N6nzTiyJrAABgI1vaMrdaZp06SQTniktkvv5WtbIO4o5+RVJgwkikjAAkigVCGsJZWuSaOGMySvaxg5uccAJiqtqqeNxbSxOmP9x8I/KCU4x9DjCUvESIJuvG0Fp2fp2zXWvhpWPzo3h4uxzwBxKi1XtTcJGnS5sDe7Bx+ZVD7WX+p2gvs1TNM+VkZ3cOp2fCD9+amOayPReTG4LZaF2/XVjKmRlotTZIG5DZal5Bce+kch5lcLNqL5erSJrhXPd7SNRiYA2No6AAKocHGOqs21NJs1K3HERgfwg5T6xSQzixTk2zAtEziCn6wwbmoa4DHHoE1tgO9BA9FJLfTua0ODeK5sjpw0WFaagua0Ek+akAcC3KiNnbI0AkKTsfiLJTsb0IyrZue3U3yULuW39stV+fbKlkmmMAPmZ4sPPTCeNoL9HZbPUVbiCWN8I7novPE9TLVVktTM4ukkLnuJ6kldPg4fkk2/DncyfSKr09C2zaizXZzI6SvidM/lE7wv8AkU7rznsdUvG1Nvbk5FWz6r0O2XuPkj5EYYpJJ+isPfIm6NqCQcDySSk0/A2mvStrpepLtWu0kimYcRt+5+K1sZlqa6LmMp13ga1cuUnJ2zrQioqkM21VULfs7VzA4foLWeZ4fdUnjAHmrI/Uiv8A6OmpQffeXkfAD8lVyBlkY75K6XDhWO/yc7ly++vwGMZljGM5I+qvWlpab2eMNiDQGjgAqNb4J2EftwR6cV6Et0Daihp5WjwyRtcPUIebGkhnCabZjTWykmOHsHDkU7U9BHF7ucLXFTljuSc4W8srnUb26OmmeI2Dgt7qzIw44C1BgwmLaq7w2a0S1Dj4sYYM8S7oEyKb0hcmvWRD9S9pI6qaCz0rsiM7ydw79B6c/kq/Mni7cM/RYmd9XUyVEpJe4l7s9StD3nWT105+y9NxsXw4lE8/nyfLkch32Lk07X21zjw3+r5L0HHUa25yvPWxzc7YW9nYk/wVdrKgsAHRcn6lKpx/R0+BG4N/6P8AFL4hxTg2IvZkc1HqSoy8EqUUUgfGFjxt3o0ZUq2f/9k=\",\n      } as RAFile,\n    },\n    ...randomSales,\n  ];\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/dataGenerator/index.ts",
      "content": "import { generateCompanies } from \"./companies\";\nimport { generateCompanyNotes } from \"./companyNotes\";\nimport { generateContactNotes } from \"./contactNotes\";\nimport { generateContacts } from \"./contacts\";\nimport { generateDealNotes } from \"./dealNotes\";\nimport { generateDeals } from \"./deals\";\nimport { finalize } from \"./finalize\";\nimport { generateSales } from \"./sales\";\nimport { generateTags } from \"./tags\";\nimport { generateTaskActivity } from \"./taskActivity\";\nimport { generateTaskNotes } from \"./taskNotes\";\nimport { generateTasks } from \"./tasks\";\nimport type { Db } from \"./types\";\n\nexport default (): Db => {\n  const db = {} as Db;\n  db.sales = generateSales(db);\n  db.tags = generateTags(db);\n  db.companies = generateCompanies(db);\n  db.companyNotes = generateCompanyNotes(db);\n  db.contacts = generateContacts(db);\n  db.contactNotes = generateContactNotes(db);\n  db.deals = generateDeals(db);\n  db.dealNotes = generateDealNotes(db);\n  db.tasks = generateTasks(db);\n  db.taskNotes = generateTaskNotes(db);\n  db.taskActivity = generateTaskActivity(db);\n  finalize(db);\n\n  return db;\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/dataGenerator/finalize.ts",
      "content": "import type { Db } from \"./types\";\n\nexport const finalize = (db: Db) => {\n  // set contact status according to the latest note\n  db.contactNotes\n    .sort((a, b) => new Date(a.date).valueOf() - new Date(b.date).valueOf())\n    .forEach((note) => {\n      db.contacts[note.contact_id as number].status = note.status;\n    });\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/dataGenerator/deals.ts",
      "content": "import { add } from \"date-fns\";\nimport { datatype, lorem, random } from \"faker/locale/en_US\";\n\nimport {\n  defaultDealCategories,\n  defaultDealStages,\n} from \"../../../root/defaultConfiguration\";\nimport type { Deal } from \"../../../types\";\nimport type { Db } from \"./types\";\nimport { randomDate } from \"./utils\";\n\nexport const generateDeals = (db: Db): Deal[] => {\n  const deals = Array.from(Array(50).keys()).map((id) => {\n    const company = random.arrayElement(db.companies);\n    company.nb_deals++;\n    const contacts = random.arrayElements(\n      db.contacts.filter((contact) => contact.company_id === company.id),\n      datatype.number({ min: 1, max: 3 }),\n    );\n    const lowercaseName = lorem.words();\n    const created_at = randomDate(new Date(company.created_at)).toISOString();\n\n    const expected_closing_date = randomDate(\n      new Date(created_at),\n      add(new Date(created_at), { months: 6 }),\n    ).toISOString();\n\n    return {\n      id,\n      name: lowercaseName[0].toUpperCase() + lowercaseName.slice(1),\n      company_id: company.id,\n      contact_ids: contacts.map((contact) => contact.id),\n      category: random.arrayElement(defaultDealCategories),\n      stage: random.arrayElement(defaultDealStages).value,\n      description: lorem.paragraphs(datatype.number({ min: 1, max: 4 })),\n      amount: datatype.number(1000) * 100,\n      created_at,\n      updated_at: randomDate(new Date(created_at)).toISOString(),\n      expected_closing_date,\n      sales_id: company.sales_id,\n      index: 0,\n    };\n  });\n  // compute index based on stage\n  defaultDealStages.forEach((stage) => {\n    deals\n      .filter((deal) => deal.stage === stage.value)\n      .forEach((deal, index) => {\n        deals[deal.id].index = index;\n      });\n  });\n  return deals;\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/dataGenerator/dealNotes.ts",
      "content": "import { datatype, lorem, random } from \"faker/locale/en_US\";\n\nimport type { Db } from \"./types\";\nimport { randomDate } from \"./utils\";\n\nexport const generateDealNotes = (db: Db) => {\n  return Array.from(Array(300).keys()).map((id) => {\n    const deal = random.arrayElement(db.deals);\n    return {\n      id,\n      deal_id: deal.id,\n      text: lorem.paragraphs(datatype.number({ min: 1, max: 4 })),\n      date: randomDate(\n        new Date(db.deals[deal.id as number].created_at),\n      ).toISOString(),\n      sales_id: deal.sales_id,\n    };\n  });\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/dataGenerator/contacts.ts",
      "content": "import {\n  company as fakerCompany,\n  internet,\n  lorem,\n  name,\n  phone,\n  random,\n  date,\n  datatype,\n} from \"faker/locale/en_US\";\n\nimport {\n  defaultContactGender,\n  defaultNoteStatuses,\n} from \"../../../root/defaultConfiguration\";\nimport type { Company, Contact } from \"../../../types\";\nimport type { Db } from \"./types\";\nimport { randomDate, weightedBoolean } from \"./utils\";\n\nconst maxContacts = {\n  1: 1,\n  10: 4,\n  50: 12,\n  250: 25,\n  500: 50,\n};\n\nconst getRandomContactDetailsType = () =>\n  random.arrayElement([\"Work\", \"Home\", \"Other\"]) as \"Work\" | \"Home\" | \"Other\";\n\nexport const generateContacts = (db: Db, size = 500): Required<Contact>[] => {\n  const nbAvailblePictures = 223;\n  let numberOfContacts = 0;\n\n  return Array.from(Array(size).keys()).map((id) => {\n    const has_avatar =\n      weightedBoolean(25) && numberOfContacts < nbAvailblePictures;\n    const gender = random.arrayElement(defaultContactGender).value;\n    const first_name = name.firstName(gender as any);\n    const last_name = name.lastName();\n    const email_jsonb = [\n      {\n        email: internet.email(first_name, last_name),\n        type: getRandomContactDetailsType(),\n      },\n    ];\n    const phone_jsonb = [\n      {\n        number: phone.phoneNumber(),\n        type: getRandomContactDetailsType(),\n      },\n      {\n        number: phone.phoneNumber(),\n        type: getRandomContactDetailsType(),\n      },\n    ];\n    const avatar = {\n      src: has_avatar\n        ? \"https://marmelab.com/posters/avatar-\" +\n          (223 - numberOfContacts) +\n          \".jpeg\"\n        : undefined,\n    };\n    const title = fakerCompany.bsAdjective();\n\n    if (has_avatar) {\n      numberOfContacts++;\n    }\n\n    // choose company with people left to know\n    let company: Required<Company>;\n    do {\n      company = random.arrayElement(db.companies);\n    } while (company.nb_contacts >= maxContacts[company.size]);\n    company.nb_contacts++;\n\n    const first_seen = randomDate(new Date(company.created_at)).toISOString();\n    const last_seen = first_seen;\n\n    // Heartbeat generation\n    const daysInactive = datatype.number({ min: 0, max: 365 });\n    \n    const computeScore = (days: number): number => {\n      if (days <= 7) return datatype.number({ min: 80, max: 100 });\n      if (days <= 30) return datatype.number({ min: 60, max: 79 });\n      if (days <= 90) return datatype.number({ min: 40, max: 59 });\n      if (days <= 180) return datatype.number({ min: 20, max: 39 });\n      return datatype.number({ min: 0, max: 19 });\n    };\n\n    const score = computeScore(daysInactive);\n    \n    // Internal heartbeat (70% populated)\n    const internalHeartbeat = Math.random() > 0.3 ? {\n      internal_heartbeat_score: score,\n      internal_heartbeat_status:\n        score >= 80 ? 'strong' :\n        score >= 60 ? 'active' :\n        score >= 40 ? 'cooling' :\n        score >= 20 ? 'cold' : 'dormant',\n      internal_heartbeat_updated_at: date.recent(7).toISOString(),\n    } : {};\n\n    // External heartbeat (50% populated)\n    const externalHeartbeat = Math.random() > 0.5 ? {\n      external_heartbeat_status: random.arrayElement(['valid', 'warning', 'invalid', 'unknown']),\n      external_heartbeat_checked_at: date.recent(30).toISOString(),\n      email_validation_status: random.arrayElement(['valid', 'risky', 'invalid', 'unknown']),\n      linkedin_profile_status: random.arrayElement(['active', 'inactive', 'not_found', 'unknown']),\n    } : {};\n\n    return {\n      id,\n      first_name,\n      last_name,\n      gender,\n      title: title.charAt(0).toUpperCase() + title.substr(1),\n      company_id: company.id,\n      company_name: company.name,\n      email_jsonb,\n      phone_jsonb,\n      background: lorem.sentence(),\n      acquisition: random.arrayElement([\"inbound\", \"outbound\"]),\n      avatar,\n      first_seen: first_seen,\n      last_seen: last_seen,\n      has_newsletter: weightedBoolean(30),\n      status: random.arrayElement(defaultNoteStatuses).value,\n      tags: random\n        .arrayElements(db.tags, random.arrayElement([0, 0, 0, 1, 1, 2]))\n        .map((tag) => tag.id), // finalize\n      sales_id: company.sales_id,\n      nb_tasks: 0,\n      linkedin_url: null,\n      ...internalHeartbeat,\n      ...externalHeartbeat,\n      days_since_last_activity: daysInactive,\n    };\n  });\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/dataGenerator/contactNotes.ts",
      "content": "import { datatype, lorem, random } from \"faker/locale/en_US\";\n\nimport { defaultNoteStatuses } from \"../../../root/defaultConfiguration\";\nimport type { ContactNote } from \"../../../types\";\nimport type { Db } from \"./types\";\nimport { randomDate } from \"./utils\";\n\nexport const generateContactNotes = (db: Db): ContactNote[] => {\n  return Array.from(Array(1200).keys()).map((id) => {\n    const contact = random.arrayElement(db.contacts);\n    const date = randomDate(new Date(contact.first_seen));\n    contact.last_seen =\n      date > new Date(contact.last_seen)\n        ? date.toISOString()\n        : contact.last_seen;\n    return {\n      id,\n      contact_id: contact.id,\n      text: lorem.paragraphs(datatype.number({ min: 1, max: 4 })),\n      date: date.toISOString(),\n      sales_id: contact.sales_id,\n      status: random.arrayElement(defaultNoteStatuses).value,\n    };\n  });\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/dataGenerator/companyNotes.ts",
      "content": "import { datatype, lorem, random } from \"faker/locale/en_US\";\n\nimport type { CompanyNote } from \"../../../types\";\nimport type { Db } from \"./types\";\nimport { randomDate } from \"./utils\";\n\nexport const generateCompanyNotes = (db: Db): CompanyNote[] => {\n  return Array.from(Array(600).keys()).map((id) => {\n    const company = random.arrayElement(db.companies);\n    const date = randomDate(new Date(company.created_at));\n\n    return {\n      id,\n      company_id: company.id,\n      text: lorem.paragraphs(datatype.number({ min: 1, max: 4 })),\n      date: date.toISOString(),\n      sales_id: company.sales_id,\n    };\n  });\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/dataGenerator/companies.ts",
      "content": "import {\n  address,\n  company,\n  datatype,\n  internet,\n  lorem,\n  phone,\n  random,\n} from \"faker/locale/en_US\";\n\nimport { randomDate } from \"./utils\";\nimport { defaultCompanySectors } from \"../../../root/defaultConfiguration\";\nimport type { Company, RAFile } from \"../../../types\";\nimport type { Db } from \"./types\";\n\nconst sizes = [1, 10, 50, 250, 500];\n\nconst regex = /\\W+/;\n\n// New field options\nconst lifecycleStages = ['prospect', 'customer', 'churned', 'lost', 'archived'];\nconst companyTypes = ['customer', 'prospect', 'partner', 'vendor', 'competitor'];\nconst qualificationStatuses = ['qualified', 'unqualified', 'duplicate', 'spam'];\nconst revenueRanges = ['0-1M', '1M-10M', '10M-50M', '50M-100M', '100M+', 'unknown'];\nconst industries = ['SaaS', 'E-commerce', 'Healthcare', 'Fintech', 'Manufacturing', 'Consulting', 'Real Estate', 'Education'];\nconst externalHeartbeats = ['healthy', 'risky', 'dead', 'unknown'];\nconst internalHeartbeats = ['engaged', 'quiet', 'at_risk', 'unresponsive'];\n\nexport const generateCompanies = (db: Db, size = 55): Required<Company>[] => {\n  return Array.from(Array(size).keys()).map((id) => {\n    const name = company.companyName();\n    const createdAt = randomDate();\n    const hasLifecycle = datatype.boolean();\n    const hasHeartbeat = datatype.number(100) > 40; // 60% have heartbeat computed\n\n    return {\n      id,\n      name: name,\n      logo: {\n        title: lorem.text(1),\n        src: `./logos/${id}.png`,\n      } as RAFile,\n      sector: random.arrayElement(defaultCompanySectors),\n      size: random.arrayElement(sizes) as 1 | 10 | 50 | 250 | 500,\n      linkedin_url: `https://www.linkedin.com/company/${name\n        .toLowerCase()\n        .replace(regex, \"_\")}`,\n      website: internet.url(),\n      phone_number: phone.phoneNumber(),\n      address: address.streetAddress(),\n      zipcode: address.zipCode(),\n      city: address.city(),\n      stateAbbr: address.stateAbbr(),\n      nb_contacts: 0,\n      nb_deals: 0,\n      nb_notes: 0,\n      nb_tasks: 0,\n      // at least 1/3rd of companies for Jane Doe\n      sales_id: datatype.number(2) === 0 ? 0 : random.arrayElement(db.sales).id,\n      created_at: createdAt.toISOString(),\n      description: lorem.paragraph(),\n      revenue: random.arrayElement([\"$1M\", \"$10M\", \"$100M\", \"$1B\"]),\n      tax_identifier: random.alphaNumeric(10),\n      country: random.arrayElement([\"USA\", \"France\", \"UK\"]),\n      context_links: [],\n\n      // Phase 1: Lifecycle & Classification (70% populated)\n      updated_at: randomDate(createdAt).toISOString(),\n      lifecycle_stage: hasLifecycle ? random.arrayElement(lifecycleStages) : undefined,\n      company_type: datatype.number(100) > 30 ? random.arrayElement(companyTypes) : undefined,\n      qualification_status: datatype.number(100) > 60 ? random.arrayElement(qualificationStatuses) : undefined,\n\n      // Phase 1: External Integration (20% populated)\n      external_id: datatype.number(100) > 80 ? random.alphaNumeric(12) : undefined,\n      external_system: datatype.number(100) > 80 ? random.arrayElement(['salesforce', 'hubspot', 'clearbit']) : undefined,\n\n      // Phase 1: Contact Information (70% have email)\n      email: datatype.number(100) > 30 ? `info@${internet.domainName()}` : undefined,\n\n      // Phase 1: Firmographics (varies by field)\n      industry: datatype.number(100) > 40 ? random.arrayElement(industries) : undefined,\n      revenue_range: datatype.number(100) > 50 ? random.arrayElement(revenueRanges) : undefined,\n      employee_count: datatype.number(100) > 50 ? datatype.number({ min: 1, max: 10000 }) : undefined,\n      founded_year: datatype.number(100) > 60 ? datatype.number({ min: 1990, max: 2023 }) : undefined,\n\n      // Phase 1: Social & Enrichment (30% have social profiles)\n      social_profiles: datatype.number(100) > 70 ? {\n        linkedin: `https://www.linkedin.com/company/${name.toLowerCase().replace(regex, \"_\")}`,\n        ...(datatype.number(100) > 90 && { x: `https://x.com/${name.toLowerCase().replace(regex, \"\")}` }),\n        ...(datatype.number(100) > 95 && { facebook: `https://facebook.com/${name.toLowerCase().replace(regex, \"\")}` }),\n      } : {},\n      logo_url: datatype.number(100) > 60 ? `https://logo.clearbit.com/${internet.domainName()}` : undefined,\n\n      // Phase 2: External Heartbeat (50% computed)\n      external_heartbeat_status: datatype.number(100) > 50 ? random.arrayElement(externalHeartbeats) : undefined,\n      external_heartbeat_checked_at: datatype.number(100) > 50 ? randomDate(createdAt).toISOString() : undefined,\n\n      // Phase 2: Internal Heartbeat (60% computed)\n      internal_heartbeat_status: hasHeartbeat ? random.arrayElement(internalHeartbeats) : undefined,\n      internal_heartbeat_score: hasHeartbeat ? datatype.number({ min: 0, max: 100 }) : undefined,\n      internal_heartbeat_updated_at: hasHeartbeat ? randomDate(createdAt).toISOString() : undefined,\n\n      // View-computed fields (will be set by view in real DB, defaulted here)\n      last_note_date: undefined,\n      last_deal_activity: undefined,\n      last_task_activity: undefined,\n      days_since_last_activity: undefined,\n      total_deal_amount: 0,\n    };\n  });\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/commons/mergeContacts.ts",
      "content": "import type { Identifier, DataProvider } from \"ra-core\";\n\nimport type { Contact, Task, Deal, ContactNote } from \"../../types\";\n\n/**\n * Merge one contact (loser) into another contact (winner).\n *\n * This function copies properties from the loser to the winner contact,\n * transfers all associated data (tasks, notes, deals) from the loser to the winner,\n * and deletes the loser contact.\n */\nexport const mergeContacts = async (\n  loserId: Identifier,\n  winnerId: Identifier,\n  dataProvider: DataProvider,\n) => {\n  // Fetch both contacts using dataProvider to get fresh data\n  const { data: winnerContact } = await dataProvider.getOne<Contact>(\n    \"contacts\",\n    { id: winnerId },\n  );\n  const { data: loserContact } = await dataProvider.getOne<Contact>(\n    \"contacts\",\n    { id: loserId },\n  );\n\n  if (!winnerContact || !loserContact) {\n    throw new Error(\"Could not fetch contacts\");\n  }\n\n  // 1. Reassign all tasks from loser to winner\n  const { data: loserTasks } = await dataProvider.getManyReference<Task>(\n    \"tasks\",\n    {\n      target: \"contact_id\",\n      id: loserId,\n      pagination: { page: 1, perPage: 1000 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: {},\n    },\n  );\n\n  const taskUpdates =\n    loserTasks?.map((task) =>\n      dataProvider.update(\"tasks\", {\n        id: task.id,\n        data: { contact_id: winnerId },\n        previousData: task,\n      }),\n    ) || [];\n\n  // 2. Reassign all notes from loser to winner\n  const { data: loserNotes } = await dataProvider.getManyReference<ContactNote>(\n    \"contactNotes\",\n    {\n      target: \"contact_id\",\n      id: loserId,\n      pagination: { page: 1, perPage: 1000 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: {},\n    },\n  );\n\n  const noteUpdates =\n    loserNotes?.map((note) =>\n      dataProvider.update<ContactNote>(\"contactNotes\", {\n        id: note.id,\n        data: { contact_id: winnerId },\n        previousData: note,\n      }),\n    ) || [];\n\n  // 3. Change contact in deals - replace loser ID with winner ID in contact_ids array\n  const { data: loserDeals } = await dataProvider.getList<Deal>(\"deals\", {\n    filter: { \"contact_ids@cs\": `{${loserId}}` },\n    pagination: { page: 1, perPage: 1000 },\n    sort: { field: \"id\", order: \"ASC\" },\n  });\n\n  const dealUpdates =\n    loserDeals?.map((deal) => {\n      const newContactIds = deal.contact_ids\n        .filter((id) => id !== loserId)\n        .concat(winnerId)\n        .filter(\n          (id: Identifier, index: number, self: Identifier[]) =>\n            self.indexOf(id) === index,\n        ); // Remove duplicates\n\n      return dataProvider.update<Deal>(\"deals\", {\n        id: deal.id,\n        data: { contact_ids: newContactIds },\n        previousData: deal,\n      });\n    }) || [];\n\n  // 4. Update winner contact with loser data\n  const mergedEmails = mergeObjectArraysUnique(\n    winnerContact.email_jsonb || [],\n    loserContact.email_jsonb || [],\n    (email) => email.email,\n  );\n\n  const mergedPhones = mergeObjectArraysUnique(\n    winnerContact.phone_jsonb || [],\n    loserContact.phone_jsonb || [],\n    (phone) => phone.number,\n  );\n\n  const winnerUpdate = dataProvider.update<Contact>(\"contacts\", {\n    id: winnerId,\n    data: {\n      avatar:\n        winnerContact.avatar && winnerContact.avatar.src\n          ? winnerContact.avatar\n          : loserContact.avatar,\n      gender: winnerContact.gender ?? loserContact.gender,\n      first_name: winnerContact.first_name ?? loserContact.first_name,\n      last_name: winnerContact.last_name ?? loserContact.last_name,\n      title: winnerContact.title ?? loserContact.title,\n      company_id: winnerContact.company_id ?? loserContact.company_id,\n      email_jsonb: mergedEmails,\n      phone_jsonb: mergedPhones,\n      linkedin_url: winnerContact.linkedin_url || loserContact.linkedin_url,\n      background: winnerContact.background ?? loserContact.background,\n      has_newsletter:\n        winnerContact.has_newsletter ?? loserContact.has_newsletter,\n      first_seen: winnerContact.first_seen ?? loserContact.first_seen,\n      last_seen:\n        winnerContact.last_seen > loserContact.last_seen\n          ? winnerContact.last_seen\n          : loserContact.last_seen,\n      sales_id: winnerContact.sales_id ?? loserContact.sales_id,\n      tags: mergeArraysUnique(\n        winnerContact.tags || [],\n        loserContact.tags || [],\n      ),\n    },\n    previousData: winnerContact,\n  });\n\n  // Execute all updates\n  await Promise.all([\n    ...taskUpdates,\n    ...noteUpdates,\n    ...dealUpdates,\n    winnerUpdate,\n  ]);\n\n  // 5. Delete the loser contact\n  await dataProvider.delete<Contact>(\"contacts\", {\n    id: loserId,\n    previousData: loserContact,\n  });\n};\n\n// Helper functions to merge arrays and remove duplicates\n\n// For primitive arrays like tags\nconst mergeArraysUnique = <T>(arr1: T[], arr2: T[]): T[] => [\n  ...new Set([...arr1, ...arr2]),\n];\n\n// For object arrays like emails and phones\nfunction mergeObjectArraysUnique<T>(\n  arr1: T[],\n  arr2: T[],\n  getKey: (item: T) => string,\n): T[] {\n  const map = new Map<string, T>();\n\n  arr1.forEach((item) => {\n    const key = getKey(item);\n    if (key) map.set(key, item);\n  });\n\n  arr2.forEach((item) => {\n    const key = getKey(item);\n    if (key && !map.has(key)) {\n      map.set(key, item);\n    }\n  });\n\n  return Array.from(map.values());\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/commons/mergeCompanies.ts",
      "content": "import type { Identifier, DataProvider } from \"ra-core\";\n\nimport type { Company, Contact, Deal } from \"../../types\";\n\n/**\n * Merge one company (loser) into another company (winner).\n *\n * This function copies properties from the loser to the winner company,\n * transfers all associated data (contacts, deals) from the loser to the winner,\n * and deletes the loser company.\n */\nexport const mergeCompanies = async (\n  loserId: Identifier,\n  winnerId: Identifier,\n  dataProvider: DataProvider,\n) => {\n  // Fetch both companies using dataProvider to get fresh data\n  const { data: winnerCompany } = await dataProvider.getOne<Company>(\n    \"companies\",\n    { id: winnerId },\n  );\n  const { data: loserCompany } = await dataProvider.getOne<Company>(\n    \"companies\",\n    { id: loserId },\n  );\n\n  if (!winnerCompany || !loserCompany) {\n    throw new Error(\"Could not fetch companies\");\n  }\n\n  // 1. Reassign all contacts from loser to winner\n  const { data: loserContacts } = await dataProvider.getManyReference<Contact>(\n    \"contacts\",\n    {\n      target: \"company_id\",\n      id: loserId,\n      pagination: { page: 1, perPage: 1000 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: {},\n    },\n  );\n\n  const contactUpdates =\n    loserContacts?.map((contact) =>\n      dataProvider.update(\"contacts\", {\n        id: contact.id,\n        data: { company_id: winnerId },\n        previousData: contact,\n      }),\n    ) || [];\n\n  // 2. Reassign all deals from loser to winner\n  const { data: loserDeals } = await dataProvider.getManyReference<Deal>(\n    \"deals\",\n    {\n      target: \"company_id\",\n      id: loserId,\n      pagination: { page: 1, perPage: 1000 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: {},\n    },\n  );\n\n  const dealUpdates =\n    loserDeals?.map((deal) =>\n      dataProvider.update<Deal>(\"deals\", {\n        id: deal.id,\n        data: { company_id: winnerId },\n        previousData: deal,\n      }),\n    ) || [];\n\n  // 3. Update winner company with loser data\n  const mergedContextLinks = mergeArraysUnique(\n    winnerCompany.context_links || [],\n    loserCompany.context_links || [],\n  );\n\n  // Merge social profiles from both companies\n  const mergedSocialProfiles = {\n    ...(loserCompany.social_profiles || {}),\n    ...(winnerCompany.social_profiles || {}),\n  };\n\n  const winnerUpdate = dataProvider.update<Company>(\"companies\", {\n    id: winnerId,\n    data: {\n      logo:\n        winnerCompany.logo && winnerCompany.logo.src\n          ? winnerCompany.logo\n          : loserCompany.logo,\n      sector: winnerCompany.sector ?? loserCompany.sector,\n      size: winnerCompany.size ?? loserCompany.size,\n      linkedin_url: winnerCompany.linkedin_url || loserCompany.linkedin_url,\n      website: winnerCompany.website || loserCompany.website,\n      phone_number: winnerCompany.phone_number ?? loserCompany.phone_number,\n      address: winnerCompany.address ?? loserCompany.address,\n      zipcode: winnerCompany.zipcode ?? loserCompany.zipcode,\n      city: winnerCompany.city ?? loserCompany.city,\n      stateAbbr: winnerCompany.stateAbbr ?? loserCompany.stateAbbr,\n      country: winnerCompany.country ?? loserCompany.country,\n      description: winnerCompany.description ?? loserCompany.description,\n      revenue: winnerCompany.revenue ?? loserCompany.revenue,\n      tax_identifier:\n        winnerCompany.tax_identifier ?? loserCompany.tax_identifier,\n      sales_id: winnerCompany.sales_id ?? loserCompany.sales_id,\n      context_links: mergedContextLinks,\n\n      // Phase 1: Lifecycle & Classification (prefer winner's values)\n      lifecycle_stage: winnerCompany.lifecycle_stage ?? loserCompany.lifecycle_stage,\n      company_type: winnerCompany.company_type ?? loserCompany.company_type,\n      qualification_status: winnerCompany.qualification_status ?? loserCompany.qualification_status,\n\n      // Phase 1: External Integration (prefer winner's values)\n      external_id: winnerCompany.external_id ?? loserCompany.external_id,\n      external_system: winnerCompany.external_system ?? loserCompany.external_system,\n\n      // Phase 1: Contact Information (prefer winner's email)\n      email: winnerCompany.email ?? loserCompany.email,\n\n      // Phase 1: Firmographics (prefer winner's values)\n      industry: winnerCompany.industry ?? loserCompany.industry,\n      revenue_range: winnerCompany.revenue_range ?? loserCompany.revenue_range,\n      employee_count: winnerCompany.employee_count ?? loserCompany.employee_count,\n      founded_year: winnerCompany.founded_year ?? loserCompany.founded_year,\n\n      // Phase 1: Social & Enrichment (merge social profiles, prefer winner's logo_url)\n      social_profiles: mergedSocialProfiles,\n      logo_url: winnerCompany.logo_url ?? loserCompany.logo_url,\n\n      // Phase 2: Heartbeat (take the better/higher heartbeat score)\n      external_heartbeat_status: winnerCompany.external_heartbeat_status ?? loserCompany.external_heartbeat_status,\n      external_heartbeat_checked_at:\n        winnerCompany.external_heartbeat_checked_at ?? loserCompany.external_heartbeat_checked_at,\n\n      // For internal heartbeat, take the higher score (better engagement)\n      internal_heartbeat_score: Math.max(\n        winnerCompany.internal_heartbeat_score ?? 0,\n        loserCompany.internal_heartbeat_score ?? 0\n      ) || undefined,\n      internal_heartbeat_status:\n        (winnerCompany.internal_heartbeat_score ?? 0) >= (loserCompany.internal_heartbeat_score ?? 0)\n          ? winnerCompany.internal_heartbeat_status\n          : loserCompany.internal_heartbeat_status,\n      internal_heartbeat_updated_at:\n        winnerCompany.internal_heartbeat_updated_at ?? loserCompany.internal_heartbeat_updated_at,\n    },\n    previousData: winnerCompany,\n  });\n\n  // Execute all updates\n  await Promise.all([...contactUpdates, ...dealUpdates, winnerUpdate]);\n\n  // 4. Delete the loser company\n  await dataProvider.delete<Company>(\"companies\", {\n    id: loserId,\n    previousData: loserCompany,\n  });\n};\n\n// Helper function to merge arrays and remove duplicates\nconst mergeArraysUnique = <T>(arr1: T[], arr2: T[]): T[] => [\n  ...new Set([...arr1, ...arr2]),\n];\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/commons/getContactAvatar.ts",
      "content": "import { fetchWithTimeout } from \"../../misc/fetchWithTimeout\";\nimport { DOMAINS_NOT_SUPPORTING_FAVICON } from \"../../misc/unsupportedDomains.const\";\nimport type { Contact } from \"../../types\";\n\nexport async function hash(string: string) {\n  const utf8 = new TextEncoder().encode(string);\n  const hashBuffer = await crypto.subtle.digest(\"SHA-256\", utf8);\n  const hashArray = Array.from(new Uint8Array(hashBuffer));\n  const hashHex = hashArray\n    .map((bytes) => bytes.toString(16).padStart(2, \"0\"))\n    .join(\"\");\n  return hashHex;\n}\n\n// Helper function to get the Gravatar URL\nasync function getGravatarUrl(email: string): Promise<string> {\n  const hashEmail = await hash(email);\n  return `https://www.gravatar.com/avatar/${hashEmail}?d=404`;\n}\n\n// Helper function to get the favicon URL\nasync function getFaviconUrl(domain: string): Promise<string | null> {\n  if (DOMAINS_NOT_SUPPORTING_FAVICON.includes(domain)) {\n    return null;\n  }\n\n  try {\n    const faviconUrl = `https://${domain}/favicon.ico`;\n    const response = await fetchWithTimeout(faviconUrl);\n    if (response.ok) {\n      return faviconUrl;\n    }\n  } catch {\n    return null;\n  }\n  return null;\n}\n\n// Main function to get the avatar URL\nexport async function getContactAvatar(\n  record: Partial<Contact>,\n): Promise<string | null> {\n  if (!record.email_jsonb || !record.email_jsonb.length) {\n    return null;\n  }\n\n  for (const { email } of record.email_jsonb) {\n    // Step 1: Try to get Gravatar image\n    const gravatarUrl = await getGravatarUrl(email);\n    try {\n      const gravatarResponse = await fetch(gravatarUrl);\n      if (gravatarResponse.ok) {\n        return gravatarUrl;\n      }\n    } catch {\n      // Gravatar not found\n    }\n\n    // Step 2: Try to get favicon from email domain\n    const domain = email.split(\"@\")[1];\n    const faviconUrl = await getFaviconUrl(domain);\n    if (faviconUrl) {\n      return faviconUrl;\n    }\n\n    // TODO: Step 3: Try to get image from LinkedIn.\n  }\n\n  return null;\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/commons/getContactAvatar.spec.ts",
      "content": "import { webcrypto } from \"node:crypto\";\n\nimport type { Contact, EmailAndType } from \"../../types\";\nimport { getContactAvatar, hash } from \"./getContactAvatar\";\n\nObject.defineProperty(globalThis, \"crypto\", {\n  value: webcrypto,\n});\n\nit(\"should return gravatar URL for anthony@marmelab.com\", async () => {\n  const email: EmailAndType[] = [\n    { email: \"anthony@marmelab.com\", type: \"Work\" },\n  ];\n  const record: Partial<Contact> = { email_jsonb: email };\n\n  const avatarUrl = await getContactAvatar(record);\n  const hashedEmail = await hash(email[0].email);\n  expect(avatarUrl).toBe(\n    `https://www.gravatar.com/avatar/${hashedEmail}?d=404`,\n  );\n});\n\nit(\"should return favicon URL if gravatar does not exist\", async () => {\n  const email: EmailAndType[] = [\n    { email: \"no-gravatar@gravatar.com\", type: \"Work\" },\n  ];\n  const record: Partial<Contact> = { email_jsonb: email };\n\n  const avatarUrl = await getContactAvatar(record);\n  expect(avatarUrl).toBe(\"https://gravatar.com/favicon.ico\");\n});\n\nit(\"should not return favicon URL if not domain not allowed\", async () => {\n  const email: EmailAndType[] = [\n    { email: \"no-gravatar@gmail.com\", type: \"Work\" },\n  ];\n  const record: Partial<Contact> = { email_jsonb: email };\n\n  const avatarUrl = await getContactAvatar(record);\n  expect(avatarUrl).toBeNull();\n});\n\nit(\"should return null if no email is provided\", async () => {\n  const record: Partial<Contact> = {};\n\n  const avatarUrl = await getContactAvatar(record);\n  expect(avatarUrl).toBeNull();\n});\n\nit(\"should return null if an empty array is provided\", async () => {\n  const email: EmailAndType[] = [];\n  const record: Partial<Contact> = { email_jsonb: email };\n\n  const avatarUrl = await getContactAvatar(record);\n  expect(avatarUrl).toBeNull();\n});\n\nit(\"should return null if email has no gravatar or validate domain\", async () => {\n  const email: EmailAndType[] = [\n    { email: \"anthony@fake-domain-marmelab.com\", type: \"Work\" },\n  ];\n  const record: Partial<Contact> = { email_jsonb: email };\n\n  const avatarUrl = await getContactAvatar(record);\n  expect(avatarUrl).toBeNull();\n});\n\nit(\"should return gravatar URL for 2nd email if 1st email has no gravatar nor valid domain\", async () => {\n  const email: EmailAndType[] = [\n    { email: \"anthony@fake-domain-marmelab.com\", type: \"Work\" },\n    { email: \"anthony@marmelab.com\", type: \"Work\" },\n  ];\n  const record: Partial<Contact> = { email_jsonb: email };\n\n  const avatarUrl = await getContactAvatar(record);\n  const hashedEmail = await hash(email[1].email);\n  expect(avatarUrl).toBe(\n    `https://www.gravatar.com/avatar/${hashedEmail}?d=404`,\n  );\n});\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/commons/getCompanyAvatar.ts",
      "content": "import type { Company } from \"../../types\";\n\n// Main function to get the avatar URL\nexport async function getCompanyAvatar(record: Partial<Company>): Promise<{\n  src: string;\n  title: string;\n} | null> {\n  // TODO: Step 1: Try to get image from LinkedIn.\n\n  // Step 2: Fallback to the favicon from website domain\n  if (!record.website) {\n    return null;\n  }\n  const websiteUrlWithoutScheme = record.website\n    .replace(/^https?:\\/\\//, \"\")\n    .replace(/\\/$/, \"\");\n  return {\n    src: `https://favicon.show/${websiteUrlWithoutScheme}`,\n    title: \"Company favicon\",\n  };\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/commons/getCompanyAvatar.spec.ts",
      "content": "import type { Company } from \"../../types\";\nimport { getCompanyAvatar } from \"./getCompanyAvatar\";\n\nit(\"should return favicon URL if website url exist\", async () => {\n  const website = \"https://example.com\";\n  const record: Partial<Company> = { website };\n\n  const avatarUrl = await getCompanyAvatar(record);\n  expect(avatarUrl).toStrictEqual({\n    src: \"https://favicon.show/example.com\",\n    title: \"Company favicon\",\n  });\n});\n\nit(\"should return null if no website is provided\", async () => {\n  const record: Partial<Company> = {};\n\n  const avatarUrl = await getCompanyAvatar(record);\n  expect(avatarUrl).toBeNull();\n});\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/commons/canAccess.ts",
      "content": "// FIXME: This should be exported from the ra-core package\ntype CanAccessParams<\n  RecordType extends Record<string, any> = Record<string, any>,\n> = {\n  action: string;\n  resource: string;\n  record?: RecordType;\n};\n\nexport const canAccess = <\n  RecordType extends Record<string, any> = Record<string, any>,\n>(\n  role: string,\n  params: CanAccessParams<RecordType>,\n) => {\n  if (role === \"admin\") {\n    return true;\n  }\n\n  // Non admins can't access the sales resource\n  if (params.resource === \"sales\") {\n    return false;\n  }\n\n  return true;\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/commons/activity.ts",
      "content": "import type { DataProvider, Identifier } from \"ra-core\";\n\nimport {\n  COMPANY_CREATED,\n  COMPANY_NOTE_CREATED,\n  CONTACT_CREATED,\n  CONTACT_NOTE_CREATED,\n  DEAL_CREATED,\n  DEAL_NOTE_CREATED,\n} from \"../../consts\";\nimport type {\n  Activity,\n  Company,\n  CompanyNote,\n  Contact,\n  ContactNote,\n  Deal,\n  DealNote,\n} from \"../../types\";\n\n// FIXME: Requires 5 large queries to get the latest activities.\n// Replace with a server-side view or a custom API endpoint.\nexport async function getActivityLog(\n  dataProvider: DataProvider,\n  companyId?: Identifier,\n  salesId?: Identifier,\n) {\n  const companyFilter = {} as any;\n  if (companyId) {\n    companyFilter.id = companyId;\n  } else if (salesId) {\n    companyFilter[\"sales_id@in\"] = `(${salesId})`;\n  }\n\n  const filter = {} as any;\n  if (companyId) {\n    filter.company_id = companyId;\n  } else if (salesId) {\n    filter[\"sales_id@in\"] = `(${salesId})`;\n  }\n\n  const [newCompanies, newContactsAndNotes, newDealsAndNotes, newCompanyNotes] =\n    await Promise.all([\n      getNewCompanies(dataProvider, companyFilter),\n      getNewContactsAndNotes(dataProvider, filter),\n      getNewDealsAndNotes(dataProvider, filter),\n      getNewCompanyNotes(dataProvider, filter),\n    ]);\n  return (\n    [...newCompanies, ...newContactsAndNotes, ...newDealsAndNotes, ...newCompanyNotes]\n      // sort by date desc\n      .sort((a, b) =>\n        a.date && b.date ? a.date.localeCompare(b.date) * -1 : 0,\n      )\n      // limit to 250 activities\n      .slice(0, 250)\n  );\n}\n\nconst getNewCompanies = async (\n  dataProvider: DataProvider,\n  filter: any,\n): Promise<Activity[]> => {\n  const { data: companies } = await dataProvider.getList<Company>(\"companies\", {\n    filter,\n    pagination: { page: 1, perPage: 250 },\n    sort: { field: \"created_at\", order: \"DESC\" },\n  });\n  return companies.map((company) => ({\n    id: `company.${company.id}.created`,\n    type: COMPANY_CREATED,\n    company_id: company.id,\n    company,\n    sales_id: company.sales_id,\n    date: company.created_at,\n  }));\n};\n\nasync function getNewContactsAndNotes(\n  dataProvider: DataProvider,\n  filter: any,\n): Promise<Activity[]> {\n  const { data: contacts } = await dataProvider.getList<Contact>(\"contacts\", {\n    filter,\n    pagination: { page: 1, perPage: 250 },\n    sort: { field: \"first_seen\", order: \"DESC\" },\n  });\n\n  const recentContactNotesFilter = {} as any;\n  if (filter.sales_id) {\n    recentContactNotesFilter.sales_id = filter.sales_id;\n  }\n  if (filter.company_id) {\n    // No company_id field in contactNote, filtering by related contacts instead.\n    // This filter is only valid if a company has less than 250 contact.\n    const contactIds = contacts.map((contact) => contact.id).join(\",\");\n    recentContactNotesFilter[\"contact_id@in\"] = `(${contactIds})`;\n  }\n\n  const { data: contactNotes } = await dataProvider.getList<ContactNote>(\n    \"contactNotes\",\n    {\n      filter: recentContactNotesFilter,\n      pagination: { page: 1, perPage: 250 },\n      sort: { field: \"date\", order: \"DESC\" },\n    },\n  );\n\n  const newContacts = contacts.map((contact) => ({\n    id: `contact.${contact.id}.created`,\n    type: CONTACT_CREATED,\n    company_id: contact.company_id,\n    sales_id: contact.sales_id,\n    contact,\n    date: contact.first_seen,\n  }));\n\n  const newContactNotes = contactNotes.map((contactNote) => ({\n    id: `contactNote.${contactNote.id}.created`,\n    type: CONTACT_NOTE_CREATED,\n    sales_id: contactNote.sales_id,\n    contactNote,\n    date: contactNote.date,\n  }));\n\n  return [...newContacts, ...newContactNotes];\n}\n\nasync function getNewDealsAndNotes(\n  dataProvider: DataProvider,\n  filter: any,\n): Promise<Activity[]> {\n  const { data: deals } = await dataProvider.getList<Deal>(\"deals\", {\n    filter,\n    pagination: { page: 1, perPage: 250 },\n    sort: { field: \"created_at\", order: \"DESC\" },\n  });\n\n  const recentDealNotesFilter = {} as any;\n  if (filter.sales_id) {\n    recentDealNotesFilter.sales_id = filter.sales_id;\n  }\n  if (filter.company_id) {\n    // No company_id field in dealNote, filtering by related deals instead.\n    // This filter is only valid if a deal has less than 250 notes.\n    const dealIds = deals.map((deal) => deal.id).join(\",\");\n    recentDealNotesFilter[\"deal_id@in\"] = `(${dealIds})`;\n  }\n\n  const { data: dealNotes } = await dataProvider.getList<DealNote>(\n    \"dealNotes\",\n    {\n      filter: recentDealNotesFilter,\n      pagination: { page: 1, perPage: 250 },\n      sort: { field: \"date\", order: \"DESC\" },\n    },\n  );\n\n  const newDeals = deals.map((deal) => ({\n    id: `deal.${deal.id}.created`,\n    type: DEAL_CREATED,\n    company_id: deal.company_id,\n    sales_id: deal.sales_id,\n    deal,\n    date: deal.created_at,\n  }));\n\n  const newDealNotes = dealNotes.map((dealNote) => ({\n    id: `dealNote.${dealNote.id}.created`,\n    type: DEAL_NOTE_CREATED,\n    sales_id: dealNote.sales_id,\n    dealNote,\n    date: dealNote.date,\n  }));\n\n  return [...newDeals, ...newDealNotes];\n}\n\nasync function getNewCompanyNotes(\n  dataProvider: DataProvider,\n  filter: any,\n): Promise<Activity[]> {\n  const recentCompanyNotesFilter = {} as any;\n\n  if (filter.sales_id) {\n    recentCompanyNotesFilter.sales_id = filter.sales_id;\n  }\n  if (filter.company_id) {\n    recentCompanyNotesFilter.company_id = filter.company_id;\n  }\n\n  const { data: companyNotes } = await dataProvider.getList<CompanyNote>(\n    \"companyNotes\",\n    {\n      filter: recentCompanyNotesFilter,\n      pagination: { page: 1, perPage: 250 },\n      sort: { field: \"date\", order: \"DESC\" },\n    },\n  );\n\n  const newCompanyNotes = companyNotes.map((companyNote) => ({\n    id: `companyNote.${companyNote.id}.created`,\n    type: COMPANY_NOTE_CREATED,\n    sales_id: companyNote.sales_id,\n    companyNote,\n    date: companyNote.date,\n  }));\n\n  return newCompanyNotes;\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/notes/utils.ts",
      "content": "export const getCurrentDate = () => {\n  const now = new Date();\n  const offset = now.getTimezoneOffset();\n  const localDate = new Date(now.getTime() - offset * 60 * 1000);\n  return localDate.toISOString().slice(0, 16);\n};\n\nexport const formatNoteDate = (dateString: string) => {\n  const date = new Date(dateString);\n  date.setSeconds(0);\n  date.setMilliseconds(0);\n  return date.toISOString();\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/notes/index.ts",
      "content": "export * from \"./NoteCreate\";\nexport * from \"./NotesIterator\";\nexport * from \"./StatusSelector\";\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/notes/StatusSelector.tsx",
      "content": "import {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\n\nimport { Status } from \"../misc/Status\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\n\nexport const StatusSelector = ({ status, setStatus }: any) => {\n  const { noteStatuses } = useConfigurationContext();\n\n  const currentStatus = noteStatuses.find((s) => s.value === status);\n\n  return (\n    <Select value={status} onValueChange={setStatus}>\n      <SelectTrigger className=\"w-32\">\n        <SelectValue>\n          {currentStatus && (\n            <div className=\"flex items-center gap-2\">\n              {currentStatus.label} <Status status={currentStatus.value} />\n            </div>\n          )}\n        </SelectValue>\n      </SelectTrigger>\n      <SelectContent>\n        {noteStatuses.map((statusOption) => (\n          <SelectItem key={statusOption.value} value={statusOption.value}>\n            <div className=\"flex items-center gap-2\">\n              {statusOption.label} <Status status={statusOption.value} />\n            </div>\n          </SelectItem>\n        ))}\n      </SelectContent>\n    </Select>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/notes/NotesIterator.tsx",
      "content": "import { useListContext } from \"ra-core\";\nimport { Fragment } from \"react\";\nimport { Separator } from \"@/components/ui/separator\";\n\nimport { Note } from \"./Note\";\nimport { NoteCreate } from \"./NoteCreate\";\n\nexport const NotesIterator = ({\n  reference,\n  showStatus,\n}: {\n  reference: \"contacts\" | \"deals\" | \"companies\" | \"tasks\";\n  showStatus?: boolean;\n}) => {\n  const { data, error, isPending } = useListContext();\n  if (isPending || error) return null;\n  return (\n    <div className=\"mt-4\">\n      <NoteCreate reference={reference} showStatus={showStatus} />\n      {data && (\n        <div className=\"mt-4 space-y-4\">\n          {data.map((note, index) => (\n            <Fragment key={index}>\n              <Note\n                note={note}\n                isLast={index === data.length - 1}\n                key={index}\n                showStatus={showStatus}\n              />\n              {index < data.length - 1 && <Separator />}\n            </Fragment>\n          ))}\n        </div>\n      )}\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/notes/NoteInputs.tsx",
      "content": "import { useState } from \"react\";\nimport { useFormContext } from \"react-hook-form\";\nimport { TextInput } from \"@/components/admin/text-input\";\nimport { FileInput } from \"@/components/admin/file-input\";\nimport { FileField } from \"@/components/admin/file-field\";\nimport { SelectInput } from \"@/components/admin/select-input\";\nimport { DateTimeInput } from \"@/components/admin/date-time-input\";\nimport { Button } from \"@/components/ui/button\";\nimport { cn } from \"@/lib/utils\";\n\nimport { Status } from \"../misc/Status\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport { getCurrentDate } from \"./utils\";\n\nexport const NoteInputs = ({ showStatus }: { showStatus?: boolean }) => {\n  const { noteStatuses } = useConfigurationContext();\n  const { setValue } = useFormContext();\n  const [displayMore, setDisplayMore] = useState(false);\n\n  return (\n    <div className=\"space-y-2\">\n      <TextInput\n        source=\"text\"\n        label={false}\n        multiline\n        helperText={false}\n        placeholder=\"Add a note\"\n        rows={6}\n      />\n\n      {!displayMore && (\n        <div className=\"flex justify-end items-center gap-2\">\n          <Button\n            variant=\"link\"\n            size=\"sm\"\n            onClick={() => {\n              setDisplayMore(!displayMore);\n              setValue(\"date\", getCurrentDate());\n            }}\n            className=\"text-sm text-muted-foreground underline hover:no-underline p-0 h-auto cursor-pointer\"\n          >\n            Show options\n          </Button>\n          <span className=\"text-sm text-muted-foreground\">\n            (attach files, or change details)\n          </span>\n        </div>\n      )}\n\n      <div\n        className={cn(\n          \"space-y-3 mt-3 overflow-hidden transition-transform ease-in-out duration-300 origin-top\",\n          !displayMore ? \"scale-y-0 max-h-0 h-0\" : \"scale-y-100\",\n        )}\n      >\n        <div className=\"grid grid-cols-2 gap-4\">\n          {showStatus && (\n            <SelectInput\n              source=\"status\"\n              choices={noteStatuses.map((status) => ({\n                id: status.value,\n                name: status.label,\n                value: status.value,\n              }))}\n              optionText={optionRenderer}\n              defaultValue={\"warm\"}\n              helperText={false}\n            />\n          )}\n          <DateTimeInput\n            source=\"date\"\n            label=\"Date\"\n            helperText={false}\n            className=\"text-primary\"\n            defaultValue={getCurrentDate()}\n          />\n        </div>\n        <FileInput source=\"attachments\" multiple>\n          <FileField source=\"src\" title=\"title\" target=\"_blank\" />\n        </FileInput>\n      </div>\n    </div>\n  );\n};\n\nconst optionRenderer = (choice: any) => {\n  return (\n    <div>\n      <Status status={choice.value} /> {choice.name}\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/notes/NoteCreate.tsx",
      "content": "import {\n  CreateBase,\n  Form,\n  useGetIdentity,\n  useListContext,\n  useNotify,\n  useRecordContext,\n  useResourceContext,\n  useUpdate,\n  type Identifier,\n  type RaRecord,\n} from \"ra-core\";\nimport { useFormContext } from \"react-hook-form\";\nimport { SaveButton } from \"@/components/admin/form\";\nimport { cn } from \"@/lib/utils\";\n\nimport { NoteInputs } from \"./NoteInputs\";\nimport { getCurrentDate } from \"./utils\";\n\nconst foreignKeyMapping = {\n  contacts: \"contact_id\",\n  deals: \"deal_id\",\n  companies: \"company_id\",\n  tasks: \"task_id\",\n};\n\nexport const NoteCreate = ({\n  reference,\n  showStatus,\n  className,\n}: {\n  reference: \"contacts\" | \"deals\" | \"companies\" | \"tasks\";\n  showStatus?: boolean;\n  className?: string;\n}) => {\n  const resource = useResourceContext();\n  const record = useRecordContext();\n  const { identity } = useGetIdentity();\n\n  if (!record || !identity) return null;\n\n  return (\n    <CreateBase resource={resource} redirect={false}>\n      <Form>\n        <div className={cn(\"space-y-3\", className)}>\n          <NoteInputs showStatus={showStatus} />\n          <NoteCreateButton reference={reference} record={record} />\n        </div>\n      </Form>\n    </CreateBase>\n  );\n};\n\nconst NoteCreateButton = ({\n  reference,\n  record,\n}: {\n  reference: \"contacts\" | \"deals\" | \"companies\" | \"tasks\";\n  record: RaRecord<Identifier>;\n}) => {\n  const [update] = useUpdate();\n  const notify = useNotify();\n  const { identity } = useGetIdentity();\n  const { reset } = useFormContext();\n  const { refetch } = useListContext();\n\n  if (!record || !identity) return null;\n\n  const resetValues: {\n    date: string;\n    text: null;\n    attachments: null;\n    status?: string;\n  } = {\n    date: getCurrentDate(),\n    text: null,\n    attachments: null,\n  };\n\n  if (reference === \"contacts\") {\n    resetValues.status = \"warm\";\n  }\n\n  const handleSuccess = (data: any) => {\n    reset(resetValues, { keepValues: false });\n    refetch();\n\n    const updateData: any = { last_seen: new Date().toISOString() };\n    if (reference === \"contacts\") {\n      updateData.status = data.status;\n    }\n\n    update(reference, {\n      id: (record && record.id) as unknown as Identifier,\n      data: updateData,\n      previousData: record,\n    });\n    notify(\"Note added\");\n  };\n\n  return (\n    <div className=\"flex justify-end\">\n      <SaveButton\n        type=\"button\"\n        label=\"Add this note\"\n        transform={(data) => ({\n          ...data,\n          [foreignKeyMapping[reference]]: record.id,\n          sales_id: identity.id,\n          date: data.date || getCurrentDate(),\n        })}\n        mutationOptions={{\n          onSuccess: handleSuccess,\n        }}\n      >\n        Add this note\n      </SaveButton>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/notes/NoteAttachments.tsx",
      "content": "import { Paperclip } from \"lucide-react\";\n\nimport type { AttachmentNote, ContactNote, DealNote } from \"../types\";\n\nexport const NoteAttachments = ({ note }: { note: ContactNote | DealNote }) => {\n  if (!note.attachments || note.attachments.length === 0) {\n    return null;\n  }\n\n  const imageAttachments = note.attachments.filter(\n    (attachment: AttachmentNote) => isImageMimeType(attachment.type),\n  );\n  const otherAttachments = note.attachments.filter(\n    (attachment: AttachmentNote) => !isImageMimeType(attachment.type),\n  );\n\n  return (\n    <div className=\"flex flex-col\">\n      {imageAttachments.length > 0 && (\n        <div className=\"grid grid-cols-4 gap-8\">\n          {imageAttachments.map((attachment: AttachmentNote, index: number) => (\n            <div key={index}>\n              <img\n                src={attachment.src}\n                alt={attachment.title}\n                className=\"w-[200px] h-[100px] object-cover cursor-pointer object-left border border-border\"\n                onClick={() => window.open(attachment.src, \"_blank\")}\n              />\n            </div>\n          ))}\n        </div>\n      )}\n      {otherAttachments.length > 0 &&\n        otherAttachments.map((attachment: AttachmentNote, index: number) => (\n          <div key={index} className=\"flex items-center gap-2\">\n            <Paperclip className=\"w-4 h-4\" />\n            <a\n              href={attachment.src}\n              target=\"_blank\"\n              rel=\"noopener noreferrer\"\n              className=\"underline hover:no-underline\"\n            >\n              {attachment.title}\n            </a>\n          </div>\n        ))}\n    </div>\n  );\n};\n\nconst isImageMimeType = (mimeType?: string): boolean => {\n  if (!mimeType) {\n    return false;\n  }\n  return mimeType.startsWith(\"image/\");\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/notes/Note.tsx",
      "content": "import { CircleX, Edit, Save, Trash2 } from \"lucide-react\";\nimport {\n  Form,\n  useDelete,\n  useNotify,\n  useResourceContext,\n  useUpdate,\n  WithRecord,\n} from \"ra-core\";\nimport { useState } from \"react\";\nimport type { FieldValues, SubmitHandler } from \"react-hook-form\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\n\nimport { CompanyAvatar } from \"../companies/CompanyAvatar\";\nimport { Avatar } from \"../contacts/Avatar\";\nimport { RelativeDate } from \"../misc/RelativeDate\";\nimport { Status } from \"../misc/Status\";\nimport { SaleName } from \"../sales/SaleName\";\nimport type { ContactNote, DealNote } from \"../types\";\nimport { NoteAttachments } from \"./NoteAttachments\";\nimport { NoteInputs } from \"./NoteInputs\";\n\nexport const Note = ({\n  showStatus,\n  note,\n}: {\n  showStatus?: boolean;\n  note: DealNote | ContactNote;\n  isLast: boolean;\n}) => {\n  const [isHover, setHover] = useState(false);\n  const [isEditing, setEditing] = useState(false);\n  const resource = useResourceContext();\n  const notify = useNotify();\n\n  const [update, { isPending }] = useUpdate();\n\n  const [deleteNote] = useDelete(\n    resource,\n    { id: note.id, previousData: note },\n    {\n      mutationMode: \"undoable\",\n      onSuccess: () => {\n        notify(\"Note deleted\", { type: \"info\", undoable: true });\n      },\n    },\n  );\n\n  const handleDelete = () => {\n    deleteNote();\n  };\n\n  const handleEnterEditMode = () => {\n    setEditing(!isEditing);\n  };\n\n  const handleCancelEdit = () => {\n    setEditing(false);\n    setHover(false);\n  };\n\n  const handleNoteUpdate: SubmitHandler<FieldValues> = (values) => {\n    update(\n      resource,\n      { id: note.id, data: values, previousData: note },\n      {\n        onSuccess: () => {\n          setEditing(false);\n          setHover(false);\n        },\n      },\n    );\n  };\n\n  return (\n    <div\n      onMouseEnter={() => setHover(true)}\n      onMouseLeave={() => setHover(false)}\n    >\n      <div className=\"flex items-center space-x-4 w-full\">\n        {resource === \"contactNote\" ? (\n          <Avatar width={20} height={20} />\n        ) : (\n          <ReferenceField source=\"company_id\" reference=\"companies\" link=\"show\">\n            <CompanyAvatar width={20} height={20} />\n          </ReferenceField>\n        )}\n        <div className=\"inline-flex h-full items-center text-sm text-muted-foreground\">\n          <ReferenceField\n            record={note}\n            resource={resource}\n            source=\"sales_id\"\n            reference=\"sales\"\n            link={false}\n          >\n            <WithRecord render={(record) => <SaleName sale={record} />} />\n          </ReferenceField>{\" \"}\n          added a note{\" \"}\n          {showStatus && note.status && (\n            <Status className=\"ml-2\" status={note.status} />\n          )}\n        </div>\n        <span className={`${isHover ? \"visible\" : \"invisible\"}`}>\n          <TooltipProvider>\n            <Tooltip>\n              <TooltipTrigger asChild>\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={handleEnterEditMode}\n                  className=\"p-1 h-auto cursor-pointer\"\n                >\n                  <Edit className=\"w-4 h-4\" />\n                </Button>\n              </TooltipTrigger>\n              <TooltipContent>\n                <p>Edit note</p>\n              </TooltipContent>\n            </Tooltip>\n          </TooltipProvider>\n          <TooltipProvider>\n            <Tooltip>\n              <TooltipTrigger asChild>\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={handleDelete}\n                  className=\"p-1 h-auto cursor-pointer\"\n                >\n                  <Trash2 className=\"w-4 h-4\" />\n                </Button>\n              </TooltipTrigger>\n              <TooltipContent>\n                <p>Delete note</p>\n              </TooltipContent>\n            </Tooltip>\n          </TooltipProvider>\n        </span>\n        <div className=\"flex-1\"></div>\n        <span className=\"text-sm text-muted-foreground\">\n          <RelativeDate date={note.date} />\n        </span>\n      </div>\n      {isEditing ? (\n        <Form onSubmit={handleNoteUpdate} record={note} className=\"mt-1\">\n          <NoteInputs showStatus={showStatus} />\n          <div className=\"flex justify-end mt-2 space-x-4\">\n            <Button\n              variant=\"ghost\"\n              onClick={handleCancelEdit}\n              type=\"button\"\n              className=\"cursor-pointer\"\n            >\n              <CircleX className=\"w-4 h-4\" />\n              Cancel\n            </Button>\n            <Button\n              type=\"submit\"\n              disabled={isPending}\n              className=\"flex items-center gap-2 cursor-pointer\"\n            >\n              <Save className=\"w-4 h-4\" />\n              Update note\n            </Button>\n          </div>\n        </Form>\n      ) : (\n        <div className=\"pt-2 [&_p:empty]:min-h-[0.75em]\">\n          {note.text?.split(\"\\n\").map((paragraph: string, index: number) => (\n            <p className=\"text-sm leading-6 m-0\" key={index}>\n              {paragraph}\n            </p>\n          ))}\n\n          {note.attachments && <NoteAttachments note={note} />}\n        </div>\n      )}\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/misc/usePapaParse.tsx",
      "content": "import * as Papa from \"papaparse\";\nimport { useCallback, useMemo, useRef, useState } from \"react\";\n\ntype Import =\n  | {\n      state: \"idle\";\n    }\n  | {\n      state: \"parsing\";\n    }\n  | {\n      state: \"running\" | \"complete\";\n\n      rowCount: number;\n      importCount: number;\n      errorCount: number;\n\n      // The remaining time in milliseconds\n      remainingTime: number | null;\n    }\n  | {\n      state: \"error\";\n\n      error: Error;\n    };\n\ntype usePapaParseProps<T> = {\n  // The import batch size\n  batchSize?: number;\n\n  // processBatch returns the number of imported items\n  processBatch(batch: T[]): Promise<void>;\n};\n\nexport function usePapaParse<T>({\n  batchSize = 10,\n  processBatch,\n}: usePapaParseProps<T>) {\n  const importIdRef = useRef<number>(0);\n\n  const [importer, setImporter] = useState<Import>({\n    state: \"idle\",\n  });\n\n  const reset = useCallback(() => {\n    setImporter({\n      state: \"idle\",\n    });\n    importIdRef.current += 1;\n  }, []);\n\n  const parseCsv = useCallback(\n    (file: File) => {\n      setImporter({\n        state: \"parsing\",\n      });\n\n      const importId = importIdRef.current;\n      Papa.parse<T>(file, {\n        header: true,\n        skipEmptyLines: true,\n        async complete(results) {\n          if (importIdRef.current !== importId) {\n            return;\n          }\n\n          setImporter({\n            state: \"running\",\n            rowCount: results.data.length,\n            errorCount: results.errors.length,\n            importCount: 0,\n            remainingTime: null,\n          });\n\n          let totalTime = 0;\n          for (let i = 0; i < results.data.length; i += batchSize) {\n            if (importIdRef.current !== importId) {\n              return;\n            }\n\n            const batch = results.data.slice(i, i + batchSize);\n            try {\n              const start = Date.now();\n              await processBatch(batch);\n              totalTime += Date.now() - start;\n\n              const meanTime = totalTime / (i + batch.length);\n              setImporter((previous) => {\n                if (previous.state === \"running\") {\n                  const importCount = previous.importCount + batch.length;\n                  return {\n                    ...previous,\n                    importCount,\n                    remainingTime:\n                      meanTime * (results.data.length - importCount),\n                  };\n                }\n                return previous;\n              });\n            } catch (error) {\n              console.error(\"Failed to import batch\", error);\n              setImporter((previous) =>\n                previous.state === \"running\"\n                  ? {\n                      ...previous,\n                      errorCount: previous.errorCount + batch.length,\n                    }\n                  : previous,\n              );\n            }\n          }\n\n          setImporter((previous) =>\n            previous.state === \"running\"\n              ? {\n                  ...previous,\n                  state: \"complete\",\n                  remainingTime: null,\n                }\n              : previous,\n          );\n        },\n        error(error) {\n          console.error(error);\n          setImporter({\n            state: \"error\",\n            error,\n          });\n        },\n        dynamicTyping: true,\n      });\n    },\n    [batchSize, processBatch],\n  );\n\n  return useMemo(\n    () => ({\n      importer,\n      parseCsv,\n      reset,\n    }),\n    [importer, parseCsv, reset],\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/misc/useAppBarHeight.ts",
      "content": "import { useIsMobile } from \"@/hooks/use-mobile\";\n\nconst DENSE_NAVBAR_HEIGHT = 48;\nconst DENSE_NAVBAR_HEIGHT_MOBILE = 64;\n\nexport default function useAppBarHeight(): number {\n  const isMobile = useIsMobile();\n  return isMobile ? DENSE_NAVBAR_HEIGHT_MOBILE : DENSE_NAVBAR_HEIGHT;\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/misc/unsupportedDomains.const.ts",
      "content": "// If you want to add more domains to the list, you can do so by adding them to the DOMAINS_NOT_SUPPORTING_FAVICON array.\nexport const DOMAINS_NOT_SUPPORTING_FAVICON = [\n  \"gmail.com\",\n  \"yahoo.com\",\n  \"hotmail.com\",\n  \"aol.com\",\n  \"hotmail.co.uk\",\n  \"hotmail.fr\",\n  \"msn.com\",\n  \"yahoo.fr\",\n  \"wanadoo.fr\",\n  \"orange.fr\",\n  \"comcast.net\",\n  \"yahoo.co.uk\",\n  \"yahoo.com.br\",\n  \"yahoo.co.in\",\n  \"live.com\",\n  \"rediffmail.com\",\n  \"free.fr\",\n  \"gmx.de\",\n  \"web.de\",\n  \"yandex.ru\",\n  \"ymail.com\",\n  \"libero.it\",\n  \"outlook.com\",\n  \"uol.com.br\",\n  \"bol.com.br\",\n  \"mail.ru\",\n  \"cox.net\",\n  \"hotmail.it\",\n  \"sbcglobal.net\",\n  \"sfr.fr\",\n  \"live.fr\",\n  \"verizon.net\",\n  \"live.co.uk\",\n  \"googlemail.com\",\n  \"yahoo.es\",\n  \"ig.com.br\",\n  \"live.nl\",\n  \"bigpond.com\",\n  \"terra.com.br\",\n  \"yahoo.it\",\n  \"neuf.fr\",\n  \"yahoo.de\",\n  \"alice.it\",\n  \"rocketmail.com\",\n  \"att.net\",\n  \"laposte.net\",\n  \"facebook.com\",\n  \"bellsouth.net\",\n  \"yahoo.in\",\n  \"hotmail.es\",\n  \"charter.net\",\n  \"yahoo.ca\",\n  \"yahoo.com.au\",\n  \"rambler.ru\",\n  \"hotmail.de\",\n  \"tiscali.it\",\n  \"shaw.ca\",\n  \"yahoo.co.jp\",\n  \"sky.com\",\n  \"earthlink.net\",\n  \"optonline.net\",\n  \"freenet.de\",\n  \"t-online.de\",\n  \"aliceadsl.fr\",\n  \"virgilio.it\",\n  \"home.nl\",\n  \"qq.com\",\n  \"telenet.be\",\n  \"me.com\",\n  \"yahoo.com.ar\",\n  \"tiscali.co.uk\",\n  \"yahoo.com.mx\",\n  \"voila.fr\",\n  \"gmx.net\",\n  \"mail.com\",\n  \"planet.nl\",\n  \"tin.it\",\n  \"live.it\",\n  \"ntlworld.com\",\n  \"arcor.de\",\n  \"yahoo.co.id\",\n  \"frontiernet.net\",\n  \"hetnet.nl\",\n  \"live.com.au\",\n  \"yahoo.com.sg\",\n  \"zonnet.nl\",\n  \"club-internet.fr\",\n  \"juno.com\",\n  \"optusnet.com.au\",\n  \"blueyonder.co.uk\",\n  \"bluewin.ch\",\n  \"skynet.be\",\n  \"sympatico.ca\",\n  \"windstream.net\",\n  \"mac.com\",\n  \"centurytel.net\",\n  \"chello.nl\",\n  \"live.ca\",\n  \"aim.com\",\n  \"bigpond.net.au\",\n  \"online.de\",\n  \"apple.com\",\n];\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/misc/isLinkedInUrl.ts",
      "content": "const LINKEDIN_URL_REGEX = /^http(?:s)?:\\/\\/(?:www\\.)?linkedin.com\\//;\n\nexport const isLinkedinUrl = (url: string) => {\n  if (!url) return;\n  try {\n    // Parse the URL to ensure it is valid\n    const parsedUrl = new URL(url);\n    if (!parsedUrl.href.match(LINKEDIN_URL_REGEX)) {\n      return \"URL must be from linkedin.com\";\n    }\n  } catch {\n    // If URL parsing fails, return false\n    return \"Must be a valid URL\";\n  }\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/misc/fetchWithTimeout.ts",
      "content": "type FetchParams = Parameters<typeof fetch>;\n\nexport async function fetchWithTimeout(\n  resource: string,\n  options: FetchParams[1] & { timeout?: number } = {},\n) {\n  const { timeout = 2000 } = options;\n\n  const controller = new AbortController();\n  const id = setTimeout(() => controller.abort(), timeout);\n\n  const response = await fetch(resource, {\n    ...options,\n    signal: controller.signal,\n  });\n  clearTimeout(id);\n\n  return response;\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/misc/Status.tsx",
      "content": "import { cn } from \"@/lib/utils\";\n\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\n\nexport const Status = ({\n  status,\n  className,\n}: {\n  status: string;\n  className?: string;\n}) => {\n  const { noteStatuses } = useConfigurationContext();\n  if (!status || !noteStatuses) return null;\n  const statusObject = noteStatuses.find((s: any) => s.value === status);\n\n  if (!statusObject) return null;\n  return (\n    <div className={cn(\"group relative inline-block mr-2\", className)}>\n      <span\n        className=\"inline-block w-2.5 h-2.5 rounded-full\"\n        style={{ backgroundColor: statusObject.color }}\n      />\n      <div className=\"absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-2 py-1 text-xs text-white bg-gray-800 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap z-10\">\n        {statusObject.label}\n      </div>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/misc/RelativeDate.tsx",
      "content": "import { formatRelative } from \"date-fns\";\n\nexport function RelativeDate({ date }: { date: string }) {\n  return formatRelative(new Date(date), new Date());\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/misc/ImageEditorField.tsx",
      "content": "import { useFieldValue } from \"ra-core\";\nimport { createRef, useCallback, useState } from \"react\";\nimport type { ReactCropperElement } from \"react-cropper\";\nimport { Cropper } from \"react-cropper\";\nimport { useDropzone } from \"react-dropzone\";\nimport { useFormContext } from \"react-hook-form\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\n\nimport \"cropperjs/dist/cropper.css\";\n\nconst ImageEditorField = (props: ImageEditorFieldProps) => {\n  const { getValues } = useFormContext();\n  const source = getValues(props.source);\n  const imageUrl = source?.src;\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n\n  const { type = \"image\", emptyText, linkPosition = \"none\" } = props;\n\n  const commonProps = {\n    src: imageUrl,\n    onClick: () => setIsDialogOpen(true),\n    style: { cursor: \"pointer\" },\n    className: `${props.className || \"\"}`,\n  };\n\n  const width = props.width || (type === \"avatar\" ? 50 : 200);\n  const height = props.height || (type === \"avatar\" ? 50 : 200);\n\n  return (\n    <>\n      <div\n        className={`flex ${\n          linkPosition === \"right\" ? \"flex-row\" : \"flex-col\"\n        } items-center ${\n          linkPosition === \"right\" ? \"gap-2\" : \"gap-1\"\n        } rounded p-${props.backgroundImageColor ? \"4\" : \"0\"}`}\n        style={{\n          backgroundColor: props.backgroundImageColor || \"transparent\",\n        }}\n      >\n        {props.type === \"avatar\" ? (\n          <Avatar\n            {...commonProps}\n            className={`cursor-pointer`}\n            style={{ width, height }}\n          >\n            <AvatarImage src={imageUrl} />\n            <AvatarFallback>{emptyText}</AvatarFallback>\n          </Avatar>\n        ) : (\n          <img\n            {...commonProps}\n            className=\"cursor-pointer object-cover\"\n            style={{ width, height }}\n            alt=\"Editable content\"\n          />\n        )}\n        {linkPosition !== \"none\" && (\n          <button\n            type=\"button\"\n            onClick={() => setIsDialogOpen(true)}\n            className=\"text-xs underline hover:no-underline cursor-pointer text-center\"\n          >\n            Change\n          </button>\n        )}\n      </div>\n      <ImageEditorDialog\n        open={isDialogOpen}\n        onClose={() => setIsDialogOpen(false)}\n        {...props}\n      />\n    </>\n  );\n};\n\nconst ImageEditorDialog = (props: ImageEditorDialogProps) => {\n  const { setValue, handleSubmit } = useFormContext();\n  const cropperRef = createRef<ReactCropperElement>();\n  const initialValue = useFieldValue({ source: props.source });\n  const [file, setFile] = useState<File | undefined>();\n  const [imageSrc, setImageSrc] = useState<string | undefined>(\n    initialValue?.src,\n  );\n  const onDrop = useCallback((files: File[]) => {\n    const preview = URL.createObjectURL(files[0]);\n    setFile(files[0]);\n    setImageSrc(preview);\n  }, []);\n\n  const updateImage = () => {\n    const cropper = cropperRef.current?.cropper;\n    const croppedImage = cropper?.getCroppedCanvas().toDataURL();\n    if (croppedImage) {\n      setImageSrc(croppedImage);\n\n      const newFile = file ?? new File([], initialValue?.src);\n      setValue(\n        props.source,\n        {\n          src: croppedImage,\n          title: newFile.name,\n          rawFile: newFile,\n        },\n        { shouldDirty: true },\n      );\n      props.onClose();\n\n      if (props.onSave) {\n        handleSubmit(props.onSave)();\n      }\n    }\n  };\n\n  const deleteImage = () => {\n    setValue(props.source, null, { shouldDirty: true });\n    if (props.onSave) {\n      handleSubmit(props.onSave)();\n    }\n    setImageSrc(undefined);\n    props.onClose();\n  };\n\n  const { getRootProps, getInputProps } = useDropzone({\n    accept: { \"image/jpeg\": [\".jpeg\", \".png\"] },\n    onDrop,\n    maxFiles: 1,\n  });\n\n  return (\n    <Dialog open={props.open} onOpenChange={props.onClose}>\n      {props.type === \"avatar\" && (\n        <style>\n          {`\n                        .cropper-crop-box,\n                        .cropper-view-box {\n                            border-radius: 50%;\n                        }\n                    `}\n        </style>\n      )}\n      <DialogContent>\n        <DialogHeader>\n          <DialogTitle>Upload and resize image</DialogTitle>\n        </DialogHeader>\n        <div className=\"flex flex-col gap-2 justify-center\">\n          <div\n            className=\"flex flex-row justify-center bg-gray-50 cursor-pointer p-4 border-2 border-dashed border-gray-300 rounded-lg hover:bg-gray-100 transition-colors\"\n            {...getRootProps()}\n          >\n            <input {...getInputProps()} />\n            <p className=\"text-gray-600\">\n              Drop a file to upload, or click to select it.\n            </p>\n          </div>\n\n          {imageSrc && (\n            <Cropper\n              ref={cropperRef}\n              src={imageSrc}\n              aspectRatio={1}\n              guides={false}\n              cropBoxResizable={false}\n            />\n          )}\n        </div>\n\n        <DialogFooter className=\"flex justify-between w-full\">\n          <Button type=\"button\" onClick={updateImage}>\n            Update Image\n          </Button>\n          <Button type=\"button\" variant=\"destructive\" onClick={deleteImage}>\n            Delete\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n};\n\nexport default ImageEditorField;\n\nexport interface ImageEditorFieldProps {\n  source: string;\n  width?: number;\n  height?: number;\n  type?: \"avatar\" | \"image\";\n  onSave?: any;\n  linkPosition?: \"right\" | \"bottom\" | \"none\";\n  backgroundImageColor?: string;\n  className?: string;\n  emptyText?: string;\n}\n\nexport interface ImageEditorDialogProps extends ImageEditorFieldProps {\n  open: boolean;\n  onClose: () => void;\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/misc/ContactOption.tsx",
      "content": "import { useRecordContext } from \"ra-core\";\n\nimport { Avatar } from \"../contacts/Avatar\";\nimport type { Contact } from \"../types\";\n\n// eslint-disable-next-line react-refresh/only-export-components\nconst ContactOptionRender = () => {\n  const record: Contact | undefined = useRecordContext();\n  if (!record) return null;\n  return (\n    <div className=\"flex flex-row gap-4 items-center justify-start\">\n      <Avatar height={40} width={40} record={record} />\n      <div className=\"flex flex-col items-start gap-1\">\n        <span>\n          {record.first_name} {record.last_name}\n        </span>\n        <span className=\"text-xs text-muted-foreground\">\n          {record.title}\n          {record.title && record.company_name && \" at \"}\n          {record.company_name}\n        </span>\n      </div>\n    </div>\n  );\n};\nexport const contactOptionText = <ContactOptionRender />;\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/misc/AsideSection.tsx",
      "content": "import type { ReactNode } from \"react\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { cn } from \"@/lib/utils\";\n\nexport type AsideSectionProps = {\n  title: string;\n  children?: ReactNode;\n  noGap?: boolean;\n};\n\nexport function AsideSection({ title, children, noGap }: AsideSectionProps) {\n  return (\n    <div className=\"mb-6 text-sm\">\n      <h3 className=\"font-medium pb-1\">{title}</h3>\n      <Separator />\n      <div className={cn(\"pt-2 flex flex-col\", { \"gap-1\": !noGap })}>\n        {children}\n      </div>\n    </div>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/login/StartPage.tsx",
      "content": "import { useQuery } from \"@tanstack/react-query\";\nimport { useDataProvider } from \"ra-core\";\nimport { Navigate } from \"react-router-dom\";\nimport { LoginPage } from \"@/components/admin/login-page\";\n\nimport type { CrmDataProvider } from \"../providers/types\";\nimport { LoginSkeleton } from \"./LoginSkeleton\";\n\nexport const StartPage = () => {\n  const dataProvider = useDataProvider<CrmDataProvider>();\n  const {\n    data: isInitialized,\n    error,\n    isPending,\n  } = useQuery({\n    queryKey: [\"init\"],\n    queryFn: async () => {\n      return dataProvider.isInitialized();\n    },\n  });\n\n  if (isPending) return <LoginSkeleton />;\n  if (error) return <LoginPage />;\n  if (isInitialized) return <LoginPage />;\n\n  return <Navigate to=\"/sign-up\" />;\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/login/SignupPage.tsx",
      "content": "import { useMutation, useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { Loader2 } from \"lucide-react\";\nimport { useDataProvider, useLogin, useNotify } from \"ra-core\";\nimport { useForm, type SubmitHandler } from \"react-hook-form\";\nimport { Navigate } from \"react-router\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\n\nimport type { CrmDataProvider } from \"../providers/types\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport type { SignUpData } from \"../types\";\nimport { LoginSkeleton } from \"./LoginSkeleton\";\n\nexport const SignupPage = () => {\n  const queryClient = useQueryClient();\n  const dataProvider = useDataProvider<CrmDataProvider>();\n  const { darkModeLogo: logo, title } = useConfigurationContext();\n  const { data: isInitialized, isPending } = useQuery({\n    queryKey: [\"init\"],\n    queryFn: async () => {\n      return dataProvider.isInitialized();\n    },\n  });\n\n  const { isPending: isSignUpPending, mutate } = useMutation({\n    mutationKey: [\"signup\"],\n    mutationFn: async (data: SignUpData) => {\n      return dataProvider.signUp(data);\n    },\n    onSuccess: (data) => {\n      login({\n        email: data.email,\n        password: data.password,\n        redirectTo: \"/contacts\",\n      }).then(() => {\n        notify(\"Initial user successfully created\");\n        // FIXME: We should probably provide a hook for that in the ra-core package\n        queryClient.invalidateQueries({\n          queryKey: [\"auth\", \"canAccess\"],\n        });\n      });\n    },\n    onError: () => {\n      notify(\"An error occurred. Please try again.\");\n    },\n  });\n\n  const login = useLogin();\n  const notify = useNotify();\n\n  const {\n    register,\n    handleSubmit,\n    formState: { isValid },\n  } = useForm<SignUpData>({\n    mode: \"onChange\",\n  });\n\n  if (isPending) {\n    return <LoginSkeleton />;\n  }\n\n  // For the moment, we only allow one user to sign up. Other users must be created by the administrator.\n  if (isInitialized) {\n    return <Navigate to=\"/login\" />;\n  }\n\n  const onSubmit: SubmitHandler<SignUpData> = async (data) => {\n    mutate(data);\n  };\n\n  return (\n    <div className=\"h-screen p-8\">\n      <div className=\"flex items-center gap-4\">\n        <img\n          src={logo}\n          alt={title}\n          width={24}\n          className=\"filter brightness-0 invert\"\n        />\n        <h1 className=\"text-xl font-semibold\">{title}</h1>\n      </div>\n      <div className=\"h-full\">\n        <div className=\"max-w-sm mx-auto h-full flex flex-col justify-center gap-4\">\n          <h1 className=\"text-2xl font-bold mb-4\">Welcome to CRM</h1>\n          <p className=\"text-base mb-4\">\n            Create the first user account to complete the setup.\n          </p>\n          <form onSubmit={handleSubmit(onSubmit)} className=\"space-y-4\">\n            <div className=\"flex flex-col gap-2\">\n              <Label htmlFor=\"first_name\">First name</Label>\n              <Input\n                {...register(\"first_name\", { required: true })}\n                id=\"first_name\"\n                type=\"text\"\n                required\n              />\n            </div>\n            <div className=\"flex flex-col gap-2\">\n              <Label htmlFor=\"last_name\">Last name</Label>\n              <Input\n                {...register(\"last_name\", { required: true })}\n                id=\"last_name\"\n                type=\"text\"\n                required\n              />\n            </div>\n            <div className=\"flex flex-col gap-2\">\n              <Label htmlFor=\"email\">Email</Label>\n              <Input\n                {...register(\"email\", { required: true })}\n                id=\"email\"\n                type=\"email\"\n                required\n              />\n            </div>\n            <div className=\"flex flex-col gap-2\">\n              <Label htmlFor=\"password\">Password</Label>\n              <Input\n                {...register(\"password\", { required: true })}\n                id=\"password\"\n                type=\"password\"\n                required\n              />\n            </div>\n            <div className=\"flex justify-between items-center mt-8\">\n              <Button\n                type=\"submit\"\n                disabled={!isValid || isSignUpPending}\n                className=\"w-full\"\n              >\n                {isSignUpPending ? (\n                  <>\n                    <Loader2 className=\"w-4 h-4 animate-spin mr-2\" />\n                    Creating...\n                  </>\n                ) : (\n                  \"Create account\"\n                )}\n              </Button>\n            </div>\n          </form>\n        </div>\n      </div>\n    </div>\n  );\n};\n\nSignupPage.path = \"/sign-up\";\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/login/LoginSkeleton.tsx",
      "content": "import { Skeleton } from \"@/components/ui/skeleton\";\n\nexport const LoginSkeleton = () => {\n  return (\n    <div className=\"max-w-screen-xl mx-auto h-screen pt-8\">\n      <div className=\"h-full\">\n        <div className=\"max-w-sm mx-auto h-full flex flex-col justify-center gap-8\">\n          <Skeleton className=\"w-full h-[100px]\" />\n          <Skeleton className=\"w-4/5 h-[50px]\" />\n          <Skeleton className=\"w-full h-9\" />\n          <Skeleton className=\"w-full h-9\" />\n          <Skeleton className=\"w-full h-9\" />\n          <Skeleton className=\"w-2/5 h-9\" />\n        </div>\n      </div>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/layout/TopToolbar.tsx",
      "content": "import { cn } from \"@/lib/utils\";\nimport type { HTMLAttributes, ReactNode } from \"react\";\n\nexport interface TopToolbarProps extends HTMLAttributes<HTMLDivElement> {\n  children?: ReactNode;\n}\n\nexport const TopToolbar = (inProps: TopToolbarProps) => {\n  const { className, children, ...props } = inProps;\n\n  return (\n    <div\n      className={cn(\n        \"flex flex-auto justify-end items-end gap-2 whitespace-nowrap\",\n        className,\n      )}\n      {...props}\n    >\n      {children}\n    </div>\n  );\n};\n\nexport default TopToolbar;\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/layout/Layout.tsx",
      "content": "import { Suspense, type ReactNode } from \"react\";\nimport { ErrorBoundary } from \"react-error-boundary\";\nimport { Notification } from \"@/components/admin/notification\";\nimport { Error } from \"@/components/admin/error\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\n\nimport Header from \"./Header\";\n\nexport const Layout = ({ children }: { children: ReactNode }) => (\n  <>\n    <Header />\n    <main className=\"max-w-screen-xl mx-auto pt-20 px-4\" id=\"main-content\">\n      <ErrorBoundary FallbackComponent={Error}>\n        <Suspense fallback={<Skeleton className=\"h-12 w-12 rounded-full\" />}>\n          {children}\n        </Suspense>\n      </ErrorBoundary>\n    </main>\n    <Notification />\n  </>\n);\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/layout/Header.tsx",
      "content": "import {\n  DropdownMenuItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n} from \"@/components/ui/dropdown-menu\";\nimport { Database, Settings, User, Webhook } from \"lucide-react\";\nimport { CanAccess } from \"ra-core\";\nimport { Link, matchPath, useLocation } from \"react-router\";\nimport { RefreshButton } from \"@/components/admin/refresh-button\";\nimport { ThemeModeToggle } from \"@/components/admin/theme-mode-toggle\";\nimport { UserMenu } from \"@/components/admin/user-menu\";\nimport { useUserMenu } from \"@/hooks/user-menu-context\";\n\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\n\nconst Header = () => {\n  const { darkModeLogo, lightModeLogo, title } = useConfigurationContext();\n  const location = useLocation();\n\n  // Simplified path matching logic\n  const navPaths = [\n    { path: \"/\", pattern: \"/\" },\n    { path: \"/contacts\", pattern: \"/contacts/*\" },\n    { path: \"/companies\", pattern: \"/companies/*\" },\n    { path: \"/deals\", pattern: \"/deals/*\" },\n    { path: \"/tasks\", pattern: \"/tasks/*\" },\n  ];\n\n  const currentPath =\n    navPaths.find((nav) => matchPath(nav.pattern, location.pathname))?.path ||\n    false;\n\n  return (\n    <header className=\"bg-secondary fixed top-0 left-0 right-0 z-50 border-b border-border\">\n      <div className=\"px-4\">\n        <div className=\"flex justify-between items-center flex-1\">\n          <Logo darkLogo={darkModeLogo} lightLogo={lightModeLogo} title={title} />\n\n          <nav className=\"flex\" aria-label=\"Main navigation\">\n            <NavigationTab\n              label=\"Dashboard\"\n              to=\"/\"\n              isActive={currentPath === \"/\"}\n            />\n            <NavigationTab\n              label=\"Contacts\"\n              to=\"/contacts\"\n              isActive={currentPath === \"/contacts\"}\n            />\n            <NavigationTab\n              label=\"Companies\"\n              to=\"/companies\"\n              isActive={currentPath === \"/companies\"}\n            />\n            <NavigationTab\n              label=\"Deals\"\n              to=\"/deals\"\n              isActive={currentPath === \"/deals\"}\n            />\n            <NavigationTab\n              label=\"Tasks\"\n              to=\"/tasks\"\n              isActive={currentPath === \"/tasks\"}\n            />\n          </nav>\n\n          <div className=\"flex items-center\">\n            <ThemeModeToggle />\n            <RefreshButton />\n            <UserMenu>\n              <ConfigurationMenu />\n              <DatabaseMenu />\n              <IntegrationsMenu />\n              <CanAccess resource=\"sales\" action=\"list\">\n                <UsersMenu />\n              </CanAccess>\n              <DropdownMenuSeparator />\n              <DropdownMenuLabel className=\"font-normal\">\n                <div className=\"text-xs text-muted-foreground\">\n                  Version {import.meta.env.VITE_APP_VERSION}\n                </div>\n              </DropdownMenuLabel>\n            </UserMenu>\n          </div>\n        </div>\n      </div>\n    </header>\n  );\n};\n\nconst Logo = ({\n  darkLogo,\n  lightLogo,\n  title,\n}: {\n  darkLogo: string;\n  lightLogo: string;\n  title: string;\n}) => (\n  <Link\n    to=\"/\"\n    className=\"flex items-center gap-2 text-secondary-foreground no-underline hover:opacity-80 transition-opacity\"\n  >\n    <img\n      className=\"[.light_&]:hidden h-6\"\n      src={darkLogo}\n      alt={`${title} logo`}\n    />\n    <img\n      className=\"[.dark_&]:hidden h-6\"\n      src={lightLogo}\n      alt={`${title} logo`}\n    />\n    <h1 className=\"text-xl font-semibold\">{title}</h1>\n  </Link>\n);\n\nconst NavigationTab = ({\n  label,\n  to,\n  isActive,\n}: {\n  label: string;\n  to: string;\n  isActive: boolean;\n}) => (\n  <Link\n    to={to}\n    className={`px-6 py-3 text-sm font-medium transition-colors border-b-2 ${\n      isActive\n        ? \"text-secondary-foreground border-secondary-foreground\"\n        : \"text-secondary-foreground/70 border-transparent hover:text-secondary-foreground/80\"\n    }`}\n  >\n    {label}\n  </Link>\n);\n\nconst UsersMenu = () => {\n  const { onClose } = useUserMenu() ?? {};\n  return (\n    <DropdownMenuItem asChild onClick={onClose}>\n      <Link to=\"/sales\" className=\"flex items-center gap-2\">\n        <User className=\"h-4 w-4\" />\n        Users\n      </Link>\n    </DropdownMenuItem>\n  );\n};\n\nconst ConfigurationMenu = () => {\n  const { onClose } = useUserMenu() ?? {};\n  return (\n    <DropdownMenuItem asChild onClick={onClose}>\n      <Link to=\"/settings\" className=\"flex items-center gap-2\">\n        <Settings className=\"h-4 w-4\" />\n        My info\n      </Link>\n    </DropdownMenuItem>\n  );\n};\n\nconst DatabaseMenu = () => {\n  const { onClose } = useUserMenu() ?? {};\n  return (\n    <DropdownMenuItem asChild onClick={onClose}>\n      <Link to=\"/database\" className=\"flex items-center gap-2\">\n        <Database className=\"h-4 w-4\" />\n        Database\n      </Link>\n    </DropdownMenuItem>\n  );\n};\n\nconst IntegrationsMenu = () => {\n  const { onClose } = useUserMenu() ?? {};\n  return (\n    <DropdownMenuItem asChild onClick={onClose}>\n      <Link to=\"/integrations\" className=\"flex items-center gap-2\">\n        <Webhook className=\"h-4 w-4\" />\n        Integrations\n      </Link>\n    </DropdownMenuItem>\n  );\n};\n\nexport default Header;\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/layout/FormToolbar.tsx",
      "content": "import { CancelButton } from \"@/components/admin/cancel-button\";\nimport { SaveButton } from \"@/components/admin/form\";\n\nexport const FormToolbar = () => (\n  <div\n    role=\"toolbar\"\n    className=\"sticky flex pt-4 pb-4 md:pb-0 bottom-0 bg-linear-to-b from-transparent to-card to-10% flex-row justify-end gap-2\"\n  >\n    <CancelButton />\n    <SaveButton />\n  </div>\n);\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/integrations/WebhooksTab.tsx",
      "content": "import { useState } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { useDataProvider, useNotify, useGetIdentity } from \"ra-core\";\nimport { useForm } from \"react-hook-form\";\nimport { generateApiKey } from \"@/lib/api-key-utils\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Plus, Trash2, Power, PowerOff } from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { format } from \"date-fns\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\n\nconst AVAILABLE_EVENTS = [\n  { value: \"contact.created\", label: \"Contact Created\", category: \"Contacts\" },\n  { value: \"contact.updated\", label: \"Contact Updated\", category: \"Contacts\" },\n  { value: \"contact.deleted\", label: \"Contact Deleted\", category: \"Contacts\" },\n  { value: \"company.created\", label: \"Company Created\", category: \"Companies\" },\n  { value: \"company.updated\", label: \"Company Updated\", category: \"Companies\" },\n  { value: \"company.deleted\", label: \"Company Deleted\", category: \"Companies\" },\n  { value: \"deal.created\", label: \"Deal Created\", category: \"Deals\" },\n  { value: \"deal.updated\", label: \"Deal Updated\", category: \"Deals\" },\n  { value: \"deal.deleted\", label: \"Deal Deleted\", category: \"Deals\" },\n  {\n    value: \"deal.stage_changed\",\n    label: \"Deal Stage Changed\",\n    category: \"Deals\",\n  },\n  { value: \"deal.won\", label: \"Deal Won\", category: \"Deals\" },\n  { value: \"deal.lost\", label: \"Deal Lost\", category: \"Deals\" },\n  { value: \"task.created\", label: \"Task Created\", category: \"Tasks\" },\n  { value: \"task.updated\", label: \"Task Updated\", category: \"Tasks\" },\n  { value: \"task.assigned\", label: \"Task Assigned\", category: \"Tasks\" },\n  { value: \"task.completed\", label: \"Task Completed\", category: \"Tasks\" },\n  {\n    value: \"task.priority_changed\",\n    label: \"Task Priority Changed\",\n    category: \"Tasks\",\n  },\n  { value: \"task.archived\", label: \"Task Archived\", category: \"Tasks\" },\n  { value: \"task.deleted\", label: \"Task Deleted\", category: \"Tasks\" },\n];\n\nexport const WebhooksTab = () => {\n  const [showCreateDialog, setShowCreateDialog] = useState(false);\n  const [webhookToDelete, setWebhookToDelete] = useState<number | null>(null);\n  const dataProvider = useDataProvider();\n  const notify = useNotify();\n  const queryClient = useQueryClient();\n\n  const { data: webhooks, isLoading } = useQuery({\n    queryKey: [\"webhooks\"],\n    queryFn: async () => {\n      const { data } = await dataProvider.getList(\"webhooks\", {\n        pagination: { page: 1, perPage: 100 },\n        sort: { field: \"created_at\", order: \"DESC\" },\n        filter: {},\n      });\n      return data;\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: number) => {\n      await dataProvider.delete(\"webhooks\", { id, previousData: {} });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"webhooks\"] });\n      notify(\"Webhook deleted successfully\");\n      setWebhookToDelete(null);\n    },\n    onError: () => {\n      notify(\"Failed to delete webhook\", { type: \"error\" });\n    },\n  });\n\n  const toggleMutation = useMutation({\n    mutationFn: async ({ id, is_active }: { id: number; is_active: boolean }) => {\n      await dataProvider.update(\"webhooks\", {\n        id,\n        data: { is_active },\n        previousData: {},\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"webhooks\"] });\n      notify(\"Webhook updated successfully\");\n    },\n    onError: () => {\n      notify(\"Failed to update webhook\", { type: \"error\" });\n    },\n  });\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex justify-between items-center\">\n        <p className=\"text-sm text-muted-foreground\">\n          Webhooks notify external systems when events occur in your CRM.\n        </p>\n        <Button onClick={() => setShowCreateDialog(true)}>\n          <Plus className=\"h-4 w-4 mr-2\" />\n          Create Webhook\n        </Button>\n      </div>\n\n      {isLoading ? (\n        <Card>\n          <CardContent className=\"py-8 text-center text-muted-foreground\">\n            Loading...\n          </CardContent>\n        </Card>\n      ) : webhooks && webhooks.length > 0 ? (\n        <div className=\"space-y-3\">\n          {webhooks.map((webhook: any) => (\n            <WebhookCard\n              key={webhook.id}\n              webhook={webhook}\n              onDelete={() => setWebhookToDelete(webhook.id)}\n              onToggle={() =>\n                toggleMutation.mutate({\n                  id: webhook.id,\n                  is_active: !webhook.is_active,\n                })\n              }\n            />\n          ))}\n        </div>\n      ) : (\n        <Card>\n          <CardContent className=\"py-12 text-center\">\n            <p className=\"text-muted-foreground mb-4\">No webhooks yet</p>\n            <Button onClick={() => setShowCreateDialog(true)}>\n              <Plus className=\"h-4 w-4 mr-2\" />\n              Create your first webhook\n            </Button>\n          </CardContent>\n        </Card>\n      )}\n\n      <CreateWebhookDialog\n        open={showCreateDialog}\n        onClose={() => setShowCreateDialog(false)}\n      />\n\n      <AlertDialog\n        open={webhookToDelete !== null}\n        onOpenChange={() => setWebhookToDelete(null)}\n      >\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Delete Webhook?</AlertDialogTitle>\n            <AlertDialogDescription>\n              This will permanently delete this webhook. No more events will be\n              sent to this endpoint. This action cannot be undone.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel>Cancel</AlertDialogCancel>\n            <AlertDialogAction\n              onClick={() =>\n                webhookToDelete && deleteMutation.mutate(webhookToDelete)\n              }\n              className=\"bg-destructive hover:bg-destructive/90\"\n            >\n              Delete\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </div>\n  );\n};\n\nconst WebhookCard = ({\n  webhook,\n  onDelete,\n  onToggle,\n}: {\n  webhook: any;\n  onDelete: () => void;\n  onToggle: () => void;\n}) => {\n  return (\n    <Card>\n      <CardHeader className=\"pb-3\">\n        <div className=\"flex justify-between items-start\">\n          <div className=\"flex-1\">\n            <CardTitle className=\"text-lg\">{webhook.name}</CardTitle>\n            <p className=\"text-sm text-muted-foreground mt-1 break-all\">\n              {webhook.url}\n            </p>\n            <div className=\"flex flex-wrap gap-1 mt-2\">\n              {webhook.is_active ? (\n                <Badge variant=\"default\">Active</Badge>\n              ) : (\n                <Badge variant=\"secondary\">Inactive</Badge>\n              )}\n              {webhook.events &&\n                webhook.events.slice(0, 3).map((event: string) => (\n                  <Badge key={event} variant=\"outline\">\n                    {event}\n                  </Badge>\n                ))}\n              {webhook.events && webhook.events.length > 3 && (\n                <Badge variant=\"outline\">+{webhook.events.length - 3} more</Badge>\n              )}\n            </div>\n          </div>\n          <div className=\"flex gap-2\">\n            <Button variant=\"ghost\" size=\"icon\" onClick={onToggle}>\n              {webhook.is_active ? (\n                <PowerOff className=\"h-4 w-4\" />\n              ) : (\n                <Power className=\"h-4 w-4\" />\n              )}\n            </Button>\n            <Button variant=\"ghost\" size=\"icon\" onClick={onDelete}>\n              <Trash2 className=\"h-4 w-4 text-destructive\" />\n            </Button>\n          </div>\n        </div>\n      </CardHeader>\n      <CardContent>\n        <div className=\"text-xs text-muted-foreground space-y-1\">\n          <p>Created: {format(new Date(webhook.created_at), \"PPP\")}</p>\n          {webhook.last_triggered_at && (\n            <p>\n              Last triggered:{\" \"}\n              {format(new Date(webhook.last_triggered_at), \"PPp\")}\n            </p>\n          )}\n          {webhook.failure_count > 0 && (\n            <p className=\"text-destructive\">\n              Failed deliveries: {webhook.failure_count}\n            </p>\n          )}\n        </div>\n      </CardContent>\n    </Card>\n  );\n};\n\nconst CreateWebhookDialog = ({\n  open,\n  onClose,\n}: {\n  open: boolean;\n  onClose: () => void;\n}) => {\n  const dataProvider = useDataProvider();\n  const notify = useNotify();\n  const queryClient = useQueryClient();\n  const { identity } = useGetIdentity();\n\n  const { register, handleSubmit, watch, setValue, reset } = useForm({\n    defaultValues: {\n      name: \"\",\n      url: \"\",\n      events: [] as string[],\n    },\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (values: any) => {\n      // Generate a random secret for webhook signature\n      const secret = generateApiKey();\n\n      await dataProvider.create(\"webhooks\", {\n        data: {\n          name: values.name,\n          url: values.url,\n          events: values.events,\n          is_active: true,\n          secret,\n          sales_id: identity?.id,\n          created_by_sales_id: identity?.id,\n        },\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"webhooks\"] });\n      notify(\"Webhook created successfully\");\n      reset();\n      onClose();\n    },\n    onError: () => {\n      notify(\"Failed to create webhook\", { type: \"error\" });\n    },\n  });\n\n  const toggleEvent = (event: string) => {\n    const currentEvents = watch(\"events\");\n    if (currentEvents.includes(event)) {\n      setValue(\n        \"events\",\n        currentEvents.filter((e) => e !== event)\n      );\n    } else {\n      setValue(\"events\", [...currentEvents, event]);\n    }\n  };\n\n  const handleClose = () => {\n    reset();\n    onClose();\n  };\n\n  // Group events by category\n  const eventsByCategory = AVAILABLE_EVENTS.reduce((acc, event) => {\n    if (!acc[event.category]) {\n      acc[event.category] = [];\n    }\n    acc[event.category].push(event);\n    return acc;\n  }, {} as Record<string, typeof AVAILABLE_EVENTS>);\n\n  return (\n    <Dialog open={open} onOpenChange={handleClose}>\n      <DialogContent className=\"sm:max-w-[600px] max-h-[80vh] overflow-y-auto\">\n        <DialogHeader>\n          <DialogTitle>Create Webhook</DialogTitle>\n          <DialogDescription>\n            Create a new webhook to receive event notifications\n          </DialogDescription>\n        </DialogHeader>\n\n        <form\n          onSubmit={handleSubmit((values) => createMutation.mutate(values))}\n        >\n          <div className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"name\">Name</Label>\n              <Input\n                id=\"name\"\n                placeholder=\"e.g., Slack Notifications\"\n                {...register(\"name\", { required: true })}\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"url\">Webhook URL</Label>\n              <Input\n                id=\"url\"\n                type=\"url\"\n                placeholder=\"https://example.com/webhook\"\n                {...register(\"url\", { required: true })}\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Events to Subscribe</Label>\n              <div className=\"space-y-3 max-h-60 overflow-y-auto border rounded-md p-3\">\n                {Object.entries(eventsByCategory).map(([category, events]) => (\n                  <div key={category}>\n                    <p className=\"text-sm font-semibold mb-2\">{category}</p>\n                    <div className=\"space-y-2 ml-2\">\n                      {events.map((event) => (\n                        <div\n                          key={event.value}\n                          className=\"flex items-center space-x-2\"\n                        >\n                          <Checkbox\n                            id={event.value}\n                            checked={watch(\"events\").includes(event.value)}\n                            onCheckedChange={() => toggleEvent(event.value)}\n                          />\n                          <label\n                            htmlFor={event.value}\n                            className=\"text-sm cursor-pointer\"\n                          >\n                            {event.label}\n                          </label>\n                        </div>\n                      ))}\n                    </div>\n                  </div>\n                ))}\n              </div>\n            </div>\n\n            <div className=\"flex justify-end gap-2\">\n              <Button type=\"button\" variant=\"outline\" onClick={handleClose}>\n                Cancel\n              </Button>\n              <Button type=\"submit\" disabled={createMutation.isPending}>\n                Create\n              </Button>\n            </div>\n          </div>\n        </form>\n      </DialogContent>\n    </Dialog>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/integrations/IntegrationsPage.tsx",
      "content": "import { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { ApiKeysTab } from \"./ApiKeysTab\";\nimport { WebhooksTab } from \"./WebhooksTab\";\nimport { IngestionChannelsTab } from \"./IngestionChannelsTab\";\nimport { FileUpload } from \"../activities/FileUpload\";\n\nexport const IntegrationsPage = () => {\n  return (\n    <div className=\"max-w-6xl mx-auto mt-8 px-4\">\n      <div className=\"mb-6\">\n        <h1 className=\"text-3xl font-bold\">Integrations</h1>\n        <p className=\"text-muted-foreground mt-2\">\n          Manage API keys, webhooks, and ingestion channels to integrate Atomic CRM with external\n          systems.\n        </p>\n      </div>\n\n      <Tabs defaultValue=\"ingestion\">\n        <TabsList className=\"mb-4\">\n          <TabsTrigger value=\"ingestion\">Ingestion Channels</TabsTrigger>\n          <TabsTrigger value=\"file-upload\">File Upload</TabsTrigger>\n          <TabsTrigger value=\"api-keys\">API Keys</TabsTrigger>\n          <TabsTrigger value=\"webhooks\">Webhooks (Outbound)</TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"ingestion\">\n          <IngestionChannelsTab />\n        </TabsContent>\n\n        <TabsContent value=\"file-upload\">\n          <FileUpload />\n        </TabsContent>\n\n        <TabsContent value=\"api-keys\">\n          <ApiKeysTab />\n        </TabsContent>\n\n        <TabsContent value=\"webhooks\">\n          <WebhooksTab />\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n};\n\nIntegrationsPage.path = \"/integrations\";\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/integrations/IngestionChannelsTab.tsx",
      "content": "import { useState } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { useDataProvider, useNotify } from \"ra-core\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Label } from \"@/components/ui/label\";\nimport { Plus, Trash2, Copy, Activity } from \"lucide-react\";\nimport { CreateChannelDialog } from \"./CreateChannelDialog\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { format } from \"date-fns\";\nimport { getSupabaseConfig } from \"@/lib/supabase-config\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\n\nexport const IngestionChannelsTab = () => {\n  const [showCreateDialog, setShowCreateDialog] = useState(false);\n  const [channelToDelete, setChannelToDelete] = useState<string | null>(null);\n  const dataProvider = useDataProvider();\n  const notify = useNotify();\n  const queryClient = useQueryClient();\n\n  const { data: channels, isLoading } = useQuery({\n    queryKey: [\"ingestion_providers\"],\n    queryFn: async () => {\n      const { data } = await dataProvider.getList(\"ingestion_providers\", {\n        pagination: { page: 1, perPage: 100 },\n        sort: { field: \"created_at\", order: \"DESC\" },\n        filter: {},\n      });\n      return data;\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      await dataProvider.delete(\"ingestion_providers\", { id, previousData: {} });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"ingestion_providers\"] });\n      notify(\"Channel deleted successfully\");\n      setChannelToDelete(null);\n    },\n    onError: () => {\n      notify(\"Failed to delete channel\", { type: \"error\" });\n    },\n  });\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex justify-between items-center\">\n        <p className=\"text-sm text-muted-foreground\">\n          Configure inbound channels (Email, Voice, SMS) to ingest activities into your CRM.\n        </p>\n        <Button onClick={() => setShowCreateDialog(true)}>\n          <Plus className=\"h-4 w-4 mr-2\" />\n          Add Channel\n        </Button>\n      </div>\n\n      {isLoading ? (\n        <Card>\n          <CardContent className=\"py-8 text-center text-muted-foreground\">\n            Loading...\n          </CardContent>\n        </Card>\n      ) : channels && channels.length > 0 ? (\n        <div className=\"grid gap-4 md:grid-cols-2\">\n          {channels.map((channel: any) => (\n            <ChannelCard\n              key={channel.id}\n              channel={channel}\n              onDelete={() => setChannelToDelete(channel.id)}\n            />\n          ))}\n        </div>\n      ) : (\n        <Card>\n          <CardContent className=\"py-12 text-center\">\n            <p className=\"text-muted-foreground mb-4\">No ingestion channels configured</p>\n            <Button onClick={() => setShowCreateDialog(true)}>\n              <Plus className=\"h-4 w-4 mr-2\" />\n              Add your first channel\n            </Button>\n          </CardContent>\n        </Card>\n      )}\n\n      <CreateChannelDialog\n        open={showCreateDialog}\n        onClose={() => setShowCreateDialog(false)}\n      />\n\n      <AlertDialog\n        open={channelToDelete !== null}\n        onOpenChange={() => setChannelToDelete(null)}\n      >\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Delete Channel?</AlertDialogTitle>\n            <AlertDialogDescription>\n              This will stop all ingestion from this source. This action cannot be undone.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel>Cancel</AlertDialogCancel>\n            <AlertDialogAction\n              onClick={() => channelToDelete && deleteMutation.mutate(channelToDelete)}\n              className=\"bg-destructive hover:bg-destructive/90\"\n            >\n              Delete\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </div>\n  );\n};\n\nconst ChannelCard = ({\n  channel,\n  onDelete,\n}: {\n  channel: any;\n  onDelete: () => void;\n}) => {\n  const notify = useNotify();\n\n  // Get the actual Supabase URL from config (localStorage or env vars)\n  const supabaseConfig = getSupabaseConfig();\n  const webhookUrl = supabaseConfig\n    ? `${supabaseConfig.url}/functions/v1/ingest-activity?key=${channel.ingestion_key}`\n    : `https://your-project.supabase.co/functions/v1/ingest-activity?key=${channel.ingestion_key}`;\n\n  const copyUrl = () => {\n    navigator.clipboard.writeText(webhookUrl);\n    notify(\"Webhook URL copied to clipboard\");\n  };\n\n  return (\n    <Card>\n      <CardHeader className=\"pb-3\">\n        <div className=\"flex justify-between items-start\">\n          <div className=\"flex items-center gap-3\">\n             <div className=\"p-2 bg-primary/10 rounded-full\">\n                 <Activity className=\"h-5 w-5 text-primary\" />\n             </div>\n             <div>\n                <CardTitle className=\"text-base\">{channel.name}</CardTitle>\n                <div className=\"flex gap-2 mt-1\">\n                <Badge variant=\"outline\">{channel.provider_code}</Badge>\n                {channel.is_active ? (\n                    <Badge className=\"bg-green-500 hover:bg-green-600\">Active</Badge>\n                ) : (\n                    <Badge variant=\"secondary\">Inactive</Badge>\n                )}\n                </div>\n             </div>\n          </div>\n          <Button variant=\"ghost\" size=\"icon\" onClick={onDelete}>\n            <Trash2 className=\"h-4 w-4 text-destructive\" />\n          </Button>\n        </div>\n      </CardHeader>\n      <CardContent className=\"space-y-3\">\n        <div className=\"space-y-1\">\n            <Label className=\"text-xs text-muted-foreground\">Webhook URL</Label>\n            <div className=\"flex items-center gap-2 font-mono text-xs bg-muted p-2 rounded overflow-hidden\">\n            <span className=\"truncate\">{webhookUrl}</span>\n            <Button variant=\"ghost\" size=\"icon\" className=\"h-6 w-6 ml-auto flex-shrink-0\" onClick={copyUrl}>\n                <Copy className=\"h-3 w-3\" />\n            </Button>\n            </div>\n        </div>\n        <div className=\"text-xs text-muted-foreground\">\n          <p>Created: {format(new Date(channel.created_at), \"PPP\")}</p>\n        </div>\n      </CardContent>\n    </Card>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/integrations/CreateChannelDialog.tsx",
      "content": "import { useState } from \"react\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { useDataProvider, useNotify } from \"ra-core\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Loader2 } from \"lucide-react\";\n\ninterface CreateChannelDialogProps {\n  open: boolean;\n  onClose: () => void;\n}\n\nexport const CreateChannelDialog = ({\n  open,\n  onClose,\n}: CreateChannelDialogProps) => {\n  const [providerCode, setProviderCode] = useState<string>(\"twilio\");\n  const [name, setName] = useState(\"\");\n  const [authToken, setAuthToken] = useState(\"\");\n  const dataProvider = useDataProvider();\n  const notify = useNotify();\n  const queryClient = useQueryClient();\n\n  const createMutation = useMutation({\n    mutationFn: async () => {\n      // Generate a cryptographically secure random ingestion key\n      const ingestionKey = \"ik_live_\" + crypto.randomUUID().replace(/-/g, '');\n\n      const config: any = {};\n      if (authToken) {\n          config.auth_token = authToken;\n      }\n\n      await dataProvider.create(\"ingestion_providers\", {\n        data: {\n          name,\n          provider_code: providerCode,\n          is_active: true,\n          config,\n          ingestion_key: ingestionKey\n        },\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"ingestion_providers\"] });\n      notify(\"Ingestion Channel created successfully\");\n      onClose();\n      // Reset form\n      setName(\"\");\n      setAuthToken(\"\");\n      setProviderCode(\"twilio\");\n    },\n    onError: (error: Error) => {\n      notify(`Failed to create channel: ${error.message}`, { type: \"error\" });\n    },\n  });\n\n  return (\n    <Dialog open={open} onOpenChange={onClose}>\n      <DialogContent className=\"sm:max-w-[425px]\">\n        <DialogHeader>\n          <DialogTitle>Add Ingestion Channel</DialogTitle>\n          <DialogDescription>\n            Configure a new source for incoming activities.\n          </DialogDescription>\n        </DialogHeader>\n        <div className=\"grid gap-4 py-4\">\n          <div className=\"grid gap-2\">\n            <Label htmlFor=\"name\">Channel Name</Label>\n            <Input\n              id=\"name\"\n              placeholder=\"e.g. US Support Line\"\n              value={name}\n              onChange={(e) => setName(e.target.value)}\n            />\n          </div>\n          <div className=\"grid gap-2\">\n            <Label htmlFor=\"provider\">Provider</Label>\n            <Select value={providerCode} onValueChange={setProviderCode}>\n              <SelectTrigger>\n                <SelectValue placeholder=\"Select provider\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"twilio\">Twilio (Voice/SMS)</SelectItem>\n                <SelectItem value=\"postmark\">Postmark (Email)</SelectItem>\n                <SelectItem value=\"generic\">Generic / Internal</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n          \n          {providerCode === \"twilio\" && (\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"token\">Auth Token (Validation)</Label>\n                <Input\n                  id=\"token\"\n                  type=\"password\"\n                  placeholder=\"Twilio Auth Token\"\n                  value={authToken}\n                  onChange={(e) => setAuthToken(e.target.value)}\n                />\n                <p className=\"text-xs text-muted-foreground\">Required to validate inbound requests.</p>\n              </div>\n          )}\n          \n        </div>\n        <DialogFooter>\n          <Button variant=\"outline\" onClick={onClose}>\n            Cancel\n          </Button>\n          <Button\n            onClick={() => createMutation.mutate()}\n            disabled={!name || createMutation.isPending}\n          >\n            {createMutation.isPending && (\n              <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n            )}\n            Create Channel\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/integrations/CreateApiKeyDialog.tsx",
      "content": "import { useState } from \"react\";\nimport { useForm } from \"react-hook-form\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { useDataProvider, useNotify, useGetIdentity } from \"ra-core\";\nimport { generateApiKey, hashApiKey } from \"@/lib/api-key-utils\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Copy, CheckCircle } from \"lucide-react\";\n\ninterface CreateApiKeyDialogProps {\n  open: boolean;\n  onClose: () => void;\n}\n\nconst AVAILABLE_SCOPES = [\n  { value: \"contacts:read\", label: \"Contacts: Read\" },\n  { value: \"contacts:write\", label: \"Contacts: Write\" },\n  { value: \"companies:read\", label: \"Companies: Read\" },\n  { value: \"companies:write\", label: \"Companies: Write\" },\n  { value: \"deals:read\", label: \"Deals: Read\" },\n  { value: \"deals:write\", label: \"Deals: Write\" },\n  { value: \"activities:write\", label: \"Activities: Write\" },\n];\n\nexport const CreateApiKeyDialog = ({\n  open,\n  onClose,\n}: CreateApiKeyDialogProps) => {\n  const [createdKey, setCreatedKey] = useState<string | null>(null);\n  const [copied, setCopied] = useState(false);\n  const dataProvider = useDataProvider();\n  const notify = useNotify();\n  const queryClient = useQueryClient();\n  const { identity } = useGetIdentity();\n\n  const { register, handleSubmit, watch, setValue, reset } = useForm({\n    defaultValues: {\n      name: \"\",\n      scopes: [] as string[],\n      expires_at: \"\",\n    },\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (values: any) => {\n      const apiKey = generateApiKey();\n      const keyHash = await hashApiKey(apiKey);\n      const keyPrefix = apiKey.substring(0, 12);\n\n      const { data } = await dataProvider.create(\"api_keys\", {\n        data: {\n          name: values.name,\n          key_hash: keyHash,\n          key_prefix: keyPrefix,\n          scopes: values.scopes,\n          is_active: true,\n          expires_at: values.expires_at || null,\n          sales_id: identity?.id,\n          created_by_sales_id: identity?.id,\n        },\n      });\n\n      return { data, apiKey };\n    },\n    onSuccess: ({ apiKey }) => {\n      setCreatedKey(apiKey);\n      queryClient.invalidateQueries({ queryKey: [\"api_keys\"] });\n      notify(\"API key created successfully\");\n    },\n    onError: () => {\n      notify(\"Failed to create API key\", { type: \"error\" });\n    },\n  });\n\n  const handleClose = () => {\n    setCreatedKey(null);\n    setCopied(false);\n    reset();\n    onClose();\n  };\n\n  const copyApiKey = () => {\n    if (createdKey) {\n      navigator.clipboard.writeText(createdKey);\n      setCopied(true);\n      setTimeout(() => setCopied(false), 2000);\n    }\n  };\n\n  const toggleScope = (scope: string) => {\n    const currentScopes = watch(\"scopes\");\n    if (currentScopes.includes(scope)) {\n      setValue(\n        \"scopes\",\n        currentScopes.filter((s) => s !== scope)\n      );\n    } else {\n      setValue(\"scopes\", [...currentScopes, scope]);\n    }\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={handleClose}>\n      <DialogContent className=\"sm:max-w-[500px]\">\n        <DialogHeader>\n          <DialogTitle>\n            {createdKey ? \"API Key Created\" : \"Create API Key\"}\n          </DialogTitle>\n          <DialogDescription>\n            {createdKey\n              ? \"Copy this key now - it won't be shown again!\"\n              : \"Create a new API key to access the CRM API\"}\n          </DialogDescription>\n        </DialogHeader>\n\n        {createdKey ? (\n          <div className=\"space-y-4\">\n            <Alert>\n              <AlertDescription>\n                Make sure to copy your API key now. You won't be able to see it\n                again!\n              </AlertDescription>\n            </Alert>\n\n            <div className=\"space-y-2\">\n              <Label>Your API Key</Label>\n              <div className=\"flex gap-2\">\n                <Input\n                  value={createdKey}\n                  readOnly\n                  className=\"font-mono text-sm\"\n                />\n                <Button\n                  type=\"button\"\n                  variant=\"outline\"\n                  size=\"icon\"\n                  onClick={copyApiKey}\n                >\n                  {copied ? (\n                    <CheckCircle className=\"h-4 w-4 text-green-500\" />\n                  ) : (\n                    <Copy className=\"h-4 w-4\" />\n                  )}\n                </Button>\n              </div>\n            </div>\n\n            <div className=\"flex justify-end\">\n              <Button onClick={handleClose}>Done</Button>\n            </div>\n          </div>\n        ) : (\n          <form\n            onSubmit={handleSubmit((values) => createMutation.mutate(values))}\n          >\n            <div className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"name\">Name</Label>\n                <Input\n                  id=\"name\"\n                  placeholder=\"e.g., Production API Key\"\n                  {...register(\"name\", { required: true })}\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label>Scopes</Label>\n                <div className=\"space-y-2\">\n                  {AVAILABLE_SCOPES.map((scope) => (\n                    <div key={scope.value} className=\"flex items-center space-x-2\">\n                      <Checkbox\n                        id={scope.value}\n                        checked={watch(\"scopes\").includes(scope.value)}\n                        onCheckedChange={() => toggleScope(scope.value)}\n                      />\n                      <label htmlFor={scope.value} className=\"text-sm cursor-pointer\">\n                        {scope.label}\n                      </label>\n                    </div>\n                  ))}\n                </div>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"expires_at\">Expiration (optional)</Label>\n                <Input\n                  id=\"expires_at\"\n                  type=\"date\"\n                  {...register(\"expires_at\")}\n                />\n              </div>\n\n              <div className=\"flex justify-end gap-2\">\n                <Button type=\"button\" variant=\"outline\" onClick={handleClose}>\n                  Cancel\n                </Button>\n                <Button type=\"submit\" disabled={createMutation.isPending}>\n                  Create\n                </Button>\n              </div>\n            </div>\n          </form>\n        )}\n      </DialogContent>\n    </Dialog>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/integrations/ApiKeysTab.tsx",
      "content": "import { useState } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { useDataProvider, useNotify, useGetIdentity } from \"ra-core\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Plus, Trash2, Copy } from \"lucide-react\";\nimport { CreateApiKeyDialog } from \"./CreateApiKeyDialog\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { format } from \"date-fns\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\n\nexport const ApiKeysTab = () => {\n  const [showCreateDialog, setShowCreateDialog] = useState(false);\n  const [keyToDelete, setKeyToDelete] = useState<number | null>(null);\n  const dataProvider = useDataProvider();\n  const notify = useNotify();\n  const queryClient = useQueryClient();\n  const { identity: _identity } = useGetIdentity();\n\n  const { data: apiKeys, isLoading } = useQuery({\n    queryKey: [\"api_keys\"],\n    queryFn: async () => {\n      const { data } = await dataProvider.getList(\"api_keys\", {\n        pagination: { page: 1, perPage: 100 },\n        sort: { field: \"created_at\", order: \"DESC\" },\n        filter: {},\n      });\n      return data;\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: number) => {\n      await dataProvider.delete(\"api_keys\", { id, previousData: {} });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"api_keys\"] });\n      notify(\"API key deleted successfully\");\n      setKeyToDelete(null);\n    },\n    onError: () => {\n      notify(\"Failed to delete API key\", { type: \"error\" });\n    },\n  });\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex justify-between items-center\">\n        <p className=\"text-sm text-muted-foreground\">\n          API keys allow external applications to access your CRM data\n          programmatically.\n        </p>\n        <Button onClick={() => setShowCreateDialog(true)}>\n          <Plus className=\"h-4 w-4 mr-2\" />\n          Create API Key\n        </Button>\n      </div>\n\n      {isLoading ? (\n        <Card>\n          <CardContent className=\"py-8 text-center text-muted-foreground\">\n            Loading...\n          </CardContent>\n        </Card>\n      ) : apiKeys && apiKeys.length > 0 ? (\n        <div className=\"space-y-3\">\n          {apiKeys.map((key: any) => (\n            <ApiKeyCard\n              key={key.id}\n              apiKey={key}\n              onDelete={() => setKeyToDelete(key.id)}\n            />\n          ))}\n        </div>\n      ) : (\n        <Card>\n          <CardContent className=\"py-12 text-center\">\n            <p className=\"text-muted-foreground mb-4\">No API keys yet</p>\n            <Button onClick={() => setShowCreateDialog(true)}>\n              <Plus className=\"h-4 w-4 mr-2\" />\n              Create your first API key\n            </Button>\n          </CardContent>\n        </Card>\n      )}\n\n      <CreateApiKeyDialog\n        open={showCreateDialog}\n        onClose={() => setShowCreateDialog(false)}\n      />\n\n      <AlertDialog\n        open={keyToDelete !== null}\n        onOpenChange={() => setKeyToDelete(null)}\n      >\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Delete API Key?</AlertDialogTitle>\n            <AlertDialogDescription>\n              This will permanently delete this API key. Any applications using\n              this key will stop working immediately. This action cannot be\n              undone.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel>Cancel</AlertDialogCancel>\n            <AlertDialogAction\n              onClick={() => keyToDelete && deleteMutation.mutate(keyToDelete)}\n              className=\"bg-destructive hover:bg-destructive/90\"\n            >\n              Delete\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </div>\n  );\n};\n\nconst ApiKeyCard = ({\n  apiKey,\n  onDelete,\n}: {\n  apiKey: any;\n  onDelete: () => void;\n}) => {\n  const notify = useNotify();\n\n  const copyKey = () => {\n    navigator.clipboard.writeText(apiKey.key_prefix + \"\");\n    notify(\"Key prefix copied (full key only shown once at creation)\");\n  };\n\n  return (\n    <Card>\n      <CardHeader className=\"pb-3\">\n        <div className=\"flex justify-between items-start\">\n          <div>\n            <CardTitle className=\"text-lg\">{apiKey.name}</CardTitle>\n            <div className=\"flex gap-2 mt-2\">\n              {apiKey.is_active ? (\n                <Badge variant=\"default\">Active</Badge>\n              ) : (\n                <Badge variant=\"secondary\">Inactive</Badge>\n              )}\n              {apiKey.scopes && apiKey.scopes.length > 0 && (\n                <Badge variant=\"outline\">{apiKey.scopes.join(\", \")}</Badge>\n              )}\n            </div>\n          </div>\n          <Button variant=\"ghost\" size=\"icon\" onClick={onDelete}>\n            <Trash2 className=\"h-4 w-4 text-destructive\" />\n          </Button>\n        </div>\n      </CardHeader>\n      <CardContent className=\"space-y-2\">\n        <div className=\"flex items-center gap-2 font-mono text-sm bg-muted p-2 rounded\">\n          <span>{apiKey.key_prefix}</span>\n          <Button variant=\"ghost\" size=\"icon\" onClick={copyKey}>\n            <Copy className=\"h-4 w-4\" />\n          </Button>\n        </div>\n        <div className=\"text-xs text-muted-foreground space-y-1\">\n          <p>Created: {format(new Date(apiKey.created_at), \"PPP\")}</p>\n          {apiKey.last_used_at && (\n            <p>Last used: {format(new Date(apiKey.last_used_at), \"PPp\")}</p>\n          )}\n          {apiKey.expires_at && (\n            <p>Expires: {format(new Date(apiKey.expires_at), \"PPP\")}</p>\n          )}\n        </div>\n      </CardContent>\n    </Card>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/filters/FilterCategory.tsx",
      "content": "import { Translate } from \"ra-core\";\nimport type { ReactNode } from \"react\";\n\nexport const FilterCategory = ({\n  icon,\n  label,\n  children,\n}: {\n  icon: ReactNode;\n  label: string;\n  children?: ReactNode;\n}) => (\n  <div className=\"flex flex-col gap-2\">\n    <h3 className=\"flex flex-row items-center gap-2 font-bold text-sm\">\n      {icon}\n      <Translate i18nKey={label} />\n    </h3>\n    <div className=\"flex flex-col items-start pl-4\">{children}</div>\n  </div>\n);\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/stages.ts",
      "content": "import type { ConfigurationContextValue } from \"../root/ConfigurationContext\";\nimport type { Deal } from \"../types\";\n\nexport type DealsByStage = Record<Deal[\"stage\"], Deal[]>;\n\nexport const getDealsByStage = (\n  unorderedDeals: Deal[],\n  dealStages: ConfigurationContextValue[\"dealStages\"],\n) => {\n  if (!dealStages) return {};\n  const dealsByStage: Record<Deal[\"stage\"], Deal[]> = unorderedDeals.reduce(\n    (acc, deal) => {\n      if (acc[deal.stage]) {\n        acc[deal.stage].push(deal);\n      }\n      return acc;\n    },\n    dealStages.reduce(\n      (obj, stage) => ({ ...obj, [stage.value]: [] }),\n      {} as Record<Deal[\"stage\"], Deal[]>,\n    ),\n  );\n  // order each column by index\n  dealStages.forEach((stage) => {\n    dealsByStage[stage.value] = dealsByStage[stage.value].sort(\n      (recordA: Deal, recordB: Deal) => recordA.index - recordB.index,\n    );\n  });\n  return dealsByStage;\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/stages.test.ts",
      "content": "import { describe, it, expect } from 'vitest';\nimport { getDealsByStage } from './stages';\nimport type { Deal } from '../types';\n\ndescribe('getDealsByStage', () => {\n  const mockDealStages = [\n    { value: 'stage1', label: 'Stage 1' },\n    { value: 'stage2', label: 'Stage 2' },\n  ];\n\n  it('should group deals by stage', () => {\n    const deals = [\n      { id: 1, stage: 'stage1', index: 0, name: 'Deal 1' },\n      { id: 2, stage: 'stage2', index: 0, name: 'Deal 2' },\n      { id: 3, stage: 'stage1', index: 1, name: 'Deal 3' },\n    ] as unknown as Deal[];\n\n    const result = getDealsByStage(deals, mockDealStages);\n\n    expect(result['stage1']).toHaveLength(2);\n    expect(result['stage2']).toHaveLength(1);\n    expect(result['stage1'].map(d => d.name)).toEqual(['Deal 1', 'Deal 3']);\n  });\n\n  it('should ignore deals with unknown stages instead of crashing', () => {\n    const deals = [\n      { id: 1, stage: 'stage1', index: 0, name: 'Deal 1' },\n      { id: 4, stage: 'unknown_stage', index: 0, name: 'Deal 4' }, // Malformed data\n    ] as unknown as Deal[];\n\n    const result = getDealsByStage(deals, mockDealStages);\n\n    expect(result['stage1']).toHaveLength(1);\n    expect(result).not.toHaveProperty('unknown_stage');\n  });\n\n  it('should handle empty deal list', () => {\n    const deals: Deal[] = [];\n    const result = getDealsByStage(deals, mockDealStages);\n    expect(result['stage1']).toEqual([]);\n    expect(result['stage2']).toEqual([]);\n  });\n\n  it('should sort deals by index', () => {\n    const deals = [\n      { id: 1, stage: 'stage1', index: 2, name: 'Deal 1' },\n      { id: 3, stage: 'stage1', index: 1, name: 'Deal 3' },\n    ] as unknown as Deal[];\n\n    const result = getDealsByStage(deals, mockDealStages);\n    expect(result['stage1'][0].index).toBe(1);\n    expect(result['stage1'][1].index).toBe(2);\n  });\n});\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/index.ts",
      "content": "import * as React from \"react\";\nconst DealList = React.lazy(() => import(\"./DealList\"));\n\nexport default {\n  list: DealList,\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/dealUtils.ts",
      "content": "export function getRelativeTimeString(dateString: string): string {\n  const date = new Date(dateString);\n  date.setHours(0, 0, 0, 0);\n\n  const today = new Date();\n  today.setHours(0, 0, 0, 0);\n\n  const diff = date.getTime() - today.getTime();\n  const unitDiff = Math.round(diff / (1000 * 60 * 60 * 24));\n\n  // Check if the date is more than one week old\n  if (Math.abs(unitDiff) > 7) {\n    return new Intl.DateTimeFormat(undefined, {\n      day: \"numeric\",\n      month: \"long\",\n    }).format(date);\n  }\n\n  // Intl.RelativeTimeFormat for dates within the last week\n  const rtf = new Intl.RelativeTimeFormat(undefined, { numeric: \"auto\" });\n  return ucFirst(rtf.format(unitDiff, \"day\"));\n}\n\nfunction ucFirst(str: string): string {\n  return str.charAt(0).toUpperCase() + str.slice(1);\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/deal.ts",
      "content": "import type { DealStage } from \"../types\";\n\nexport const findDealLabel = (dealStages: DealStage[], dealValue: string) => {\n  return dealStages.find((dealStage) => dealStage.value === dealValue)?.label;\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/OnlyMineInput.tsx",
      "content": "import { useGetIdentity, useListFilterContext } from \"ra-core\";\nimport { Label } from \"@/components/ui/label\";\nimport { Switch } from \"@/components/ui/switch\";\n\nexport const OnlyMineInput = (_: { alwaysOn: boolean; source: string }) => {\n  const { filterValues, displayedFilters, setFilters } = useListFilterContext();\n  const { identity } = useGetIdentity();\n\n  const handleChange = () => {\n    const newFilterValues = { ...filterValues };\n    if (typeof filterValues.sales_id !== \"undefined\") {\n      delete newFilterValues.sales_id;\n    } else {\n      newFilterValues.sales_id = identity && identity?.id;\n    }\n    setFilters(newFilterValues, displayedFilters);\n  };\n  return (\n    <div className=\"mt-auto pb-2.25\">\n      <div className=\"flex items-center space-x-2\">\n        <Switch\n          id=\"only-mine\"\n          checked={typeof filterValues.sales_id !== \"undefined\"}\n          onCheckedChange={handleChange}\n        />\n        <Label htmlFor=\"only-mine\">Only companies I manage</Label>\n      </div>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/DealShow.tsx",
      "content": "import { useMutation } from \"@tanstack/react-query\";\nimport { format, isValid } from \"date-fns\";\nimport { Archive, ArchiveRestore } from \"lucide-react\";\nimport {\n  ShowBase,\n  useDataProvider,\n  useNotify,\n  useRecordContext,\n  useRedirect,\n  useRefresh,\n  useUpdate,\n} from \"ra-core\";\nimport { DeleteButton } from \"@/components/admin/delete-button\";\nimport { EditButton } from \"@/components/admin/edit-button\";\nimport { ReferenceArrayField } from \"@/components/admin/reference-array-field\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { ReferenceManyField } from \"@/components/admin/reference-many-field\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Dialog, DialogContent, DialogTitle } from \"@/components/ui/dialog\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { VisuallyHidden } from \"@/components/ui/visually-hidden\";\n\nimport { CompanyAvatar } from \"../companies/CompanyAvatar\";\nimport { NoteCreate } from \"../notes/NoteCreate\";\nimport { NotesIterator } from \"../notes/NotesIterator\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport type { Deal } from \"../types\";\nimport { ContactList } from \"./ContactList\";\nimport { findDealLabel } from \"./deal\";\n\nexport const DealShow = ({ open, id }: { open: boolean; id?: string }) => {\n  const redirect = useRedirect();\n  const handleClose = () => {\n    redirect(\"list\", \"deals\");\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={(open) => !open && handleClose()}>\n      <DialogContent className=\"lg:max-w-4xl p-4 overflow-y-auto max-h-9/10 top-1/20 translate-y-0\">\n        <VisuallyHidden>\n          <DialogTitle>Deal Details</DialogTitle>\n        </VisuallyHidden>\n        {id ? (\n          <ShowBase id={id}>\n            <DealShowContent />\n          </ShowBase>\n        ) : null}\n      </DialogContent>\n    </Dialog>\n  );\n};\n\nconst DealShowContent = () => {\n  const { dealStages } = useConfigurationContext();\n  const record = useRecordContext<Deal>();\n  if (!record) return null;\n\n  return (\n    <>\n      <div className=\"space-y-2\">\n        {record.archived_at ? <ArchivedTitle /> : null}\n        <div className=\"flex-1\">\n          <div className=\"flex justify-between items-start mb-8\">\n            <div className=\"flex items-center gap-4\">\n              <ReferenceField\n                source=\"company_id\"\n                reference=\"companies\"\n                link=\"show\"\n              >\n                <CompanyAvatar />\n              </ReferenceField>\n              <h2 className=\"text-2xl font-semibold\">{record.name}</h2>\n            </div>\n            <div className={`flex gap-2 ${record.archived_at ? \"\" : \"pr-12\"}`}>\n              {record.archived_at ? (\n                <>\n                  <UnarchiveButton record={record} />\n                  <DeleteButton />\n                </>\n              ) : (\n                <>\n                  <ArchiveButton record={record} />\n                  <EditButton />\n                </>\n              )}\n            </div>\n          </div>\n\n          <div className=\"flex gap-8 m-4\">\n            <div className=\"flex flex-col mr-10\">\n              <span className=\"text-xs text-muted-foreground tracking-wide\">\n                Expected closing date\n              </span>\n              <div className=\"flex items-center gap-2\">\n                <span className=\"text-sm\">\n                  {isValid(new Date(record.expected_closing_date))\n                    ? format(new Date(record.expected_closing_date), \"PP\")\n                    : \"Invalid date\"}\n                </span>\n                {new Date(record.expected_closing_date) < new Date() ? (\n                  <Badge variant=\"destructive\">Past</Badge>\n                ) : null}\n              </div>\n            </div>\n\n            <div className=\"flex flex-col mr-10\">\n              <span className=\"text-xs text-muted-foreground tracking-wide\">\n                Budget\n              </span>\n              <span className=\"text-sm\">\n                {record.amount.toLocaleString(\"en-US\", {\n                  notation: \"compact\",\n                  style: \"currency\",\n                  currency: \"USD\",\n                  currencyDisplay: \"narrowSymbol\",\n                  minimumSignificantDigits: 3,\n                })}\n              </span>\n            </div>\n\n            {record.category && (\n              <div className=\"flex flex-col mr-10\">\n                <span className=\"text-xs text-muted-foreground tracking-wide\">\n                  Category\n                </span>\n                <span className=\"text-sm\">{record.category}</span>\n              </div>\n            )}\n\n            <div className=\"flex flex-col mr-10\">\n              <span className=\"text-xs text-muted-foreground tracking-wide\">\n                Stage\n              </span>\n              <span className=\"text-sm\">\n                {findDealLabel(dealStages, record.stage)}\n              </span>\n            </div>\n          </div>\n\n          {!!record.contact_ids?.length && (\n            <div className=\"m-4\">\n              <div className=\"flex flex-col min-h-12 mr-10\">\n                <span className=\"text-xs text-muted-foreground tracking-wide\">\n                  Contacts\n                </span>\n                <ReferenceArrayField\n                  source=\"contact_ids\"\n                  reference=\"contacts_summary\"\n                >\n                  <ContactList />\n                </ReferenceArrayField>\n              </div>\n            </div>\n          )}\n\n          {record.description && (\n            <div className=\"m-4 whitespace-pre-line\">\n              <span className=\"text-xs text-muted-foreground tracking-wide\">\n                Description\n              </span>\n              <p className=\"text-sm leading-6\">{record.description}</p>\n            </div>\n          )}\n\n          <div className=\"m-4\">\n            <Separator className=\"mb-4\" />\n            <ReferenceManyField\n              target=\"deal_id\"\n              reference=\"dealNotes\"\n              sort={{ field: \"date\", order: \"DESC\" }}\n              empty={<NoteCreate reference={\"deals\"} />}\n            >\n              <NotesIterator reference=\"deals\" />\n            </ReferenceManyField>\n          </div>\n        </div>\n      </div>\n    </>\n  );\n};\n\nconst ArchivedTitle = () => (\n  <div className=\"bg-orange-500 px-6 py-4\">\n    <h3 className=\"text-lg font-bold text-white\">Archived Deal</h3>\n  </div>\n);\n\nconst ArchiveButton = ({ record }: { record: Deal }) => {\n  const [update] = useUpdate();\n  const redirect = useRedirect();\n  const notify = useNotify();\n  const refresh = useRefresh();\n  const handleClick = () => {\n    update(\n      \"deals\",\n      {\n        id: record.id,\n        data: { archived_at: new Date().toISOString() },\n        previousData: record,\n      },\n      {\n        onSuccess: () => {\n          redirect(\"list\", \"deals\");\n          notify(\"Deal archived\", { type: \"info\", undoable: false });\n          refresh();\n        },\n        onError: () => {\n          notify(\"Error: deal not archived\", { type: \"error\" });\n        },\n      },\n    );\n  };\n\n  return (\n    <Button\n      onClick={handleClick}\n      size=\"sm\"\n      variant=\"outline\"\n      className=\"flex items-center gap-2 h-9\"\n    >\n      <Archive className=\"w-4 h-4\" />\n      Archive\n    </Button>\n  );\n};\n\nconst UnarchiveButton = ({ record }: { record: Deal }) => {\n  const dataProvider = useDataProvider();\n  const redirect = useRedirect();\n  const notify = useNotify();\n  const refresh = useRefresh();\n\n  const { mutate } = useMutation({\n    mutationFn: () => dataProvider.unarchiveDeal(record),\n    onSuccess: () => {\n      redirect(\"list\", \"deals\");\n      notify(\"Deal unarchived\", {\n        type: \"info\",\n        undoable: false,\n      });\n      refresh();\n    },\n    onError: () => {\n      notify(\"Error: deal not unarchived\", { type: \"error\" });\n    },\n  });\n\n  const handleClick = () => {\n    mutate();\n  };\n\n  return (\n    <Button\n      onClick={handleClick}\n      size=\"sm\"\n      variant=\"outline\"\n      className=\"flex items-center gap-2 h-9\"\n    >\n      <ArchiveRestore className=\"w-4 h-4\" />\n      Send back to the board\n    </Button>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/DealListContent.tsx",
      "content": "import { DragDropContext, type OnDragEndResponder } from \"@hello-pangea/dnd\";\nimport isEqual from \"lodash/isEqual\";\nimport { useDataProvider, useListContext, type DataProvider } from \"ra-core\";\nimport { useEffect, useState } from \"react\";\n\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport type { Deal } from \"../types\";\nimport { DealColumn } from \"./DealColumn\";\nimport type { DealsByStage } from \"./stages\";\nimport { getDealsByStage } from \"./stages\";\n\nexport const DealListContent = () => {\n  const { dealStages } = useConfigurationContext();\n  const { data: unorderedDeals, isPending, refetch } = useListContext<Deal>();\n  const dataProvider = useDataProvider();\n\n  const [dealsByStage, setDealsByStage] = useState<DealsByStage>(\n    getDealsByStage([], dealStages),\n  );\n\n  useEffect(() => {\n    if (unorderedDeals) {\n      const newDealsByStage = getDealsByStage(unorderedDeals, dealStages);\n      if (!isEqual(newDealsByStage, dealsByStage)) {\n        setDealsByStage(newDealsByStage);\n      }\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [unorderedDeals]);\n\n  if (isPending) return null;\n\n  const onDragEnd: OnDragEndResponder = (result) => {\n    const { destination, source } = result;\n\n    if (!destination) {\n      return;\n    }\n\n    if (\n      destination.droppableId === source.droppableId &&\n      destination.index === source.index\n    ) {\n      return;\n    }\n\n    const sourceStage = source.droppableId;\n    const destinationStage = destination.droppableId;\n    const sourceDeal = dealsByStage[sourceStage][source.index]!;\n    const destinationDeal = dealsByStage[destinationStage][\n      destination.index\n    ] ?? {\n      stage: destinationStage,\n      index: undefined, // undefined if dropped after the last item\n    };\n\n    // compute local state change synchronously\n    setDealsByStage(\n      updateDealStageLocal(\n        sourceDeal,\n        { stage: sourceStage, index: source.index },\n        { stage: destinationStage, index: destination.index },\n        dealsByStage,\n      ),\n    );\n\n    // persist the changes\n    updateDealStage(sourceDeal, destinationDeal, dataProvider).then(() => {\n      refetch();\n    });\n  };\n\n  return (\n    <DragDropContext onDragEnd={onDragEnd}>\n      <div className=\"flex gap-4\">\n        {dealStages.map((stage) => (\n          <DealColumn\n            stage={stage.value}\n            deals={dealsByStage[stage.value]}\n            key={stage.value}\n          />\n        ))}\n      </div>\n    </DragDropContext>\n  );\n};\n\nconst updateDealStageLocal = (\n  sourceDeal: Deal,\n  source: { stage: string; index: number },\n  destination: {\n    stage: string;\n    index?: number; // undefined if dropped after the last item\n  },\n  dealsByStage: DealsByStage,\n) => {\n  if (source.stage === destination.stage) {\n    // moving deal inside the same column\n    const column = dealsByStage[source.stage];\n    column.splice(source.index, 1);\n    column.splice(destination.index ?? column.length + 1, 0, sourceDeal);\n    return {\n      ...dealsByStage,\n      [destination.stage]: column,\n    };\n  } else {\n    // moving deal across columns\n    const sourceColumn = dealsByStage[source.stage];\n    const destinationColumn = dealsByStage[destination.stage];\n    sourceColumn.splice(source.index, 1);\n    destinationColumn.splice(\n      destination.index ?? destinationColumn.length + 1,\n      0,\n      sourceDeal,\n    );\n    return {\n      ...dealsByStage,\n      [source.stage]: sourceColumn,\n      [destination.stage]: destinationColumn,\n    };\n  }\n};\n\nconst updateDealStage = async (\n  source: Deal,\n  destination: {\n    stage: string;\n    index?: number; // undefined if dropped after the last item\n  },\n  dataProvider: DataProvider,\n) => {\n  if (source.stage === destination.stage) {\n    // moving deal inside the same column\n    // Fetch all the deals in this stage (because the list may be filtered, but we need to update even non-filtered deals)\n    const { data: columnDeals } = await dataProvider.getList(\"deals\", {\n      sort: { field: \"index\", order: \"ASC\" },\n      pagination: { page: 1, perPage: 100 },\n      filter: { stage: source.stage },\n    });\n    const destinationIndex = destination.index ?? columnDeals.length + 1;\n\n    if (source.index > destinationIndex) {\n      // deal moved up, eg\n      // dest   src\n      //  <------\n      // [4, 7, 23, 5]\n      await Promise.all([\n        // for all deals between destinationIndex and source.index, increase the index\n        ...columnDeals\n          .filter(\n            (deal) =>\n              deal.index >= destinationIndex && deal.index < source.index,\n          )\n          .map((deal) =>\n            dataProvider.update(\"deals\", {\n              id: deal.id,\n              data: { index: deal.index + 1 },\n              previousData: deal,\n            }),\n          ),\n        // for the deal that was moved, update its index\n        dataProvider.update(\"deals\", {\n          id: source.id,\n          data: { index: destinationIndex },\n          previousData: source,\n        }),\n      ]);\n    } else {\n      // deal moved down, e.g\n      // src   dest\n      //  ------>\n      // [4, 7, 23, 5]\n      await Promise.all([\n        // for all deals between source.index and destinationIndex, decrease the index\n        ...columnDeals\n          .filter(\n            (deal) =>\n              deal.index <= destinationIndex && deal.index > source.index,\n          )\n          .map((deal) =>\n            dataProvider.update(\"deals\", {\n              id: deal.id,\n              data: { index: deal.index - 1 },\n              previousData: deal,\n            }),\n          ),\n        // for the deal that was moved, update its index\n        dataProvider.update(\"deals\", {\n          id: source.id,\n          data: { index: destinationIndex },\n          previousData: source,\n        }),\n      ]);\n    }\n  } else {\n    // moving deal across columns\n    // Fetch all the deals in both stages (because the list may be filtered, but we need to update even non-filtered deals)\n    const [{ data: sourceDeals }, { data: destinationDeals }] =\n      await Promise.all([\n        dataProvider.getList(\"deals\", {\n          sort: { field: \"index\", order: \"ASC\" },\n          pagination: { page: 1, perPage: 100 },\n          filter: { stage: source.stage },\n        }),\n        dataProvider.getList(\"deals\", {\n          sort: { field: \"index\", order: \"ASC\" },\n          pagination: { page: 1, perPage: 100 },\n          filter: { stage: destination.stage },\n        }),\n      ]);\n    const destinationIndex = destination.index ?? destinationDeals.length + 1;\n\n    await Promise.all([\n      // decrease index on the deals after the source index in the source columns\n      ...sourceDeals\n        .filter((deal) => deal.index > source.index)\n        .map((deal) =>\n          dataProvider.update(\"deals\", {\n            id: deal.id,\n            data: { index: deal.index - 1 },\n            previousData: deal,\n          }),\n        ),\n      // increase index on the deals after the destination index in the destination columns\n      ...destinationDeals\n        .filter((deal) => deal.index >= destinationIndex)\n        .map((deal) =>\n          dataProvider.update(\"deals\", {\n            id: deal.id,\n            data: { index: deal.index + 1 },\n            previousData: deal,\n          }),\n        ),\n      // change the dragged deal to take the destination index and column\n      dataProvider.update(\"deals\", {\n        id: source.id,\n        data: {\n          index: destinationIndex,\n          stage: destination.stage,\n        },\n        previousData: source,\n      }),\n    ]);\n  }\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/DealList.tsx",
      "content": "import { useGetIdentity, useListContext } from \"ra-core\";\nimport { matchPath, useLocation } from \"react-router\";\nimport { AutocompleteInput } from \"@/components/admin/autocomplete-input\";\nimport { CreateButton } from \"@/components/admin/create-button\";\nimport { ExportButton } from \"@/components/admin/export-button\";\nimport { List } from \"@/components/admin/list\";\nimport { ReferenceInput } from \"@/components/admin/reference-input\";\nimport { FilterButton } from \"@/components/admin/filter-form\";\nimport { SearchInput } from \"@/components/admin/search-input\";\nimport { SelectInput } from \"@/components/admin/select-input\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Card } from \"@/components/ui/card\";\n\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport { TopToolbar } from \"../layout/TopToolbar\";\nimport { DealArchivedList } from \"./DealArchivedList\";\nimport { DealCreate } from \"./DealCreate\";\nimport { DealEdit } from \"./DealEdit\";\nimport { DealEmpty } from \"./DealEmpty\";\nimport { DealListContent } from \"./DealListContent\";\nimport { DealShow } from \"./DealShow\";\nimport { OnlyMineInput } from \"./OnlyMineInput\";\n\nconst DealList = () => {\n  const { dealCategories } = useConfigurationContext();\n\n  const dealFilters = [\n    <SearchInput source=\"q\" alwaysOn />,\n    <ReferenceInput source=\"company_id\" reference=\"companies\">\n      <AutocompleteInput label={false} placeholder=\"Company\" />\n    </ReferenceInput>,\n    <SelectInput\n      source=\"category\"\n      emptyText=\"Category\"\n      choices={dealCategories.map((type) => ({ id: type, name: type }))}\n    />,\n    <OnlyMineInput source=\"sales_id\" alwaysOn />,\n  ];\n\n  return (\n    <List\n      perPage={100}\n      filter={{ \"archived_at@is\": null }}\n      title={false}\n      sort={{ field: \"index\", order: \"DESC\" }}\n      filters={dealFilters}\n      actions={<DealActions />}\n      pagination={null}\n    >\n      <DealLayout />\n    </List>\n  );\n};\n\nconst DealLayout = () => {\n  const location = useLocation();\n  const matchCreate = matchPath(\"/deals/create\", location.pathname);\n  const matchShow = matchPath(\"/deals/:id/show\", location.pathname);\n  const matchEdit = matchPath(\"/deals/:id\", location.pathname);\n\n  const { data, isPending, filterValues } = useListContext();\n  const { identity } = useGetIdentity();\n  const hasFilters = filterValues && Object.keys(filterValues).length > 0;\n\n  // Show loading skeleton while identity or data is loading\n  if (!identity || isPending) {\n    return (\n      <div className=\"w-full\">\n        <Card className=\"p-4\">\n          <div className=\"flex gap-4\">\n            <Skeleton className=\"h-96 w-1/4\" />\n            <Skeleton className=\"h-96 w-1/4\" />\n            <Skeleton className=\"h-96 w-1/4\" />\n            <Skeleton className=\"h-96 w-1/4\" />\n          </div>\n        </Card>\n      </div>\n    );\n  }\n\n  if (!data?.length && !hasFilters)\n    return (\n      <>\n        <DealEmpty>\n          <DealShow open={!!matchShow} id={matchShow?.params.id} />\n          <DealArchivedList />\n        </DealEmpty>\n      </>\n    );\n\n  return (\n    <div className=\"w-full\">\n      <DealListContent />\n      <DealArchivedList />\n      <DealCreate open={!!matchCreate} />\n      <DealEdit open={!!matchEdit && !matchCreate} id={matchEdit?.params.id} />\n      <DealShow open={!!matchShow} id={matchShow?.params.id} />\n    </div>\n  );\n};\n\nconst DealActions = () => (\n  <TopToolbar>\n    <FilterButton />\n    <ExportButton />\n    <CreateButton label=\"New Deal\" />\n  </TopToolbar>\n);\n\nexport default DealList;\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/DealInputs.tsx",
      "content": "import { required } from \"ra-core\";\nimport { AutocompleteArrayInput } from \"@/components/admin/autocomplete-array-input\";\nimport { ReferenceArrayInput } from \"@/components/admin/reference-array-input\";\nimport { ReferenceInput } from \"@/components/admin/reference-input\";\nimport { TextInput } from \"@/components/admin/text-input\";\nimport { NumberInput } from \"@/components/admin/number-input\";\nimport { DateInput } from \"@/components/admin/date-input\";\nimport { SelectInput } from \"@/components/admin/select-input\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { useIsMobile } from \"@/hooks/use-mobile\";\n\nimport { contactOptionText } from \"../misc/ContactOption\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport { AutocompleteCompanyInput } from \"../companies/AutocompleteCompanyInput.tsx\";\n\nexport const DealInputs = () => {\n  const isMobile = useIsMobile();\n  return (\n    <div className=\"flex flex-col gap-8\">\n      <DealInfoInputs />\n\n      <div className={`flex gap-6 ${isMobile ? \"flex-col\" : \"flex-row\"}`}>\n        <DealLinkedToInputs />\n        <Separator orientation={isMobile ? \"horizontal\" : \"vertical\"} />\n        <DealMiscInputs />\n      </div>\n    </div>\n  );\n};\n\nconst DealInfoInputs = () => {\n  return (\n    <div className=\"flex flex-col gap-4 flex-1\">\n      <TextInput\n        source=\"name\"\n        label=\"Deal name\"\n        validate={required()}\n        helperText={false}\n      />\n      <TextInput source=\"description\" multiline rows={3} helperText={false} />\n    </div>\n  );\n};\n\nconst DealLinkedToInputs = () => {\n  return (\n    <div className=\"flex flex-col gap-4 flex-1\">\n      <h3 className=\"text-base font-medium\">Linked to</h3>\n      <ReferenceInput source=\"company_id\" reference=\"companies\">\n        <AutocompleteCompanyInput validate={required()} />\n      </ReferenceInput>\n\n      <ReferenceArrayInput source=\"contact_ids\" reference=\"contacts_summary\">\n        <AutocompleteArrayInput\n          label=\"Contacts\"\n          optionText={contactOptionText}\n          helperText={false}\n        />\n      </ReferenceArrayInput>\n    </div>\n  );\n};\n\nconst DealMiscInputs = () => {\n  const { dealStages, dealCategories } = useConfigurationContext();\n  return (\n    <div className=\"flex flex-col gap-4 flex-1\">\n      <h3 className=\"text-base font-medium\">Misc</h3>\n\n      <SelectInput\n        source=\"category\"\n        label=\"Category\"\n        choices={dealCategories.map((type) => ({\n          id: type,\n          name: type,\n        }))}\n        helperText={false}\n      />\n      <NumberInput\n        source=\"amount\"\n        defaultValue={0}\n        helperText={false}\n        validate={required()}\n      />\n      <DateInput\n        validate={required()}\n        source=\"expected_closing_date\"\n        helperText={false}\n        defaultValue={new Date().toISOString().split(\"T\")[0]}\n      />\n      <SelectInput\n        source=\"stage\"\n        choices={dealStages.map((stage) => ({\n          id: stage.value,\n          name: stage.label,\n        }))}\n        defaultValue=\"opportunity\"\n        helperText={false}\n        validate={required()}\n      />\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/DealEmpty.tsx",
      "content": "import { useGetList } from \"ra-core\";\nimport { matchPath, useLocation, Link } from \"react-router\";\nimport type { ReactNode } from \"react\";\nimport { CreateButton } from \"@/components/admin/create-button\";\nimport { Progress } from \"@/components/ui/progress\";\n\nimport useAppBarHeight from \"../misc/useAppBarHeight\";\nimport type { Contact } from \"../types\";\nimport { DealCreate } from \"./DealCreate\";\n\nexport const DealEmpty = ({ children }: { children?: ReactNode }) => {\n  const location = useLocation();\n  const matchCreate = matchPath(\"/deals/create\", location.pathname);\n  const appbarHeight = useAppBarHeight();\n\n  // get Contact data\n  const { data: contacts, isPending: contactsLoading } = useGetList<Contact>(\n    \"contacts\",\n    {\n      pagination: { page: 1, perPage: 1 },\n    },\n  );\n\n  if (contactsLoading) return <Progress value={50} />;\n\n  return (\n    <div\n      className=\"flex flex-col justify-center items-center gap-12\"\n      style={{\n        height: `calc(100dvh - ${appbarHeight}px)`,\n      }}\n    >\n      <img src=\"./img/empty.svg\" alt=\"No deals found\" />\n      {contacts && contacts.length > 0 ? (\n        <>\n          <div className=\"flex flex-col items-center gap-0\">\n            <h3 className=\"text-lg font-bold\">No deals found</h3>\n            <p className=\"text-sm text-center text-muted-foreground mb-4\">\n              It seems your deal list is empty.\n            </p>\n          </div>\n          <div className=\"flex space-x-8\">\n            <CreateButton label=\"Create deal\" />\n          </div>\n          <DealCreate open={!!matchCreate} />\n          {children}\n        </>\n      ) : (\n        <div className=\"flex flex-col items-center gap-0\">\n          <h3 className=\"text-lg font-bold\">No deals found</h3>\n          <p className=\"text-sm text-center text-muted-foreground mb-4\">\n            It seems your contact list is empty.\n            <br />\n            <Link to=\"/contacts/create\" className=\"hover:underline\">\n              Add your first contact\n            </Link>{\" \"}\n            before creating a deal.\n          </p>\n        </div>\n      )}\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/DealEdit.tsx",
      "content": "import {\n  EditBase,\n  Form,\n  useNotify,\n  useRecordContext,\n  useRedirect,\n} from \"ra-core\";\nimport { Link } from \"react-router\";\nimport { DeleteButton } from \"@/components/admin/delete-button\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { Button } from \"@/components/ui/button\";\nimport { Dialog, DialogContent, DialogTitle } from \"@/components/ui/dialog\";\n\nimport { FormToolbar } from \"../layout/FormToolbar\";\nimport { CompanyAvatar } from \"../companies/CompanyAvatar\";\nimport type { Deal } from \"../types\";\nimport { DealInputs } from \"./DealInputs\";\n\nexport const DealEdit = ({ open, id }: { open: boolean; id?: string }) => {\n  const redirect = useRedirect();\n  const notify = useNotify();\n\n  const handleClose = () => {\n    redirect(\"/deals\", undefined, undefined, undefined, {\n      _scrollToTop: false,\n    });\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={() => handleClose()}>\n      <DialogContent className=\"lg:max-w-4xl p-4 overflow-y-auto max-h-9/10 top-1/20 translate-y-0\">\n        {id ? (\n          <EditBase\n            id={id}\n            mutationMode=\"pessimistic\"\n            mutationOptions={{\n              onSuccess: () => {\n                notify(\"Deal updated\");\n                redirect(`/deals/${id}/show`, undefined, undefined, undefined, {\n                  _scrollToTop: false,\n                });\n              },\n            }}\n          >\n            <EditHeader />\n            <Form>\n              <DealInputs />\n              <FormToolbar />\n            </Form>\n          </EditBase>\n        ) : null}\n      </DialogContent>\n    </Dialog>\n  );\n};\n\nfunction EditHeader() {\n  const deal = useRecordContext<Deal>();\n  if (!deal) {\n    return null;\n  }\n\n  return (\n    <DialogTitle className=\"pb-0\">\n      <div className=\"flex justify-between items-start mb-8\">\n        <div className=\"flex items-center gap-4\">\n          <ReferenceField source=\"company_id\" reference=\"companies\" link=\"show\">\n            <CompanyAvatar />\n          </ReferenceField>\n          <h2 className=\"text-2xl font-semibold\">Edit {deal.name} deal</h2>\n        </div>\n        <div className=\"flex gap-2 pr-12\">\n          <DeleteButton />\n          <Button asChild variant=\"outline\" className=\"h-9\">\n            <Link to={`/deals/${deal.id}/show`}>Back to deal</Link>\n          </Button>\n        </div>\n      </div>\n    </DialogTitle>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/DealCreate.tsx",
      "content": "import { useQueryClient } from \"@tanstack/react-query\";\nimport {\n  Form,\n  useDataProvider,\n  useGetIdentity,\n  useListContext,\n  useRedirect,\n  type GetListResult,\n} from \"ra-core\";\nimport { Create } from \"@/components/admin/create\";\nimport { SaveButton } from \"@/components/admin/form\";\nimport { FormToolbar } from \"@/components/admin/simple-form\";\nimport { Dialog, DialogContent, DialogTitle } from \"@/components/ui/dialog\";\nimport { VisuallyHidden } from \"@/components/ui/visually-hidden\";\n\nimport type { Deal } from \"../types\";\nimport { DealInputs } from \"./DealInputs\";\n\nexport const DealCreate = ({ open }: { open: boolean }) => {\n  const redirect = useRedirect();\n  const dataProvider = useDataProvider();\n  const { data: allDeals } = useListContext<Deal>();\n\n  const handleClose = () => {\n    redirect(\"/deals\");\n  };\n\n  const queryClient = useQueryClient();\n\n  const onSuccess = async (deal: Deal) => {\n    if (!allDeals) {\n      redirect(\"/deals\");\n      return;\n    }\n    // increase the index of all deals in the same stage as the new deal\n    // first, get the list of deals in the same stage\n    const deals = allDeals.filter(\n      (d: Deal) => d.stage === deal.stage && d.id !== deal.id,\n    );\n    // update the actual deals in the database\n    await Promise.all(\n      deals.map(async (oldDeal) =>\n        dataProvider.update(\"deals\", {\n          id: oldDeal.id,\n          data: { index: oldDeal.index + 1 },\n          previousData: oldDeal,\n        }),\n      ),\n    );\n    // refresh the list of deals in the cache as we used dataProvider.update(),\n    // which does not update the cache\n    const dealsById = deals.reduce(\n      (acc, d) => ({\n        ...acc,\n        [d.id]: { ...d, index: d.index + 1 },\n      }),\n      {} as { [key: string]: Deal },\n    );\n    const now = Date.now();\n    queryClient.setQueriesData<GetListResult | undefined>(\n      { queryKey: [\"deals\", \"getList\"] },\n      (res) => {\n        if (!res) return res;\n        return {\n          ...res,\n          data: res.data.map((d: Deal) => dealsById[d.id] || d),\n        };\n      },\n      { updatedAt: now },\n    );\n    redirect(\"/deals\");\n  };\n\n  const { identity } = useGetIdentity();\n\n  return (\n    <Dialog open={open} onOpenChange={() => handleClose()}>\n      <DialogContent className=\"lg:max-w-4xl overflow-y-auto max-h-9/10 top-1/20 translate-y-0\">\n        <VisuallyHidden>\n          <DialogTitle>Create Deal</DialogTitle>\n        </VisuallyHidden>\n        <Create resource=\"deals\" mutationOptions={{ onSuccess }}>\n          <Form\n            defaultValues={{\n              sales_id: identity?.id,\n              contact_ids: [],\n              index: 0,\n            }}\n          >\n            <DealInputs />\n            <FormToolbar>\n              <SaveButton />\n            </FormToolbar>\n          </Form>\n        </Create>\n      </DialogContent>\n    </Dialog>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/DealColumn.tsx",
      "content": "import { Droppable } from \"@hello-pangea/dnd\";\n\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport type { Deal } from \"../types\";\nimport { findDealLabel } from \"./deal\";\nimport { DealCard } from \"./DealCard\";\n\nexport const DealColumn = ({\n  stage,\n  deals,\n}: {\n  stage: string;\n  deals: Deal[];\n}) => {\n  const totalAmount = deals.reduce((sum, deal) => sum + deal.amount, 0);\n\n  const { dealStages } = useConfigurationContext();\n  return (\n    <div className=\"flex-1 pb-8\">\n      <div className=\"flex flex-col items-center\">\n        <h3 className=\"text-base font-medium\">\n          {findDealLabel(dealStages, stage)}\n        </h3>\n        <p className=\"text-sm text-muted-foreground\">\n          {totalAmount.toLocaleString(\"en-US\", {\n            notation: \"compact\",\n            style: \"currency\",\n            currency: \"USD\",\n            currencyDisplay: \"narrowSymbol\",\n            minimumSignificantDigits: 3,\n          })}\n        </p>\n      </div>\n      <Droppable droppableId={stage}>\n        {(droppableProvided, snapshot) => (\n          <div\n            ref={droppableProvided.innerRef}\n            {...droppableProvided.droppableProps}\n            className={`flex flex-col rounded-2xl mt-2 gap-2 ${\n              snapshot.isDraggingOver ? \"bg-muted\" : \"\"\n            }`}\n          >\n            {deals.map((deal, index) => (\n              <DealCard key={deal.id} deal={deal} index={index} />\n            ))}\n            {droppableProvided.placeholder}\n          </div>\n        )}\n      </Droppable>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/DealCard.tsx",
      "content": "import { Draggable } from \"@hello-pangea/dnd\";\nimport { useRedirect } from \"ra-core\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { Card, CardContent } from \"@/components/ui/card\";\n\nimport { CompanyAvatar } from \"../companies/CompanyAvatar\";\nimport type { Deal } from \"../types\";\n\nexport const DealCard = ({ deal, index }: { deal: Deal; index: number }) => {\n  if (!deal) return null;\n\n  return (\n    <Draggable draggableId={String(deal.id)} index={index}>\n      {(provided, snapshot) => (\n        <DealCardContent provided={provided} snapshot={snapshot} deal={deal} />\n      )}\n    </Draggable>\n  );\n};\n\nexport const DealCardContent = ({\n  provided,\n  snapshot,\n  deal,\n}: {\n  provided?: any;\n  snapshot?: any;\n  deal: Deal;\n}) => {\n  const redirect = useRedirect();\n  const handleClick = () => {\n    redirect(`/deals/${deal.id}/show`, undefined, undefined, undefined, {\n      _scrollToTop: false,\n    });\n  };\n\n  return (\n    <div\n      className=\"cursor-pointer\"\n      {...provided?.draggableProps}\n      {...provided?.dragHandleProps}\n      ref={provided?.innerRef}\n      onClick={handleClick}\n    >\n      <Card\n        className={`py-4 transition-all duration-200 ${\n          snapshot?.isDragging\n            ? \"opacity-90 transform rotate-1 shadow-lg\"\n            : \"shadow-sm hover:shadow-md\"\n        }`}\n      >\n        <CardContent className=\"px-4 flex\">\n          <ReferenceField\n            source=\"company_id\"\n            record={deal}\n            reference=\"companies\"\n            link={false}\n          >\n            <CompanyAvatar width={20} height={20} />\n          </ReferenceField>\n          <div className=\"ml-3\">\n            <p className=\"text-sm font-medium mb-2\">{deal.name}</p>\n            <p className=\"text-xs text-muted-foreground\">\n              {deal.amount.toLocaleString(\"en-US\", {\n                notation: \"compact\",\n                style: \"currency\",\n                currency: \"USD\",\n                currencyDisplay: \"narrowSymbol\",\n                minimumSignificantDigits: 3,\n              })}\n              {deal.category ? `, ${deal.category}` : \"\"}\n            </p>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/DealArchivedList.tsx",
      "content": "/* eslint-disable react-refresh/only-export-components */\nimport { useGetIdentity, useGetList } from \"ra-core\";\nimport { useEffect, useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Dialog, DialogContent, DialogTitle } from \"@/components/ui/dialog\";\n\nimport type { Deal } from \"../types\";\nimport { DealCardContent } from \"./DealCard\";\n\nexport const DealArchivedList = () => {\n  const { identity } = useGetIdentity();\n  const {\n    data: archivedLists,\n    total,\n    isPending,\n  } = useGetList(\"deals\", {\n    pagination: { page: 1, perPage: 1000 },\n    sort: { field: \"archived_at\", order: \"DESC\" },\n    filter: { \"archived_at@not.is\": null },\n  });\n  const [openDialog, setOpenDialog] = useState(false);\n\n  useEffect(() => {\n    if (!isPending && total === 0) {\n      setOpenDialog(false);\n    }\n  }, [isPending, total]);\n\n  useEffect(() => {\n    setOpenDialog(false);\n  }, [archivedLists]);\n\n  if (!identity || isPending || !total || !archivedLists) return null;\n\n  // Group archived lists by date\n  const archivedListsByDate: { [date: string]: Deal[] } = archivedLists.reduce(\n    (acc, deal) => {\n      const date = new Date(deal.archived_at).toDateString();\n      if (!acc[date]) {\n        acc[date] = [];\n      }\n      acc[date].push(deal);\n      return acc;\n    },\n    {} as { [date: string]: Deal[] },\n  );\n\n  return (\n    <div className=\"w-full flex flex-row items-center justify-center\">\n      <Button\n        variant=\"ghost\"\n        onClick={() => setOpenDialog(true)}\n        className=\"my-4\"\n      >\n        View archived deals\n      </Button>\n      <Dialog open={openDialog} onOpenChange={() => setOpenDialog(false)}>\n        <DialogContent className=\"lg:max-w-4xl overflow-y-auto max-h-9/10 top-1/20 translate-y-0\">\n          <DialogTitle>Archived Deals</DialogTitle>\n          <div className=\"flex flex-col gap-8\">\n            {Object.entries(archivedListsByDate).map(([date, deals]) => (\n              <div key={date} className=\"flex flex-col gap-4\">\n                <h4 className=\"font-bold\">{getRelativeTimeString(date)}</h4>\n                <div className=\"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-8\">\n                  {deals.map((deal: Deal) => (\n                    <div key={deal.id}>\n                      <DealCardContent deal={deal} />\n                    </div>\n                  ))}\n                </div>\n              </div>\n            ))}\n          </div>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n};\n\nexport function getRelativeTimeString(dateString: string): string {\n  const date = new Date(dateString);\n  date.setHours(0, 0, 0, 0);\n\n  const today = new Date();\n  today.setHours(0, 0, 0, 0);\n\n  const diff = date.getTime() - today.getTime();\n  const unitDiff = Math.round(diff / (1000 * 60 * 60 * 24));\n\n  // Check if the date is more than one week old\n  if (Math.abs(unitDiff) > 7) {\n    return new Intl.DateTimeFormat(undefined, {\n      day: \"numeric\",\n      month: \"long\",\n    }).format(date);\n  }\n\n  // Intl.RelativeTimeFormat for dates within the last week\n  const rtf = new Intl.RelativeTimeFormat(undefined, { numeric: \"auto\" });\n  return ucFirst(rtf.format(unitDiff, \"day\"));\n}\n\nfunction ucFirst(str: string): string {\n  return str.charAt(0).toUpperCase() + str.slice(1);\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/ContactList.tsx",
      "content": "import { useListContext } from \"ra-core\";\nimport { Link as RouterLink } from \"react-router\";\n\nimport { Avatar } from \"../contacts/Avatar\";\n\nexport const ContactList = () => {\n  const { data, error, isPending } = useListContext();\n  if (isPending || error) return <div className=\"h-8\" />;\n  return (\n    <div className=\"flex flex-row flex-wrap gap-4 mt-4\">\n      {data.map((contact) => (\n        <div className=\"flex flex-row gap-4 items-center\" key={contact.id}>\n          <Avatar record={contact} />\n          <div className=\"flex flex-col\">\n            <RouterLink\n              to={`/contacts/${contact.id}/show`}\n              className=\"text-sm hover:underline\"\n            >\n              {contact.first_name} {contact.last_name}\n            </RouterLink>\n            <span className=\"text-xs text-muted-foreground\">\n              {contact.title}\n              {contact.title && contact.company_name && \" at \"}\n              {contact.company_name}\n            </span>\n          </div>\n        </div>\n      ))}\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/dashboard/Welcome.tsx",
      "content": "import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\n\nexport const Welcome = () => (\n  <Card>\n    <CardHeader className=\"px-4\">\n      <CardTitle>Your CRM Starter Kit</CardTitle>\n    </CardHeader>\n    <CardContent className=\"px-4\">\n      <p className=\"text-sm mb-4\">\n        <a\n          href=\"https://github.com/therealtimex/realtimex-crm\"\n          className=\"underline hover:no-underline\"\n        >\n          RealTimeX CRM\n        </a>{\" \"}\n        is a full-featured CRM designed to help you manage contacts, deals, and\n        tasks.\n      </p>\n      <p className=\"text-sm mb-4\">\n        This demo runs on a mock API, so you can explore and modify the data. It\n        resets on reload. The full version uses Supabase for the backend.\n      </p>\n      <p className=\"text-sm\">\n        Powered by{\" \"}\n        <a\n          href=\"https://marmelab.com/shadcn-admin-kit\"\n          className=\"underline hover:no-underline\"\n        >\n          shadcn-admin-kit\n        </a>\n        . Fork of{\" \"}\n        <a\n          href=\"https://github.com/marmelab/atomic-crm\"\n          className=\"underline hover:no-underline\"\n        >\n          Atomic CRM\n        </a>{\" \"}\n        by Marmelab.\n      </p>\n    </CardContent>\n  </Card>\n);\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/dashboard/TasksListFilter.tsx",
      "content": "import {\n  ListContextProvider,\n  ResourceContextProvider,\n  useGetIdentity,\n  useGetList,\n  useList,\n} from \"ra-core\";\n\nimport { TasksIterator } from \"../tasks/TasksIterator\";\n\nexport const TasksListFilter = ({\n  title,\n  filter,\n}: {\n  title: string;\n  filter: any;\n}) => {\n  const { identity } = useGetIdentity();\n\n  const {\n    data: tasks,\n    total,\n    isPending,\n  } = useGetList(\n    \"tasks\",\n    {\n      pagination: { page: 1, perPage: 100 },\n      sort: { field: \"due_date\", order: \"ASC\" },\n      filter: {\n        ...filter,\n        sales_id: identity?.id,\n      },\n    },\n    { enabled: !!identity },\n  );\n\n  const listContext = useList({\n    data: tasks,\n    isPending,\n    resource: \"tasks\",\n    perPage: 5,\n  });\n\n  if (isPending || !tasks || !total) return null;\n\n  return (\n    <div className=\"flex flex-col gap-2\">\n      <p className=\"text-xs uppercase tracking-wider text-muted-foreground font-medium mb-2\">\n        {title}\n      </p>\n      <ResourceContextProvider value=\"tasks\">\n        <ListContextProvider value={listContext}>\n          <TasksIterator showContact />\n        </ListContextProvider>\n      </ResourceContextProvider>\n      {total > listContext.perPage && (\n        <div className=\"flex justify-center\">\n          <a\n            href=\"#\"\n            onClick={(e) => {\n              listContext.setPerPage(listContext.perPage + 10);\n              e.preventDefault();\n            }}\n            className=\"text-sm underline hover:no-underline\"\n          >\n            Load more\n          </a>\n        </div>\n      )}\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/dashboard/TasksListEmpty.tsx",
      "content": "import { useGetIdentity, useGetList } from \"ra-core\";\n\nexport const TasksListEmpty = () => {\n  const { identity } = useGetIdentity();\n\n  const { total } = useGetList(\n    \"tasks\",\n    {\n      pagination: { page: 1, perPage: 1 },\n      filter: {\n        sales_id: identity?.id,\n      },\n    },\n    { enabled: !!identity },\n  );\n\n  if (total) return null;\n\n  return (\n    <p className=\"text-sm\">Tasks added to your contacts will appear here.</p>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/dashboard/TasksList.tsx",
      "content": "import {\n  endOfToday,\n  endOfTomorrow,\n  endOfWeek,\n  getDay,\n  startOfToday,\n} from \"date-fns\";\nimport { CheckSquare } from \"lucide-react\";\nimport { Card } from \"@/components/ui/card\";\n\nimport { AddTask } from \"../tasks/AddTask\";\nimport { TasksListEmpty } from \"./TasksListEmpty\";\nimport { TasksListFilter } from \"./TasksListFilter\";\n\nconst today = new Date();\nconst todayDayOfWeek = getDay(today);\nconst isBeforeFriday = todayDayOfWeek < 5; // Friday is represented by 5\nconst startOfTodayDateISO = startOfToday().toISOString();\nconst endOfTodayDateISO = endOfToday().toISOString();\nconst endOfTomorrowDateISO = endOfTomorrow().toISOString();\nconst endOfWeekDateISO = endOfWeek(today, { weekStartsOn: 0 }).toISOString();\n\nconst taskFilters = {\n  overdue: { \"done_date@is\": null, \"due_date@lt\": startOfTodayDateISO },\n  today: {\n    \"done_date@is\": null,\n    \"due_date@gte\": startOfTodayDateISO,\n    \"due_date@lte\": endOfTodayDateISO,\n  },\n  tomorrow: {\n    \"done_date@is\": null,\n    \"due_date@gt\": endOfTodayDateISO,\n    \"due_date@lt\": endOfTomorrowDateISO,\n  },\n  thisWeek: {\n    \"done_date@is\": null,\n    \"due_date@gte\": endOfTomorrowDateISO,\n    \"due_date@lte\": endOfWeekDateISO,\n  },\n  later: { \"done_date@is\": null, \"due_date@gt\": endOfWeekDateISO },\n};\n\nexport const TasksList = () => {\n  return (\n    <div className=\"flex flex-col gap-2\">\n      <div className=\"flex items-center\">\n        <div className=\"mr-3 flex\">\n          <CheckSquare className=\"text-muted-foreground w-6 h-6\" />\n        </div>\n        <h2 className=\"text-xl font-semibold text-muted-foreground flex-1\">\n          Upcoming Tasks\n        </h2>\n        <AddTask display=\"icon\" selectContact />\n      </div>\n      <Card className=\"p-4 mb-2\">\n        <div className=\"flex flex-col gap-4\">\n          <TasksListEmpty />\n          <TasksListFilter title=\"Overdue\" filter={taskFilters.overdue} />\n          <TasksListFilter title=\"Today\" filter={taskFilters.today} />\n          <TasksListFilter title=\"Tomorrow\" filter={taskFilters.tomorrow} />\n          {isBeforeFriday && (\n            <TasksListFilter title=\"This week\" filter={taskFilters.thisWeek} />\n          )}\n          <TasksListFilter title=\"Later\" filter={taskFilters.later} />\n        </div>\n      </Card>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/dashboard/LatestNotes.tsx",
      "content": "import { formatDistance } from \"date-fns\";\nimport { FileText } from \"lucide-react\";\nimport { useGetIdentity, useGetList } from \"ra-core\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { Card, CardContent } from \"@/components/ui/card\";\n\nimport type { Contact, ContactNote } from \"../types\";\n\nexport const LatestNotes = () => {\n  const { identity } = useGetIdentity();\n  const { data: contactNotesData, isPending: contactNotesLoading } = useGetList(\n    \"contactNotes\",\n    {\n      pagination: { page: 1, perPage: 5 },\n      sort: { field: \"date\", order: \"DESC\" },\n      filter: { sales_id: identity?.id },\n    },\n    { enabled: Number.isInteger(identity?.id) },\n  );\n  const { data: dealNotesData, isPending: dealNotesLoading } = useGetList(\n    \"dealNotes\",\n    {\n      pagination: { page: 1, perPage: 5 },\n      sort: { field: \"date\", order: \"DESC\" },\n      filter: { sales_id: identity?.id },\n    },\n    { enabled: Number.isInteger(identity?.id) },\n  );\n  if (contactNotesLoading || dealNotesLoading) {\n    return null;\n  }\n  // TypeScript guards\n  if (!contactNotesData || !dealNotesData) {\n    return null;\n  }\n\n  const allNotes = ([] as any[])\n    .concat(\n      contactNotesData.map((note) => ({\n        ...note,\n        type: \"contactNote\",\n      })),\n      dealNotesData.map((note) => ({ ...note, type: \"dealNote\" })),\n    )\n    .sort((a, b) => new Date(b.date).valueOf() - new Date(a.date).valueOf())\n    .slice(0, 5);\n\n  return (\n    <div>\n      <div className=\"flex items-center mb-4\">\n        <div className=\"ml-8 mr-8 flex\">\n          <FileText className=\"text-muted-foreground w-6 h-6\" />\n        </div>\n        <h2 className=\"text-xl font-semibold text-muted-foreground\">\n          My Latest Notes\n        </h2>\n      </div>\n      <Card>\n        <CardContent>\n          {allNotes.map((note) => (\n            <div\n              id={`${note.type}_${note.id}`}\n              key={`${note.type}_${note.id}`}\n              className=\"mb-8\"\n            >\n              <div className=\"text-sm text-muted-foreground\">\n                on{\" \"}\n                {note.type === \"dealNote\" ? (\n                  <Deal note={note} />\n                ) : (\n                  <Contact note={note} />\n                )}\n                , added{\" \"}\n                {formatDistance(note.date, new Date(), {\n                  addSuffix: true,\n                })}\n              </div>\n              <div>\n                <p className=\"text-sm line-clamp-3 overflow-hidden\">\n                  {note.text}\n                </p>\n              </div>\n            </div>\n          ))}\n        </CardContent>\n      </Card>\n    </div>\n  );\n};\n\nconst Deal = ({ note }: any) => (\n  <>\n    Deal{\" \"}\n    <ReferenceField\n      record={note}\n      source=\"deal_id\"\n      reference=\"deals\"\n      link=\"show\"\n    >\n      <TextField source=\"name\" />\n    </ReferenceField>\n  </>\n);\n\nconst Contact = ({ note }: any) => (\n  <>\n    Contact{\" \"}\n    <ReferenceField<ContactNote, Contact>\n      record={note}\n      source=\"contact_id\"\n      reference=\"contacts\"\n      link=\"show\"\n    />\n  </>\n);\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/dashboard/HotContacts.tsx",
      "content": "import { Plus, Users } from \"lucide-react\";\nimport { useGetIdentity, useGetList } from \"ra-core\";\nimport { Link } from \"react-router\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card } from \"@/components/ui/card\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\n\nimport { SimpleList } from \"../simple-list/SimpleList\";\nimport { Avatar } from \"../contacts/Avatar\";\nimport type { Contact } from \"../types\";\n\nexport const HotContacts = () => {\n  const { identity } = useGetIdentity();\n  const {\n    data: contactData,\n    total: contactTotal,\n    isPending: contactsLoading,\n  } = useGetList<Contact>(\n    \"contacts\",\n    {\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"last_seen\", order: \"DESC\" },\n      filter: { status: \"hot\", sales_id: identity?.id },\n    },\n    { enabled: Number.isInteger(identity?.id) },\n  );\n\n  return (\n    <div className=\"flex flex-col gap-2\">\n      <div className=\"flex items-center\">\n        <div className=\"mr-3 flex\">\n          <Users className=\"text-muted-foreground w-6 h-6\" />\n        </div>\n        <h2 className=\"text-xl font-semibold text-muted-foreground\">\n          Hot Contacts\n        </h2>\n        <TooltipProvider>\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                className=\"ml-auto text-muted-foreground\"\n                asChild\n              >\n                <Link to=\"/contacts/create\">\n                  <Plus className=\"w-4 h-4 text-primary\" />\n                </Link>\n              </Button>\n            </TooltipTrigger>\n            <TooltipContent>Create contact</TooltipContent>\n          </Tooltip>\n        </TooltipProvider>\n      </div>\n      <Card className=\"py-0\">\n        <SimpleList<Contact>\n          linkType=\"show\"\n          data={contactData}\n          total={contactTotal}\n          isPending={contactsLoading}\n          resource=\"contacts\"\n          className=\"[&>li:first-child>a]:rounded-t-xl [&>li:last-child>a]:rounded-b-xl\"\n          primaryText={(contact) =>\n            `${contact.first_name} ${contact.last_name}`\n          }\n          secondaryText={(contact) => (\n            <>\n              {contact.title} at {contact.company_name}\n            </>\n          )}\n          leftAvatar={(contact) => <Avatar record={contact} />}\n          empty={\n            <div className=\"p-4\">\n              <p className=\"text-sm mb-4\">\n                Contacts with a \"hot\" status will appear here.\n              </p>\n              <p className=\"text-sm\">\n                Change the status of a contact by adding a note to that contact\n                and clicking on \"show options\".\n              </p>\n            </div>\n          }\n        />\n      </Card>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/dashboard/DealsPipeline.tsx",
      "content": "import { DollarSign } from \"lucide-react\";\nimport { useGetIdentity, useGetList } from \"ra-core\";\nimport { Link } from \"react-router\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { Card } from \"@/components/ui/card\";\n\nimport { SimpleList } from \"../simple-list/SimpleList\";\nimport { CompanyAvatar } from \"../companies/CompanyAvatar\";\nimport { findDealLabel } from \"../deals/deal\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport type { Deal } from \"../types\";\n\n/**\n * This component displays the deals pipeline for the current user.\n * It's currently not used in the application but can be added to the dashboard.\n */\nexport const DealsPipeline = () => {\n  const { identity } = useGetIdentity();\n  const { dealStages, dealPipelineStatuses } = useConfigurationContext();\n  const { data, total, isPending } = useGetList<Deal>(\n    \"deals\",\n    {\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"last_seen\", order: \"DESC\" },\n      filter: { \"stage@neq\": \"lost\", sales_id: identity?.id },\n    },\n    { enabled: Number.isInteger(identity?.id) },\n  );\n\n  const getOrderedDeals = (data?: Deal[]): Deal[] | undefined => {\n    if (!data) {\n      return;\n    }\n    const deals: Deal[] = [];\n    dealStages\n      .filter((stage) => !dealPipelineStatuses.includes(stage.value))\n      .forEach((stage) =>\n        data\n          .filter((deal) => deal.stage === stage.value)\n          .forEach((deal) => deals.push(deal)),\n      );\n    return deals;\n  };\n\n  return (\n    <>\n      <div className=\"flex items-center mb-4\">\n        <div className=\"ml-8 mr-8 flex\">\n          <DollarSign className=\"text-muted-foreground w-6 h-6\" />\n        </div>\n        <Link\n          className=\"text-xl font-semibold text-muted-foreground hover:underline\"\n          to=\"/deals\"\n        >\n          Deals Pipeline\n        </Link>\n      </div>\n      <Card>\n        <SimpleList<Deal>\n          resource=\"deals\"\n          linkType=\"show\"\n          data={getOrderedDeals(data)}\n          total={total}\n          isPending={isPending}\n          primaryText={(deal) => deal.name}\n          secondaryText={(deal) =>\n            `${deal.amount.toLocaleString(\"en-US\", {\n              notation: \"compact\",\n              style: \"currency\",\n              currency: \"USD\",\n              currencyDisplay: \"narrowSymbol\",\n              minimumSignificantDigits: 3,\n            })} , ${findDealLabel(dealStages, deal.stage)}`\n          }\n          leftAvatar={(deal) => (\n            <ReferenceField\n              source=\"company_id\"\n              record={deal}\n              reference=\"companies\"\n              resource=\"deals\"\n              link={false}\n            >\n              <CompanyAvatar width={20} height={20} />\n            </ReferenceField>\n          )}\n        />\n      </Card>\n    </>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/dashboard/DealsChart.tsx",
      "content": "import { ResponsiveBar } from \"@nivo/bar\";\nimport { format, startOfMonth } from \"date-fns\";\nimport { DollarSign } from \"lucide-react\";\nimport { useGetList } from \"ra-core\";\nimport { memo, useMemo } from \"react\";\n\nimport type { Deal } from \"../types\";\n\nconst multiplier = {\n  opportunity: 0.2,\n  \"proposal-sent\": 0.5,\n  \"in-negociation\": 0.8,\n  delayed: 0.3,\n};\n\nconst threeMonthsAgo = new Date(\n  new Date().setMonth(new Date().getMonth() - 6),\n).toISOString();\n\nconst DEFAULT_LOCALE = \"en-US\";\nconst CURRENCY = \"USD\";\n\nexport const DealsChart = memo(() => {\n  const acceptedLanguages = navigator\n    ? navigator.languages || [navigator.language]\n    : [DEFAULT_LOCALE];\n\n  const { data, isPending } = useGetList<Deal>(\"deals\", {\n    pagination: { perPage: 100, page: 1 },\n    sort: {\n      field: \"created_at\",\n      order: \"ASC\",\n    },\n    filter: {\n      \"created_at@gte\": threeMonthsAgo,\n    },\n  });\n  const months = useMemo(() => {\n    if (!data) return [];\n    const dealsByMonth = data.reduce((acc, deal) => {\n      const month = startOfMonth(deal.created_at ?? new Date()).toISOString();\n      if (!acc[month]) {\n        acc[month] = [];\n      }\n      acc[month].push(deal);\n      return acc;\n    }, {} as any);\n\n    const amountByMonth = Object.keys(dealsByMonth).map((month) => {\n      return {\n        date: format(month, \"MMM\"),\n        won: dealsByMonth[month]\n          .filter((deal: Deal) => deal.stage === \"won\")\n          .reduce((acc: number, deal: Deal) => {\n            const amount = deal.amount ?? 0;\n            if (!isNaN(amount)) {\n              acc += amount;\n            }\n            return acc;\n          }, 0),\n        pending: dealsByMonth[month]\n          .filter((deal: Deal) => ![\"won\", \"lost\"].includes(deal.stage))\n          .reduce((acc: number, deal: Deal) => {\n            const amount = deal.amount ?? 0;\n            // @ts-expect-error - multiplier type issue\n            const mult = multiplier[deal.stage] ?? 0;\n            if (!isNaN(amount) && !isNaN(mult)) {\n              acc += amount * mult;\n            }\n            return acc;\n          }, 0),\n        lost: dealsByMonth[month]\n          .filter((deal: Deal) => deal.stage === \"lost\")\n          .reduce((acc: number, deal: Deal) => {\n            const amount = deal.amount ?? 0;\n            if (!isNaN(amount)) {\n              acc -= amount;\n            }\n            return acc;\n          }, 0),\n      };\n    });\n\n    // Filter out any months with NaN values\n    return amountByMonth.filter(\n      (month) =>\n        !isNaN(month.won) && !isNaN(month.pending) && !isNaN(month.lost),\n    );\n  }, [data]);\n\n  if (isPending) return null; // FIXME return skeleton instead\n  if (months.length === 0) return null; // No data to display\n\n  const range = months.reduce(\n    (acc, month) => {\n      acc.min = Math.min(acc.min, month.lost);\n      acc.max = Math.max(acc.max, month.won + month.pending);\n      return acc;\n    },\n    { min: 0, max: 0 },\n  );\n\n  // Ensure we have a valid range for the chart\n  const chartRange = {\n    min: range.min === 0 && range.max === 0 ? -100 : range.min * 1.2,\n    max: range.min === 0 && range.max === 0 ? 100 : range.max * 1.2,\n  };\n\n  return (\n    <div className=\"flex flex-col\">\n      <div className=\"flex items-center mb-4\">\n        <div className=\"mr-3 flex\">\n          <DollarSign className=\"text-muted-foreground w-6 h-6\" />\n        </div>\n        <h2 className=\"text-xl font-semibold text-muted-foreground\">\n          Upcoming Deal Revenue\n        </h2>\n      </div>\n      <div className=\"h-[400px]\">\n        <ResponsiveBar\n          data={months}\n          indexBy=\"date\"\n          keys={[\"won\", \"pending\", \"lost\"]}\n          colors={[\"#61cdbb\", \"#97e3d5\", \"#e25c3b\"]}\n          margin={{ top: 30, right: 50, bottom: 30, left: 0 }}\n          padding={0.3}\n          valueScale={{\n            type: \"linear\",\n            min: chartRange.min,\n            max: chartRange.max,\n          }}\n          indexScale={{ type: \"band\", round: true }}\n          enableGridX={true}\n          enableGridY={false}\n          enableLabel={false}\n          tooltip={({ value, indexValue }) => (\n            <div className=\"p-2 bg-secondary rounded shadow inline-flex items-center gap-1 text-secondary-foreground\">\n              <strong>{indexValue}: </strong>&nbsp;{value > 0 ? \"+\" : \"\"}\n              {value.toLocaleString(acceptedLanguages.at(0) ?? DEFAULT_LOCALE, {\n                style: \"currency\",\n                currency: CURRENCY,\n              })}\n            </div>\n          )}\n          axisTop={{\n            tickSize: 0,\n            tickPadding: 12,\n            style: {\n              ticks: {\n                text: {\n                  fill: \"var(--color-muted-foreground)\",\n                },\n              },\n              legend: {\n                text: {\n                  fill: \"var(--color-muted-foreground)\",\n                },\n              },\n            },\n          }}\n          axisBottom={{\n            legendPosition: \"middle\",\n            legendOffset: 50,\n            tickSize: 0,\n            tickPadding: 12,\n            style: {\n              ticks: {\n                text: {\n                  fill: \"var(--color-muted-foreground)\",\n                },\n              },\n              legend: {\n                text: {\n                  fill: \"var(--color-muted-foreground)\",\n                },\n              },\n            },\n          }}\n          axisLeft={null}\n          axisRight={{\n            format: (v: any) => `${Math.abs(v / 1000)}k`,\n            tickValues: 8,\n            style: {\n              ticks: {\n                text: {\n                  fill: \"var(--color-muted-foreground)\",\n                },\n              },\n              legend: {\n                text: {\n                  fill: \"var(--color-muted-foreground)\",\n                },\n              },\n            },\n          }}\n          markers={\n            [\n              {\n                axis: \"y\",\n                value: 0,\n                lineStyle: { strokeOpacity: 0 },\n                textStyle: { fill: \"#2ebca6\" },\n                legend: \"Won\",\n                legendPosition: \"top-left\",\n                legendOrientation: \"vertical\",\n              },\n              {\n                axis: \"y\",\n                value: 0,\n                lineStyle: {\n                  stroke: \"#f47560\",\n                  strokeWidth: 1,\n                },\n                textStyle: { fill: \"#e25c3b\" },\n                legend: \"Lost\",\n                legendPosition: \"bottom-left\",\n                legendOrientation: \"vertical\",\n              },\n            ] as any\n          }\n        />\n      </div>\n    </div>\n  );\n});\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/dashboard/DashboardStepper.tsx",
      "content": "import { CheckCircle, Circle } from \"lucide-react\";\nimport type { Identifier } from \"ra-core\";\nimport { Link } from \"react-router\";\nimport { CreateButton } from \"@/components/admin/create-button\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\n\nimport { ContactImportButton } from \"../contacts/ContactImportButton\";\nimport useAppBarHeight from \"../misc/useAppBarHeight\";\n\nexport const DashboardStepper = ({\n  step,\n  contactId,\n}: {\n  step: number;\n  contactId?: Identifier;\n}) => {\n  const appbarHeight = useAppBarHeight();\n  return (\n    <div\n      className=\"flex justify-center items-center\"\n      style={{\n        height: `calc(100dvh - ${appbarHeight}px)`,\n      }}\n    >\n      <Card className=\"w-full max-w-[600px]\">\n        <CardContent className=\"px-6\">\n          <div className=\"flex items-center justify-between mb-8\">\n            <h3 className=\"text-lg font-bold\">What's next?</h3>\n            <div className=\"w-[150px]\">\n              <Progress value={(step / 3) * 100} className=\"mb-2\" />\n              <div className=\"text-right text-sm\">{step}/3 done</div>\n            </div>\n          </div>\n          <div className=\"flex flex-col gap-12\">\n            <div className=\"flex gap-8 items-center\">\n              <CheckCircle className=\"text-green-600 w-5 h-5\" />\n              <h4 className=\"font-bold\">Install RealTimeX CRM</h4>\n            </div>\n            <div className=\"flex gap-8 items-start\">\n              {step > 1 ? (\n                <CheckCircle className=\"text-green-600 w-5 h-5 mt-1\" />\n              ) : (\n                <Circle className=\"text-muted-foreground w-5 h-5 mt-1\" />\n              )}\n\n              <div className=\"flex flex-col gap-4\">\n                <h4 className=\"font-bold\">Add your first contact</h4>\n\n                <div className=\"flex gap-8\">\n                  <CreateButton label=\"New Contact\" resource=\"contacts\" />\n                  <ContactImportButton />\n                </div>\n              </div>\n            </div>\n            <div className=\"flex gap-8 items-start\">\n              <Circle className=\"text-muted-foreground w-5 h-5 mt-1\" />\n              <div className=\"flex flex-col gap-4\">\n                <h4 className=\"font-bold\">Add your first note</h4>\n                <p>Go to a contact page and add a note</p>\n                <Button asChild disabled={step < 2} className=\"w-[100px]\">\n                  <Link to={`/contacts/${contactId}/show`}>Add note</Link>\n                </Button>\n              </div>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/dashboard/DashboardActivityLog.tsx",
      "content": "import { Clock } from \"lucide-react\";\nimport { Card } from \"@/components/ui/card\";\n\nimport { ActivityLog } from \"../activity/ActivityLog\";\n\nexport function DashboardActivityLog() {\n  return (\n    <div className=\"flex flex-col\">\n      <div className=\"flex items-center mb-2\">\n        <div className=\"mr-3 flex\">\n          <Clock className=\"text-muted-foreground w-6 h-6\" />\n        </div>\n        <h2 className=\"text-xl font-semibold text-muted-foreground\">\n          Latest Activity\n        </h2>\n      </div>\n      <Card className=\"mb-2 p-6\">\n        <ActivityLog pageSize={10} />\n      </Card>\n    </div>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/dashboard/Dashboard.tsx",
      "content": "import { useGetList } from \"ra-core\";\n\nimport type { Contact, ContactNote } from \"../types\";\nimport { DashboardActivityLog } from \"./DashboardActivityLog\";\nimport { DashboardStepper } from \"./DashboardStepper\";\nimport { DealsChart } from \"./DealsChart\";\nimport { HotContacts } from \"./HotContacts\";\nimport { TasksList } from \"./TasksList\";\nimport { Welcome } from \"./Welcome\";\n\nexport const Dashboard = () => {\n  const {\n    data: dataContact,\n    total: totalContact,\n    isPending: isPendingContact,\n  } = useGetList<Contact>(\"contacts\", {\n    pagination: { page: 1, perPage: 1 },\n  });\n\n  const { total: totalContactNotes, isPending: isPendingContactNotes } =\n    useGetList<ContactNote>(\"contactNotes\", {\n      pagination: { page: 1, perPage: 1 },\n    });\n\n  const { total: totalDeal, isPending: isPendingDeal } = useGetList<Contact>(\n    \"deals\",\n    {\n      pagination: { page: 1, perPage: 1 },\n    },\n  );\n\n  const isPending = isPendingContact || isPendingContactNotes || isPendingDeal;\n\n  if (isPending) {\n    return null;\n  }\n\n  if (!totalContact) {\n    return <DashboardStepper step={1} />;\n  }\n\n  if (!totalContactNotes) {\n    return <DashboardStepper step={2} contactId={dataContact?.[0]?.id} />;\n  }\n\n  return (\n    <div className=\"grid grid-cols-1 md:grid-cols-12 gap-6 mt-1\">\n      <div className=\"md:col-span-3\">\n        <div className=\"flex flex-col gap-4\">\n          {import.meta.env.VITE_IS_DEMO === \"true\" ? <Welcome /> : null}\n          <HotContacts />\n        </div>\n      </div>\n      <div className=\"md:col-span-6\">\n        <div className=\"flex flex-col gap-6\">\n          {totalDeal ? <DealsChart /> : null}\n          <DashboardActivityLog />\n        </div>\n      </div>\n\n      <div className=\"md:col-span-3\">\n        <TasksList />\n      </div>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/useContactImport.tsx",
      "content": "import { useDataProvider, useGetIdentity, type DataProvider } from \"ra-core\";\nimport { useCallback, useMemo } from \"react\";\n\nimport type { Company, Tag } from \"../types\";\n\nexport type ContactImportSchema = {\n  first_name: string;\n  last_name: string;\n  gender: string;\n  title: string;\n  company: string;\n  email_work: string;\n  email_home: string;\n  email_other: string;\n  phone_work: string;\n  phone_home: string;\n  phone_other: string;\n  background: string;\n  avatar: string;\n  first_seen: string;\n  last_seen: string;\n  has_newsletter: string;\n  status: string;\n  tags: string;\n  linkedin_url: string;\n};\n\nexport function useContactImport() {\n  const today = new Date().toISOString();\n  const user = useGetIdentity();\n  const dataProvider = useDataProvider();\n\n  // company cache to avoid creating the same company multiple times and costly roundtrips\n  // Cache is dependent of dataProvider, so it's safe to use it as a dependency\n  const companiesCache = useMemo(\n    () => new Map<string, Company>(),\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n    [dataProvider],\n  );\n  const getCompanies = useCallback(\n    async (names: string[]) =>\n      fetchRecordsWithCache<Company>(\n        \"companies\",\n        companiesCache,\n        names,\n        (name) => ({\n          name,\n          created_at: new Date().toISOString(),\n          sales_id: user?.identity?.id,\n        }),\n        dataProvider,\n      ),\n    [companiesCache, user?.identity?.id, dataProvider],\n  );\n\n  // Tags cache to avoid creating the same tag multiple times and costly roundtrips\n  // Cache is dependent of dataProvider, so it's safe to use it as a dependency\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n  const tagsCache = useMemo(() => new Map<string, Tag>(), [dataProvider]);\n  const getTags = useCallback(\n    async (names: string[]) =>\n      fetchRecordsWithCache<Tag>(\n        \"tags\",\n        tagsCache,\n        names,\n        (name) => ({\n          name,\n          color: \"#f9f9f9\",\n        }),\n        dataProvider,\n      ),\n    [tagsCache, dataProvider],\n  );\n\n  const processBatch = useCallback(\n    async (batch: ContactImportSchema[]) => {\n      const [companies, tags] = await Promise.all([\n        getCompanies(\n          batch\n            .map((contact) => contact.company?.trim())\n            .filter((name) => name),\n        ),\n        getTags(batch.flatMap((batch) => parseTags(batch.tags))),\n      ]);\n\n      await Promise.all(\n        batch.map(\n          async ({\n            first_name,\n            last_name,\n            gender,\n            title,\n            email_work,\n            email_home,\n            email_other,\n            phone_work,\n            phone_home,\n            phone_other,\n            background,\n            first_seen,\n            last_seen,\n            has_newsletter,\n            status,\n            company: companyName,\n            tags: tagNames,\n            linkedin_url,\n          }) => {\n            const email_jsonb = [\n              { email: email_work, type: \"Work\" },\n              { email: email_home, type: \"Home\" },\n              { email: email_other, type: \"Other\" },\n            ].filter(({ email }) => email);\n            const phone_jsonb = [\n              { number: phone_work, type: \"Work\" },\n              { number: phone_home, type: \"Home\" },\n              { number: phone_other, type: \"Other\" },\n            ].filter(({ number }) => number);\n            const company = companyName?.trim()\n              ? companies.get(companyName.trim())\n              : undefined;\n            const tagList = parseTags(tagNames)\n              .map((name) => tags.get(name))\n              .filter((tag): tag is Tag => !!tag);\n\n            return dataProvider.create(\"contacts\", {\n              data: {\n                first_name,\n                last_name,\n                gender,\n                title,\n                email_jsonb,\n                phone_jsonb,\n                background,\n                first_seen: first_seen\n                  ? new Date(first_seen).toISOString()\n                  : today,\n                last_seen: last_seen\n                  ? new Date(last_seen).toISOString()\n                  : today,\n                has_newsletter,\n                status,\n                company_id: company?.id,\n                tags: tagList.map((tag) => tag.id),\n                sales_id: user?.identity?.id,\n                linkedin_url,\n              },\n            });\n          },\n        ),\n      );\n    },\n    [dataProvider, getCompanies, getTags, user?.identity?.id, today],\n  );\n\n  return processBatch;\n}\n\nconst fetchRecordsWithCache = async function <T>(\n  resource: string,\n  cache: Map<string, T>,\n  names: string[],\n  getCreateData: (name: string) => Partial<T>,\n  dataProvider: DataProvider,\n) {\n  const trimmedNames = [...new Set(names.map((name) => name.trim()))];\n  const uncachedRecordNames = trimmedNames.filter((name) => !cache.has(name));\n\n  // check the backend for existing records\n  if (uncachedRecordNames.length > 0) {\n    const response = await dataProvider.getList(resource, {\n      filter: {\n        \"name@in\": `(${uncachedRecordNames\n          .map((name) => `\"${name}\"`)\n          .join(\",\")})`,\n      },\n      pagination: { page: 1, perPage: trimmedNames.length },\n      sort: { field: \"id\", order: \"ASC\" },\n    });\n    for (const record of response.data) {\n      cache.set(record.name.trim(), record);\n    }\n  }\n\n  // create missing records in parallel\n  await Promise.all(\n    uncachedRecordNames.map(async (name) => {\n      if (cache.has(name)) return;\n      const response = await dataProvider.create(resource, {\n        data: getCreateData(name),\n      });\n      cache.set(name, response.data);\n    }),\n  );\n\n  // now all records are in cache, return a map of all records\n  return trimmedNames.reduce((acc, name) => {\n    acc.set(name, cache.get(name) as T);\n    return acc;\n  }, new Map<string, T>());\n};\n\nconst parseTags = (tags: string) =>\n  tags\n    ?.split(\",\")\n    ?.map((tag: string) => tag.trim())\n    ?.filter((tag: string) => tag) ?? [];\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/index.tsx",
      "content": "import type { Contact } from \"../types\";\nimport { ContactCreate } from \"./ContactCreate\";\nimport { ContactEdit } from \"./ContactEdit\";\nimport { ContactList } from \"./ContactList\";\nimport { ContactShow } from \"./ContactShow\";\n\nexport default {\n  list: ContactList,\n  show: ContactShow,\n  edit: ContactEdit,\n  create: ContactCreate,\n  recordRepresentation: (record: Contact) =>\n    record?.first_name + \" \" + record?.last_name,\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/exportToVCard.ts",
      "content": "import type { Contact, Company } from \"../types\";\n\n/**\n * Folds a long line according to vCard specification (max 75 chars per line)\n * Continuation lines start with a space\n */\nfunction foldLine(line: string): string {\n  const maxLength = 75;\n  if (line.length <= maxLength) return line;\n\n  const result: string[] = [];\n  let currentLine = line.substring(0, maxLength);\n  let remaining = line.substring(maxLength);\n\n  result.push(currentLine);\n\n  while (remaining.length > 0) {\n    // Continuation lines start with a space and can have 74 more chars\n    const chunkSize = maxLength - 1;\n    currentLine = \" \" + remaining.substring(0, chunkSize);\n    remaining = remaining.substring(chunkSize);\n    result.push(currentLine);\n  }\n\n  return result.join(\"\\r\\n\");\n}\n\n/**\n * Converts a contact and their company to vCard 3.0 format\n */\nexport function exportToVCard(\n  contact: Contact,\n  company?: Company,\n  photoData?: { base64: string; mimeType: string },\n): string {\n  const lines: string[] = [];\n\n  // vCard header\n  lines.push(\"BEGIN:VCARD\");\n  lines.push(\"VERSION:3.0\");\n\n  // Name (N: Family Name;Given Name;Additional Names;Honorific Prefixes;Honorific Suffixes)\n  lines.push(`N:${contact.last_name};${contact.first_name};;;`);\n\n  // Formatted name\n  lines.push(`FN:${contact.first_name} ${contact.last_name}`);\n\n  // Title/Job position\n  if (contact.title) {\n    lines.push(`TITLE:${contact.title}`);\n  }\n\n  // Organization\n  if (company?.name) {\n    lines.push(`ORG:${company.name}`);\n  }\n\n  // Emails\n  if (contact.email_jsonb && contact.email_jsonb.length > 0) {\n    contact.email_jsonb.forEach((emailObj) => {\n      const type = emailObj.type.toUpperCase();\n      lines.push(`EMAIL;TYPE=${type}:${emailObj.email}`);\n    });\n  }\n\n  // Phone numbers\n  if (contact.phone_jsonb && contact.phone_jsonb.length > 0) {\n    contact.phone_jsonb.forEach((phoneObj) => {\n      const type = phoneObj.type.toUpperCase();\n      lines.push(`TEL;TYPE=${type}:${phoneObj.number}`);\n    });\n  }\n\n  // LinkedIn URL\n  if (contact.linkedin_url) {\n    lines.push(`URL:${contact.linkedin_url}`);\n  }\n\n  // Background/Note\n  if (contact.background) {\n    // Escape newlines and special characters in notes\n    const escapedNote = contact.background\n      .replace(/\\\\/g, \"\\\\\\\\\")\n      .replace(/\\n/g, \"\\\\n\")\n      .replace(/,/g, \"\\\\,\")\n      .replace(/;/g, \"\\\\;\");\n    lines.push(`NOTE:${escapedNote}`);\n  }\n\n  // Photo/Avatar - vCard 3.0 format with base64 encoding\n  if (photoData) {\n    // Extract image type from MIME type (e.g., \"image/png\" -> \"PNG\")\n    const imageType = photoData.mimeType.split(\"/\")[1]?.toUpperCase() || \"PNG\";\n\n    // vCard 3.0 format: PHOTO;ENCODING=b;TYPE=PNG:\n    const photoLine = `PHOTO;ENCODING=b;TYPE=${imageType}:${photoData.base64}`;\n    lines.push(foldLine(photoLine));\n  }\n\n  // vCard footer\n  lines.push(\"END:VCARD\");\n\n  return lines.join(\"\\r\\n\");\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/TagsListEdit.tsx",
      "content": "import { Edit, Plus } from \"lucide-react\";\nimport {\n  useGetList,\n  useGetMany,\n  useRecordContext,\n  useUpdate,\n  type Identifier,\n} from \"ra-core\";\nimport { useCallback, useState } from \"react\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\n\nimport { TagChip } from \"../tags/TagChip\";\nimport { TagCreateModal } from \"../tags/TagCreateModal\";\nimport type { Contact, Tag } from \"../types\";\n\nexport const TagsListEdit = () => {\n  const record = useRecordContext<Contact>();\n  const [open, setOpen] = useState(false);\n\n  const { data: allTags, isPending: isPendingAllTags } = useGetList<Tag>(\n    \"tags\",\n    {\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"name\", order: \"ASC\" },\n    },\n  );\n  const { data: tags, isPending: isPendingRecordTags } = useGetMany<Tag>(\n    \"tags\",\n    { ids: record?.tags },\n    { enabled: record && record.tags && record.tags.length > 0 },\n  );\n  const [update] = useUpdate<Contact>();\n\n  const unselectedTags =\n    allTags && record && allTags.filter((tag) => !(record.tags ?? []).includes(tag.id));\n\n  const handleTagAdd = (id: Identifier) => {\n    if (!record) {\n      throw new Error(\"No contact record found\");\n    }\n    const tags = [...(record.tags ?? []), id];\n    update(\"contacts\", {\n      id: record.id,\n      data: { tags },\n      previousData: record,\n    });\n  };\n\n  const handleTagDelete = async (id: Identifier) => {\n    if (!record) {\n      throw new Error(\"No contact record found\");\n    }\n    const tags = (record.tags ?? []).filter((tagId) => tagId !== id);\n    await update(\"contacts\", {\n      id: record.id,\n      data: { tags },\n      previousData: record,\n    });\n  };\n\n  const openTagCreateDialog = () => {\n    setOpen(true);\n  };\n\n  const handleTagCreateClose = () => {\n    setOpen(false);\n  };\n\n  const handleTagCreated = useCallback(\n    async (tag: Tag) => {\n      if (!record) {\n        throw new Error(\"No contact record found\");\n      }\n\n      await update(\n        \"contacts\",\n        {\n          id: record.id,\n          data: { tags: [...(record.tags ?? []), tag.id] },\n          previousData: record,\n        },\n        {\n          onSuccess: () => {\n            setOpen(false);\n          },\n        },\n      );\n    },\n    [update, record],\n  );\n\n  if (isPendingRecordTags || isPendingAllTags) return null;\n\n  return (\n    <div className=\"flex flex-wrap gap-2\">\n      {tags?.map((tag) => (\n        <div key={tag.id}>\n          <TagChip tag={tag} onUnlink={() => handleTagDelete(tag.id)} />\n        </div>\n      ))}\n\n      <div>\n        <DropdownMenu>\n          <DropdownMenuTrigger asChild>\n            <Button variant=\"outline\" size=\"sm\" className=\"h-6 cursor-pointer\">\n              <Plus className=\"h-3 w-3 mr-1\" />\n              Add tag\n            </Button>\n          </DropdownMenuTrigger>\n          <DropdownMenuContent>\n            {unselectedTags?.map((tag) => (\n              <DropdownMenuItem\n                key={tag.id}\n                onClick={() => handleTagAdd(tag.id)}\n              >\n                <Badge\n                  variant=\"secondary\"\n                  className=\"text-xs font-normal text-black\"\n                  style={{\n                    backgroundColor: tag.color,\n                  }}\n                >\n                  {tag.name}\n                </Badge>\n              </DropdownMenuItem>\n            ))}\n            <DropdownMenuItem onClick={openTagCreateDialog}>\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                className=\"w-full justify-start p-0 cursor-pointer\"\n              >\n                <Edit className=\"h-3 w-3 mr-2\" />\n                Create new tag\n              </Button>\n            </DropdownMenuItem>\n          </DropdownMenuContent>\n        </DropdownMenu>\n      </div>\n\n      <TagCreateModal\n        open={open}\n        onClose={handleTagCreateClose}\n        onSuccess={handleTagCreated}\n      />\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/TagsList.tsx",
      "content": "import { useRecordContext } from \"ra-core\";\nimport { ReferenceArrayField } from \"@/components/admin/reference-array-field\";\nimport { SingleFieldList } from \"@/components/admin/single-field-list\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { cn } from \"@/lib/utils\";\n\nconst ColoredBadge = (props: any) => {\n  const record = useRecordContext();\n  if (!record) return null;\n  return (\n    <Badge\n      {...props}\n      style={{ backgroundColor: record.color, border: 0 }}\n      variant=\"outline\"\n      className={cn(\"text-black font-normal\", props.className)}\n    >\n      {record.name}\n    </Badge>\n  );\n};\n\nexport const TagsList = () => (\n  <ReferenceArrayField\n    className=\"inline-block\"\n    resource=\"contacts\"\n    source=\"tags\"\n    reference=\"tags\"\n  >\n    <SingleFieldList>\n      <ColoredBadge source=\"name\" />\n    </SingleFieldList>\n  </ReferenceArrayField>\n);\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/ExportVCardButton.tsx",
      "content": "import { Download } from \"lucide-react\";\nimport { useGetOne, useRecordContext } from \"ra-core\";\nimport { Button } from \"@/components/ui/button\";\nimport type { Contact, Company } from \"../types\";\nimport { exportToVCard } from \"./exportToVCard\";\n\nexport const ExportVCardButton = () => {\n  const contact = useRecordContext<Contact>();\n\n  // Fetch the company data on mount\n  const { data: company } = useGetOne<Company>(\n    \"companies\",\n    { id: contact?.company_id },\n    { enabled: !!contact?.company_id },\n  );\n\n  const handleExport = async () => {\n    if (!contact) return;\n\n    // Fetch and convert avatar to base64 if it exists\n    let photoData: { base64: string; mimeType: string } | undefined = undefined;\n\n    if (contact.avatar?.src) {\n      try {\n        const response = await fetch(contact.avatar.src);\n        const blob = await response.blob();\n        const mimeType = blob.type || \"image/png\";\n\n        // Convert blob to base64\n        const base64 = await new Promise<string>((resolve, reject) => {\n          const reader = new FileReader();\n          reader.onloadend = () => {\n            const result = reader.result as string;\n            // Remove the data URL prefix (data:image/png;base64,)\n            const base64Data = result.split(\",\")[1];\n            resolve(base64Data);\n          };\n          reader.onerror = reject;\n          reader.readAsDataURL(blob);\n        });\n\n        photoData = { base64, mimeType };\n      } catch (error) {\n        console.error(\"Failed to fetch avatar image:\", error);\n        // Continue without the photo\n      }\n    }\n\n    // Generate vCard content\n    const vCardContent = exportToVCard(contact, company, photoData);\n\n    // Create blob and download\n    const blob = new Blob([vCardContent], {\n      type: \"text/vcard;charset=utf-8\",\n    });\n    const url = URL.createObjectURL(blob);\n    const link = document.createElement(\"a\");\n    link.href = url;\n    link.download = `${contact.first_name}_${contact.last_name}.vcf`;\n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n    URL.revokeObjectURL(url);\n  };\n\n  if (!contact) return null;\n\n  return (\n    <Button\n      variant=\"outline\"\n      size=\"sm\"\n      onClick={handleExport}\n      className=\"h-6 cursor-pointer\"\n    >\n      <Download className=\"w-4 h-4\" />\n      Export to vCard\n    </Button>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/ContactShow.tsx",
      "content": "import { ShowBase, useShowContext } from \"ra-core\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { ReferenceManyField } from \"@/components/admin/reference-many-field\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { Card, CardContent } from \"@/components/ui/card\";\n\nimport { CompanyAvatar } from \"../companies/CompanyAvatar\";\nimport { NoteCreate, NotesIterator } from \"../notes\";\nimport type { Contact } from \"../types\";\nimport { Avatar } from \"./Avatar\";\nimport { ContactAside } from \"./ContactAside\";\nimport { ActivityFeed } from \"../activities/ActivityFeed\";\n\nexport const ContactShow = () => (\n  <ShowBase>\n    <ContactShowContent />\n  </ShowBase>\n);\n\nconst ContactShowContent = () => {\n  const { record, isPending } = useShowContext<Contact>();\n  if (isPending || !record) return null;\n\n  return (\n    <div className=\"mt-2 mb-2 flex gap-8\">\n      <div className=\"flex-1\">\n        <Card>\n          <CardContent>\n            <div className=\"flex\">\n              <Avatar />\n              <div className=\"ml-2 flex-1\">\n                <h5 className=\"text-xl font-semibold\">\n                  {record.first_name} {record.last_name}\n                </h5>\n                <div className=\"inline-flex text-sm text-muted-foreground\">\n                  {record.title}\n                  {record.title && record.company_id != null && \" at \"}\n                  {record.company_id != null && (\n                    <ReferenceField\n                      source=\"company_id\"\n                      reference=\"companies\"\n                      link=\"show\"\n                    >\n                      &nbsp;\n                      <TextField source=\"name\" />\n                    </ReferenceField>\n                  )}\n                </div>\n              </div>\n              <div>\n                <ReferenceField\n                  source=\"company_id\"\n                  reference=\"companies\"\n                  link=\"show\"\n                  className=\"no-underline\"\n                >\n                  <CompanyAvatar />\n                </ReferenceField>\n              </div>\n            </div>\n\n            {/* Activity Timeline - Shows processing status (temporary) */}\n            <div className=\"mt-6\">\n                <h3 className=\"text-lg font-semibold mb-4\">Activity Timeline</h3>\n                <p className=\"text-sm text-muted-foreground mb-3\">\n                  Real-time processing status of incoming activities\n                </p>\n                <ActivityFeed contactId={record.id as number} />\n            </div>\n\n            {/* Notes - Permanent record of outcomes */}\n            <div className=\"mt-8\">\n                <h3 className=\"text-lg font-semibold mb-4\">Notes</h3>\n                <p className=\"text-sm text-muted-foreground mb-3\">\n                  Permanent record of interactions and outcomes\n                </p>\n                <ReferenceManyField\n                  target=\"contact_id\"\n                  reference=\"contactNotes\"\n                  sort={{ field: \"date\", order: \"DESC\" }}\n                  empty={\n                    <NoteCreate reference=\"contacts\" showStatus className=\"mt-4\" />\n                  }\n                >\n                  <NotesIterator reference=\"contacts\" showStatus />\n                </ReferenceManyField>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n      <ContactAside />\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/ContactMergeButton.tsx",
      "content": "import { useState, useEffect } from \"react\";\nimport { Merge, CircleX, AlertTriangle, ArrowDown } from \"lucide-react\";\nimport {\n  useDataProvider,\n  useRecordContext,\n  useGetList,\n  useGetManyReference,\n  required,\n  Form,\n  useNotify,\n  useRedirect,\n} from \"ra-core\";\nimport type { Identifier } from \"ra-core\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogDescription,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { ReferenceInput } from \"@/components/admin/reference-input\";\nimport { AutocompleteInput } from \"@/components/admin/autocomplete-input\";\nimport { Alert, AlertDescription, AlertTitle } from \"@/components/ui/alert\";\nimport type { Contact } from \"../types\";\nimport { contactOptionText } from \"../misc/ContactOption\";\n\nexport const ContactMergeButton = () => {\n  const [mergeDialogOpen, setMergeDialogOpen] = useState(false);\n  return (\n    <>\n      <Button\n        variant=\"outline\"\n        className=\"h-6 cursor-pointer\"\n        size=\"sm\"\n        onClick={() => setMergeDialogOpen(true)}\n      >\n        <Merge className=\"w-4 h-4\" />\n        Merge with another contact\n      </Button>\n      <ContactMergeDialog\n        open={mergeDialogOpen}\n        onClose={() => setMergeDialogOpen(false)}\n      />\n    </>\n  );\n};\n\ninterface ContactMergeDialogProps {\n  open: boolean;\n  onClose: () => void;\n}\n\nconst ContactMergeDialog = ({ open, onClose }: ContactMergeDialogProps) => {\n  const loserContact = useRecordContext<Contact>();\n  const notify = useNotify();\n  const redirect = useRedirect();\n  const dataProvider = useDataProvider();\n  const [winnerId, setWinnerId] = useState<Identifier | null>(null);\n  const [suggestedWinnerId, setSuggestedWinnerId] = useState<Identifier | null>(\n    null,\n  );\n  const [isMerging, setIsMerging] = useState(false);\n  const { mutateAsync } = useMutation({\n    mutationKey: [\"contacts\", \"merge\", { loserId: loserContact?.id, winnerId }],\n    mutationFn: async () => {\n      return dataProvider.mergeContacts(loserContact?.id, winnerId);\n    },\n  });\n\n  // Find potential contacts with matching first and last name\n  const { data: matchingContacts } = useGetList(\n    \"contacts\",\n    {\n      filter: {\n        first_name: loserContact?.first_name,\n        last_name: loserContact?.last_name,\n        \"id@neq\": `${loserContact?.id}`, // Exclude current contact\n      },\n      pagination: { page: 1, perPage: 10 },\n    },\n    { enabled: open && !!loserContact },\n  );\n\n  // Get counts of items to be merged\n  const canFetchCounts = open && !!loserContact && !!winnerId;\n  const { total: tasksCount } = useGetManyReference(\n    \"tasks\",\n    {\n      target: \"contact_id\",\n      id: loserContact?.id,\n      pagination: { page: 1, perPage: 1 },\n    },\n    { enabled: canFetchCounts },\n  );\n\n  const { total: notesCount } = useGetManyReference(\n    \"contactNotes\",\n    {\n      target: \"contact_id\",\n      id: loserContact?.id,\n      pagination: { page: 1, perPage: 1 },\n    },\n    { enabled: canFetchCounts },\n  );\n\n  const { total: dealsCount } = useGetList(\n    \"deals\",\n    {\n      filter: { \"contact_ids@cs\": `{${loserContact?.id}}` },\n      pagination: { page: 1, perPage: 1 },\n    },\n    { enabled: canFetchCounts },\n  );\n\n  useEffect(() => {\n    if (matchingContacts && matchingContacts.length > 0) {\n      const suggestedWinnerId = matchingContacts[0].id;\n      setSuggestedWinnerId(suggestedWinnerId);\n      setWinnerId(suggestedWinnerId);\n    }\n  }, [matchingContacts]);\n\n  const handleMerge = async () => {\n    if (!winnerId || !loserContact) {\n      notify(\"Please select a contact to merge with\", { type: \"warning\" });\n      return;\n    }\n\n    try {\n      setIsMerging(true);\n      await mutateAsync();\n      setIsMerging(false);\n      notify(\"Contacts merged successfully\", { type: \"success\" });\n      redirect(`/contacts/${winnerId}/show`);\n      onClose();\n    } catch (error) {\n      setIsMerging(false);\n      notify(\"Failed to merge contacts\", { type: \"error\" });\n      console.error(\"Merge failed:\", error);\n    }\n  };\n\n  if (!loserContact) return null;\n\n  return (\n    <Dialog open={open} onOpenChange={onClose}>\n      <DialogContent className=\"md:min-w-lg max-w-2xl\">\n        <DialogHeader>\n          <DialogTitle>Merge Contact</DialogTitle>\n          <DialogDescription>\n            Merge this contact with another one.\n          </DialogDescription>\n        </DialogHeader>\n\n        <div className=\"space-y-4\">\n          <div className=\"p-4 bg-primary/5 rounded-lg border border-primary/20\">\n            <p className=\"font-medium text-sm\">\n              Current Contact (will be deleted)\n            </p>\n            <div className=\"font-medium text-sm mt-4\">{contactOptionText}</div>\n\n            <div className=\"flex justify-center my-4\">\n              <ArrowDown className=\"h-5 w-5 text-muted-foreground\" />\n            </div>\n\n            <p className=\"font-medium text-sm mb-2\">\n              Target Contact (will be kept)\n            </p>\n            <Form>\n              <ReferenceInput\n                source=\"winner_id\"\n                reference=\"contacts\"\n                filter={{ \"id@neq\": loserContact.id }}\n              >\n                <AutocompleteInput\n                  label=\"\"\n                  optionText={contactOptionText}\n                  validate={required()}\n                  onChange={setWinnerId}\n                  defaultValue={suggestedWinnerId}\n                  helperText={false}\n                />\n              </ReferenceInput>\n            </Form>\n          </div>\n\n          {winnerId && (\n            <>\n              <div className=\"space-y-2\">\n                <p className=\"font-medium text-sm\">What will be merged:</p>\n                <ul className=\"text-sm text-muted-foreground space-y-1 ml-4\">\n                  {notesCount != null && notesCount > 0 && (\n                    <li>\n                       {notesCount} note\n                      {notesCount !== 1 ? \"s\" : \"\"} will be reassigned\n                    </li>\n                  )}\n                  {tasksCount != null && tasksCount > 0 && (\n                    <li>\n                       {tasksCount} task\n                      {tasksCount !== 1 ? \"s\" : \"\"} will be reassigned\n                    </li>\n                  )}\n                  {dealsCount != null && dealsCount > 0 && (\n                    <li>\n                       {dealsCount} deal\n                      {dealsCount !== 1 ? \"s\" : \"\"} will be updated\n                    </li>\n                  )}\n                  {loserContact.email_jsonb?.length > 0 && (\n                    <li>\n                       {loserContact.email_jsonb.length} email address\n                      {loserContact.email_jsonb.length !== 1 ? \"es\" : \"\"} will\n                      be added\n                    </li>\n                  )}\n                  {loserContact.phone_jsonb?.length > 0 && (\n                    <li>\n                       {loserContact.phone_jsonb.length} phone number\n                      {loserContact.phone_jsonb.length !== 1 ? \"s\" : \"\"} will be\n                      added\n                    </li>\n                  )}\n                  {!notesCount &&\n                    !tasksCount &&\n                    !dealsCount &&\n                    !loserContact.email_jsonb?.length &&\n                    !loserContact.phone_jsonb?.length && (\n                      <li className=\"text-muted-foreground/60\">\n                        No additional data to merge\n                      </li>\n                    )}\n                </ul>\n              </div>\n              <Alert variant=\"destructive\">\n                <AlertTriangle className=\"h-4 w-4\" />\n                <AlertTitle>Warning: Destructive Operation</AlertTitle>\n                <AlertDescription>\n                  All data will be transferred to the second contact. This\n                  action cannot be undone.\n                </AlertDescription>\n              </Alert>\n            </>\n          )}\n        </div>\n\n        <DialogFooter>\n          <Button variant=\"ghost\" onClick={onClose} disabled={isMerging}>\n            <CircleX />\n            Cancel\n          </Button>\n          <Button onClick={handleMerge} disabled={!winnerId || isMerging}>\n            <Merge />\n            {isMerging ? \"Merging...\" : \"Merge Contacts\"}\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/ContactListFilter.tsx",
      "content": "import { endOfYesterday, startOfMonth, startOfWeek, subMonths } from \"date-fns\";\nimport { Activity, CheckSquare, Clock, HeartPulse, Tag, TrendingUp, Users } from \"lucide-react\";\nimport { FilterLiveForm, useGetIdentity, useGetList } from \"ra-core\";\nimport { ToggleFilterButton } from \"@/components/admin/toggle-filter-button\";\nimport { SearchInput } from \"@/components/admin/search-input\";\nimport { Badge } from \"@/components/ui/badge\";\n\nimport { FilterCategory } from \"../filters/FilterCategory\";\nimport { Status } from \"../misc/Status\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\n\nexport const ContactListFilter = () => {\n  const { noteStatuses } = useConfigurationContext();\n  const { identity } = useGetIdentity();\n  const { data } = useGetList(\"tags\", {\n    pagination: { page: 1, perPage: 10 },\n    sort: { field: \"name\", order: \"ASC\" },\n  });\n\n  return (\n    <div className=\"w-52 min-w-52 order-first pt-0.75 flex flex-col gap-4\">\n      <FilterLiveForm>\n        <SearchInput source=\"q\" placeholder=\"Search name, company...\" />\n      </FilterLiveForm>\n\n      <FilterCategory label=\"Last activity\" icon={<Clock />}>\n        <ToggleFilterButton\n          className=\"w-full justify-between\"\n          label=\"Today\"\n          value={{\n            \"last_seen@gte\": endOfYesterday().toISOString(),\n            \"last_seen@lte\": undefined,\n          }}\n        />\n        <ToggleFilterButton\n          className=\"w-full justify-between\"\n          label=\"This week\"\n          value={{\n            \"last_seen@gte\": startOfWeek(new Date()).toISOString(),\n            \"last_seen@lte\": undefined,\n          }}\n        />\n        <ToggleFilterButton\n          className=\"w-full justify-between\"\n          label=\"Before this week\"\n          value={{\n            \"last_seen@gte\": undefined,\n            \"last_seen@lte\": startOfWeek(new Date()).toISOString(),\n          }}\n        />\n        <ToggleFilterButton\n          className=\"w-full justify-between\"\n          label=\"Before this month\"\n          value={{\n            \"last_seen@gte\": undefined,\n            \"last_seen@lte\": startOfMonth(new Date()).toISOString(),\n          }}\n        />\n        <ToggleFilterButton\n          className=\"w-full justify-between\"\n          label=\"Before last month\"\n          value={{\n            \"last_seen@gte\": undefined,\n            \"last_seen@lte\": subMonths(\n              startOfMonth(new Date()),\n              1,\n            ).toISOString(),\n          }}\n        />\n      </FilterCategory>\n\n      <FilterCategory label=\"Engagement\" icon={<Activity />}>\n        <ToggleFilterButton\n          className=\"w-full justify-between\"\n          label=\"Strong\"\n          value={{ internal_heartbeat_status: \"strong\" }}\n        />\n        <ToggleFilterButton\n          className=\"w-full justify-between\"\n          label=\"Active\"\n          value={{ internal_heartbeat_status: \"active\" }}\n        />\n        <ToggleFilterButton\n          className=\"w-full justify-between\"\n          label=\"Cooling\"\n          value={{ internal_heartbeat_status: \"cooling\" }}\n        />\n        <ToggleFilterButton\n          className=\"w-full justify-between\"\n          label=\"Cold\"\n          value={{ internal_heartbeat_status: \"cold\" }}\n        />\n        <ToggleFilterButton\n          className=\"w-full justify-between\"\n          label=\"Dormant\"\n          value={{ internal_heartbeat_status: \"dormant\" }}\n        />\n      </FilterCategory>\n\n      <FilterCategory label=\"Validation\" icon={<HeartPulse />}>\n        <ToggleFilterButton\n          className=\"w-full justify-between\"\n          label=\"Valid Email\"\n          value={{ email_validation_status: \"valid\" }}\n        />\n        <ToggleFilterButton\n          className=\"w-full justify-between\"\n          label=\"Risky Email\"\n          value={{ email_validation_status: \"risky\" }}\n        />\n        <ToggleFilterButton\n          className=\"w-full justify-between\"\n          label=\"Invalid Email\"\n          value={{ email_validation_status: \"invalid\" }}\n        />\n      </FilterCategory>\n\n      <FilterCategory label=\"Status\" icon={<TrendingUp />}>\n        {noteStatuses.map((status) => (\n          <ToggleFilterButton\n            key={status.value}\n            className=\"w-full justify-between\"\n            label={\n              <span>\n                {status.label} <Status status={status.value} />\n              </span>\n            }\n            value={{ status: status.value }}\n          />\n        ))}\n      </FilterCategory>\n\n      <FilterCategory label=\"Tags\" icon={<Tag />}>\n        {data &&\n          data.map((record) => (\n            <ToggleFilterButton\n              className=\"w-full justify-between\"\n              key={record.id}\n              label={\n                <Badge\n                  variant=\"secondary\"\n                  className=\"text-black text-xs font-normal cursor-pointer\"\n                  style={{\n                    backgroundColor: record?.color,\n                  }}\n                >\n                  {record?.name}\n                </Badge>\n              }\n              value={{ \"tags@cs\": `{${record.id}}` }}\n            />\n          ))}\n      </FilterCategory>\n\n      <FilterCategory icon={<CheckSquare />} label=\"Tasks\">\n        <ToggleFilterButton\n          className=\"w-full justify-between\"\n          label={\"With pending tasks\"}\n          value={{ \"nb_tasks@gt\": 0 }}\n        />\n      </FilterCategory>\n\n      <FilterCategory icon={<Users />} label=\"Account Manager\">\n        <ToggleFilterButton\n          className=\"w-full justify-between\"\n          label={\"Me\"}\n          value={{ sales_id: identity?.id }}\n        />\n      </FilterCategory>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/ContactListContent.tsx",
      "content": "import { formatRelative } from \"date-fns\";\nimport { RecordContextProvider, useListContext } from \"ra-core\";\nimport { type MouseEvent, useCallback } from \"react\";\nimport { Link } from \"react-router\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { useIsMobile } from \"@/hooks/use-mobile\";\n\nimport { Status } from \"../misc/Status\";\nimport type { Contact } from \"../types\";\nimport { Avatar } from \"./Avatar\";\nimport { TagsList } from \"./TagsList\";\n\nexport const ContactListContent = () => {\n  const {\n    data: contacts,\n    error,\n    isPending,\n    onToggleItem,\n    selectedIds,\n  } = useListContext<Contact>();\n  const isSmall = useIsMobile();\n\n  // StopPropagation does not work for some reason on Checkbox, this handler is a workaround\n  const handleLinkClick = useCallback(function handleLinkClick(\n    e: MouseEvent<HTMLAnchorElement>,\n  ) {\n    if (e.target instanceof HTMLButtonElement) {\n      e.preventDefault();\n    }\n  }, []);\n\n  if (isPending) {\n    return <Skeleton className=\"w-full h-9\" />;\n  }\n\n  if (error) {\n    return null;\n  }\n  const now = Date.now();\n\n  return (\n    <div className=\"divide-y\">\n      {contacts.map((contact) => (\n        <RecordContextProvider key={contact.id} value={contact}>\n          <Link\n            to={`/contacts/${contact.id}/show`}\n            className=\"flex flex-row gap-4 items-center px-4 py-2 hover:bg-muted transition-colors first:rounded-t-xl last:rounded-b-xl\"\n            onClick={handleLinkClick}\n          >\n            <Checkbox\n              className=\"cursor-pointer\"\n              checked={selectedIds.includes(contact.id)}\n              onCheckedChange={() => onToggleItem(contact.id)}\n            />\n            <Avatar />\n            <div className=\"flex-1 min-w-0\">\n              <div className=\"font-medium\">\n                {`${contact.first_name} ${contact.last_name ?? \"\"}`}\n              </div>\n              <div className=\"text-sm text-muted-foreground\">\n                {contact.title}\n                {contact.title && contact.company_id != null && \" at \"}\n                {contact.company_id != null && (\n                  <ReferenceField\n                    source=\"company_id\"\n                    reference=\"companies\"\n                    link={false}\n                  >\n                    <TextField source=\"name\" />\n                  </ReferenceField>\n                )}\n                {contact.nb_tasks\n                  ? ` - ${contact.nb_tasks} task${\n                      contact.nb_tasks > 1 ? \"s\" : \"\"\n                    }`\n                  : \"\"}\n                &nbsp;&nbsp;\n                <TagsList />\n              </div>\n            </div>\n            {contact.last_seen && (\n              <div className=\"text-right ml-4\">\n                <div\n                  className=\"text-sm text-muted-foreground\"\n                  title={contact.last_seen}\n                >\n                  {!isSmall && \"last activity \"}\n                  {formatRelative(contact.last_seen, now)}{\" \"}\n                  <Status status={contact.status} />\n                </div>\n              </div>\n            )}\n          </Link>\n        </RecordContextProvider>\n      ))}\n\n      {contacts.length === 0 && (\n        <div className=\"p-4\">\n          <div className=\"text-muted-foreground\">No contacts found</div>\n        </div>\n      )}\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/ContactList.tsx",
      "content": "import jsonExport from \"jsonexport/dist\";\nimport {\n  downloadCSV,\n  useGetIdentity,\n  useListContext,\n  type Exporter,\n} from \"ra-core\";\nimport { BulkActionsToolbar } from \"@/components/admin/bulk-actions-toolbar\";\nimport { CreateButton } from \"@/components/admin/create-button\";\nimport { ExportButton } from \"@/components/admin/export-button\";\nimport { List } from \"@/components/admin/list\";\nimport { SortButton } from \"@/components/admin/sort-button\";\nimport { Card } from \"@/components/ui/card\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\n\nimport type { Company, Contact, Sale, Tag } from \"../types\";\nimport { ContactEmpty } from \"./ContactEmpty\";\nimport { ContactImportButton } from \"./ContactImportButton\";\nimport { ContactListContent } from \"./ContactListContent\";\nimport { ContactListFilter } from \"./ContactListFilter\";\nimport { TopToolbar } from \"../layout/TopToolbar\";\n\nexport const ContactList = () => {\n  return (\n    <List\n      title={false}\n      actions={<ContactListActions />}\n      perPage={25}\n      sort={{ field: \"last_seen\", order: \"DESC\" }}\n      exporter={exporter}\n    >\n      <ContactListLayout />\n    </List>\n  );\n};\n\nconst ContactListLayout = () => {\n  const { data, isPending, filterValues } = useListContext();\n  const { identity } = useGetIdentity();\n\n  const hasFilters = filterValues && Object.keys(filterValues).length > 0;\n\n  // Show loading skeleton while identity or data is loading\n  if (!identity || isPending) {\n    return (\n      <div className=\"flex flex-row gap-8\">\n        <div className=\"w-64\">\n          <Skeleton className=\"h-96 w-full\" />\n        </div>\n        <div className=\"w-full flex flex-col gap-4\">\n          <Card className=\"p-4\">\n            <div className=\"space-y-3\">\n              <Skeleton className=\"h-12 w-full\" />\n              <Skeleton className=\"h-12 w-full\" />\n              <Skeleton className=\"h-12 w-full\" />\n              <Skeleton className=\"h-12 w-full\" />\n              <Skeleton className=\"h-12 w-full\" />\n            </div>\n          </Card>\n        </div>\n      </div>\n    );\n  }\n\n  if (!data?.length && !hasFilters) return <ContactEmpty />;\n\n  return (\n    <div className=\"flex flex-row gap-8\">\n      <ContactListFilter />\n      <div className=\"w-full flex flex-col gap-4\">\n        <Card className=\"py-0\">\n          <ContactListContent />\n        </Card>\n      </div>\n      <BulkActionsToolbar />\n    </div>\n  );\n};\n\nconst ContactListActions = () => (\n  <TopToolbar>\n    <SortButton fields={[\"first_name\", \"last_name\", \"last_seen\"]} />\n    <ContactImportButton />\n    <ExportButton exporter={exporter} />\n    <CreateButton />\n  </TopToolbar>\n);\n\nconst exporter: Exporter<Contact> = async (records, fetchRelatedRecords) => {\n  const companies = await fetchRelatedRecords<Company>(\n    records,\n    \"company_id\",\n    \"companies\",\n  );\n  const sales = await fetchRelatedRecords<Sale>(records, \"sales_id\", \"sales\");\n  const tags = await fetchRelatedRecords<Tag>(records, \"tags\", \"tags\");\n\n  const contacts = records.map((contact) => {\n    const exportedContact = {\n      ...contact,\n      company:\n        contact.company_id != null\n          ? companies[contact.company_id].name\n          : undefined,\n      sales: `${sales[contact.sales_id].first_name} ${\n        sales[contact.sales_id].last_name\n      }`,\n      tags: contact.tags.map((tagId) => tags[tagId].name).join(\", \"),\n      email_work: contact.email_jsonb?.find((email) => email.type === \"Work\")\n        ?.email,\n      email_home: contact.email_jsonb?.find((email) => email.type === \"Home\")\n        ?.email,\n      email_other: contact.email_jsonb?.find((email) => email.type === \"Other\")\n        ?.email,\n      email_jsonb: JSON.stringify(contact.email_jsonb),\n      email_fts: undefined,\n      phone_work: contact.phone_jsonb?.find((phone) => phone.type === \"Work\")\n        ?.number,\n      phone_home: contact.phone_jsonb?.find((phone) => phone.type === \"Home\")\n        ?.number,\n      phone_other: contact.phone_jsonb?.find((phone) => phone.type === \"Other\")\n        ?.number,\n      phone_jsonb: JSON.stringify(contact.phone_jsonb),\n      phone_fts: undefined,\n    };\n    delete exportedContact.email_fts;\n    delete exportedContact.phone_fts;\n    return exportedContact;\n  });\n  return jsonExport(contacts, {}, (_err: any, csv: string) => {\n    downloadCSV(csv, \"contacts\");\n  });\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/ContactInputs.tsx",
      "content": "import { email, required } from \"ra-core\";\nimport type { FocusEvent, ClipboardEventHandler } from \"react\";\nimport { useFormContext } from \"react-hook-form\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { useIsMobile } from \"@/hooks/use-mobile\";\nimport { BooleanInput } from \"@/components/admin/boolean-input\";\nimport { ReferenceInput } from \"@/components/admin/reference-input\";\nimport { TextInput } from \"@/components/admin/text-input\";\nimport { RadioButtonGroupInput } from \"@/components/admin/radio-button-group-input\";\nimport { SelectInput } from \"@/components/admin/select-input\";\nimport { ArrayInput } from \"@/components/admin/array-input\";\nimport { SimpleFormIterator } from \"@/components/admin/simple-form-iterator\";\n\nimport { isLinkedinUrl } from \"../misc/isLinkedInUrl\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport type { Sale } from \"../types\";\nimport { Avatar } from \"./Avatar\";\nimport { AutocompleteCompanyInput } from \"../companies/AutocompleteCompanyInput.tsx\";\n\nexport const ContactInputs = () => {\n  const isMobile = useIsMobile();\n\n  return (\n    <div className=\"flex flex-col gap-2 p-1\">\n      <Avatar />\n      <div className={`flex gap-6 ${isMobile ? \"flex-col\" : \"flex-row\"}`}>\n        <div className=\"flex flex-col gap-10 flex-1\">\n          <ContactIdentityInputs />\n          <ContactPositionInputs />\n        </div>\n        <Separator\n          orientation={isMobile ? \"horizontal\" : \"vertical\"}\n          className=\"flex-shrink-0\"\n        />\n        <div className=\"flex flex-col gap-10 flex-1\">\n          <ContactPersonalInformationInputs />\n          <ContactMiscInputs />\n        </div>\n      </div>\n    </div>\n  );\n};\n\nconst ContactIdentityInputs = () => {\n  const { contactGender } = useConfigurationContext();\n  return (\n    <div className=\"flex flex-col gap-4\">\n      <h6 className=\"text-lg font-semibold\">Identity</h6>\n      <RadioButtonGroupInput\n        label={false}\n        row\n        source=\"gender\"\n        choices={contactGender}\n        helperText={false}\n        optionText=\"label\"\n        optionValue=\"value\"\n        defaultValue={contactGender[0].value}\n      />\n      <TextInput source=\"first_name\" validate={required()} helperText={false} />\n      <TextInput source=\"last_name\" validate={required()} helperText={false} />\n    </div>\n  );\n};\n\nconst ContactPositionInputs = () => {\n  return (\n    <div className=\"flex flex-col gap-4\">\n      <h6 className=\"text-lg font-semibold\">Position</h6>\n      <TextInput source=\"title\" helperText={false} />\n      <ReferenceInput source=\"company_id\" reference=\"companies\" perPage={10}>\n        <AutocompleteCompanyInput />\n      </ReferenceInput>\n    </div>\n  );\n};\n\nconst ContactPersonalInformationInputs = () => {\n  const { getValues, setValue } = useFormContext();\n\n  // set first and last name based on email\n  const handleEmailChange = (email: string) => {\n    const { first_name, last_name } = getValues();\n    if (first_name || last_name || !email) return;\n    const [first, last] = email.split(\"@\")[0].split(\".\");\n    setValue(\"first_name\", first.charAt(0).toUpperCase() + first.slice(1));\n    setValue(\n      \"last_name\",\n      last ? last.charAt(0).toUpperCase() + last.slice(1) : \"\",\n    );\n  };\n\n  const handleEmailPaste: ClipboardEventHandler<\n    HTMLTextAreaElement | HTMLInputElement\n  > = (e) => {\n    const email = e.clipboardData?.getData(\"text/plain\");\n    handleEmailChange(email);\n  };\n\n  const handleEmailBlur = (\n    e: FocusEvent<HTMLTextAreaElement | HTMLInputElement>,\n  ) => {\n    const email = e.target.value;\n    handleEmailChange(email);\n  };\n\n  return (\n    <div className=\"flex flex-col gap-4\">\n      <h6 className=\"text-lg font-semibold\">Personal info</h6>\n      <ArrayInput\n        source=\"email_jsonb\"\n        label=\"Email addresses\"\n        helperText={false}\n      >\n        <SimpleFormIterator\n          inline\n          disableReordering\n          disableClear\n          className=\"[&>ul>li]:border-b-0 [&>ul>li]:pb-0\"\n        >\n          <TextInput\n            source=\"email\"\n            className=\"w-full\"\n            helperText={false}\n            label={false}\n            placeholder=\"Email\"\n            validate={email()}\n            onPaste={handleEmailPaste}\n            onBlur={handleEmailBlur}\n          />\n          <SelectInput\n            source=\"type\"\n            helperText={false}\n            label={false}\n            optionText=\"id\"\n            choices={personalInfoTypes}\n            defaultValue=\"Work\"\n            className=\"w-24 min-w-24\"\n          />\n        </SimpleFormIterator>\n      </ArrayInput>\n      <ArrayInput source=\"phone_jsonb\" label=\"Phone numbers\" helperText={false}>\n        <SimpleFormIterator\n          inline\n          disableReordering\n          disableClear\n          className=\"[&>ul>li]:border-b-0 [&>ul>li]:pb-0\"\n        >\n          <TextInput\n            source=\"number\"\n            className=\"w-full\"\n            helperText={false}\n            label={false}\n            placeholder=\"Phone number\"\n          />\n          <SelectInput\n            source=\"type\"\n            helperText={false}\n            label={false}\n            optionText=\"id\"\n            choices={personalInfoTypes}\n            defaultValue=\"Work\"\n            className=\"w-24 min-w-24\"\n          />\n        </SimpleFormIterator>\n      </ArrayInput>\n      <TextInput\n        source=\"linkedin_url\"\n        label=\"Linkedin URL\"\n        helperText={false}\n        validate={isLinkedinUrl}\n      />\n    </div>\n  );\n};\n\nconst personalInfoTypes = [{ id: \"Work\" }, { id: \"Home\" }, { id: \"Other\" }];\n\nconst ContactMiscInputs = () => {\n  return (\n    <div className=\"flex flex-col gap-4\">\n      <h6 className=\"text-lg font-semibold\">Misc</h6>\n      <TextInput\n        source=\"background\"\n        label=\"Background info (bio, how you met, etc)\"\n        multiline\n        helperText={false}\n      />\n      <BooleanInput source=\"has_newsletter\" helperText={false} />\n      <ReferenceInput\n        reference=\"sales\"\n        source=\"sales_id\"\n        sort={{ field: \"last_name\", order: \"ASC\" }}\n        filter={{\n          \"disabled@neq\": true,\n        }}\n      >\n        <SelectInput\n          helperText={false}\n          label=\"Account manager\"\n          optionText={saleOptionRenderer}\n          validate={required()}\n        />\n      </ReferenceInput>\n    </div>\n  );\n};\n\nconst saleOptionRenderer = (choice: Sale) =>\n  `${choice.first_name} ${choice.last_name}`;\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/ContactImportButton.tsx",
      "content": "import { useEffect, useState } from \"react\";\nimport type { MouseEvent } from \"react\";\nimport { Upload, Loader2 } from \"lucide-react\";\nimport { Form, useRefresh } from \"ra-core\";\nimport { Link } from \"react-router\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { FormToolbar } from \"@/components/admin/simple-form\";\nimport { FileInput } from \"@/components/admin/file-input\";\nimport { FileField } from \"@/components/admin/file-field\";\n\nimport { usePapaParse } from \"../misc/usePapaParse\";\nimport type { ContactImportSchema } from \"./useContactImport\";\nimport { useContactImport } from \"./useContactImport\";\nimport * as sampleCsv from \"./contacts_export.csv?raw\";\n\nexport const ContactImportButton = () => {\n  const [modalOpen, setModalOpen] = useState(false);\n\n  const handleOpenModal = () => {\n    setModalOpen(true);\n  };\n\n  const handleCloseModal = () => {\n    setModalOpen(false);\n  };\n\n  return (\n    <>\n      <Button\n        variant=\"outline\"\n        onClick={handleOpenModal}\n        className=\"flex items-center gap-2 cursor-pointer\"\n      >\n        <Upload /> Import\n      </Button>\n      <ContactImportDialog open={modalOpen} onClose={handleCloseModal} />\n    </>\n  );\n};\n\nconst SAMPLE_URL = `data:text/csv;name=crm_contacts_sample.csv;charset=utf-8,${encodeURIComponent(\n  sampleCsv.default,\n)}`;\n\ntype ContactImportModalProps = {\n  open: boolean;\n  onClose(): void;\n};\n\nexport function ContactImportDialog({\n  open,\n  onClose,\n}: ContactImportModalProps) {\n  const refresh = useRefresh();\n  const processBatch = useContactImport();\n  const { importer, parseCsv, reset } = usePapaParse<ContactImportSchema>({\n    batchSize: 10,\n    processBatch,\n  });\n\n  const [file, setFile] = useState<File | null>(null);\n\n  useEffect(() => {\n    if (importer.state === \"complete\") {\n      refresh();\n    }\n  }, [importer.state, refresh]);\n\n  const handleFileChange = (file: File | null) => {\n    setFile(file);\n  };\n\n  const startImport = () => {\n    if (!file) return;\n    parseCsv(file);\n  };\n\n  const handleClose = () => {\n    reset();\n    onClose();\n  };\n\n  const handleReset = (e: MouseEvent<HTMLButtonElement>) => {\n    e.preventDefault();\n    reset();\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={handleClose}>\n      <DialogContent className=\"max-w-2xl\">\n        <Form className=\"flex flex-col gap-4\">\n          <DialogHeader>\n            <DialogTitle>Import</DialogTitle>\n          </DialogHeader>\n\n          <div className=\"flex flex-col space-y-2\">\n            {importer.state === \"running\" && (\n              <div className=\"flex flex-col gap-2\">\n                <Alert>\n                  <AlertDescription className=\"flex flex-row gap-4\">\n                    <Loader2 className=\"h-5 w-5 animate-spin\" />\n                    The import is running, please do not close this tab.\n                  </AlertDescription>\n                </Alert>\n\n                <div className=\"text-sm\">\n                  Imported{\" \"}\n                  <strong>\n                    {importer.importCount} / {importer.rowCount}\n                  </strong>{\" \"}\n                  contacts, with <strong>{importer.errorCount}</strong> errors.\n                  {importer.remainingTime !== null && (\n                    <>\n                      {\" \"}\n                      Estimated remaining time:{\" \"}\n                      <strong>\n                        {millisecondsToTime(importer.remainingTime)}\n                      </strong>\n                      .{\" \"}\n                      <button\n                        onClick={handleReset}\n                        className=\"text-red-600 underline hover:text-red-800\"\n                      >\n                        Stop import\n                      </button>\n                    </>\n                  )}\n                </div>\n              </div>\n            )}\n\n            {importer.state === \"error\" && (\n              <Alert variant=\"destructive\">\n                <AlertDescription>\n                  Failed to import this file, please make sure your provided a\n                  valid CSV file.\n                </AlertDescription>\n              </Alert>\n            )}\n\n            {importer.state === \"complete\" && (\n              <Alert>\n                <AlertDescription>\n                  Contacts import complete. Imported {importer.importCount}{\" \"}\n                  contacts, with {importer.errorCount} errors\n                </AlertDescription>\n              </Alert>\n            )}\n\n            {importer.state === \"idle\" && (\n              <>\n                <Alert>\n                  <AlertDescription className=\"flex flex-col gap-4\">\n                    Here is a sample CSV file you can use as a template\n                    <Button asChild variant=\"outline\" size=\"sm\">\n                      <Link\n                        to={SAMPLE_URL}\n                        download={\"crm_contacts_sample.csv\"}\n                      >\n                        Download CSV sample\n                      </Link>\n                    </Button>{\" \"}\n                  </AlertDescription>\n                </Alert>\n\n                <FileInput\n                  source=\"csv\"\n                  label=\"CSV File\"\n                  accept={{ \"text/csv\": [\".csv\"] }}\n                  onChange={handleFileChange}\n                >\n                  <FileField source=\"src\" title=\"title\" target=\"_blank\" />\n                </FileInput>\n              </>\n            )}\n          </div>\n        </Form>\n\n        <div className=\"flex justify-start pt-6\">\n          <FormToolbar>\n            {importer.state === \"idle\" ? (\n              <Button onClick={startImport} disabled={!file}>\n                Import\n              </Button>\n            ) : (\n              <Button\n                variant=\"outline\"\n                onClick={handleClose}\n                disabled={importer.state === \"running\"}\n              >\n                Close\n              </Button>\n            )}\n          </FormToolbar>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n\nfunction millisecondsToTime(ms: number) {\n  const seconds = Math.floor((ms / 1000) % 60);\n  const minutes = Math.floor((ms / (60 * 1000)) % 60);\n\n  return `${minutes}m ${seconds}s`;\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/ContactHealthCard.tsx",
      "content": "import { formatDistance } from \"date-fns\";\nimport { Activity, HeartPulse, Mail, Linkedin } from \"lucide-react\";\nimport { useRecordContext } from \"ra-core\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Progress } from \"@/components/ui/progress\";\n\nimport { AsideSection } from \"../misc/AsideSection\";\nimport type { Contact } from \"../types\";\n\nconst InternalStatusBadge = ({ status }: { status: string }) => {\n  let variant: \"default\" | \"secondary\" | \"destructive\" | \"outline\" = \"outline\";\n  let className = \"\";\n\n  switch (status) {\n    case \"strong\":\n      variant = \"default\";\n      break;\n    case \"active\":\n      variant = \"secondary\"; \n      className = \"bg-green-100 text-green-800 hover:bg-green-100\";\n      break;\n    case \"cooling\":\n      variant = \"secondary\";\n      className = \"bg-yellow-100 text-yellow-800 hover:bg-yellow-100\";\n      break;\n    case \"cold\":\n      variant = \"secondary\";\n      className = \"bg-orange-100 text-orange-800 hover:bg-orange-100\";\n      break;\n    case \"dormant\":\n      variant = \"secondary\";\n      break;\n  }\n\n  return (\n    <Badge variant={variant} className={className}>\n      {status.charAt(0).toUpperCase() + status.slice(1)}\n    </Badge>\n  );\n};\n\nconst EmailStatusBadge = ({ status }: { status: string }) => {\n  let variant: \"default\" | \"secondary\" | \"destructive\" | \"outline\" = \"outline\";\n  let className = \"\";\n\n  switch (status) {\n    case \"valid\":\n      variant = \"secondary\";\n      className = \"bg-green-100 text-green-800 hover:bg-green-100\";\n      break;\n    case \"risky\":\n      variant = \"secondary\";\n      className = \"bg-yellow-100 text-yellow-800 hover:bg-yellow-100\";\n      break;\n    case \"invalid\":\n      variant = \"destructive\";\n      break;\n  }\n\n  return (\n    <Badge variant={variant} className={className}>\n      {status.charAt(0).toUpperCase() + status.slice(1)}\n    </Badge>\n  );\n};\n\nconst LinkedInStatusBadge = ({ status }: { status: string }) => {\n  let variant: \"default\" | \"secondary\" | \"destructive\" | \"outline\" = \"outline\";\n  let className = \"\";\n\n  switch (status) {\n    case \"active\":\n      variant = \"default\";\n      className = \"bg-[#0077b5] hover:bg-[#0077b5]\"; // LinkedIn Blue\n      break;\n    case \"inactive\":\n      variant = \"secondary\";\n      break;\n    case \"not_found\":\n      variant = \"destructive\";\n      break;\n  }\n\n  return (\n    <Badge variant={variant} className={className}>\n      {status.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')}\n    </Badge>\n  );\n};\n\nexport const ContactHealthCard = () => {\n  const record = useRecordContext<Contact>();\n  if (!record) return null;\n\n  const daysSince = record.days_since_last_activity ?? \n    (record.last_seen ? Math.floor((new Date().getTime() - new Date(record.last_seen).getTime()) / (1000 * 60 * 60 * 24)) : undefined);\n\n  const hasInternalHealth =\n    record.internal_heartbeat_score != null ||\n    record.internal_heartbeat_status != null ||\n    daysSince != null;\n\n  const hasExternalHealth =\n    record.external_heartbeat_status != null ||\n    record.email_validation_status != null ||\n    record.linkedin_profile_status != null;\n\n  return (\n    <AsideSection title=\"Contact Health\">\n      {!hasInternalHealth && !hasExternalHealth && (\n        <div className=\"text-xs text-muted-foreground italic\">\n          No health data calculated yet.\n        </div>\n      )}\n\n      {/* Internal Heartbeat (Relationship Strength) */}\n      {hasInternalHealth && (\n        <div className=\"mb-4\">\n          <div className=\"flex items-center gap-2 mb-2\">\n            <Activity className=\"w-4 h-4 text-muted-foreground\" />\n            <span className=\"font-medium text-sm\">Relationship Strength</span>\n          </div>\n\n          {record.internal_heartbeat_score != null && (\n            <div className=\"mb-2\">\n              <div className=\"flex items-center justify-between mb-1\">\n                <span className=\"text-xs text-muted-foreground\">\n                  Engagement Score\n                </span>\n                <span className=\"text-xs font-medium\">\n                  {record.internal_heartbeat_score}/100\n                </span>\n              </div>\n              <Progress\n                value={record.internal_heartbeat_score}\n                className=\"h-2\"\n              />\n            </div>\n          )}\n\n          {record.internal_heartbeat_status && (\n            <div className=\"mb-2\">\n              <InternalStatusBadge status={record.internal_heartbeat_status} />\n            </div>\n          )}\n\n          {daysSince != null && (\n            <div className=\"text-xs text-muted-foreground\">\n              Last activity:{\" \"}\n              {daysSince === 0\n                ? \"Today\"\n                : daysSince === 1\n                  ? \"Yesterday\"\n                  : `${daysSince} days ago`}\n            </div>\n          )}\n        </div>\n      )}\n\n      {/* External Heartbeat (Contact Validation) */}\n      {hasExternalHealth && (\n        <div>\n          <div className=\"flex items-center gap-2 mb-2\">\n            <HeartPulse className=\"w-4 h-4 text-muted-foreground\" />\n            <span className=\"font-medium text-sm\">Contact Validation</span>\n          </div>\n\n          {record.email_validation_status && (\n            <div className=\"flex items-center gap-2 mb-2\">\n              <Mail className=\"w-3 h-3 text-muted-foreground\" />\n              <EmailStatusBadge status={record.email_validation_status} />\n              {record.email_last_bounced_at && (\n                <span className=\"text-xs text-destructive\">\n                  (bounced)\n                </span>\n              )}\n            </div>\n          )}\n\n          {record.linkedin_profile_status && (\n            <div className=\"flex items-center gap-2 mb-2\">\n              <Linkedin className=\"w-3 h-3 text-muted-foreground\" />\n              <LinkedInStatusBadge status={record.linkedin_profile_status} />\n            </div>\n          )}\n\n          {record.external_heartbeat_checked_at && (\n            <div className=\"text-xs text-muted-foreground\">\n              Validated{\" \"}\n              {formatDistance(\n                new Date(record.external_heartbeat_checked_at),\n                new Date(),\n                { addSuffix: true },\n              )}\n            </div>\n          )}\n        </div>\n      )}\n    </AsideSection>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/ContactEmpty.tsx",
      "content": "import { CreateButton } from \"@/components/admin/create-button\";\n\nimport useAppBarHeight from \"../misc/useAppBarHeight\";\nimport { ContactImportButton } from \"./ContactImportButton\";\n\nexport const ContactEmpty = () => {\n  const appbarHeight = useAppBarHeight();\n  return (\n    <div\n      className=\"flex flex-col justify-center items-center gap-3\"\n      style={{\n        height: `calc(100dvh - ${appbarHeight}px)`,\n      }}\n    >\n      <img src=\"./img/empty.svg\" alt=\"No contacts found\" />\n      <div className=\"flex flex-col gap-0 items-center\">\n        <h6 className=\"text-lg font-bold\">No contacts found</h6>\n        <p className=\"text-sm text-muted-foreground text-center mb-4\">\n          It seems your contact list is empty.\n        </p>\n      </div>\n      <div className=\"flex flex-row gap-2\">\n        <CreateButton label=\"New Contact\" />\n        <ContactImportButton />\n      </div>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/ContactEdit.tsx",
      "content": "import { Card, CardContent } from \"@/components/ui/card\";\nimport { EditBase, Form, useEditContext } from \"ra-core\";\n\nimport type { Contact } from \"../types\";\nimport { ContactAside } from \"./ContactAside\";\nimport { ContactInputs } from \"./ContactInputs\";\nimport { FormToolbar } from \"../layout/FormToolbar\";\n\nexport const ContactEdit = () => (\n  <EditBase redirect=\"show\">\n    <ContactEditContent />\n  </EditBase>\n);\n\nconst ContactEditContent = () => {\n  const { isPending, record } = useEditContext<Contact>();\n  if (isPending || !record) return null;\n  return (\n    <div className=\"mt-2 flex gap-8\">\n      <Form className=\"flex flex-1 flex-col gap-4\">\n        <Card>\n          <CardContent>\n            <ContactInputs />\n            <FormToolbar />\n          </CardContent>\n        </Card>\n      </Form>\n\n      <ContactAside link=\"show\" />\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/ContactCreate.tsx",
      "content": "import { CreateBase, Form, useGetIdentity } from \"ra-core\";\nimport { FormToolbar } from \"@/components/admin/simple-form\";\nimport { Card, CardContent } from \"@/components/ui/card\";\n\nimport type { Contact } from \"../types\";\nimport { ContactInputs } from \"./ContactInputs\";\n\nexport const ContactCreate = () => {\n  const { identity } = useGetIdentity();\n  return (\n    <CreateBase\n      redirect=\"show\"\n      transform={(data: Contact) => ({\n        ...data,\n        first_seen: new Date().toISOString(),\n        last_seen: new Date().toISOString(),\n        tags: [],\n      })}\n    >\n      <div className=\"mt-2 flex lg:mr-72\">\n        <div className=\"flex-1\">\n          <Form defaultValues={{ sales_id: identity?.id }}>\n            <Card>\n              <CardContent>\n                <ContactInputs />\n                <FormToolbar />\n              </CardContent>\n            </Card>\n          </Form>\n        </div>\n      </div>\n    </CreateBase>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/ContactAside.tsx",
      "content": "import { Linkedin, Mail, Phone } from \"lucide-react\";\nimport { useRecordContext, WithRecord } from \"ra-core\";\nimport type { ReactNode } from \"react\";\nimport { ArrayField } from \"@/components/admin/array-field\";\nimport { EditButton } from \"@/components/admin/edit-button\";\nimport { DeleteButton } from \"@/components/admin\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { ReferenceManyField } from \"@/components/admin/reference-many-field\";\nimport { ShowButton } from \"@/components/admin/show-button\";\nimport { SingleFieldList } from \"@/components/admin/single-field-list\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { DateField } from \"@/components/admin/date-field\";\nimport { EmailField } from \"@/components/admin/email-field\";\n\nimport { AddTask } from \"../tasks/AddTask\";\nimport { TasksIterator } from \"../tasks/TasksIterator\";\nimport { TagsListEdit } from \"./TagsListEdit\";\nimport { AsideSection } from \"../misc/AsideSection\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport { SaleName } from \"../sales/SaleName\";\nimport type { Contact } from \"../types\";\nimport { ContactMergeButton } from \"./ContactMergeButton\";\nimport { ExportVCardButton } from \"./ExportVCardButton\";\nimport { ContactHealthCard } from \"./ContactHealthCard\";\n\nexport const ContactAside = ({ link = \"edit\" }: { link?: \"edit\" | \"show\" }) => {\n  const { contactGender } = useConfigurationContext();\n  const record = useRecordContext<Contact>();\n\n  if (!record) return null;\n  return (\n    <div className=\"hidden sm:block w-64 min-w-64 text-sm\">\n      <div className=\"mb-4 -ml-1\">\n        {link === \"edit\" ? (\n          <EditButton label=\"Edit Contact\" />\n        ) : (\n          <ShowButton label=\"Show Contact\" />\n        )}\n      </div>\n\n      <ContactHealthCard />\n\n      <AsideSection title=\"Personal info\">\n        <ArrayField source=\"email_jsonb\">\n          <SingleFieldList className=\"flex-col\">\n            <PersonalInfoRow\n              icon={<Mail className=\"w-4 h-4 text-muted-foreground\" />}\n              primary={<EmailField source=\"email\" />}\n            />\n          </SingleFieldList>\n        </ArrayField>\n\n        {record.has_newsletter && (\n          <p className=\"pl-6 text-sm text-muted-foreground\">\n            Subscribed to newsletter\n          </p>\n        )}\n\n        {record.linkedin_url && (\n          <PersonalInfoRow\n            icon={<Linkedin className=\"w-4 h-4 text-muted-foreground\" />}\n            primary={\n              <a\n                className=\"underline hover:no-underline text-sm text-muted-foreground\"\n                href={record.linkedin_url}\n                target=\"_blank\"\n                rel=\"noopener noreferrer\"\n                title={record.linkedin_url}\n              >\n                LinkedIn\n              </a>\n            }\n          />\n        )}\n        <ArrayField source=\"phone_jsonb\">\n          <SingleFieldList className=\"flex-col\">\n            <PersonalInfoRow\n              icon={<Phone className=\"w-4 h-4 text-muted-foreground\" />}\n              primary={<TextField source=\"number\" />}\n              showType\n            />\n          </SingleFieldList>\n        </ArrayField>\n        {contactGender\n          .map((genderOption) => {\n            if (record.gender === genderOption.value) {\n              return (\n                <PersonalInfoRow\n                  key={genderOption.value}\n                  icon={\n                    <genderOption.icon className=\"w-4 h-4 text-muted-foreground\" />\n                  }\n                  primary={<span>{genderOption.label}</span>}\n                />\n              );\n            }\n            return null;\n          })\n          .filter(Boolean)}\n      </AsideSection>\n      <AsideSection title=\"Background info\">\n        <WithRecord<Contact>\n          render={(record) =>\n            record?.background ? (\n              <TextField source=\"background\" record={record} className=\"pb-2\" />\n            ) : null\n          }\n        />\n        <div className=\"text-muted-foreground\">\n          <span className=\"text-sm\">Added on</span>{\" \"}\n          <DateField\n            source=\"first_seen\"\n            options={{ year: \"numeric\", month: \"long\", day: \"numeric\" }}\n          />\n        </div>\n\n        <div className=\"text-muted-foreground\">\n          <span className=\"text-sm\">Last activity on</span>{\" \"}\n          <DateField\n            source=\"last_seen\"\n            options={{ year: \"numeric\", month: \"long\", day: \"numeric\" }}\n          />\n        </div>\n\n        <div className=\"inline-flex text-muted-foreground\">\n          Followed by&nbsp;\n          <ReferenceField source=\"sales_id\" reference=\"sales\">\n            <SaleName />\n          </ReferenceField>\n        </div>\n      </AsideSection>\n\n      <AsideSection title=\"Tags\">\n        <TagsListEdit />\n      </AsideSection>\n\n      <AsideSection title=\"Tasks\">\n        <ReferenceManyField\n          target=\"contact_id\"\n          reference=\"tasks\"\n          sort={{ field: \"due_date\", order: \"ASC\" }}\n        >\n          <TasksIterator />\n        </ReferenceManyField>\n        <AddTask />\n      </AsideSection>\n\n      {link !== \"edit\" && (\n        <>\n          <div className=\"mt-6 pt-6 border-t hidden sm:flex flex-col gap-2 items-start\">\n            <ExportVCardButton />\n            <ContactMergeButton />\n          </div>\n          <div className=\"mt-6 pt-6 border-t hidden sm:flex flex-col gap-2 items-start\">\n            <DeleteButton\n              className=\"h-6 cursor-pointer hover:bg-destructive/10! text-destructive! border-destructive! focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40\"\n              size=\"sm\"\n            />\n          </div>\n        </>\n      )}\n    </div>\n  );\n};\n\nconst PersonalInfoRow = ({\n  icon,\n  primary,\n  showType,\n}: {\n  icon: ReactNode;\n  primary: ReactNode;\n  showType?: boolean;\n}) => (\n  <div className=\"flex flex-row items-center gap-2 min-h-6\">\n    {icon}\n    <div className=\"flex flex-wrap gap-x-2 gap-y-0\">\n      {primary}\n      {showType ? (\n        <WithRecord\n          render={(row) =>\n            row.type !== \"Other\" && (\n              <TextField source=\"type\" className=\"text-muted-foreground\" />\n            )\n          }\n        />\n      ) : null}\n    </div>\n  </div>\n);\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/Avatar.tsx",
      "content": "import {\n  AvatarFallback,\n  AvatarImage,\n  Avatar as ShadcnAvatar,\n} from \"@/components/ui/avatar\";\nimport { useRecordContext } from \"ra-core\";\n\nimport type { Contact } from \"../types\";\n\nexport const Avatar = (props: {\n  record?: Contact;\n  width?: 20 | 25 | 40;\n  height?: 20 | 25 | 40;\n  title?: string;\n}) => {\n  const record = useRecordContext<Contact>(props);\n  // If we come from company page, the record is defined (to pass the company as a prop),\n  // but neither of those fields are and this lead to an error when creating contact.\n  if (!record?.avatar && !record?.first_name && !record?.last_name) {\n    return null;\n  }\n\n  const size = props.width || props.height;\n  const sizeClass =\n    props.width === 20\n      ? `w-[20px] h-[20px]`\n      : props.width === 25\n        ? \"w-[25px] h-[25px]\"\n        : \"w-10 h-10\";\n\n  return (\n    <ShadcnAvatar className={sizeClass} title={props.title}>\n      <AvatarImage src={record.avatar?.src ?? undefined} />\n      <AvatarFallback className={size && size < 40 ? \"text-[10px]\" : \"text-sm\"}>\n        {record.first_name?.charAt(0).toUpperCase()}\n        {record.last_name?.charAt(0).toUpperCase()}\n      </AvatarFallback>\n    </ShadcnAvatar>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/sizes.ts",
      "content": "export const sizes = [\n  { id: 1, name: \"1 employee\" },\n  { id: 10, name: \"2-9 employees\" },\n  { id: 50, name: \"10-49 employees\" },\n  { id: 250, name: \"50-249 employees\" },\n  { id: 500, name: \"250 or more employees\" },\n];\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/index.ts",
      "content": "import { CompanyList } from \"./CompanyList\";\nimport { CompanyCreate } from \"./CompanyCreate\";\nimport { CompanyShow } from \"./CompanyShow\";\nimport { CompanyEdit } from \"./CompanyEdit\";\n\nexport default {\n  list: CompanyList,\n  create: CompanyCreate,\n  edit: CompanyEdit,\n  show: CompanyShow,\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/GridList.tsx",
      "content": "import { RecordContextProvider, useListContext } from \"ra-core\";\n\nimport type { Company } from \"../types\";\nimport { CompanyCard } from \"./CompanyCard\";\n\nconst times = (nbChildren: number, fn: (key: number) => any) =>\n  Array.from({ length: nbChildren }, (_, key) => fn(key));\n\nconst LoadingGridList = () => (\n  <div className=\"flex flex-wrap w-[1008px] gap-1\">\n    {times(15, (key) => (\n      <div\n        className=\"h-[200px] w-[194px] flex flex-col bg-gray-200\"\n        key={key}\n      />\n    ))}\n  </div>\n);\n\nconst LoadedGridList = () => {\n  const { data, error, isPending } = useListContext<Company>();\n\n  if (isPending || error) return null;\n\n  return (\n    <div\n      className=\"w-full gap-2 grid\"\n      style={{\n        gridTemplateColumns: \"repeat(auto-fill, minmax(180px, 1fr))\",\n      }}\n    >\n      {data.map((record) => (\n        <RecordContextProvider key={record.id} value={record}>\n          <CompanyCard />\n        </RecordContextProvider>\n      ))}\n\n      {data.length === 0 && <div className=\"p-2\">No companies found</div>}\n    </div>\n  );\n};\n\nexport const ImageList = () => {\n  const { isPending } = useListContext();\n  return isPending ? <LoadingGridList /> : <LoadedGridList />;\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/CompanyShow.tsx",
      "content": "import { formatDistance } from \"date-fns\";\nimport { UserPlus } from \"lucide-react\";\nimport {\n  RecordContextProvider,\n  ShowBase,\n  useListContext,\n  useRecordContext,\n  useShowContext,\n} from \"ra-core\";\nimport {\n  Link as RouterLink,\n  useLocation,\n  useMatch,\n  useNavigate,\n} from \"react-router-dom\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"@/components/ui/tabs\";\nimport { ReferenceManyField } from \"@/components/admin/reference-many-field\";\nimport { SortButton } from \"@/components/admin/sort-button\";\n\nimport { ActivityLog } from \"../activity/ActivityLog\";\nimport { Avatar } from \"../contacts/Avatar\";\nimport { TagsList } from \"../contacts/TagsList\";\nimport { findDealLabel } from \"../deals/deal\";\nimport { Status } from \"../misc/Status\";\nimport { NoteCreate } from \"../notes/NoteCreate\";\nimport { NotesIterator } from \"../notes/NotesIterator\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport type { Company, Contact, Deal } from \"../types\";\nimport { CompanyAside } from \"./CompanyAside\";\nimport { CompanyAvatar } from \"./CompanyAvatar\";\n\nexport const CompanyShow = () => (\n  <ShowBase>\n    <CompanyShowContent />\n  </ShowBase>\n);\n\nconst CompanyShowContent = () => {\n  const { record, isPending } = useShowContext<Company>();\n  const navigate = useNavigate();\n\n  // Get tab from URL or default to \"activity\"\n  const tabMatch = useMatch(\"/companies/:id/show/:tab\");\n  const currentTab = tabMatch?.params?.tab || \"activity\";\n\n  const handleTabChange = (value: string) => {\n    if (value === currentTab) return;\n    if (value === \"activity\") {\n      navigate(`/companies/${record?.id}/show`);\n      return;\n    }\n    navigate(`/companies/${record?.id}/show/${value}`);\n  };\n\n  if (isPending || !record) return null;\n\n  return (\n    <div className=\"mt-2 flex pb-2 gap-8\">\n      <div className=\"flex-1\">\n        <Card>\n          <CardContent>\n            <div className=\"flex mb-3\">\n              <CompanyAvatar />\n              <h5 className=\"text-xl ml-2 flex-1\">{record.name}</h5>\n            </div>\n            <Tabs defaultValue={currentTab} onValueChange={handleTabChange}>\n              <TabsList className=\"grid w-full grid-cols-4\">\n                <TabsTrigger value=\"activity\">Activity</TabsTrigger>\n                <TabsTrigger value=\"contacts\">\n                  {record.nb_contacts\n                    ? record.nb_contacts === 1\n                      ? \"1 Contact\"\n                      : `${record.nb_contacts} Contacts`\n                    : \"No Contacts\"}\n                </TabsTrigger>\n                <TabsTrigger value=\"notes\">\n                  {record.nb_notes\n                    ? record.nb_notes === 1\n                      ? \"1 Note\"\n                      : `${record.nb_notes} Notes`\n                    : \"Notes\"}\n                </TabsTrigger>\n                {record.nb_deals ? (\n                  <TabsTrigger value=\"deals\">\n                    {record.nb_deals === 1\n                      ? \"1 deal\"\n                      : `${record.nb_deals} deals`}\n                  </TabsTrigger>\n                ) : null}\n              </TabsList>\n              <TabsContent value=\"activity\" className=\"pt-2\">\n                <ActivityLog companyId={record.id} context=\"company\" />\n              </TabsContent>\n              <TabsContent value=\"contacts\">\n                {record.nb_contacts ? (\n                  <ReferenceManyField\n                    reference=\"contacts_summary\"\n                    target=\"company_id\"\n                    sort={{ field: \"last_name\", order: \"ASC\" }}\n                  >\n                    <div className=\"flex flex-col gap-4\">\n                      <div className=\"flex flex-row justify-end space-x-2 mt-1\">\n                        {!!record.nb_contacts && (\n                          <SortButton\n                            fields={[\"last_name\", \"first_name\", \"last_seen\"]}\n                          />\n                        )}\n                        <CreateRelatedContactButton />\n                      </div>\n                      <ContactsIterator />\n                    </div>\n                  </ReferenceManyField>\n                ) : (\n                  <div className=\"flex flex-col gap-4\">\n                    <div className=\"flex flex-row justify-end space-x-2 mt-1\">\n                      <CreateRelatedContactButton />\n                    </div>\n                  </div>\n                )}\n              </TabsContent>\n              <TabsContent value=\"notes\">\n                <ReferenceManyField\n                  reference=\"companyNotes\"\n                  target=\"company_id\"\n                  sort={{ field: \"date\", order: \"DESC\" }}\n                  empty={<NoteCreate reference=\"companies\" className=\"mt-4\" />}\n                >\n                  <NotesIterator reference=\"companies\" />\n                </ReferenceManyField>\n              </TabsContent>\n              <TabsContent value=\"deals\">\n                {record.nb_deals ? (\n                  <ReferenceManyField\n                    reference=\"deals\"\n                    target=\"company_id\"\n                    sort={{ field: \"name\", order: \"ASC\" }}\n                  >\n                    <DealsIterator />\n                  </ReferenceManyField>\n                ) : null}\n              </TabsContent>\n            </Tabs>\n          </CardContent>\n        </Card>\n      </div>\n      <CompanyAside />\n    </div>\n  );\n};\n\nconst ContactsIterator = () => {\n  const location = useLocation();\n  const { data: contacts, error, isPending } = useListContext<Contact>();\n\n  if (isPending || error) return null;\n\n  const now = Date.now();\n  return (\n    <div className=\"pt-0\">\n      {contacts.map((contact) => (\n        <RecordContextProvider key={contact.id} value={contact}>\n          <div className=\"p-0 text-sm\">\n            <RouterLink\n              to={`/contacts/${contact.id}/show`}\n              state={{ from: location.pathname }}\n              className=\"flex items-center justify-between hover:bg-muted py-2 transition-colors\"\n            >\n              <div className=\"mr-4\">\n                <Avatar />\n              </div>\n              <div className=\"flex-1 min-w-0\">\n                <div className=\"font-medium\">\n                  {`${contact.first_name} ${contact.last_name}`}\n                </div>\n                <div className=\"text-sm text-muted-foreground\">\n                  {contact.title}\n                  {contact.nb_tasks\n                    ? ` - ${contact.nb_tasks} task${\n                        contact.nb_tasks > 1 ? \"s\" : \"\"\n                      }`\n                    : \"\"}\n                  &nbsp; &nbsp;\n                  <TagsList />\n                </div>\n              </div>\n              {contact.last_seen && (\n                <div className=\"text-right\">\n                  <div className=\"text-sm text-muted-foreground\">\n                    last activity {formatDistance(contact.last_seen, now)} ago{\" \"}\n                    <Status status={contact.status} />\n                  </div>\n                </div>\n              )}\n            </RouterLink>\n          </div>\n        </RecordContextProvider>\n      ))}\n    </div>\n  );\n};\n\nconst CreateRelatedContactButton = () => {\n  const company = useRecordContext<Company>();\n  return (\n    <Button variant=\"outline\" asChild size=\"sm\" className=\"h-9\">\n      <RouterLink\n        to=\"/contacts/create\"\n        state={company ? { record: { company_id: company.id } } : undefined}\n        className=\"flex items-center gap-2\"\n      >\n        <UserPlus className=\"h-4 w-4\" />\n        Add contact\n      </RouterLink>\n    </Button>\n  );\n};\n\nconst DealsIterator = () => {\n  const { data: deals, error, isPending } = useListContext<Deal>();\n  const { dealStages } = useConfigurationContext();\n  if (isPending || error) return null;\n\n  const now = Date.now();\n  return (\n    <div>\n      <div>\n        {deals.map((deal) => (\n          <div key={deal.id} className=\"p-0 text-sm\">\n            <RouterLink\n              to={`/deals/${deal.id}/show`}\n              className=\"flex items-center justify-between hover:bg-muted py-2 px-4 transition-colors\"\n            >\n              <div className=\"flex-1 min-w-0\">\n                <div className=\"font-medium\">{deal.name}</div>\n                <div className=\"text-sm text-muted-foreground\">\n                  {findDealLabel(dealStages, deal.stage)},{\" \"}\n                  {deal.amount.toLocaleString(\"en-US\", {\n                    notation: \"compact\",\n                    style: \"currency\",\n                    currency: \"USD\",\n                    currencyDisplay: \"narrowSymbol\",\n                    minimumSignificantDigits: 3,\n                  })}\n                  {deal.category ? `, ${deal.category}` : \"\"}\n                </div>\n              </div>\n              <div className=\"text-right\">\n                <div className=\"text-sm text-muted-foreground\">\n                  last activity {formatDistance(deal.updated_at, now)} ago{\" \"}\n                </div>\n              </div>\n            </RouterLink>\n          </div>\n        ))}\n      </div>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/CompanyMergeButton.tsx",
      "content": "import { useState, useEffect } from \"react\";\nimport { Merge, CircleX, AlertTriangle, ArrowDown } from \"lucide-react\";\nimport {\n  useDataProvider,\n  useRecordContext,\n  useGetList,\n  useGetManyReference,\n  required,\n  Form,\n  useNotify,\n  useRedirect,\n} from \"ra-core\";\nimport type { Identifier } from \"ra-core\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogDescription,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { ReferenceInput } from \"@/components/admin/reference-input\";\nimport { AutocompleteInput } from \"@/components/admin/autocomplete-input\";\nimport { Alert, AlertDescription, AlertTitle } from \"@/components/ui/alert\";\nimport type { Company } from \"../types\";\n\nexport const CompanyMergeButton = () => {\n  const [mergeDialogOpen, setMergeDialogOpen] = useState(false);\n  return (\n    <>\n      <Button\n        variant=\"outline\"\n        className=\"h-6 cursor-pointer\"\n        size=\"sm\"\n        onClick={() => setMergeDialogOpen(true)}\n      >\n        <Merge className=\"w-4 h-4\" />\n        Merge with another company\n      </Button>\n      <CompanyMergeDialog\n        open={mergeDialogOpen}\n        onClose={() => setMergeDialogOpen(false)}\n      />\n    </>\n  );\n};\n\ninterface CompanyMergeDialogProps {\n  open: boolean;\n  onClose: () => void;\n}\n\nconst CompanyMergeDialog = ({ open, onClose }: CompanyMergeDialogProps) => {\n  const loserCompany = useRecordContext<Company>();\n  const notify = useNotify();\n  const redirect = useRedirect();\n  const dataProvider = useDataProvider();\n  const [winnerId, setWinnerId] = useState<Identifier | null>(null);\n  const [suggestedWinnerId, setSuggestedWinnerId] = useState<Identifier | null>(\n    null,\n  );\n  const [isMerging, setIsMerging] = useState(false);\n  const { mutateAsync } = useMutation({\n    mutationKey: [\"companies\", \"merge\", { loserId: loserCompany?.id, winnerId }],\n    mutationFn: async () => {\n      return dataProvider.mergeCompanies(loserCompany?.id, winnerId);\n    },\n  });\n\n  // Find potential companies with matching name\n  const { data: matchingCompanies } = useGetList(\n    \"companies\",\n    {\n      filter: {\n        name: loserCompany?.name,\n        \"id@neq\": `${loserCompany?.id}`, // Exclude current company\n      },\n      pagination: { page: 1, perPage: 10 },\n    },\n    { enabled: open && !!loserCompany },\n  );\n\n  // Get counts of items to be merged\n  const canFetchCounts = open && !!loserCompany && !!winnerId;\n  const { total: contactsCount } = useGetManyReference(\n    \"contacts\",\n    {\n      target: \"company_id\",\n      id: loserCompany?.id,\n      pagination: { page: 1, perPage: 1 },\n    },\n    { enabled: canFetchCounts },\n  );\n\n  const { total: dealsCount } = useGetManyReference(\n    \"deals\",\n    {\n      target: \"company_id\",\n      id: loserCompany?.id,\n      pagination: { page: 1, perPage: 1 },\n    },\n    { enabled: canFetchCounts },\n  );\n\n  useEffect(() => {\n    if (matchingCompanies && matchingCompanies.length > 0) {\n      const suggestedWinnerId = matchingCompanies[0].id;\n      setSuggestedWinnerId(suggestedWinnerId);\n      setWinnerId(suggestedWinnerId);\n    }\n  }, [matchingCompanies]);\n\n  const handleMerge = async () => {\n    if (!winnerId || !loserCompany) {\n      notify(\"Please select a company to merge with\", { type: \"warning\" });\n      return;\n    }\n\n    try {\n      setIsMerging(true);\n      await mutateAsync();\n      setIsMerging(false);\n      notify(\"Companies merged successfully\", { type: \"success\" });\n      redirect(`/companies/${winnerId}/show`);\n      onClose();\n    } catch (error) {\n      setIsMerging(false);\n      notify(\"Failed to merge companies\", { type: \"error\" });\n      console.error(\"Merge failed:\", error);\n    }\n  };\n\n  if (!loserCompany) return null;\n\n  return (\n    <Dialog open={open} onOpenChange={onClose}>\n      <DialogContent className=\"md:min-w-lg max-w-2xl\">\n        <DialogHeader>\n          <DialogTitle>Merge Company</DialogTitle>\n          <DialogDescription>\n            Merge this company with another one.\n          </DialogDescription>\n        </DialogHeader>\n\n        <div className=\"space-y-4\">\n          <div className=\"p-4 bg-primary/5 rounded-lg border border-primary/20\">\n            <p className=\"font-medium text-sm\">\n              Current Company (will be deleted)\n            </p>\n            <div className=\"font-medium text-sm mt-4\">{loserCompany.name}</div>\n\n            <div className=\"flex justify-center my-4\">\n              <ArrowDown className=\"h-5 w-5 text-muted-foreground\" />\n            </div>\n\n            <p className=\"font-medium text-sm mb-2\">\n              Target Company (will be kept)\n            </p>\n            <Form>\n              <ReferenceInput\n                source=\"winner_id\"\n                reference=\"companies\"\n                filter={{ \"id@neq\": loserCompany.id }}\n              >\n                <AutocompleteInput\n                  label=\"\"\n                  optionText=\"name\"\n                  validate={required()}\n                  onChange={setWinnerId}\n                  defaultValue={suggestedWinnerId}\n                  helperText={false}\n                />\n              </ReferenceInput>\n            </Form>\n          </div>\n\n          {winnerId && (\n            <>\n              <div className=\"space-y-2\">\n                <p className=\"font-medium text-sm\">What will be merged:</p>\n                <ul className=\"text-sm text-muted-foreground space-y-1 ml-4\">\n                  {contactsCount != null && contactsCount > 0 && (\n                    <li>\n                       {contactsCount} contact\n                      {contactsCount !== 1 ? \"s\" : \"\"} will be reassigned\n                    </li>\n                  )}\n                  {dealsCount != null && dealsCount > 0 && (\n                    <li>\n                       {dealsCount} deal\n                      {dealsCount !== 1 ? \"s\" : \"\"} will be reassigned\n                    </li>\n                  )}\n                  {loserCompany.context_links?.length > 0 && (\n                    <li>\n                       {loserCompany.context_links.length} context link\n                      {loserCompany.context_links.length !== 1 ? \"s\" : \"\"} will\n                      be added\n                    </li>\n                  )}\n                  {!contactsCount &&\n                    !dealsCount &&\n                    !loserCompany.context_links?.length && (\n                      <li className=\"text-muted-foreground/60\">\n                        No additional data to merge\n                      </li>\n                    )}\n                </ul>\n              </div>\n              <Alert variant=\"destructive\">\n                <AlertTriangle className=\"h-4 w-4\" />\n                <AlertTitle>Warning: Destructive Operation</AlertTitle>\n                <AlertDescription>\n                  All data will be transferred to the second company. This\n                  action cannot be undone.\n                </AlertDescription>\n              </Alert>\n            </>\n          )}\n        </div>\n\n        <DialogFooter>\n          <Button variant=\"ghost\" onClick={onClose} disabled={isMerging}>\n            <CircleX />\n            Cancel\n          </Button>\n          <Button onClick={handleMerge} disabled={!winnerId || isMerging}>\n            <Merge />\n            {isMerging ? \"Merging...\" : \"Merge Companies\"}\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/CompanyListFilter.tsx",
      "content": "import { Building, Truck, Users } from \"lucide-react\";\nimport { FilterLiveForm, useGetIdentity } from \"ra-core\";\nimport { ToggleFilterButton } from \"@/components/admin/toggle-filter-button\";\nimport { SearchInput } from \"@/components/admin/search-input\";\n\nimport { FilterCategory } from \"../filters/FilterCategory\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport { sizes } from \"./sizes\";\n\nexport const CompanyListFilter = () => {\n  const { identity } = useGetIdentity();\n  const { companySectors } = useConfigurationContext();\n  const sectors = companySectors.map((sector) => ({\n    id: sector,\n    name: sector,\n  }));\n  return (\n    <div className=\"w-52 min-w-52 flex flex-col gap-8\">\n      <FilterLiveForm>\n        <SearchInput source=\"q\" />\n      </FilterLiveForm>\n\n      <FilterCategory icon={<Building className=\"h-4 w-4\" />} label=\"Size\">\n        {sizes.map((size) => (\n          <ToggleFilterButton\n            key={size.id}\n            className=\"w-full justify-between\"\n            label={size.name}\n            value={{ size: size.id }}\n          />\n        ))}\n      </FilterCategory>\n\n      <FilterCategory icon={<Truck className=\"h-4 w-4\" />} label=\"Sector\">\n        {sectors.map((sector) => (\n          <ToggleFilterButton\n            key={sector.id}\n            className=\"w-full justify-between\"\n            label={sector.name}\n            value={{ sector: sector.id }}\n          />\n        ))}\n      </FilterCategory>\n\n      <FilterCategory\n        icon={<Users className=\"h-4 w-4\" />}\n        label=\"Account Manager\"\n      >\n        <ToggleFilterButton\n          className=\"w-full justify-between\"\n          label={\"Me\"}\n          value={{ sales_id: identity?.id }}\n        />\n      </FilterCategory>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/CompanyList.tsx",
      "content": "import { useGetIdentity, useListContext } from \"ra-core\";\nimport { CreateButton } from \"@/components/admin/create-button\";\nimport { ExportButton } from \"@/components/admin/export-button\";\nimport { List } from \"@/components/admin/list\";\nimport { ListPagination } from \"@/components/admin/list-pagination\";\nimport { SortButton } from \"@/components/admin/sort-button\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Card } from \"@/components/ui/card\";\n\nimport { TopToolbar } from \"../layout/TopToolbar\";\nimport { CompanyEmpty } from \"./CompanyEmpty\";\nimport { CompanyListFilter } from \"./CompanyListFilter\";\nimport { ImageList } from \"./GridList\";\n\nexport const CompanyList = () => {\n  return (\n    <List\n      title={false}\n      perPage={25}\n      sort={{ field: \"name\", order: \"ASC\" }}\n      actions={<CompanyListActions />}\n      pagination={<ListPagination rowsPerPageOptions={[10, 25, 50, 100]} />}\n    >\n      <CompanyListLayout />\n    </List>\n  );\n};\n\nconst CompanyListLayout = () => {\n  const { data, isPending, filterValues } = useListContext();\n  const { identity } = useGetIdentity();\n  const hasFilters = filterValues && Object.keys(filterValues).length > 0;\n\n  // Show loading skeleton while identity or data is loading\n  if (!identity || isPending) {\n    return (\n      <div className=\"w-full flex flex-row gap-8\">\n        <div className=\"w-64\">\n          <Skeleton className=\"h-96 w-full\" />\n        </div>\n        <div className=\"flex flex-col flex-1 gap-4\">\n          <Card className=\"p-4\">\n            <div className=\"grid grid-cols-3 gap-4\">\n              <Skeleton className=\"h-48 w-full\" />\n              <Skeleton className=\"h-48 w-full\" />\n              <Skeleton className=\"h-48 w-full\" />\n              <Skeleton className=\"h-48 w-full\" />\n              <Skeleton className=\"h-48 w-full\" />\n              <Skeleton className=\"h-48 w-full\" />\n            </div>\n          </Card>\n        </div>\n      </div>\n    );\n  }\n\n  if (!data?.length && !hasFilters) return <CompanyEmpty />;\n\n  return (\n    <div className=\"w-full flex flex-row gap-8\">\n      <CompanyListFilter />\n      <div className=\"flex flex-col flex-1 gap-4\">\n        <ImageList />\n      </div>\n    </div>\n  );\n};\n\nconst CompanyListActions = () => {\n  return (\n    <TopToolbar>\n      <SortButton fields={[\"name\", \"created_at\", \"nb_contacts\"]} />\n      <ExportButton />\n      <CreateButton label=\"New Company\" />\n    </TopToolbar>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/CompanyInputs.tsx",
      "content": "import { required, useRecordContext } from \"ra-core\";\nimport { ReferenceInput } from \"@/components/admin/reference-input\";\nimport { TextInput } from \"@/components/admin/text-input\";\nimport { SelectInput } from \"@/components/admin/select-input\";\nimport { ArrayInput } from \"@/components/admin/array-input\";\nimport { SimpleFormIterator } from \"@/components/admin/simple-form-iterator\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { useIsMobile } from \"@/hooks/use-mobile\";\nimport { Collapsible, CollapsibleContent, CollapsibleTrigger } from \"@/components/ui/collapsible\";\nimport { ChevronDown } from \"lucide-react\";\nimport { useState } from \"react\";\n\nimport ImageEditorField from \"../misc/ImageEditorField\";\nimport { isLinkedinUrl } from \"../misc/isLinkedInUrl\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport type { Company, Sale } from \"../types\";\nimport { sizes } from \"./sizes\";\n\nconst isUrl = (url: string) => {\n  if (!url) return;\n  const UrlRegex = new RegExp(\n    /^(http:\\/\\/www\\.|https:\\/\\/www\\.|http:\\/\\/|https:\\/\\/)?[a-z0-9]+([-.]{1}[a-z0-9]+)*\\.[a-z]{2,5}(:[0-9]{1,5})?(\\/.*)?$/i,\n  );\n  if (!UrlRegex.test(url)) {\n    return \"Must be a valid URL\";\n  }\n};\n\nexport const CompanyInputs = () => {\n  const isMobile = useIsMobile();\n\n  return (\n    <div className=\"flex flex-col gap-4 p-1\">\n      <CompanyDisplayInputs />\n      <div className={`flex gap-6 ${isMobile ? \"flex-col\" : \"flex-row\"}`}>\n        <div className=\"flex flex-col gap-10 flex-1\">\n          <CompanyContactInputs />\n          <CompanyContextInputs />\n        </div>\n        <Separator orientation={isMobile ? \"horizontal\" : \"vertical\"} />\n        <div className=\"flex flex-col gap-8 flex-1\">\n          <CompanyAddressInputs />\n          <CompanyAdditionalInformationInputs />\n          <CompanyAccountManagerInput />\n        </div>\n      </div>\n      <Separator className=\"my-4\" />\n      <CompanyAdvancedSettings />\n    </div>\n  );\n};\n\nconst CompanyDisplayInputs = () => {\n  const record = useRecordContext<Company>();\n  return (\n    <div className=\"flex gap-4 flex-1 flex-row\">\n      <ImageEditorField\n        source=\"logo\"\n        type=\"avatar\"\n        width={60}\n        height={60}\n        emptyText={record?.name.charAt(0)}\n        linkPosition=\"bottom\"\n      />\n      <TextInput\n        source=\"name\"\n        className=\"w-full h-fit\"\n        validate={required()}\n        helperText={false}\n        placeholder=\"Company name\"\n      />\n    </div>\n  );\n};\n\nconst CompanyContactInputs = () => {\n  return (\n    <div className=\"flex flex-col gap-4\">\n      <h6 className=\"text-lg font-semibold\">Contact</h6>\n      <TextInput source=\"email\" helperText={false} type=\"email\" />\n      <TextInput source=\"website\" helperText={false} validate={isUrl} />\n      <TextInput source=\"phone_number\" helperText={false} />\n\n      <div className=\"mt-2\">\n        <p className=\"text-sm font-medium mb-2\">Social Profiles</p>\n        <div className=\"flex flex-col gap-3 ml-2\">\n          <TextInput\n            source=\"linkedin_url\"\n            label=\"LinkedIn\"\n            helperText={false}\n            validate={isLinkedinUrl}\n          />\n          <TextInput\n            source=\"social_profiles.x\"\n            label=\"Twitter/X\"\n            helperText={false}\n            validate={isUrl}\n          />\n          <TextInput\n            source=\"social_profiles.facebook\"\n            label=\"Facebook\"\n            helperText={false}\n            validate={isUrl}\n          />\n          <TextInput\n            source=\"social_profiles.github\"\n            label=\"GitHub\"\n            helperText={false}\n            validate={isUrl}\n          />\n        </div>\n      </div>\n\n      <TextInput source=\"logo_url\" label=\"Logo URL\" helperText={false} validate={isUrl} />\n    </div>\n  );\n};\n\nconst CompanyContextInputs = () => {\n  const {\n    companySectors,\n    companyLifecycleStages,\n    companyTypes,\n    companyRevenueRanges,\n  } = useConfigurationContext();\n\n  return (\n    <div className=\"flex flex-col gap-4\">\n      <h6 className=\"text-lg font-semibold\">Context</h6>\n\n      {/* Classification */}\n      {companyLifecycleStages && (\n        <SelectInput\n          source=\"lifecycle_stage\"\n          label=\"Lifecycle Stage\"\n          choices={companyLifecycleStages}\n          helperText={false}\n        />\n      )}\n      {companyTypes && (\n        <SelectInput\n          source=\"company_type\"\n          label=\"Company Type\"\n          choices={companyTypes}\n          helperText={false}\n        />\n      )}\n\n      {/* Industry & Sector */}\n      <SelectInput\n        source=\"sector\"\n        choices={companySectors.map((sector) => ({\n          id: sector,\n          name: sector,\n        }))}\n        helperText={false}\n      />\n      <TextInput source=\"industry\" helperText={false} />\n\n      {/* Size & Revenue */}\n      <SelectInput source=\"size\" choices={sizes} helperText={false} />\n      <TextInput source=\"employee_count\" label=\"Employee Count\" helperText={false} type=\"number\" />\n      <TextInput source=\"revenue\" helperText={false} />\n      {companyRevenueRanges && (\n        <SelectInput\n          source=\"revenue_range\"\n          label=\"Revenue Range\"\n          choices={companyRevenueRanges}\n          helperText={false}\n        />\n      )}\n\n      {/* Additional */}\n      <TextInput source=\"founded_year\" label=\"Founded Year\" helperText={false} type=\"number\" />\n      <TextInput source=\"tax_identifier\" helperText={false} />\n    </div>\n  );\n};\n\nconst CompanyAddressInputs = () => {\n  return (\n    <div className=\"flex flex-col gap-4\">\n      <h6 className=\"text-lg font-semibold\">Address</h6>\n      <TextInput source=\"address\" helperText={false} />\n      <TextInput source=\"city\" helperText={false} />\n      <TextInput source=\"zipcode\" helperText={false} />\n      <TextInput source=\"stateAbbr\" helperText={false} />\n      <TextInput source=\"country\" helperText={false} />\n    </div>\n  );\n};\n\nconst CompanyAdditionalInformationInputs = () => {\n  return (\n    <div className=\"flex flex-col gap-4\">\n      <h6 className=\"text-lg font-semibold\">Additional information</h6>\n      <TextInput source=\"description\" multiline helperText={false} />\n      <ArrayInput source=\"context_links\" helperText={false}>\n        <SimpleFormIterator disableReordering fullWidth getItemLabel={false}>\n          <TextInput\n            source=\"\"\n            label={false}\n            helperText={false}\n            validate={isUrl}\n          />\n        </SimpleFormIterator>\n      </ArrayInput>\n    </div>\n  );\n};\n\nconst CompanyAccountManagerInput = () => {\n  return (\n    <div className=\"flex flex-col gap-4\">\n      <h6 className=\"text-lg font-semibold\">Account manager</h6>\n      <ReferenceInput\n        source=\"sales_id\"\n        reference=\"sales\"\n        filter={{\n          \"disabled@neq\": true,\n        }}\n      >\n        <SelectInput\n          label=\"Account manager\"\n          helperText={false}\n          optionText={saleOptionRenderer}\n        />\n      </ReferenceInput>\n    </div>\n  );\n};\n\nconst saleOptionRenderer = (choice: Sale) =>\n  `${choice.first_name} ${choice.last_name}`;\n\nconst CompanyAdvancedSettings = () => {\n  const [isOpen, setIsOpen] = useState(false);\n  const { companyQualificationStatuses } = useConfigurationContext();\n\n  return (\n    <Collapsible open={isOpen} onOpenChange={setIsOpen}>\n      <CollapsibleTrigger className=\"flex items-center gap-2 text-sm font-medium text-muted-foreground hover:text-foreground transition-colors\">\n        <ChevronDown className={`h-4 w-4 transition-transform ${isOpen ? \"rotate-180\" : \"\"}`} />\n        Advanced Settings\n      </CollapsibleTrigger>\n      <CollapsibleContent className=\"mt-4\">\n        <div className=\"flex flex-col gap-6 pl-6 border-l-2 border-muted\">\n          {/* External System Integration */}\n          <div className=\"flex flex-col gap-4\">\n            <h6 className=\"text-sm font-semibold text-muted-foreground\">External System Integration</h6>\n            <TextInput\n              source=\"external_id\"\n              label=\"External ID\"\n              helperText={false}\n              placeholder=\"e.g., Salesforce Account ID\"\n            />\n            <SelectInput\n              source=\"external_system\"\n              label=\"External System\"\n              choices={[\n                { id: 'salesforce', name: 'Salesforce' },\n                { id: 'hubspot', name: 'HubSpot' },\n                { id: 'clearbit', name: 'Clearbit' },\n                { id: 'apollo', name: 'Apollo' },\n                { id: 'zoominfo', name: 'ZoomInfo' },\n              ]}\n              helperText={false}\n            />\n          </div>\n\n          {/* Data Quality */}\n          {companyQualificationStatuses && (\n            <div className=\"flex flex-col gap-4\">\n              <h6 className=\"text-sm font-semibold text-muted-foreground\">Data Quality</h6>\n              <SelectInput\n                source=\"qualification_status\"\n                label=\"Qualification Status\"\n                choices={companyQualificationStatuses}\n                helperText={false}\n              />\n            </div>\n          )}\n        </div>\n      </CollapsibleContent>\n    </Collapsible>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/CompanyHealthCard.tsx",
      "content": "import { formatDistance } from \"date-fns\";\nimport { Activity, HeartPulse } from \"lucide-react\";\nimport { useRecordContext } from \"ra-core\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Progress } from \"@/components/ui/progress\";\n\nimport { AsideSection } from \"../misc/AsideSection\";\nimport type { Company } from \"../types\";\n\nexport const CompanyHealthCard = () => {\n  const record = useRecordContext<Company>();\n  if (!record) return null;\n\n  const hasInternalHealth =\n    record.internal_heartbeat_score !== undefined ||\n    record.internal_heartbeat_status ||\n    record.days_since_last_activity !== undefined;\n\n  const hasExternalHealth =\n    record.external_heartbeat_status || record.external_heartbeat_checked_at;\n\n  if (!hasInternalHealth && !hasExternalHealth) {\n    return null;\n  }\n\n  return (\n    <AsideSection title=\"Company Health\">\n      {/* Internal Heartbeat (Engagement) */}\n      {hasInternalHealth && (\n        <div className=\"mb-4\">\n          <div className=\"flex items-center gap-2 mb-2\">\n            <Activity className=\"w-4 h-4 text-muted-foreground\" />\n            <span className=\"font-medium text-sm\">Internal Engagement</span>\n          </div>\n\n          {record.internal_heartbeat_score !== undefined && (\n            <div className=\"mb-2\">\n              <div className=\"flex items-center justify-between mb-1\">\n                <span className=\"text-xs text-muted-foreground\">\n                  Engagement Score\n                </span>\n                <span className=\"text-xs font-medium\">\n                  {record.internal_heartbeat_score}/100\n                </span>\n              </div>\n              <Progress\n                value={record.internal_heartbeat_score}\n                className=\"h-2\"\n              />\n            </div>\n          )}\n\n          {record.internal_heartbeat_status && (\n            <div className=\"mb-2\">\n              <InternalStatusBadge status={record.internal_heartbeat_status} />\n            </div>\n          )}\n\n          {record.days_since_last_activity !== undefined && (\n            <div className=\"text-xs text-muted-foreground\">\n              Last activity:{\" \"}\n              {record.days_since_last_activity === 0\n                ? \"Today\"\n                : record.days_since_last_activity === 1\n                  ? \"Yesterday\"\n                  : `${record.days_since_last_activity} days ago`}\n            </div>\n          )}\n\n          {record.internal_heartbeat_updated_at && (\n            <div className=\"text-xs text-muted-foreground mt-1\">\n              Updated{\" \"}\n              {formatDistance(\n                new Date(record.internal_heartbeat_updated_at),\n                new Date(),\n                { addSuffix: true },\n              )}\n            </div>\n          )}\n        </div>\n      )}\n\n      {/* External Heartbeat (Entity Health) */}\n      {hasExternalHealth && (\n        <div>\n          <div className=\"flex items-center gap-2 mb-2\">\n            <HeartPulse className=\"w-4 h-4 text-muted-foreground\" />\n            <span className=\"font-medium text-sm\">External Health</span>\n          </div>\n\n          {record.external_heartbeat_status && (\n            <div className=\"mb-2\">\n              <ExternalStatusBadge status={record.external_heartbeat_status} />\n            </div>\n          )}\n\n          {record.external_heartbeat_checked_at && (\n            <div className=\"text-xs text-muted-foreground\">\n              Last checked{\" \"}\n              {formatDistance(\n                new Date(record.external_heartbeat_checked_at),\n                new Date(),\n                { addSuffix: true },\n              )}\n            </div>\n          )}\n        </div>\n      )}\n    </AsideSection>\n  );\n};\n\nconst InternalStatusBadge = ({ status }: { status: string }) => {\n  const statusConfig: Record<\n    string,\n    { variant: \"default\" | \"secondary\" | \"outline\" | \"destructive\"; label: string }\n  > = {\n    engaged: { variant: \"default\", label: \"Engaged\" },\n    quiet: { variant: \"secondary\", label: \"Quiet\" },\n    at_risk: { variant: \"outline\", label: \"At Risk\" },\n    unresponsive: { variant: \"destructive\", label: \"Unresponsive\" },\n  };\n\n  const config = statusConfig[status] || {\n    variant: \"outline\" as const,\n    label: status,\n  };\n\n  return (\n    <Badge variant={config.variant} className=\"text-xs\">\n      {config.label}\n    </Badge>\n  );\n};\n\nconst ExternalStatusBadge = ({ status }: { status: string }) => {\n  const statusConfig: Record<\n    string,\n    { variant: \"default\" | \"secondary\" | \"outline\" | \"destructive\"; label: string }\n  > = {\n    healthy: { variant: \"default\", label: \"Healthy\" },\n    risky: { variant: \"outline\", label: \"Risky\" },\n    dead: { variant: \"destructive\", label: \"Dead\" },\n    unknown: { variant: \"secondary\", label: \"Unknown\" },\n  };\n\n  const config = statusConfig[status] || {\n    variant: \"outline\" as const,\n    label: status,\n  };\n\n  return (\n    <Badge variant={config.variant} className=\"text-xs\">\n      {config.label}\n    </Badge>\n  );\n};",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/CompanyEmpty.tsx",
      "content": "import { CreateButton } from \"@/components/admin/create-button\";\n\nimport useAppBarHeight from \"../misc/useAppBarHeight\";\n\nexport const CompanyEmpty = () => {\n  const appbarHeight = useAppBarHeight();\n  return (\n    <div\n      className=\"flex flex-col justify-center items-center gap-6\"\n      style={{\n        height: `calc(100dvh - ${appbarHeight}px)`,\n      }}\n    >\n      <img src=\"./img/empty.svg\" alt=\"No companies found\" />\n      <div className=\"flex flex-col gap-0 items-center\">\n        <h6 className=\"text-lg font-bold\">No companies found</h6>\n        <p className=\"text-sm text-center text-muted-foreground mb-4\">\n          It seems your company list is empty.\n        </p>\n      </div>\n      <div className=\"flex space-x-2\">\n        <CreateButton label=\"Create Company\" />\n      </div>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/CompanyEdit.tsx",
      "content": "import { EditBase, Form } from \"ra-core\";\nimport { Card, CardContent } from \"@/components/ui/card\";\n\nimport { CompanyInputs } from \"./CompanyInputs\";\nimport { CompanyAside } from \"./CompanyAside\";\nimport { FormToolbar } from \"../layout/FormToolbar\";\n\nexport const CompanyEdit = () => (\n  <EditBase\n    actions={false}\n    redirect=\"show\"\n    transform={(values) => {\n      // add https:// before website if not present\n      if (values.website && !values.website.startsWith(\"http\")) {\n        values.website = `https://${values.website}`;\n      }\n      return values;\n    }}\n  >\n    <div className=\"mt-2 flex gap-8\">\n      <Form className=\"flex flex-1 flex-col gap-4 pb-2\">\n        <Card>\n          <CardContent>\n            <CompanyInputs />\n            <FormToolbar />\n          </CardContent>\n        </Card>\n      </Form>\n\n      <CompanyAside link=\"show\" />\n    </div>\n  </EditBase>\n);\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/CompanyCreate.tsx",
      "content": "import { CreateBase, Form, useGetIdentity } from \"ra-core\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { CancelButton } from \"@/components/admin/cancel-button\";\nimport { SaveButton } from \"@/components/admin/form\";\nimport { FormToolbar } from \"@/components/admin/simple-form\";\n\nimport { CompanyInputs } from \"./CompanyInputs\";\n\nexport const CompanyCreate = () => {\n  const { identity } = useGetIdentity();\n  return (\n    <CreateBase\n      redirect=\"show\"\n      transform={(values) => {\n        // add https:// before website if not present\n        if (values.website && !values.website.startsWith(\"http\")) {\n          values.website = `https://${values.website}`;\n        }\n        return values;\n      }}\n    >\n      <div className=\"mt-2 flex lg:mr-72\">\n        <div className=\"flex-1\">\n          <Form defaultValues={{ sales_id: identity?.id }}>\n            <Card>\n              <CardContent>\n                <CompanyInputs />\n                <FormToolbar>\n                  <div className=\"flex flex-row gap-2 justify-end\">\n                    <CancelButton />\n                    <SaveButton label=\"Create Company\" />\n                  </div>\n                </FormToolbar>\n              </CardContent>\n            </Card>\n          </Form>\n        </div>\n      </div>\n    </CreateBase>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/CompanyCard.tsx",
      "content": "import { DollarSign } from \"lucide-react\";\nimport { Link } from \"react-router\";\nimport { useCreatePath, useListContext, useRecordContext } from \"ra-core\";\nimport { ReferenceManyField } from \"@/components/admin/reference-many-field\";\nimport { Card } from \"@/components/ui/card\";\n\nimport { Avatar as ContactAvatar } from \"../contacts/Avatar\";\nimport type { Company } from \"../types\";\nimport { CompanyAvatar } from \"./CompanyAvatar\";\n\nexport const CompanyCard = (props: { record?: Company }) => {\n  const createPath = useCreatePath();\n  const record = useRecordContext<Company>(props);\n  if (!record) return null;\n\n  return (\n    <Link\n      to={createPath({\n        resource: \"companies\",\n        id: record.id,\n        type: \"show\",\n      })}\n      className=\"no-underline\"\n    >\n      <Card className=\"h-[200px] flex flex-col justify-between p-4 hover:bg-muted\">\n        <div className=\"flex flex-col items-center gap-1\">\n          <CompanyAvatar />\n          <div className=\"text-center mt-1\">\n            <h6 className=\"text-sm font-medium\">{record.name}</h6>\n            <p className=\"text-xs text-muted-foreground\">{record.sector}</p>\n          </div>\n        </div>\n        <div className=\"flex flex-row w-full justify-between gap-2\">\n          <div className=\"flex items-center\">\n            {record.nb_contacts ? (\n              <ReferenceManyField reference=\"contacts\" target=\"company_id\">\n                <AvatarGroupIterator />\n              </ReferenceManyField>\n            ) : null}\n          </div>\n          {record.nb_deals ? (\n            <div className=\"flex items-center ml-2 gap-0.5\">\n              <DollarSign className=\"w-4 h-4 text-muted-foreground\" />\n              <span className=\"text-sm font-medium\">{record.nb_deals}</span>\n              <span className=\"text-xs text-muted-foreground\">\n                {record.nb_deals\n                  ? record.nb_deals > 1\n                    ? \"deals\"\n                    : \"deal\"\n                  : \"deal\"}\n              </span>\n            </div>\n          ) : null}\n        </div>\n      </Card>\n    </Link>\n  );\n};\n\nconst AvatarGroupIterator = () => {\n  const { data, total, error, isPending } = useListContext();\n  if (isPending || error) return null;\n\n  const MAX_AVATARS = 3;\n  return (\n    <div className=\"*:data-[slot=avatar]:ring-background flex -space-x-0.5 *:data-[slot=avatar]:ring-2 *:data-[slot=avatar]:grayscale-50\">\n      {data.slice(0, MAX_AVATARS).map((record: any) => (\n        <ContactAvatar\n          key={record.id}\n          record={record}\n          width={25}\n          height={25}\n          title={`${record.first_name} ${record.last_name}`}\n        />\n      ))}\n      {total > MAX_AVATARS && (\n        <span\n          className=\"relative flex size-8 shrink-0 overflow-hidden rounded-full w-[25px] h-[25px]\"\n          data-slot=\"avatar\"\n        >\n          <span className=\"bg-muted flex size-full items-center justify-center rounded-full text-[10px]\">\n            +{total - MAX_AVATARS}\n          </span>\n        </span>\n      )}\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/CompanyAvatar.tsx",
      "content": "import { useRecordContext } from \"ra-core\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\n\nimport type { Company } from \"../types\";\n\nexport const CompanyAvatar = (props: {\n  record?: Company;\n  width?: 20 | 40;\n  height?: 20 | 40;\n}) => {\n  const { width = 40 } = props;\n  const record = useRecordContext<Company>(props);\n  if (!record) return null;\n\n  const sizeClass = width !== 40 ? `w-[20px] h-[20px]` : \"w-10 h-10\";\n\n  return (\n    <Avatar className={sizeClass}>\n      <AvatarImage\n        src={record.logo?.src}\n        alt={record.name}\n        className=\"object-contain\"\n      />\n      <AvatarFallback className={width !== 40 ? \"text-xs\" : \"text-sm\"}>\n        {record.name.charAt(0)}\n      </AvatarFallback>\n    </Avatar>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/CompanyAside.tsx",
      "content": "import { Globe, Linkedin, Phone } from \"lucide-react\";\nimport { useRecordContext } from \"ra-core\";\nimport { EditButton } from \"@/components/admin/edit-button\";\nimport { DeleteButton } from \"@/components/admin/delete-button\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { ShowButton } from \"@/components/admin/show-button\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { DateField } from \"@/components/admin/date-field\";\nimport { UrlField } from \"@/components/admin/url-field\";\nimport { SelectField } from \"@/components/admin/select-field\";\n\nimport { AsideSection } from \"../misc/AsideSection\";\nimport { SaleName } from \"../sales/SaleName\";\nimport type { Company } from \"../types\";\nimport { sizes } from \"./sizes\";\nimport { CompanyMergeButton } from \"./CompanyMergeButton\";\nimport { CompanyHealthCard } from \"./CompanyHealthCard\";\n\ninterface CompanyAsideProps {\n  link?: string;\n}\n\nexport const CompanyAside = ({ link = \"edit\" }: CompanyAsideProps) => {\n  const record = useRecordContext<Company>();\n  if (!record) return null;\n\n  return (\n    <div className=\"hidden sm:block w-[250px] min-w-[250px] space-y-4\">\n      <div className=\"flex flex-row space-x-1\">\n        {link === \"edit\" ? (\n          <EditButton label=\"Edit Company\" />\n        ) : (\n          <ShowButton label=\"Show Company\" />\n        )}\n      </div>\n\n      <CompanyHealthCard />\n\n      <CompanyInfo record={record} />\n\n      <AddressInfo record={record} />\n\n      <ContextInfo record={record} />\n\n      <AdditionalInfo record={record} />\n\n      {link !== \"edit\" && (\n        <>\n          <div className=\"mt-6 pt-6 border-t hidden sm:flex flex-col gap-2 items-start\">\n            <CompanyMergeButton />\n          </div>\n          <div className=\"mt-6 pt-6 border-t hidden sm:flex flex-col gap-2 items-start\">\n            <DeleteButton\n              className=\"h-6 cursor-pointer hover:bg-destructive/10! text-destructive! border-destructive! focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40\"\n              size=\"sm\"\n            />\n          </div>\n        </>\n      )}\n    </div>\n  );\n};\n\nconst CompanyInfo = ({ record }: { record: Company }) => {\n  if (!record.website && !record.linkedin_url && !record.phone_number) {\n    return null;\n  }\n\n  return (\n    <AsideSection title=\"Company Info\">\n      {record.website && (\n        <div className=\"flex flex-row items-center gap-1 min-h-[24px]\">\n          <Globe className=\"w-4 h-4\" />\n          <UrlField\n            source=\"website\"\n            target=\"_blank\"\n            rel=\"noopener\"\n            content={record.website\n              .replace(\"http://\", \"\")\n              .replace(\"https://\", \"\")}\n          />\n        </div>\n      )}\n      {record.linkedin_url && (\n        <div className=\"flex flex-row items-center gap-1 min-h-[24px]\">\n          <Linkedin className=\"w-4 h-4\" />\n          <a\n            className=\"underline hover:no-underline\"\n            href={record.linkedin_url}\n            target=\"_blank\"\n            rel=\"noopener noreferrer\"\n            title={record.linkedin_url}\n          >\n            LinkedIn\n          </a>\n        </div>\n      )}\n      {record.phone_number && (\n        <div className=\"flex flex-row items-center gap-1 min-h-[24px]\">\n          <Phone className=\"w-4 h-4\" />\n          <TextField source=\"phone_number\" />\n        </div>\n      )}\n    </AsideSection>\n  );\n};\n\nconst ContextInfo = ({ record }: { record: Company }) => {\n  if (!record.revenue && !record.id) {\n    return null;\n  }\n\n  return (\n    <AsideSection title=\"Context\">\n      {record.sector && (\n        <span>\n          Sector: <TextField source=\"sector\" />\n        </span>\n      )}\n      {record.size && (\n        <span>\n          Size: <SelectField source=\"size\" choices={sizes} />\n        </span>\n      )}\n      {record.revenue && (\n        <span>\n          Revenue: <TextField source=\"revenue\" />\n        </span>\n      )}\n      {record.tax_identifier && (\n        <span>\n          Tax Identifier: <TextField source=\"tax_identifier\" />\n        </span>\n      )}\n    </AsideSection>\n  );\n};\n\nconst AddressInfo = ({ record }: { record: Company }) => {\n  if (!record.address && !record.city && !record.zipcode && !record.stateAbbr) {\n    return null;\n  }\n\n  return (\n    <AsideSection title=\"Main Address\" noGap>\n      <TextField source=\"address\" />\n      <TextField source=\"city\" />\n      <TextField source=\"zipcode\" />\n      <TextField source=\"stateAbbr\" />\n      <TextField source=\"country\" />\n    </AsideSection>\n  );\n};\n\nconst AdditionalInfo = ({ record }: { record: Company }) => {\n  if (\n    !record.created_at &&\n    !record.sales_id &&\n    !record.description &&\n    !record.context_links\n  ) {\n    return null;\n  }\n  const getBaseURL = (url: string) => {\n    const urlObject = new URL(url.startsWith(\"http\") ? url : `https://${url}`);\n    return urlObject.hostname;\n  };\n\n  return (\n    <AsideSection title=\"Additional Info\">\n      {record.description && (\n        <p className=\"text-sm  mb-1\">{record.description}</p>\n      )}\n      {record.context_links && Array.isArray(record.context_links) && (\n        <div className=\"flex flex-col\">\n          {record.context_links.map((link, index) =>\n            link ? (\n              <a\n                key={index}\n                className=\"text-sm underline hover:no-underline mb-1\"\n                href={link.startsWith(\"http\") ? link : `https://${link}`}\n                target=\"_blank\"\n                rel=\"noopener noreferrer\"\n                title={link}\n              >\n                {getBaseURL(link)}\n              </a>\n            ) : null,\n          )}\n        </div>\n      )}\n      {record.sales_id !== null && (\n        <div className=\"inline-flex text-sm text-muted-foreground mb-1\">\n          Followed by&nbsp;\n          <ReferenceField source=\"sales_id\" reference=\"sales\" record={record}>\n            <SaleName />\n          </ReferenceField>\n        </div>\n      )}\n      {record.created_at && (\n        <p className=\"text-sm text-muted-foreground mb-1\">\n          Added on{\" \"}\n          <DateField\n            source=\"created_at\"\n            record={record}\n            options={{\n              year: \"numeric\",\n              month: \"long\",\n              day: \"numeric\",\n            }}\n          />\n        </p>\n      )}\n    </AsideSection>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/AutocompleteCompanyInput.tsx",
      "content": "import { useCreate, useGetIdentity, useNotify } from \"ra-core\";\nimport { AutocompleteInput } from \"@/components/admin/autocomplete-input\";\nimport type { InputProps } from \"ra-core\";\n\nexport const AutocompleteCompanyInput = ({\n  validate,\n}: Pick<InputProps, \"validate\">) => {\n  const [create] = useCreate();\n  const { identity } = useGetIdentity();\n  const notify = useNotify();\n  const handleCreateCompany = async (name?: string) => {\n    if (!name) return;\n    try {\n      const newCompany = await create(\n        \"companies\",\n        {\n          data: {\n            name,\n            sales_id: identity?.id,\n            created_at: new Date().toISOString(),\n          },\n        },\n        { returnPromise: true },\n      );\n      return newCompany;\n    } catch {\n      notify(\"An error occurred while creating the company\", {\n        type: \"error\",\n      });\n    }\n  };\n\n  return (\n    <AutocompleteInput\n      optionText=\"name\"\n      helperText={false}\n      onCreate={handleCreateCompany}\n      createItemLabel=\"Create %{item}\"\n      createLabel=\"Start typing to create a new company\"\n      validate={validate}\n    />\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLogNote.tsx",
      "content": "import { Fragment, type ReactNode } from \"react\";\n\ntype ActivityLogContactNoteCreatedProps = {\n  header: ReactNode;\n  text: string;\n};\n\nexport function ActivityLogNote({\n  header,\n  text,\n}: ActivityLogContactNoteCreatedProps) {\n  if (!text) {\n    return null;\n  }\n  const paragraphs = text.split(\"\\n\");\n\n  return (\n    <div className=\"p-0\">\n      <div className=\"flex flex-col space-y-2 w-full\">\n        <div className=\"flex flex-row space-x-1 items-center w-full\">\n          {header}\n        </div>\n        <div>\n          <div className=\"text-sm line-clamp-3 overflow-hidden\">\n            {paragraphs.map((paragraph: string, index: number) => (\n              <Fragment key={index}>\n                {paragraph}\n                {index < paragraphs.length - 1 && <br />}\n              </Fragment>\n            ))}\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLogIterator.tsx",
      "content": "import { Fragment, useState } from \"react\";\n\nimport { Separator } from \"@/components/ui/separator\";\nimport {\n  COMPANY_CREATED,\n  COMPANY_NOTE_CREATED,\n  CONTACT_CREATED,\n  CONTACT_NOTE_CREATED,\n  DEAL_CREATED,\n  DEAL_NOTE_CREATED,\n} from \"../consts\";\nimport type { Activity } from \"../types\";\nimport { ActivityLogCompanyCreated } from \"./ActivityLogCompanyCreated\";\nimport { ActivityLogCompanyNoteCreated } from \"./ActivityLogCompanyNoteCreated\";\nimport { ActivityLogContactCreated } from \"./ActivityLogContactCreated\";\nimport { ActivityLogContactNoteCreated } from \"./ActivityLogContactNoteCreated\";\nimport { ActivityLogDealCreated } from \"./ActivityLogDealCreated\";\nimport { ActivityLogDealNoteCreated } from \"./ActivityLogDealNoteCreated\";\n\ntype ActivityLogIteratorProps = {\n  activities: Activity[];\n  pageSize: number;\n};\n\nexport function ActivityLogIterator({\n  activities,\n  pageSize,\n}: ActivityLogIteratorProps) {\n  const [activitiesDisplayed, setActivityDisplayed] = useState(pageSize);\n\n  const filteredActivities = activities.slice(0, activitiesDisplayed);\n\n  return (\n    <div className=\"space-y-4\">\n      {filteredActivities.map((activity, index) => (\n        <Fragment key={index}>\n          <ActivityItem key={activity.id} activity={activity} />\n          <Separator />\n        </Fragment>\n      ))}\n\n      {activitiesDisplayed < activities.length && (\n        <a\n          href=\"#\"\n          onClick={(e) => {\n            e.preventDefault();\n            setActivityDisplayed(\n              (activitiesDisplayed) => activitiesDisplayed + pageSize,\n            );\n          }}\n          className=\"flex w-full justify-center text-sm underline hover:no-underline\"\n        >\n          Load more activity\n        </a>\n      )}\n    </div>\n  );\n}\n\nfunction ActivityItem({ activity }: { activity: Activity }) {\n  if (activity.type === COMPANY_CREATED) {\n    return <ActivityLogCompanyCreated activity={activity} />;\n  }\n\n  if (activity.type === CONTACT_CREATED) {\n    return <ActivityLogContactCreated activity={activity} />;\n  }\n\n  if (activity.type === CONTACT_NOTE_CREATED) {\n    return <ActivityLogContactNoteCreated activity={activity} />;\n  }\n\n  if (activity.type === DEAL_CREATED) {\n    return <ActivityLogDealCreated activity={activity} />;\n  }\n\n  if (activity.type === DEAL_NOTE_CREATED) {\n    return <ActivityLogDealNoteCreated activity={activity} />;\n  }\n\n  if (activity.type === COMPANY_NOTE_CREATED) {\n    return <ActivityLogCompanyNoteCreated activity={activity} />;\n  }\n\n  return null;\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLogDealNoteCreated.tsx",
      "content": "import type { RaRecord } from \"ra-core\";\n\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { CompanyAvatar } from \"../companies/CompanyAvatar\";\nimport { RelativeDate } from \"../misc/RelativeDate\";\nimport { SaleName } from \"../sales/SaleName\";\nimport type { ActivityDealNoteCreated } from \"../types\";\nimport { useActivityLogContext } from \"./ActivityLogContext\";\nimport { ActivityLogNote } from \"./ActivityLogNote\";\n\ntype ActivityLogDealNoteCreatedProps = {\n  activity: RaRecord & ActivityDealNoteCreated;\n};\n\nexport function ActivityLogDealNoteCreated({\n  activity,\n}: ActivityLogDealNoteCreatedProps) {\n  const context = useActivityLogContext();\n  const { dealNote } = activity;\n  return (\n    <ActivityLogNote\n      header={\n        <div className=\"flex flex-row items-center gap-2 flex-grow\">\n          <ReferenceField\n            source=\"deal_id\"\n            reference=\"deals\"\n            record={dealNote}\n            link={false}\n          >\n            <ReferenceField\n              source=\"company_id\"\n              reference=\"companies\"\n              link={false}\n            >\n              <CompanyAvatar width={20} height={20} />\n            </ReferenceField>\n          </ReferenceField>\n\n          <span className=\"text-sm text-muted-foreground flex-grow inline-flex\">\n            <ReferenceField\n              source=\"sales_id\"\n              reference=\"sales\"\n              record={activity}\n              link={false}\n            >\n              <SaleName />\n            </ReferenceField>\n            &nbsp;added a note about deal&nbsp;\n            <ReferenceField\n              source=\"deal_id\"\n              reference=\"deals\"\n              record={dealNote}\n              link=\"show\"\n            />\n            {context !== \"company\" && (\n              <>\n                {\" at \"}\n                <ReferenceField\n                  source=\"deal_id\"\n                  reference=\"deals\"\n                  record={dealNote}\n                  link={false}\n                >\n                  <ReferenceField\n                    source=\"company_id\"\n                    reference=\"companies\"\n                    link=\"show\"\n                  />\n                </ReferenceField>{\" \"}\n              </>\n            )}\n          </span>\n\n          {context === \"company\" && (\n            <span className=\"text-muted-foreground text-sm\">\n              <RelativeDate date={activity.date} />\n            </span>\n          )}\n        </div>\n      }\n      text={dealNote.text}\n    />\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLogDealCreated.tsx",
      "content": "import { Link } from \"react-router\";\nimport type { RaRecord } from \"ra-core\";\n\nimport { RelativeDate } from \"../misc/RelativeDate\";\nimport type { ActivityDealCreated } from \"../types\";\nimport { useActivityLogContext } from \"./ActivityLogContext\";\n\ntype ActivityLogDealCreatedProps = {\n  activity: RaRecord & ActivityDealCreated;\n};\n\nexport function ActivityLogDealCreated({\n  activity,\n}: ActivityLogDealCreatedProps) {\n  const context = useActivityLogContext();\n  const { deal } = activity;\n  return (\n    <div className=\"p-0\">\n      <div className=\"flex flex-row space-x-1 items-center w-full\">\n        <div className=\"w-5 h-5 bg-gray-300 rounded-full\" />\n        <div className=\"text-sm text-muted-foreground flex-grow\">\n          <span className=\"text-muted-foreground text-sm\">\n            Sales ID: {activity.sales_id}\n          </span>{\" \"}\n          added deal <Link to={`/deals/${deal.id}/show`}>{deal.name}</Link>{\" \"}\n          {context !== \"company\" && (\n            <>\n              to company {activity.company_id}{\" \"}\n              <RelativeDate date={activity.date} />\n            </>\n          )}\n        </div>\n        {context === \"company\" && (\n          <span className=\"text-muted-foreground text-sm\">\n            <RelativeDate date={activity.date} />\n          </span>\n        )}\n      </div>\n    </div>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLogContext.tsx",
      "content": "import { createContext, useContext } from \"react\";\n\nexport type activityLogContextValue = \"company\" | \"contact\" | \"deal\" | \"all\";\n\nexport const ActivityLogContext = createContext<activityLogContextValue>(\"all\");\n\nexport const useActivityLogContext = () => {\n  const context = useContext(ActivityLogContext);\n\n  return context;\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLogContactNoteCreated.tsx",
      "content": "import { useRecordContext } from \"ra-core\";\n\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { Avatar } from \"../contacts/Avatar\";\nimport { RelativeDate } from \"../misc/RelativeDate\";\nimport { SaleName } from \"../sales/SaleName\";\nimport type { ActivityContactNoteCreated, Contact } from \"../types\";\nimport { useActivityLogContext } from \"./ActivityLogContext\";\nimport { ActivityLogNote } from \"./ActivityLogNote\";\n\ntype ActivityLogContactNoteCreatedProps = {\n  activity: ActivityContactNoteCreated;\n};\n\nfunction ContactAvatar() {\n  const record = useRecordContext<Contact>();\n  return <Avatar width={20} height={20} record={record} />;\n}\n\nexport function ActivityLogContactNoteCreated({\n  activity,\n}: ActivityLogContactNoteCreatedProps) {\n  const context = useActivityLogContext();\n  const { contactNote } = activity;\n  return (\n    <ActivityLogNote\n      header={\n        <div className=\"flex items-center gap-2 w-full\">\n          <ReferenceField\n            source=\"contact_id\"\n            reference=\"contacts\"\n            record={activity.contactNote}\n          >\n            <ContactAvatar />\n          </ReferenceField>\n\n          <div className=\"flex flex-row flex-grow\">\n            <div className=\"text-sm text-muted-foreground flex-grow\">\n              <span className=\"text-muted-foreground text-sm inline-flex\">\n                <ReferenceField\n                  source=\"sales_id\"\n                  reference=\"sales\"\n                  record={activity}\n                >\n                  <SaleName />\n                </ReferenceField>\n                <ReferenceField\n                  source=\"contact_id\"\n                  reference=\"contacts\"\n                  record={activity.contactNote}\n                >\n                  &nbsp;added a note about <TextField source=\"first_name\" />\n                  &nbsp;\n                  <TextField source=\"last_name\" />\n                </ReferenceField>\n              </span>\n            </div>\n\n            {context === \"company\" && (\n              <span className=\"text-muted-foreground text-sm\">\n                <RelativeDate date={activity.date} />\n              </span>\n            )}\n          </div>\n        </div>\n      }\n      text={contactNote.text}\n    />\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLogContactCreated.tsx",
      "content": "import { Link } from \"react-router\";\n\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { Avatar } from \"../contacts/Avatar\";\nimport { RelativeDate } from \"../misc/RelativeDate\";\nimport { SaleName } from \"../sales/SaleName\";\nimport type { ActivityContactCreated } from \"../types\";\nimport { useActivityLogContext } from \"./ActivityLogContext\";\n\ntype ActivityLogContactCreatedProps = {\n  activity: ActivityContactCreated;\n};\n\nexport function ActivityLogContactCreated({\n  activity,\n}: ActivityLogContactCreatedProps) {\n  const context = useActivityLogContext();\n  const { contact } = activity;\n  return (\n    <div className=\"p-0\">\n      <div className=\"flex flex-row gap-2 items-center w-full\">\n        <Avatar width={20} height={20} record={contact} />\n        <span className=\"text-muted-foreground text-sm inline-flex  flex-grow\">\n          <ReferenceField source=\"sales_id\" reference=\"sales\" record={activity}>\n            <SaleName />\n          </ReferenceField>\n          &nbsp;added&nbsp;\n          <Link to={`/contacts/${contact.id}/show`}>\n            {contact.first_name}&nbsp;{contact.last_name}\n          </Link>\n          &nbsp;\n          {context !== \"company\" && <>to company {activity.company_id}</>}\n        </span>\n        {context === \"company\" && (\n          <span className=\"text-muted-foreground text-sm\">\n            <RelativeDate date={activity.date} />\n          </span>\n        )}\n      </div>\n    </div>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLogCompanyNoteCreated.tsx",
      "content": "import { ReferenceField } from \"@/components/admin/reference-field\";\n\nimport { CompanyAvatar } from \"../companies/CompanyAvatar\";\nimport { RelativeDate } from \"../misc/RelativeDate\";\nimport { SaleName } from \"../sales/SaleName\";\nimport type { ActivityCompanyNoteCreated } from \"../types\";\nimport { useActivityLogContext } from \"./ActivityLogContext\";\nimport { ActivityLogNote } from \"./ActivityLogNote\";\n\ntype ActivityLogCompanyNoteCreatedProps = {\n  activity: ActivityCompanyNoteCreated;\n};\n\nexport function ActivityLogCompanyNoteCreated({\n  activity,\n}: ActivityLogCompanyNoteCreatedProps) {\n  const context = useActivityLogContext();\n  const { companyNote } = activity;\n  return (\n    <ActivityLogNote\n      header={\n        <div className=\"flex flex-row items-center gap-2 flex-grow\">\n          <ReferenceField\n            source=\"company_id\"\n            reference=\"companies\"\n            record={companyNote}\n            link={false}\n          >\n            <CompanyAvatar width={20} height={20} />\n          </ReferenceField>\n\n          <span className=\"text-sm text-muted-foreground flex-grow inline-flex\">\n            <ReferenceField\n              source=\"sales_id\"\n              reference=\"sales\"\n              record={activity}\n              link={false}\n            >\n              <SaleName />\n            </ReferenceField>\n            &nbsp;added a note about&nbsp;\n            <ReferenceField\n              source=\"company_id\"\n              reference=\"companies\"\n              record={companyNote}\n              link=\"show\"\n            />\n          </span>\n\n          {context === \"company\" && (\n            <span className=\"text-muted-foreground text-sm\">\n              <RelativeDate date={activity.date} />\n            </span>\n          )}\n        </div>\n      }\n      text={companyNote.text}\n    />\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLogCompanyCreated.tsx",
      "content": "import { Link } from \"react-router\";\n\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { CompanyAvatar } from \"../companies/CompanyAvatar\";\nimport { RelativeDate } from \"../misc/RelativeDate\";\nimport { SaleName } from \"../sales/SaleName\";\nimport type { ActivityCompanyCreated } from \"../types\";\nimport { useActivityLogContext } from \"./ActivityLogContext\";\n\ntype ActivityLogCompanyCreatedProps = {\n  activity: ActivityCompanyCreated;\n};\n\nexport function ActivityLogCompanyCreated({\n  activity,\n}: ActivityLogCompanyCreatedProps) {\n  const context = useActivityLogContext();\n  const { company } = activity;\n  return (\n    <div className=\"p-0\">\n      <div className=\"flex flex-row space-x-1 items-center w-full\">\n        <CompanyAvatar width={20} height={20} record={company} />\n\n        <div className=\"text-sm text-muted-foreground flex-grow\">\n          <span className=\"text-muted-foreground text-sm inline-flex\">\n            <ReferenceField\n              source=\"sales_id\"\n              reference=\"sales\"\n              record={activity}\n            >\n              <SaleName />\n            </ReferenceField>\n          </span>\n          &nbsp;added company &nbsp;\n          <Link to={`/companies/${company.id}/show`}>{company.name}</Link>\n          {context === \"all\" && (\n            <>\n              <RelativeDate date={activity.date} />\n            </>\n          )}\n        </div>\n        {context === \"company\" && (\n          <span className=\"text-muted-foreground text-sm\">\n            <RelativeDate date={activity.date} />\n          </span>\n        )}\n      </div>\n    </div>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLog.tsx",
      "content": "import { Alert } from \"@/components/ui/alert\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { type Identifier, useDataProvider } from \"ra-core\";\n\nimport type { CrmDataProvider } from \"../providers/types\";\nimport { ActivityLogContext } from \"./ActivityLogContext\";\nimport { ActivityLogIterator } from \"./ActivityLogIterator\";\n\ntype ActivityLogProps = {\n  companyId?: Identifier;\n  pageSize?: number;\n  context?: \"company\" | \"contact\" | \"deal\" | \"all\";\n};\n\nexport function ActivityLog({\n  companyId,\n  pageSize = 20,\n  context = \"all\",\n}: ActivityLogProps) {\n  const dataProvider = useDataProvider<CrmDataProvider>();\n  const { data, isPending, error } = useQuery({\n    queryKey: [\"activityLog\", companyId],\n    queryFn: () => dataProvider.getActivityLog(companyId),\n  });\n\n  if (isPending) {\n    return (\n      <div className=\"mt-1\">\n        {Array.from({ length: 5 }).map((_, index) => (\n          <div className=\"space-y-2 mt-1\" key={index}>\n            <div className=\"flex flex-row space-x-2 items-center\">\n              <Skeleton className=\"w-5 h-5 rounded-full\" />\n              <Skeleton className=\"w-full h-4\" />\n            </div>\n            <Skeleton className=\"w-full h-12\" />\n            <Separator />\n          </div>\n        ))}\n      </div>\n    );\n  }\n\n  if (error) {\n    return <Alert>Failed to load activity log</Alert>;\n  }\n\n  return (\n    <ActivityLogContext.Provider value={context}>\n      <ActivityLogIterator activities={data} pageSize={pageSize} />\n    </ActivityLogContext.Provider>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activities/FileUpload.tsx",
      "content": "import { useState, useCallback, useEffect } from 'react';\nimport { useDropzone } from 'react-dropzone';\nimport { useNotify, useGetIdentity, useGetList } from 'ra-core';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Progress } from '@/components/ui/progress';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Label } from '@/components/ui/label';\nimport { Upload, FileIcon, CheckCircle, XCircle, Loader2 } from 'lucide-react';\nimport { getSupabaseConfig } from '@/lib/supabase-config';\n\ninterface UploadFile {\n  file: File;\n  status: 'pending' | 'uploading' | 'success' | 'error';\n  progress: number;\n  activityId?: string;\n  error?: string;\n}\n\ninterface IngestionProvider {\n  id: string;\n  name: string;\n  provider_code: string;\n  ingestion_key: string;\n}\n\nexport const FileUpload = () => {\n  const [files, setFiles] = useState<UploadFile[]>([]);\n  const [activityType, setActivityType] = useState<string>('note');\n  const [selectedProvider, setSelectedProvider] = useState<string>('');\n\n  const notify = useNotify();\n  const { data: identity } = useGetIdentity();\n\n  // Load ingestion providers using React-Admin hook (cleaner than manual useEffect)\n  const { data: providers = [] } = useGetList<IngestionProvider>('ingestion_providers', {\n    filter: { is_active: true },\n    pagination: { page: 1, perPage: 100 },\n    sort: { field: 'created_at', order: 'DESC' }\n  });\n\n  // Auto-select first provider when data loads\n  useEffect(() => {\n    if (providers.length > 0 && !selectedProvider) {\n      setSelectedProvider(providers[0].id);\n    }\n  }, [providers, selectedProvider]);\n\n  const onDrop = useCallback((acceptedFiles: File[]) => {\n    const newFiles = acceptedFiles.map(file => ({\n      file,\n      status: 'pending' as const,\n      progress: 0\n    }));\n\n    setFiles(prev => [...prev, ...newFiles]);\n  }, []);\n\n  const { getRootProps, getInputProps, isDragActive } = useDropzone({\n    onDrop,\n    // Accept all file types (removed restrictive accept prop)\n    // Only block dangerous executable files for security\n    validator: (file) => {\n      // Guard against missing file name\n      if (!file.name) {\n        return null; // Allow files without names (edge case)\n      }\n\n      const dangerous = ['.exe', '.bat', '.cmd', '.com', '.scr', '.vbs', '.ps1', '.msi'];\n      const fileName = file.name.toLowerCase();\n      const dotIndex = fileName.lastIndexOf('.');\n\n      // If no extension, allow the file\n      if (dotIndex === -1) {\n        return null;\n      }\n\n      const ext = fileName.slice(dotIndex);\n\n      if (dangerous.includes(ext)) {\n        return {\n          code: 'dangerous-file',\n          message: 'Executable files are not allowed for security reasons'\n        };\n      }\n      return null;\n    }\n  });\n\n  const uploadFile = async (index: number) => {\n    const fileToUpload = files[index];\n    const provider = providers.find(p => p.id === selectedProvider);\n\n    if (!provider) {\n      notify('Please select an ingestion channel', { type: 'error' });\n      return;\n    }\n\n    const config = getSupabaseConfig();\n    const webhookUrl = `${config.url}/functions/v1/ingest-activity`;\n\n    // Update status to uploading\n    setFiles(prev => prev.map((f, i) =>\n      i === index ? { ...f, status: 'uploading', progress: 0 } : f\n    ));\n\n    try {\n      const formData = new FormData();\n      formData.append('file', fileToUpload.file);\n      formData.append('type', activityType);\n      formData.append('from', identity?.email || 'manual-upload');\n      formData.append('subject', `File Upload: ${fileToUpload.file.name}`);\n\n      const xhr = new XMLHttpRequest();\n\n      // Track upload progress\n      xhr.upload.addEventListener('progress', (e) => {\n        if (e.lengthComputable) {\n          const progress = Math.round((e.loaded / e.total) * 100);\n          setFiles(prev => prev.map((f, i) =>\n            i === index ? { ...f, progress } : f\n          ));\n        }\n      });\n\n      xhr.addEventListener('load', () => {\n        if (xhr.status >= 200 && xhr.status < 300) {\n          const response = JSON.parse(xhr.responseText);\n          setFiles(prev => prev.map((f, i) =>\n            i === index ? { ...f, status: 'success', progress: 100, activityId: response.id } : f\n          ));\n          notify(`File uploaded: ${fileToUpload.file.name}`, { type: 'success' });\n        } else {\n          throw new Error(`Upload failed with status ${xhr.status}`);\n        }\n      });\n\n      xhr.addEventListener('error', () => {\n        setFiles(prev => prev.map((f, i) =>\n          i === index ? { ...f, status: 'error', error: 'Network error' } : f\n        ));\n        notify(`Upload failed: ${fileToUpload.file.name}`, { type: 'error' });\n      });\n\n      xhr.open('POST', webhookUrl);\n      // Security: Move ingestion key from URL to header (prevents key leakage in logs)\n      xhr.setRequestHeader('x-ingestion-key', provider.ingestion_key);\n      xhr.send(formData);\n\n    } catch (error) {\n      setFiles(prev => prev.map((f, i) =>\n        i === index ? { ...f, status: 'error', error: String(error) } : f\n      ));\n      notify(`Upload failed: ${fileToUpload.file.name}`, { type: 'error' });\n    }\n  };\n\n  const uploadAll = async () => {\n    const pendingFiles = files\n      .map((f, index) => ({ file: f, index }))\n      .filter(({ file }) => file.status === 'pending');\n\n    // Upload all files in parallel for better performance\n    // Browsers manage connection limits automatically (usually 6 concurrent)\n    await Promise.all(\n      pendingFiles.map(({ index }) => uploadFile(index))\n    );\n  };\n\n  const clearCompleted = () => {\n    setFiles(prev => prev.filter(f => f.status !== 'success'));\n  };\n\n  const formatFileSize = (bytes: number) => {\n    if (bytes === 0) return '0 Bytes';\n    const k = 1024;\n    const sizes = ['Bytes', 'KB', 'MB', 'GB'];\n    const i = Math.floor(Math.log(bytes) / Math.log(k));\n    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];\n  };\n\n  return (\n    <div className=\"p-6 max-w-4xl mx-auto space-y-6\">\n      <Card>\n        <CardHeader>\n          <CardTitle>Upload Files</CardTitle>\n          <CardDescription>\n            Upload documents, images, audio, or video files to create activities.\n            Files are automatically stored and linked to your account.\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          {/* Configuration */}\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"provider\">Ingestion Channel</Label>\n              <Select value={selectedProvider} onValueChange={setSelectedProvider}>\n                <SelectTrigger id=\"provider\">\n                  <SelectValue placeholder=\"Select channel...\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {providers.map(provider => (\n                    <SelectItem key={provider.id} value={provider.id}>\n                      {provider.name} ({provider.provider_code})\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"type\">Activity Type</Label>\n              <Select value={activityType} onValueChange={setActivityType}>\n                <SelectTrigger id=\"type\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"note\">Note</SelectItem>\n                  <SelectItem value=\"email\">Email</SelectItem>\n                  <SelectItem value=\"call\">Call Recording</SelectItem>\n                  <SelectItem value=\"meeting\">Meeting Recording</SelectItem>\n                  <SelectItem value=\"other\">Other</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n\n          {/* Dropzone */}\n          <div\n            {...getRootProps()}\n            className={`\n              border-2 border-dashed rounded-lg p-12 text-center cursor-pointer\n              transition-all duration-200\n              ${isDragActive\n                ? 'border-green-500 bg-green-50 scale-[1.02] shadow-lg'\n                : 'border-gray-300 hover:border-primary/50 hover:bg-gray-50'\n              }\n            `}\n          >\n            <input {...getInputProps()} />\n            <Upload className=\"w-12 h-12 mx-auto mb-4 text-gray-400\" />\n            {isDragActive ? (\n              <p className=\"text-lg font-medium\">Drop files here...</p>\n            ) : (\n              <>\n                <p className=\"text-lg font-medium mb-2\">\n                  Drag & drop files here, or click to select\n                </p>\n                <p className=\"text-sm text-gray-500\">\n                  Supports all file types (executables blocked for security)\n                </p>\n              </>\n            )}\n          </div>\n\n          {/* File List */}\n          {files.length > 0 && (\n            <div className=\"space-y-2\">\n              <div className=\"flex items-center justify-between\">\n                <h3 className=\"font-medium\">Files ({files.length})</h3>\n                <div className=\"space-x-2\">\n                  <Button\n                    size=\"sm\"\n                    onClick={uploadAll}\n                    disabled={!files.some(f => f.status === 'pending')}\n                  >\n                    Upload All\n                  </Button>\n                  <Button\n                    size=\"sm\"\n                    variant=\"outline\"\n                    onClick={clearCompleted}\n                    disabled={!files.some(f => f.status === 'success')}\n                  >\n                    Clear Completed\n                  </Button>\n                </div>\n              </div>\n\n              <div className=\"space-y-2\">\n                {files.map((fileItem, index) => (\n                  <div\n                    key={index}\n                    className=\"border rounded-lg p-4 space-y-2\"\n                  >\n                    <div className=\"flex items-start justify-between gap-4\">\n                      <div className=\"flex items-start gap-3 flex-1 min-w-0\">\n                        <FileIcon className=\"w-5 h-5 mt-0.5 flex-shrink-0 text-gray-400\" />\n                        <div className=\"flex-1 min-w-0\">\n                          <p className=\"font-medium truncate\">\n                            {fileItem.file.name}\n                          </p>\n                          <p className=\"text-sm text-gray-500\">\n                            {formatFileSize(fileItem.file.size)}\n                            {fileItem.activityId && (\n                              <span className=\"ml-2 text-xs\">\n                                ID: {fileItem.activityId.substring(0, 8)}...\n                              </span>\n                            )}\n                          </p>\n                        </div>\n                      </div>\n\n                      <div className=\"flex items-center gap-2 flex-shrink-0\">\n                        {fileItem.status === 'pending' && (\n                          <Button\n                            size=\"sm\"\n                            onClick={() => uploadFile(index)}\n                          >\n                            Upload\n                          </Button>\n                        )}\n                        {fileItem.status === 'uploading' && (\n                          <Loader2 className=\"w-5 h-5 animate-spin text-primary\" />\n                        )}\n                        {fileItem.status === 'success' && (\n                          <CheckCircle className=\"w-5 h-5 text-green-500\" />\n                        )}\n                        {fileItem.status === 'error' && (\n                          <XCircle className=\"w-5 h-5 text-red-500\" />\n                        )}\n                      </div>\n                    </div>\n\n                    {/* Progress bar */}\n                    {fileItem.status === 'uploading' && (\n                      <Progress value={fileItem.progress} className=\"h-1\" />\n                    )}\n\n                    {/* Error message */}\n                    {fileItem.status === 'error' && fileItem.error && (\n                      <p className=\"text-sm text-red-500\">\n                        Error: {fileItem.error}\n                      </p>\n                    )}\n                  </div>\n                ))}\n              </div>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Info Card */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"text-base\">How it works</CardTitle>\n        </CardHeader>\n        <CardContent className=\"text-sm text-gray-600 space-y-2\">\n          <p> Files are uploaded directly to secure storage (no database bloat)</p>\n          <p> Each file creates an activity record for tracking and search</p>\n          <p> Large files are handled automatically (no size limits)</p>\n          <p> Files are linked to your selected ingestion channel</p>\n          <p> Activities appear in the Activity Feed immediately</p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activities/ActivityFeed.tsx",
      "content": "import { useEffect, useMemo } from \"react\";\nimport { useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { supabase } from \"@/components/atomic-crm/providers/supabase/supabase\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Mail, Phone, MessageSquare, StickyNote, Play, Calendar, User, Clock, CheckCircle2, AlertCircle } from \"lucide-react\";\nimport { formatDistanceToNow } from \"date-fns\";\nimport { Button } from \"@/components/ui/button\";\n\ninterface ActivityFeedProps {\n  contactId?: number;\n  salesId?: number; // Optional: filter by agent\n  className?: string;\n}\n\nexport const ActivityFeed = ({ contactId, salesId, className }: ActivityFeedProps) => {\n  const queryClient = useQueryClient();\n  const queryKey = useMemo(() => [\"activities\", contactId, salesId], [contactId, salesId]);\n\n  // 1. Initial Fetch\n  const { data: activities, isLoading } = useQuery({\n    queryKey,\n    queryFn: async () => {\n      let query = supabase\n        .from(\"activities\")\n        .select(`\n            *,\n            sales:sales_id (first_name, last_name)\n        `)\n        .order(\"created_at\", { ascending: false })\n        .limit(50);\n\n      if (contactId) {\n        query = query.eq(\"contact_id\", contactId);\n      }\n      if (salesId) {\n        query = query.eq(\"sales_id\", salesId);\n      }\n\n      const { data, error } = await query;\n      if (error) throw error;\n      return data;\n    },\n  });\n\n  // 2. Realtime Subscription\n  useEffect(() => {\n    const channel = supabase\n      .channel(\"activities-feed\")\n      .on(\n        \"postgres_changes\",\n        {\n          event: \"*\",\n          schema: \"public\",\n          table: \"activities\",\n          filter: contactId ? `contact_id=eq.${contactId}` : undefined,\n        },\n        (payload) => {\n          console.log(\"Realtime update:\", payload);\n          // Invalidate query to refetch (simplest way to keep sync)\n          queryClient.invalidateQueries({ queryKey });\n        }\n      )\n      .subscribe();\n\n    return () => {\n      supabase.removeChannel(channel);\n    };\n  }, [contactId, queryClient, queryKey]);\n\n  if (isLoading) {\n    return (\n      <div className={`space-y-4 ${className}`}>\n        <Skeleton className=\"h-24 w-full\" />\n        <Skeleton className=\"h-24 w-full\" />\n        <Skeleton className=\"h-24 w-full\" />\n      </div>\n    );\n  }\n\n  if (!activities || activities.length === 0) {\n    return (\n      <div className={`text-center py-8 text-muted-foreground bg-muted/20 rounded-lg border border-dashed ${className}`}>\n        No activities yet.\n      </div>\n    );\n  }\n\n  return (\n    <div className={`space-y-4 ${className}`}>\n        {activities.map((activity) => (\n            <ActivityCard key={activity.id} activity={activity} />\n        ))}\n    </div>\n  );\n};\n\nconst ActivityCard = ({ activity }: { activity: any }) => {\n  const isPending = activity.processing_status === \"raw\" || activity.processing_status === \"processing\";\n  const isFailed = activity.processing_status === \"failed\";\n\n  return (\n    <Card className={`relative overflow-hidden transition-all ${isPending ? 'border-blue-200 bg-blue-50/30 dark:bg-blue-950/10' : ''}`}>\n      {isPending && (\n          <div className=\"absolute top-0 left-0 right-0 h-1 bg-blue-100\">\n              <div className=\"h-full bg-blue-500 animate-progress origin-left w-full\"></div>\n          </div>\n      )}\n      \n      <CardHeader className=\"py-3 px-4 flex flex-row items-start justify-between space-y-0\">\n        <div className=\"flex items-center gap-3\">\n          <ActivityIcon type={activity.type} />\n          <div>\n            <CardTitle className=\"text-base font-medium flex items-center gap-2\">\n              <span className=\"capitalize\">{activity.type}</span>\n              {activity.direction === \"inbound\" && (\n                  <Badge variant=\"outline\" className=\"text-[10px] h-5\">Inbound</Badge>\n              )}\n               {activity.direction === \"outbound\" && (\n                  <Badge variant=\"secondary\" className=\"text-[10px] h-5\">Outbound</Badge>\n              )}\n            </CardTitle>\n            <div className=\"text-xs text-muted-foreground flex items-center gap-2 mt-0.5\">\n              <Clock className=\"h-3 w-3\" />\n              {formatDistanceToNow(new Date(activity.created_at), { addSuffix: true })}\n              {activity.sales && (\n                  <>\n                    <span></span>\n                    <User className=\"h-3 w-3\" />\n                    {activity.sales.first_name} {activity.sales.last_name}\n                  </>\n              )}\n            </div>\n          </div>\n        </div>\n        \n        <StatusBadge status={activity.processing_status} />\n      </CardHeader>\n\n      <CardContent className=\"pb-4 px-4 pt-0\">\n        {/* Content Body */}\n        <div className=\"mt-2 text-sm\">\n            {isPending ? (\n                <div className=\"flex items-center gap-2 text-muted-foreground italic\">\n                    <div className=\"h-2 w-2 bg-blue-500 rounded-full animate-bounce\" style={{ animationDelay: '0ms' }}></div>\n                    <div className=\"h-2 w-2 bg-blue-500 rounded-full animate-bounce\" style={{ animationDelay: '150ms' }}></div>\n                    <div className=\"h-2 w-2 bg-blue-500 rounded-full animate-bounce\" style={{ animationDelay: '300ms' }}></div>\n                    <span>Processing content...</span>\n                </div>\n            ) : isFailed ? (\n                 <p className=\"text-destructive\">Processing failed.</p>\n            ) : (\n                <div className=\"space-y-2\">\n                    {/* Transcript / Text */}\n                    {activity.processed_data?.transcript ? (\n                        <div className=\"bg-muted/50 p-3 rounded-md border text-foreground/90 whitespace-pre-wrap\">\n                            {activity.processed_data.transcript}\n                        </div>\n                    ) : activity.raw_data?.source_type === \"text\" ? (\n                        <p className=\"whitespace-pre-wrap\">{activity.raw_data.content}</p>\n                    ) : null}\n                    \n                    {/* Audio Player */}\n                    {activity.raw_data?.source_type === \"url\" && (\n                         <div className=\"flex items-center gap-2 bg-secondary p-2 rounded-md w-fit\">\n                             <Button size=\"icon\" variant=\"ghost\" className=\"h-8 w-8 rounded-full\">\n                                 <Play className=\"h-4 w-4\" />\n                             </Button>\n                             <span className=\"text-xs font-mono\">Audio Recording</span>\n                         </div>\n                    )}\n                    \n                    {/* Atomic Facts / Summary */}\n                    {activity.processed_data?.summary && (\n                        <div className=\"bg-yellow-50 dark:bg-yellow-950/20 p-2 rounded border border-yellow-200 dark:border-yellow-800 text-xs\">\n                            <span className=\"font-semibold text-yellow-700 dark:text-yellow-500 block mb-1\">Summary:</span>\n                            {activity.processed_data.summary}\n                        </div>\n                    )}\n                </div>\n            )}\n        </div>\n      </CardContent>\n    </Card>\n  );\n};\n\nconst ActivityIcon = ({ type }: { type: string }) => {\n  const className = \"h-5 w-5 text-muted-foreground\";\n  switch (type) {\n    case \"email\": return <Mail className={className} />;\n    case \"call\": return <Phone className={className} />;\n    case \"sms\": return <MessageSquare className={className} />;\n    case \"meeting\": return <Calendar className={className} />;\n    default: return <StickyNote className={className} />;\n  }\n};\n\nconst StatusBadge = ({ status }: { status: string }) => {\n    switch (status) {\n        case \"raw\":\n        case \"processing\":\n            return <Badge variant=\"outline\" className=\"border-blue-200 text-blue-600 bg-blue-50\">Processing</Badge>;\n        case \"completed\":\n            return <CheckCircle2 className=\"h-4 w-4 text-green-500\" />;\n        case \"failed\":\n            return <AlertCircle className=\"h-4 w-4 text-destructive\" />;\n        default:\n            return null;\n    }\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activities/ActivitiesPage.tsx",
      "content": "import { ActivityFeed } from \"./ActivityFeed\";\n\nexport const ActivitiesPage = () => {\n  return (\n    <div className=\"container mx-auto py-6\">\n      <div className=\"mb-6\">\n        <h1 className=\"text-3xl font-bold\">Activity Timeline</h1>\n        <p className=\"text-muted-foreground mt-2\">\n          All activities from ingestion channels and manual entries\n        </p>\n      </div>\n\n      <ActivityFeed />\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/supabase/set-password-page.tsx",
      "content": "import { useState } from \"react\";\nimport type { ValidateForm } from \"ra-core\";\nimport { Form, required, useNotify, useTranslate } from \"ra-core\";\nimport { useSetPassword, useSupabaseAccessToken } from \"ra-supabase-core\";\nimport type { FieldValues, SubmitHandler } from \"react-hook-form\";\nimport { Button } from \"@/components/ui/button\";\nimport { TextInput } from \"@/components/admin/text-input\";\nimport { Layout } from \"@/components/supabase/layout\";\n\ninterface FormData {\n  password: string;\n  confirmPassword: string;\n}\n\nexport const SetPasswordPage = () => {\n  const [loading, setLoading] = useState(false);\n\n  const access_token = useSupabaseAccessToken();\n  const refresh_token = useSupabaseAccessToken({\n    parameterName: \"refresh_token\",\n  });\n\n  const notify = useNotify();\n  const translate = useTranslate();\n  const [, { mutateAsync: setPassword }] = useSetPassword();\n\n  const validate = (values: FormData) => {\n    if (values.password !== values.confirmPassword) {\n      return {\n        password: \"ra-supabase.validation.password_mismatch\",\n        confirmPassword: \"ra-supabase.validation.password_mismatch\",\n      };\n    }\n    return {};\n  };\n\n  if (!access_token || !refresh_token) {\n    if (process.env.NODE_ENV === \"development\") {\n      console.error(\"Missing access_token or refresh_token for set password\");\n    }\n    return (\n      <Layout>\n        <p>{translate(\"ra-supabase.auth.missing_tokens\")}</p>\n      </Layout>\n    );\n  }\n\n  const submit = async (values: FormData) => {\n    try {\n      setLoading(true);\n      await setPassword({\n        access_token,\n        refresh_token,\n        password: values.password,\n      });\n    } catch (error: any) {\n      notify(\n        typeof error === \"string\"\n          ? error\n          : typeof error === \"undefined\" || !error.message\n            ? \"ra.auth.sign_in_error\"\n            : error.message,\n        {\n          type: \"warning\",\n          messageArgs: {\n            _:\n              typeof error === \"string\"\n                ? error\n                : error && error.message\n                  ? error.message\n                  : undefined,\n          },\n        },\n      );\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  return (\n    <Layout>\n      <div className=\"flex flex-col space-y-2 text-center\">\n        <h1 className=\"text-2xl font-semibold tracking-tight\">\n          {translate(\"ra-supabase.set_password.new_password\", {\n            _: \"Choose your password\",\n          })}\n        </h1>\n      </div>\n      <Form<FormData>\n        className=\"space-y-8\"\n        onSubmit={submit as SubmitHandler<FieldValues>}\n        validate={validate as ValidateForm}\n      >\n        <TextInput\n          label={translate(\"ra.auth.password\", {\n            _: \"Password\",\n          })}\n          autoComplete=\"new-password\"\n          source=\"password\"\n          type=\"password\"\n          validate={required()}\n        />\n        <TextInput\n          label={translate(\"ra.auth.confirm_password\", {\n            _: \"Confirm password\",\n          })}\n          source=\"confirmPassword\"\n          type=\"password\"\n          validate={required()}\n        />\n        <Button type=\"submit\" className=\"cursor-pointer\" disabled={loading}>\n          {translate(\"ra.action.save\")}\n        </Button>\n      </Form>\n    </Layout>\n  );\n};\n\nSetPasswordPage.path = \"set-password\";\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/supabase/otp-login-page.tsx",
      "content": "import { useState } from \"react\";\nimport { Form, required, useNotify, useTranslate } from \"ra-core\";\nimport { Layout } from \"@/components/supabase/layout\";\nimport type { FieldValues, SubmitHandler } from \"react-hook-form\";\nimport { TextInput } from \"@/components/admin/text-input\";\nimport { Button } from \"@/components/ui/button\";\nimport { OtpInput } from \"@/components/supabase/otp-input\";\nimport { supabase } from \"@/components/atomic-crm/providers/supabase/supabase\";\n\ninterface EmailFormData {\n  email: string;\n}\n\ntype Step = 'email' | 'otp';\n\nexport const OtpLoginPage = () => {\n  const [loading, setLoading] = useState(false);\n  const [step, setStep] = useState<Step>('email');\n  const [email, setEmail] = useState('');\n  const [otp, setOtp] = useState('');\n  const [otpError, setOtpError] = useState(false);\n\n  const notify = useNotify();\n  const translate = useTranslate();\n\n  const submitEmail = async (values: EmailFormData) => {\n    try {\n      setLoading(true);\n      // Normalize email to lowercase\n      const normalizedEmail = values.email.trim().toLowerCase();\n      setEmail(normalizedEmail);\n\n      const { error } = await supabase.auth.signInWithOtp({\n        email: normalizedEmail,\n        options: {\n          shouldCreateUser: false, // Only allow existing users\n        },\n      });\n\n      if (error) {\n        throw error;\n      }\n\n      notify('A 6-digit code has been sent to your email', { type: 'success' });\n      setStep('otp');\n    } catch (error: any) {\n      notify(\n        typeof error === \"string\"\n          ? error\n          : typeof error === \"undefined\" || !error.message\n            ? \"ra.auth.sign_in_error\"\n            : error.message,\n        {\n          type: \"warning\",\n          messageArgs: {\n            _:\n              typeof error === \"string\"\n                ? error\n                : error && error.message\n                  ? error.message\n                  : undefined,\n          },\n        },\n      );\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const verifyOtp = async (otpCode: string) => {\n    try {\n      setLoading(true);\n      setOtpError(false);\n\n      // Trim whitespace from OTP code\n      const cleanOtp = otpCode.trim();\n\n      console.log('Verifying OTP:', { email, token: cleanOtp, type: 'email' });\n\n      const { data, error } = await supabase.auth.verifyOtp({\n        email: email.trim().toLowerCase(), // Normalize email\n        token: cleanOtp,\n        type: 'magiclink', // Changed from 'email' - some Supabase versions treat OTP as magiclink\n      });\n\n      console.log('OTP Verification result:', { data, error });\n\n      if (error) {\n        throw error;\n      }\n\n      if (!data.session) {\n        throw new Error('Failed to create session');\n      }\n\n      console.log('Session created successfully, user:', data.user);\n\n      // Check if user exists in sales table (access control)\n      console.log('Checking sales table for user_id:', data.user.id);\n      const { data: saleData, error: saleError } = await supabase\n        .from('sales')\n        .select('id, email_confirmed_at')\n        .eq('user_id', data.user.id)\n        .single();\n\n      console.log('Sales table query result:', { saleData, saleError });\n\n      if (saleError || !saleData) {\n        // User authenticated but not in sales table - deny access\n        console.error('User not found in sales table or query error');\n        await supabase.auth.signOut();\n        throw new Error('You do not have access to this application. Please contact your administrator.');\n      }\n\n      // User is logged in and authorized\n      console.log('User authorized, OTP verification complete');\n      notify('Login successful!', { type: 'success' });\n\n      // IMPORTANT: Don't call login() - user is already authenticated via Supabase\n      // The OTP verification already set the session\n      // Calling login({}) with empty params could cause session confusion\n\n      // Force reload to ensure clean state\n      console.log('Reloading to establish session...');\n\n      // Check if this is their first login (email not confirmed yet)\n      if (!saleData.email_confirmed_at) {\n        // Navigate to change password\n        window.location.href = '#/change-password';\n        window.location.reload();\n      } else {\n        // Navigate to dashboard\n        window.location.href = '#/';\n        window.location.reload();\n      }\n    } catch (error: any) {\n      setOtpError(true);\n      notify(\n        typeof error === \"string\"\n          ? error\n          : typeof error === \"undefined\" || !error.message\n            ? \"Invalid or expired code\"\n            : error.message,\n        {\n          type: \"warning\",\n          messageArgs: {\n            _:\n              typeof error === \"string\"\n                ? error\n                : error && error.message\n                  ? error.message\n                  : undefined,\n          },\n        },\n      );\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleOtpComplete = (otpCode: string) => {\n    verifyOtp(otpCode);\n  };\n\n  const handleResendCode = async () => {\n    setOtp('');\n    setOtpError(false);\n    await submitEmail({ email });\n  };\n\n  return (\n    <Layout>\n      {step === 'email' ? (\n        <>\n          <div className=\"flex flex-col space-y-2 text-center\">\n            <h1 className=\"text-2xl font-semibold tracking-tight\">\n              Login with code\n            </h1>\n            <p className=\"text-sm text-muted-foreground\">\n              Enter your email to receive a 6-digit login code\n            </p>\n          </div>\n          <Form<EmailFormData>\n            className=\"space-y-8\"\n            onSubmit={submitEmail as SubmitHandler<FieldValues>}\n          >\n            <TextInput\n              source=\"email\"\n              label={translate(\"ra.auth.email\", {\n                _: \"Email\",\n              })}\n              autoComplete=\"email\"\n              validate={required()}\n            />\n            <Button type=\"submit\" className=\"cursor-pointer w-full\" disabled={loading}>\n              {translate(\"ra.action.send_code\", {\n                _: \"Send code\",\n              })}\n            </Button>\n          </Form>\n        </>\n      ) : (\n        <>\n          <div className=\"flex flex-col space-y-2 text-center\">\n            <h1 className=\"text-2xl font-semibold tracking-tight\">\n              Enter verification code\n            </h1>\n            <p className=\"text-sm text-muted-foreground\">\n              We've sent a 6-digit code to {email}\n            </p>\n          </div>\n          <div className=\"space-y-6\">\n            <div className=\"space-y-4\">\n              <OtpInput\n                length={6}\n                value={otp}\n                onChange={setOtp}\n                onComplete={handleOtpComplete}\n                disabled={loading}\n                error={otpError}\n              />\n              {otpError && (\n                <p className=\"text-sm text-destructive text-center\">\n                  Invalid or expired code. Please try again.\n                </p>\n              )}\n            </div>\n            <div className=\"flex flex-col gap-2\">\n              <Button\n                type=\"button\"\n                className=\"cursor-pointer w-full\"\n                disabled={loading || otp.length !== 6}\n                onClick={() => verifyOtp(otp)}\n              >\n                {loading ? 'Verifying...' : 'Verify code'}\n              </Button>\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                className=\"cursor-pointer w-full\"\n                disabled={loading}\n                onClick={handleResendCode}\n              >\n                Resend code\n              </Button>\n            </div>\n          </div>\n        </>\n      )}\n    </Layout>\n  );\n};\n\nOtpLoginPage.path = \"otp-login\";\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/supabase/otp-input.tsx",
      "content": "import { useRef, useState, KeyboardEvent, ClipboardEvent } from 'react';\nimport { Input } from '@/components/ui/input';\nimport { cn } from '@/lib/utils';\n\ninterface OtpInputProps {\n  length?: number;\n  value: string;\n  onChange: (value: string) => void;\n  onComplete?: (value: string) => void;\n  disabled?: boolean;\n  error?: boolean;\n}\n\nexport function OtpInput({\n  length = 6,\n  value,\n  onChange,\n  onComplete,\n  disabled = false,\n  error = false,\n}: OtpInputProps) {\n  const inputRefs = useRef<(HTMLInputElement | null)[]>([]);\n  const [focusedIndex, setFocusedIndex] = useState<number | null>(null);\n\n  const handleChange = (index: number, inputValue: string) => {\n    // Only allow digits\n    const digit = inputValue.replace(/[^0-9]/g, '');\n\n    if (digit.length === 0) {\n      // Handle backspace/delete\n      const newValue = value.split('');\n      newValue[index] = '';\n      const updatedValue = newValue.join('');\n      onChange(updatedValue);\n\n      // Move to previous input\n      if (index > 0) {\n        inputRefs.current[index - 1]?.focus();\n      }\n      return;\n    }\n\n    // Update the value at the current index\n    const newValue = value.split('');\n    newValue[index] = digit[0];\n    const updatedValue = newValue.join('');\n    onChange(updatedValue);\n\n    // Move to next input if not the last one\n    if (index < length - 1) {\n      inputRefs.current[index + 1]?.focus();\n    }\n\n    // Check if OTP is complete\n    if (updatedValue.length === length && onComplete) {\n      onComplete(updatedValue);\n    }\n  };\n\n  const handleKeyDown = (index: number, e: KeyboardEvent<HTMLInputElement>) => {\n    if (e.key === 'Backspace' && !value[index] && index > 0) {\n      // If current input is empty and backspace is pressed, move to previous\n      inputRefs.current[index - 1]?.focus();\n    } else if (e.key === 'ArrowLeft' && index > 0) {\n      inputRefs.current[index - 1]?.focus();\n    } else if (e.key === 'ArrowRight' && index < length - 1) {\n      inputRefs.current[index + 1]?.focus();\n    }\n  };\n\n  const handlePaste = (e: ClipboardEvent<HTMLInputElement>) => {\n    e.preventDefault();\n    const pastedData = e.clipboardData.getData('text/plain');\n    const digits = pastedData.replace(/[^0-9]/g, '').slice(0, length);\n\n    onChange(digits);\n\n    // Focus the next empty input or the last input\n    const nextIndex = Math.min(digits.length, length - 1);\n    inputRefs.current[nextIndex]?.focus();\n\n    // Check if OTP is complete\n    if (digits.length === length && onComplete) {\n      onComplete(digits);\n    }\n  };\n\n  return (\n    <div className=\"flex gap-2 justify-center\">\n      {Array.from({ length }).map((_, index) => (\n        <Input\n          key={index}\n          ref={(el) => {\n            inputRefs.current[index] = el;\n          }}\n          type=\"text\"\n          inputMode=\"numeric\"\n          maxLength={1}\n          value={value[index] || ''}\n          onChange={(e) => handleChange(index, e.target.value)}\n          onKeyDown={(e) => handleKeyDown(index, e)}\n          onPaste={handlePaste}\n          onFocus={() => setFocusedIndex(index)}\n          onBlur={() => setFocusedIndex(null)}\n          disabled={disabled}\n          className={cn(\n            'w-12 h-12 text-center text-lg font-semibold',\n            error && 'border-destructive focus-visible:ring-destructive',\n            focusedIndex === index && 'ring-2 ring-ring'\n          )}\n          aria-label={`Digit ${index + 1}`}\n        />\n      ))}\n    </div>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/supabase/layout.tsx",
      "content": "import * as React from \"react\";\nimport { Link } from \"react-router\";\nimport { Notification } from \"@/components/admin/notification\";\nimport { useConfigurationContext } from \"@/components/atomic-crm/root/ConfigurationContext\";\n\nexport const Layout = ({ children }: React.PropsWithChildren) => {\n  const { darkModeLogo, title } = useConfigurationContext();\n\n  return (\n    <div className=\"min-h-screen flex\">\n      <div className=\"container relative grid flex-col items-center justify-center sm:max-w-none lg:grid-cols-2 lg:px-0\">\n        <div className=\"relative hidden h-full flex-col bg-muted p-10 text-white dark:border-r lg:flex\">\n          <div className=\"absolute inset-0 bg-zinc-900\" />\n          <Link\n            to=\"/\"\n            className=\"relative z-20 flex items-center text-lg font-medium no-underline text-white hover:opacity-80 transition-opacity\"\n          >\n            <img className=\"h-6 mr-2\" src={darkModeLogo} alt={title} />\n            {title}\n          </Link>\n        </div>\n        <div className=\"lg:p-8\">\n          <div className=\"mx-auto flex w-full flex-col justify-center space-y-6 sm:w-[350px]\">\n            {children}\n          </div>\n        </div>\n      </div>\n      <Notification />\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/supabase/forgot-password-page.tsx",
      "content": "import { useState } from \"react\";\nimport { Form, required, useNotify, useTranslate } from \"ra-core\";\nimport { Layout } from \"@/components/supabase/layout\";\nimport type { FieldValues, SubmitHandler } from \"react-hook-form\";\nimport { TextInput } from \"@/components/admin/text-input\";\nimport { Button } from \"@/components/ui/button\";\nimport { OtpInput } from \"@/components/supabase/otp-input\";\nimport { supabase } from \"@/components/atomic-crm/providers/supabase/supabase\";\nimport { Link } from \"react-router\";\n\ninterface EmailFormData {\n  email: string;\n}\n\ntype Step = 'email' | 'otp';\n\nexport const ForgotPasswordPage = () => {\n  const [loading, setLoading] = useState(false);\n  const [step, setStep] = useState<Step>('email');\n  const [email, setEmail] = useState('');\n  const [otp, setOtp] = useState('');\n  const [otpError, setOtpError] = useState(false);\n\n  const notify = useNotify();\n  const translate = useTranslate();\n\n  const submitEmail = async (values: EmailFormData) => {\n    try {\n      setLoading(true);\n      // Normalize email to lowercase\n      const normalizedEmail = values.email.trim().toLowerCase();\n      setEmail(normalizedEmail);\n\n      const { error } = await supabase.auth.signInWithOtp({\n        email: normalizedEmail,\n        options: {\n          shouldCreateUser: false, // Only allow existing users to reset password\n        },\n      });\n\n      if (error) {\n        throw error;\n      }\n\n      notify('A 6-digit code has been sent to your email', { type: 'success' });\n      setStep('otp');\n    } catch (error: any) {\n      notify(\n        typeof error === \"string\"\n          ? error\n          : typeof error === \"undefined\" || !error.message\n            ? \"ra.auth.sign_in_error\"\n            : error.message,\n        {\n          type: \"warning\",\n          messageArgs: {\n            _:\n              typeof error === \"string\"\n                ? error\n                : error && error.message\n                  ? error.message\n                  : undefined,\n          },\n        },\n      );\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const verifyOtp = async (otpCode: string) => {\n    try {\n      setLoading(true);\n      setOtpError(false);\n\n      // Trim whitespace from OTP code\n      const cleanOtp = otpCode.trim();\n\n      console.log('Verifying OTP (forgot password):', { email, token: cleanOtp, type: 'email' });\n\n      const { data, error } = await supabase.auth.verifyOtp({\n        email: email.trim().toLowerCase(), // Normalize email\n        token: cleanOtp,\n        type: 'magiclink', // Changed from 'email' - some Supabase versions treat OTP as magiclink\n      });\n\n      console.log('OTP Verification result:', { data, error });\n\n      if (error) {\n        throw error;\n      }\n\n      if (!data.session) {\n        throw new Error('Failed to create session');\n      }\n\n      console.log('Session created successfully for password reset');\n\n      // User is now logged in, redirect to change password page\n      notify('Code verified! Please set your new password.', { type: 'success' });\n\n      // IMPORTANT: Don't call login() - user is already authenticated via Supabase\n      // The OTP verification already set the session\n      // Calling login({}) with empty params could cause session confusion\n\n      // Navigate to change password page with reload\n      console.log('Navigating to /change-password');\n      window.location.href = '#/change-password';\n      window.location.reload();\n    } catch (error: any) {\n      setOtpError(true);\n      notify(\n        typeof error === \"string\"\n          ? error\n          : typeof error === \"undefined\" || !error.message\n            ? \"Invalid or expired code\"\n            : error.message,\n        {\n          type: \"warning\",\n          messageArgs: {\n            _:\n              typeof error === \"string\"\n                ? error\n                : error && error.message\n                  ? error.message\n                  : undefined,\n          },\n        },\n      );\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleOtpComplete = (otpCode: string) => {\n    verifyOtp(otpCode);\n  };\n\n  const handleResendCode = async () => {\n    setOtp('');\n    setOtpError(false);\n    await submitEmail({ email });\n  };\n\n  return (\n    <Layout>\n      {step === 'email' ? (\n        <>\n          <div className=\"flex flex-col space-y-2 text-center\">\n            <h1 className=\"text-2xl font-semibold tracking-tight\">\n              {translate(\"ra-supabase.reset_password.forgot_password\", {\n                _: \"Forgot password?\",\n              })}\n            </h1>\n            <p>\n              {translate(\"ra-supabase.reset_password.forgot_password_details\", {\n                _: \"Enter your email to receive a 6-digit code.\",\n              })}\n            </p>\n          </div>\n          <Form<EmailFormData>\n            className=\"space-y-8\"\n            onSubmit={submitEmail as SubmitHandler<FieldValues>}\n          >\n            <TextInput\n              source=\"email\"\n              label={translate(\"ra.auth.email\", {\n                _: \"Email\",\n              })}\n              autoComplete=\"email\"\n              validate={required()}\n            />\n            <Button type=\"submit\" className=\"cursor-pointer w-full\" disabled={loading}>\n              {translate(\"ra.action.reset_password\", {\n                _: \"Send code\",\n              })}\n            </Button>\n          </Form>\n          <div className=\"text-center\">\n            <Link\n              to=\"/\"\n              className=\"text-sm text-muted-foreground hover:text-primary underline-offset-4 hover:underline\"\n            >\n              Back to login\n            </Link>\n          </div>\n        </>\n      ) : (\n        <>\n          <div className=\"flex flex-col space-y-2 text-center\">\n            <h1 className=\"text-2xl font-semibold tracking-tight\">\n              Enter verification code\n            </h1>\n            <p className=\"text-sm text-muted-foreground\">\n              We've sent a 6-digit code to {email}\n            </p>\n          </div>\n          <div className=\"space-y-6\">\n            <div className=\"space-y-4\">\n              <OtpInput\n                length={6}\n                value={otp}\n                onChange={setOtp}\n                onComplete={handleOtpComplete}\n                disabled={loading}\n                error={otpError}\n              />\n              {otpError && (\n                <p className=\"text-sm text-destructive text-center\">\n                  Invalid or expired code. Please try again.\n                </p>\n              )}\n            </div>\n            <div className=\"flex flex-col gap-2\">\n              <Button\n                type=\"button\"\n                className=\"cursor-pointer w-full\"\n                disabled={loading || otp.length !== 6}\n                onClick={() => verifyOtp(otp)}\n              >\n                {loading ? 'Verifying...' : 'Verify code'}\n              </Button>\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                className=\"cursor-pointer w-full\"\n                disabled={loading}\n                onClick={handleResendCode}\n              >\n                Resend code\n              </Button>\n              <Button\n                type=\"button\"\n                variant=\"ghost\"\n                className=\"cursor-pointer w-full\"\n                disabled={loading}\n                onClick={() => {\n                  setStep('email');\n                  setOtp('');\n                  setOtpError(false);\n                }}\n              >\n                 Back to email\n              </Button>\n            </div>\n          </div>\n          <div className=\"text-center\">\n            <Link\n              to=\"/\"\n              className=\"text-sm text-muted-foreground hover:text-primary underline-offset-4 hover:underline\"\n            >\n              Back to login\n            </Link>\n          </div>\n        </>\n      )}\n    </Layout>\n  );\n};\n\nForgotPasswordPage.path = \"forgot-password\";\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/supabase/change-password-page.tsx",
      "content": "import { useState } from \"react\";\nimport { Form, required, useNotify, useTranslate } from \"ra-core\";\nimport { Layout } from \"@/components/supabase/layout\";\nimport type { FieldValues, SubmitHandler } from \"react-hook-form\";\nimport { TextInput } from \"@/components/admin/text-input\";\nimport { Button } from \"@/components/ui/button\";\nimport { supabase } from \"@/components/atomic-crm/providers/supabase/supabase\";\nimport { useNavigate, Link } from \"react-router\";\n\ninterface FormData {\n  password: string;\n  confirm: string;\n}\n\nexport const ChangePasswordPage = () => {\n  const [loading, setLoading] = useState(false);\n\n  const notify = useNotify();\n  const translate = useTranslate();\n  const navigate = useNavigate();\n\n  const validate = (values: FormData) => {\n    const errors: Record<string, string> = {};\n\n    if (!values.password) {\n      errors.password = translate(\"ra.validation.required\");\n    } else if (values.password.length < 6) {\n      errors.password = \"Password must be at least 6 characters\";\n    }\n\n    if (!values.confirm) {\n      errors.confirm = translate(\"ra.validation.required\");\n    } else if (values.password !== values.confirm) {\n      errors.confirm = \"Passwords do not match\";\n    }\n\n    return errors;\n  };\n\n  const submit = async (values: FormData) => {\n    try {\n      setLoading(true);\n\n      const { error } = await supabase.auth.updateUser({\n        password: values.password,\n      });\n\n      if (error) {\n        throw error;\n      }\n\n      notify(\"Password updated successfully\", { type: \"success\" });\n      navigate(\"/\");\n    } catch (error: any) {\n      notify(\n        typeof error === \"string\"\n          ? error\n          : typeof error === \"undefined\" || !error.message\n            ? \"Failed to update password\"\n            : error.message,\n        {\n          type: \"warning\",\n          messageArgs: {\n            _:\n              typeof error === \"string\"\n                ? error\n                : error && error.message\n                  ? error.message\n                  : undefined,\n          },\n        },\n      );\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  return (\n    <Layout>\n      <div className=\"flex flex-col space-y-2 text-center\">\n        <h1 className=\"text-2xl font-semibold tracking-tight\">\n          Set new password\n        </h1>\n        <p className=\"text-sm text-muted-foreground\">\n          Choose a secure password for your account\n        </p>\n      </div>\n      <Form<FormData>\n        className=\"space-y-6\"\n        onSubmit={submit as SubmitHandler<FieldValues>}\n        validate={validate}\n      >\n        <TextInput\n          source=\"password\"\n          type=\"password\"\n          label={translate(\"ra.auth.password\", {\n            _: \"New password\",\n          })}\n          autoComplete=\"new-password\"\n          validate={required()}\n        />\n        <TextInput\n          source=\"confirm\"\n          type=\"password\"\n          label={translate(\"ra.auth.confirm_password\", {\n            _: \"Confirm password\",\n          })}\n          autoComplete=\"new-password\"\n          validate={required()}\n        />\n        <Button type=\"submit\" className=\"cursor-pointer w-full\" disabled={loading}>\n          {loading ? \"Updating...\" : \"Update password\"}\n        </Button>\n      </Form>\n      <div className=\"text-center\">\n        <Link\n          to=\"/\"\n          className=\"text-sm text-muted-foreground hover:text-primary underline-offset-4 hover:underline\"\n        >\n          Back to login\n        </Link>\n      </div>\n    </Layout>\n  );\n};\n\nChangePasswordPage.path = \"change-password\";\n",
      "type": "registry:component"
    },
    {
      "path": "src/hooks/user-menu-context.tsx",
      "content": "import { createContext, useContext } from \"react\";\n\n/**\n * @deprecated Use UserMenuContextValue from `ra-core` once available.\n */\nexport type UserMenuContextValue = {\n  /**\n   * Closes the user menu\n   * @see UserMenu\n   */\n  onClose: () => void;\n};\n\n/**\n * @deprecated Use UserMenuContext from `ra-core` once available.\n */\nexport const UserMenuContext = createContext<UserMenuContextValue | undefined>(\n  undefined,\n);\n\n/**\n * @deprecated Use useUserMenu from `ra-core` once available.\n */\nexport const useUserMenu = () => useContext(UserMenuContext);\n",
      "type": "registry:hook"
    },
    {
      "path": "src/hooks/useBulkExport.tsx",
      "content": "import type { Exporter } from \"ra-core\";\nimport {\n  fetchRelatedRecords,\n  useDataProvider,\n  useListContext,\n  useNotify,\n  useResourceContext,\n} from \"ra-core\";\nimport { useCallback, useMemo } from \"react\";\n\n/**\n * This fill will be backported to 'ra-core' in the future.\n *\n * @deprecated Import from 'ra-core' instead.\n */\nexport function useBulkExport<\n  ResourceInformationsType extends Partial<{ resource: string }>,\n>(props: UseBulkExportProps<ResourceInformationsType>) {\n  const { exporter: customExporter, meta } = props;\n\n  const resource = useResourceContext(props);\n  const { exporter: exporterFromContext, selectedIds } = useListContext();\n  const exporter = customExporter || exporterFromContext;\n  const dataProvider = useDataProvider();\n  const notify = useNotify();\n\n  const bulkExport = useCallback(() => {\n    if (exporter && resource) {\n      dataProvider\n        .getMany(resource, { ids: selectedIds, meta })\n        .then(({ data }) =>\n          exporter(\n            data,\n            fetchRelatedRecords(dataProvider),\n            dataProvider,\n            resource,\n          ),\n        )\n        .catch((error) => {\n          console.error(error);\n          notify(\"ra.notification.http_error\", {\n            type: \"error\",\n          });\n        });\n    }\n  }, [dataProvider, exporter, notify, resource, selectedIds, meta]);\n\n  return useMemo(() => {\n    return {\n      bulkExport,\n    };\n  }, [bulkExport]);\n}\n\nexport type ResourceInformation = Partial<{ resource: string }>;\n\nexport type UseBulkExportProps<T extends ResourceInformation> = T & {\n  exporter?: Exporter;\n\n  meta?: any;\n};\n",
      "type": "registry:hook"
    },
    {
      "path": "src/hooks/simple-form-iterator-context.tsx",
      "content": "import { createContext, useContext } from \"react\";\n\n/**\n * A React context that provides access to a SimpleFormIterator data (the total number of items) and mutators (add, reorder and remove).\n * Useful to create custom array input iterators.\n * @deprecated Use SimpleFormIteratorContext from `ra-core` once available.\n * @see {SimpleFormIterator}\n * @see {ArrayInput}\n */\nexport const SimpleFormIteratorContext = createContext<\n  SimpleFormIteratorContextValue | undefined\n>(undefined);\n\n/**\n * @deprecated Use SimpleFormIteratorContextValue from `ra-core` once available.\n */\nexport type SimpleFormIteratorContextValue = {\n  add: (item?: any) => void;\n  remove: (index: number) => void;\n  reOrder: (index: number, newIndex: number) => void;\n  source: string;\n  total: number;\n};\n\n/**\n * @deprecated Use useSimpleFormIterator from `ra-core` once available.\n */\nexport const useSimpleFormIterator = () => {\n  const context = useContext(SimpleFormIteratorContext);\n  if (!context) {\n    throw new Error(\n      \"useSimpleFormIterator must be used inside a SimpleFormIterator\",\n    );\n  }\n  return context;\n};\n\n/**\n * A React context that provides access to a SimpleFormIterator item meta (its index and the total number of items) and mutators (reorder and remove this remove).\n * Useful to create custom array input iterators.\n * @deprecated Use SimpleFormIteratorItemContext from `ra-core` once available.\n * @see {SimpleFormIterator}\n * @see {ArrayInput}\n */\nexport const SimpleFormIteratorItemContext = createContext<\n  SimpleFormIteratorItemContextValue | undefined\n>(undefined);\n\n/**\n * @deprecated Use SimpleFormIteratorItemContextValue from `ra-core` once available.\n */\nexport type SimpleFormIteratorItemContextValue = {\n  index: number;\n  total: number;\n  remove: () => void;\n  reOrder: (newIndex: number) => void;\n};\n\n/**\n * @deprecated Use useSimpleFormIteratorItem from `ra-core` once available.\n */\nexport const useSimpleFormIteratorItem = () => {\n  const context = useContext(SimpleFormIteratorItemContext);\n  if (!context) {\n    throw new Error(\n      \"useSimpleFormIteratorItem must be used inside a SimpleFormIteratorItem\",\n    );\n  }\n  return context;\n};\n",
      "type": "registry:hook"
    }
  ],
  "type": "registry:block"
}